var TC=TC||{};TC.tool=TC.tool||{};TC.tool.Proxification=function(t,e){this.Consts={url:{SPLIT_REGEX:/([^:]*:)?\/\/([^:]*:?[^@]*@)?([^:\/\?]*):?([^\/\?]*)/}};if(void 0===t)throw new TypeError('"proxy" parameter is undefined',"TC.tool.Proxification.js");this.proxy="function"==typeof t?t:function(e){var r=t;"http"!=e.substr(0,4)&&(r+=window.location.protocol);return r+=encodeURIComponent(e)};e=e||{};this._location=e.location||window.location;this.preventMixedContent=void 0===e.allowedMixedContent||!e.allowedMixedContent};!function(){window.fetch||function(t){"use strict";if(!t.fetch){var e={searchParams:"URLSearchParams"in t,iterable:"Symbol"in t&&"iterator"in Symbol,blob:"FileReader"in t&&"Blob"in t&&function(){try{new Blob;return!0}catch(t){return!1}}(),formData:"FormData"in t,arrayBuffer:"ArrayBuffer"in t};if(e.arrayBuffer)var r=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"],n=function(t){return t&&DataView.prototype.isPrototypeOf(t)},o=ArrayBuffer.isView||function(t){return t&&r.indexOf(Object.prototype.toString.call(t))>-1};f.prototype.append=function(t,e){t=a(t);e=c(e);var r=this.map[t];this.map[t]=r?r+","+e:e};f.prototype.delete=function(t){delete this.map[a(t)]};f.prototype.get=function(t){t=a(t);return this.has(t)?this.map[t]:null};f.prototype.has=function(t){return this.map.hasOwnProperty(a(t))};f.prototype.set=function(t,e){this.map[a(t)]=c(e)};f.prototype.forEach=function(t,e){for(var r in this.map)this.map.hasOwnProperty(r)&&t.call(e,this.map[r],r,this)};f.prototype.keys=function(){var t=[];this.forEach(function(e,r){t.push(r)});return u(t)};f.prototype.values=function(){var t=[];this.forEach(function(e){t.push(e)});return u(t)};f.prototype.entries=function(){var t=[];this.forEach(function(e,r){t.push([r,e])});return u(t)};e.iterable&&(f.prototype[Symbol.iterator]=f.prototype.entries);var i=["DELETE","GET","HEAD","OPTIONS","POST","PUT"];m.prototype.clone=function(){return new m(this,{body:this._bodyInit})};y.call(m.prototype);y.call(g.prototype);g.prototype.clone=function(){return new g(this._bodyInit,{status:this.status,statusText:this.statusText,headers:new f(this.headers),url:this.url})};g.error=function(){var t=new g(null,{status:0,statusText:""});t.type="error";return t};var s=[301,302,303,307,308];g.redirect=function(t,e){if(-1===s.indexOf(e))throw new RangeError("Invalid status code");return new g(null,{status:e,headers:{location:t}})};t.Headers=f;t.Request=m;t.Response=g;t.fetch=function(t,r){return new Promise(function(n,o){var i=new m(t,r);r=r||{};var s=new XMLHttpRequest;s.onload=function(){if(0===s.status)return new g(null,{status:s.status});var t={status:s.status,statusText:s.statusText,headers:b(s.getAllResponseHeaders()||"")};t.url="responseURL"in s?s.responseURL:t.headers.get("X-Request-URL");var e="response"in s?s.response:s.responseText;n(new g(e,t))};s.onerror=function(){o(new TypeError("Network request failed"))};s.ontimeout=function(){o(new TypeError("Network request failed"))};s.open(i.method,i.url,!r.sync);"include"===i.credentials?s.withCredentials=!0:"omit"===i.credentials&&(s.withCredentials=!1);!r.sync&&"responseType"in s&&e.blob&&(s.responseType="blob");i.headers.forEach(function(t,e){s.setRequestHeader(e,t)});s.send(void 0===i._bodyInit?null:i._bodyInit)})};t.fetch.polyfill=!0}function a(t){"string"!=typeof t&&(t=String(t));if(/[^a-z0-9\-#$%&'*+.\^_`|~]/i.test(t))throw new TypeError("Invalid character in header field name");return t.toLowerCase()}function c(t){"string"!=typeof t&&(t=String(t));return t}function u(t){var r={next:function(){var e=t.shift();return{done:void 0===e,value:e}}};e.iterable&&(r[Symbol.iterator]=function(){return r});return r}function f(t){this.map={};t instanceof f?t.forEach(function(t,e){this.append(e,t)},this):Array.isArray(t)?t.forEach(function(t){this.append(t[0],t[1])},this):t&&Object.getOwnPropertyNames(t).forEach(function(e){this.append(e,t[e])},this)}function h(t){if(t.bodyUsed)return Promise.reject(new TypeError("Already read"));t.bodyUsed=!0}function l(t){return new Promise(function(e,r){t.onload=function(){e(t.result)};t.onerror=function(){r(t.error)}})}function p(t){var e=new FileReader,r=l(e);e.readAsArrayBuffer(t);return r}function d(t){if(t.slice)return t.slice(0);var e=new Uint8Array(t.byteLength);e.set(new Uint8Array(t));return e.buffer}function y(){this.bodyUsed=!1;this._initBody=function(t){this._bodyInit=t;if(t)if("string"==typeof t)this._bodyText=t;else if(e.blob&&Blob.prototype.isPrototypeOf(t))this._bodyBlob=t;else if(e.formData&&FormData.prototype.isPrototypeOf(t))this._bodyFormData=t;else if(e.searchParams&&URLSearchParams.prototype.isPrototypeOf(t))this._bodyText=t.toString();else if(e.arrayBuffer&&e.blob&&n(t)){this._bodyArrayBuffer=d(t.buffer);this._bodyInit=new Blob([this._bodyArrayBuffer])}else{if(!e.arrayBuffer||!ArrayBuffer.prototype.isPrototypeOf(t)&&!o(t))throw new Error("unsupported BodyInit type");this._bodyArrayBuffer=d(t)}else this._bodyText="";this.headers.get("content-type")||("string"==typeof t?this.headers.set("content-type","text/plain;charset=UTF-8"):this._bodyBlob&&this._bodyBlob.type?this.headers.set("content-type",this._bodyBlob.type):e.searchParams&&URLSearchParams.prototype.isPrototypeOf(t)&&this.headers.set("content-type","application/x-www-form-urlencoded;charset=UTF-8"))};if(e.blob){this.blob=function(){var t=h(this);if(t)return t;if(this._bodyBlob)return Promise.resolve(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(new Blob([this._bodyArrayBuffer]));if(this._bodyFormData)throw new Error("could not read FormData body as blob");return Promise.resolve(new Blob([this._bodyText]))};this.arrayBuffer=function(){return this._bodyArrayBuffer?h(this)||Promise.resolve(this._bodyArrayBuffer):this.blob().then(p)}}this.text=function(){var t=h(this);if(t)return t;if(this._bodyBlob)return function(t){var e=new FileReader,r=l(e);e.readAsText(t);return r}(this._bodyBlob);if(this._bodyArrayBuffer)return Promise.resolve(function(t){for(var e=new Uint8Array(t),r=new Array(e.length),n=0;n<e.length;n++)r[n]=String.fromCharCode(e[n]);return r.join("")}(this._bodyArrayBuffer));if(this._bodyFormData)throw new Error("could not read FormData body as text");return Promise.resolve(this._bodyText)};e.formData&&(this.formData=function(){return this.text().then(T)});this.json=function(){return this.text().then(JSON.parse)};return this}function m(t,e){var r,n,o=(e=e||{}).body;if(t instanceof m){if(t.bodyUsed)throw new TypeError("Already read");this.url=t.url;this.credentials=t.credentials;e.headers||(this.headers=new f(t.headers));this.method=t.method;this.mode=t.mode;if(!o&&null!=t._bodyInit){o=t._bodyInit;t.bodyUsed=!0}}else this.url=String(t);this.credentials=e.credentials||this.credentials||"omit";!e.headers&&this.headers||(this.headers=new f(e.headers));this.method=(r=e.method||this.method||"GET",n=r.toUpperCase(),i.indexOf(n)>-1?n:r);this.mode=e.mode||this.mode||null;this.referrer=null;if(("GET"===this.method||"HEAD"===this.method)&&o)throw new TypeError("Body not allowed for GET or HEAD requests");this._initBody(o)}function T(t){var e=new FormData;t.trim().split("&").forEach(function(t){if(t){var r=t.split("="),n=r.shift().replace(/\+/g," "),o=r.join("=").replace(/\+/g," ");e.append(decodeURIComponent(n),decodeURIComponent(o))}});return e}function b(t){var e=new f;t.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach(function(t){var r=t.split(":"),n=r.shift().trim();if(n){var o=r.join(":").trim();e.append(n,o)}});return e}function g(t,e){e||(e={});this.type="default";this.status=void 0===e.status?200:e.status;this.ok=this.status>=200&&this.status<300;this.statusText="statusText"in e?e.statusText:"OK";this.headers=new f(e.headers);this.url=e.url||"";this._initBody(t)}}("undefined"!=typeof self?self:this);var t=function(t){var e=document.createElement("a");e.href=t;if(!e.origin){if(!e.protocol||!e.hostname){var r=/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/.exec(e.href);e.protocol=r[1];if(r[4].indexOf(":")>-1){var n=r[4].split(":");e.hostname=n[0];e.port=n[1]}else e.hostname=r[4]}e.origin=(0===e.protocol.length?window.location.protocol:e.protocol)+"//"+e.hostname+(e.port&&t.indexOf(e.port)>-1?":"+e.port:"")}return e};var e=TC.tool.Proxification.prototype;e.cacheHost=new function(){var e=function(e){var r=t(e);return r?r.origin:null};this._hosts=[];this._hostsImage=[];this.is=function(t,r){var n=e(t);return null!==this.get(n,r)};this.get=function(t,e){if(0===this.getList(e).length)return null;var r=this.getList(e).filter(function(r){return r.key===t&&e.exportable==r.exportable});return 0===r.length?null:r[0]};this.getList=function(t){return t.forImage?this._hostsImage:this._hosts};this.addKey=function(t,r){var n={key:e(t),action:null};r.exportable&&(n.exportable=r.exportable);this.getList(r).push(n);return this.getList(r)[this.getList(r).length-1]};this.removeKey=function(t,r){for(var n=e(t),o=0;o<this.getList(r).length;o++)if(this.getList(r)[o].key===n&&r.exportable==this.getList(r)[o].exportable){this.getList(r).splice(o,1);break}};this.getAction=function(t,r){r=r||{};var n=e(t),o=this.get(n,r);return o?o._actionPromise:Promise.reject(new Error("Cache null"))}};e._isServiceWorker=function(){if(navigator.serviceWorker){if(navigator.serviceWorker.controller&&"activated"===navigator.serviceWorker.controller.state)return!0;navigator.serviceWorker.ready.then(function(t){return!!t.active});return!1}return!1};e._isSameOrigin=function(t){var e=0!==t.indexOf("http")&&0!==t.indexOf("//"),r=!e&&t.match(this.Consts.url.SPLIT_REGEX);if(r){var n=r[1];e=(n==this._location.protocol||null==n)&&r[3]==this._location.hostname;var o=r[4],i=this._location.port;(80!=o&&""!==o||"80"!=i&&""!==i)&&(e=e&&o==i)}return e};e._isSameProtocol=function(t){var e=/^(https?:\/\/)/i,r=t.match(e);if(r&&r.length>1){var n=self._location.match(e);if(n&&n.length>1)return r[0].trim()===n[0].trim()}return!1};e._isSecureURL=function(t){return!/^(f|ht)tps?:\/\//i.test(t)||/^(f|ht)tps:\/\//i.test(t)};const r=function(t,e,r){this.status=t;this.text=e;this.url=r};var n=function(e,r){var n=t(e);return e.replace(n.protocol,r)},o=function(t){return n(t,"https:")},i=function(t){return n(t,"http:")},s=function(t,e,r,n){var s=this;t=o(t);s._image.getImgTag(t,e).then(function(t){r(t,s._actionHTTPS)},function(o){o===s._image.ErrorType.PROTOCOL?n(o):a.call(s,i(t),e,r,n)})},a=function(t,e,r,n){var o=this;e.sameOrigin=o._isSameOrigin(o._actionProxy.call(o,t));o._image.getImgTagByAction(t,e,o._actionProxy.bind(o)).then(function(t){r(t,o._actionProxy)},function(t){n(t)})};e._actionDirect=function(t){return t};e._actionHTTP=function(t){return n(t,"http:")};e._actionHTTPS=function(t){return n(t,"https:")};e._actionProxy=function(t){return this.proxy(t)};e._image={ErrorType:{CORS:"cors",PROTOCOL:"protocol",NOTFOUNDED:"notfounded",UNEXPECTED:"unexpected"},checkHttpStatus:function(t){const e=this;return fetch(t,{credentials:"omit"}).then(function(t){return{status:t.status,statusText:t.statusText}}).catch(function(t){return e.ErrorType.UNEXPECTED})},getImgTag:function(t,r){return new Promise(function(e,n){var o=this,i=document.createElement("img");if(r.exportable&&!r.sameOrigin){i.dataset.checkCORSHeaders=!0;i.crossOrigin="anonymous"}i.onload=function(){console.log("Load OK: "+i.src);i.onload=i.onerror=void 0;if(r.exportable&&!r.sameOrigin){try{var t=function(t){var e=document.createElement("CANVAS"),r=e.getContext("2d");e.height=t.height;e.width=t.width;r.drawImage(t,0,0);return e}(i);result=t.toDataURL("image/png");e(i)}catch(t){18===t.code?n(o.ErrorType.CORS):e(i)}}else e(i)};i.onerror=function(e){console.log("Load crossOrigin ERROR: "+i.src);if(i.dataset.checkCORSHeaders){i.crossOrigin=null;i.onerror=void 0;i.onerror=function(t){console.log("Load ERROR: "+i.src);o.checkHttpStatus(i.src).then(function(t){r.ignoreProxification?n(o.ErrorType.PROTOCOL):400===t.status?n(o.ErrorType.PROTOCOL):n(t)}).catch(n);i.onload=i.onerror=void 0};i.src=t}else{console.log("Load ERROR: "+i.src);i.onload=i.onerror=void 0;o.checkHttpStatus(i.src).then(function(t){r.ignoreProxification?n(o.ErrorType.PROTOCOL):400===t.status?n(o.ErrorType.PROTOCOL):n(t)}).catch(n)}};try{i.src=t}catch(t){console.log("Load ERROR: "+i.src);n(o.ErrorType.UNEXPECTED)}}.bind(e._image))},getImgTagByAction:function(t,r,n){return new Promise(function(e,o){var i=this,s=document.createElement("img");r.sameOrigin||r.exportable&&(s.crossOrigin="anonymous");s.onload=function(){s.onload=s.onerror=void 0;e(s)};s.onerror=function(t){console.log("Load ERROR: "+s.src);s.onload=s.onerror=void 0;i.checkHttpStatus(s.src).then(function(t){r.ignoreProxification?o(i.ErrorType.PROTOCOL):400===t.status?o(i.ErrorType.PROTOCOL):o(t)}).catch(o)};s.src=n(t)}.bind(e._image))}};e._fetch={Headers:{CONTENTTYPE:"content-type"},ErrorType:{CORS:"cors",NOTFOUNDED:"Not_Founded",UNEXPECTED:"Un_Expected",UNEXPECTEDCONTENTTYPE:"Un_Expected_ContentType"},validateResponse:function(t){if(!t.ok)throw new r(t.status,t.statusText,t.url);return t},validateContentType:function(t,e){const r=this;if(!t)return e;var n=e.headers.get(r._fetch.Headers.CONTENTTYPE);if(n&&-1===n.indexOf(t))throw Error(r._fetch.ErrorType.UNEXPECTEDCONTENTTYPE);return e}};e.fetchImage=function(t,e){var r=this;(e=e||{}).forImage=!0;return new Promise(function(n,c){if(r.cacheHost.is(t,e))r.cacheHost.getAction(t,e).then(function(o){e.sameOrigin=r._isSameOrigin(o.action(t));r._image.getImgTagByAction(t,e,o.action).then(function(t){n(t)},function(t){c(t)})});else{var u=r.cacheHost.addKey(t,e);u._actionPromise=new Promise(function(f,h){const l=function(t,o){u.action=o.bind(r);u.exportable=e.exportable;f({action:u.action});n(t)},p=function(n){if(200==n.status){r.cacheHost.removeKey(t,e);c(n)}else{r.cacheHost.removeKey(t,e);c(n)}};!function(e){if(r._isSameOrigin(t)){e.sameOrigin=!0;r._image.getImgTag(t,e).then(function(t){l(t,r._actionDirect)},p)}else r._isSecureURL(t)?r._image.getImgTag(t,e).then(function(t){l(t,r._actionDirect)},function(n){e.exportable&&n===r._image.ErrorType.CORS||r._isServiceWorker()||r._isSecureURL(r._location)&&r.preventMixedContent?n===r._image.ErrorType.PROTOCOL&&e.ignoreProxification?p(n):a.call(r,t,e,l,p):function(t,e,r,n){var s=this;t=i(t);s._image.getImgTag(t,e).then(function(t){r(t,s._actionHTTP)},function(i){i===s._image.ErrorType.PROTOCOL?n(i):a.call(s,o(t),e,r,n)})}.call(r,t,e,l,p)}):r._isServiceWorker()||r._isSecureURL(r._location)&&r.preventMixedContent?s.call(r,t,e,l,p):r._image.getImgTag(t,e).then(function(t){l(t,r._actionDirect)},function(n){e.exportable&&n===r._image.ErrorType.CORS||!r._isSecureURL(r._location)?n===r._image.ErrorType.PROTOCOL&&e.ignoreProxification?p(n):a.call(r,t,e,l,p):s.call(r,t,e,l,p)})}(e)})}})};e.fetchRetry=function(t,e,r){const n=this;var o=fetch;e.sync&&(o=n.fetchSync);return o(t,e).catch(function(o){if(1===r)throw o;return n.fetchRetry(t,e,r-1)})};e.fetchSync=function(t,e){var r=this;return new Promise(function(n,o){"Symbol"in r&&Symbol;var i="FileReader"in r&&"Blob"in r&&function(){try{new Blob;return!0}catch(t){return!1}}();if("ArrayBuffer"in r){var s=["[object Int8Array]","[object Uint8Array]","[object Uint8ClampedArray]","[object Int16Array]","[object Uint16Array]","[object Int32Array]","[object Uint32Array]","[object Float32Array]","[object Float64Array]"];ArrayBuffer.isView}function a(t){var e=new Headers;t.replace(/\r?\n[\t ]+/g," ").split(/\r?\n/).forEach(function(t){var r=t.split(":"),n=r.shift().trim();if(n){var o=r.join(":").trim();e.append(n,o)}});return e}var c=new Request(t,e),u=new XMLHttpRequest;u.onload=function(){var t={status:u.status,statusText:u.statusText,headers:a(u.getAllResponseHeaders()||"")};t.url="responseURL"in u?u.responseURL:t.headers.get("X-Request-URL");var e="response"in u?u.response:u.responseText;n(new Response(e,t))};u.onerror=function(){o(new TypeError("Network request failed"))};u.ontimeout=function(){o(new TypeError("Network request failed"))};u.open(c.method,c.url,!1);"include"===c.credentials?u.withCredentials=!e.sync:"omit"===c.credentials&&(u.withCredentials=!1);!e.sync&&"responseType"in u&&i&&(u.responseType="blob");c.headers.forEach(function(t,e){u.setRequestHeader(e,t)});u.send(void 0===c._bodyInit?null:c._bodyInit)})};e.fetchXML=function(t,e){(e=e||{}).responseType="xml";return this.fetch(t,e)};e.fetchJSON=function(t,e){(e=e||{}).responseType=TC.Consts.mimeType.JSON;return this.fetch(t,e)};e.fetchBlob=function(t,e){(e=e||{}).responseType="blob";return this.fetch(t,e)};e.fetchImageAsBlob=function(t,e){(e=e||{}).responseType="image";return this.fetch(t,e)};e.fetch=function(e,r){const n=this;if((r=r||{}).type){r.method=r.type;delete r.type}if(r.data){r.body=r.data;delete r.data}if(r.contentType){r.headers=new Headers;r.headers.append("Content-Type",r.contentType);delete r.contentType}r.responseType||(r.responseType="");var o=function(t,e,r,i){return(e.retryAttempts?n.fetchRetry(r[0].call(n,t),e,e.retryAttempts):fetch(r[0].call(n,t),e)).then(n._fetch.validateResponse).then(n._fetch.validateContentType.bind(n,e.responseType)).then(function(t){i&&(i.action=r[0].bind(n));const o=t.headers.get(n._fetch.Headers.CONTENTTYPE),s=function(e){return t.blob().then(function(t){const r=new FileReader;return new Promise(function(n,o){r.addEventListener("error",function(){r.abort();o(new DOMException("Problem decoding"))});r.addEventListener("loadend",function(){n(r.result)});r.readAsText(t,e)})})};switch(!0){case e.responseType.indexOf("xml")>-1:case e.responseType.indexOf("text/xml")>-1:case e.responseType.indexOf(TC.Consts.mimeType.XML)>-1:return(a=/charset=([^;]*)/i.exec(o))&&2===a.length&&"UTF-8"!==a[1]?s(a[1]).then(function(t){return(new window.DOMParser).parseFromString(t,"text/xml")}):t.text().then(function(t){return(new window.DOMParser).parseFromString(t,"text/xml")});case e.responseType.indexOf("arraybuffer")>-1:return t.arrayBuffer();case e.responseType.indexOf("image")>-1:case e.responseType.indexOf("blob")>-1:return t.blob().then(function(t){return new Blob([t],{type:o})});case e.responseType.indexOf("document")>-1:throw new DeveloperError("Unhandled responseType: "+e.responseType);case e.responseType.indexOf(TC.Consts.mimeType.JSON)>-1:return t.json();case""==e.responseType:case e.responseType.indexOf("text")>-1:default:var a;return(a=/charset=([^;]*)/i.exec(o))&&2===a.length&&"UTF-8"!==a[1]?s(a[1]).then(function(t){return""==e.responseType?{responseText:t,contentType:o}:t}):t.text().then(function(t){return""==e.responseType?{responseText:t,contentType:o}:t})}}).catch(function(n){if(1===r.length){console.log("request failed",n);return Promise.reject(n)}r.shift();return o(t,e,r,i)})};if(n.cacheHost.is(e,r))return new Promise(function(t,i){n.cacheHost.getAction(e,r).then(function(n){t(o(e,r,[n.action]))}).catch(function(o){o.status>400?i(new Error(o.text)):t(n.fetch(e,r))})});var i=n.cacheHost.addKey(e,r);return new Promise(function(s,a){i._actionPromise=new Promise(function(c,u){e=t(e).href;const f=function(t){c({action:i.action});s(t)},h=function(t){n.cacheHost.removeKey(e,r);u(t);a(new Error(t.text))};n._isSameOrigin(e)?o(e,r,[n._actionDirect,n._actionProxy],i).then(f).catch(h):n._isSecureURL(e)?n._isServiceWorker()?o(e,r,[n._actionDirect,n._actionProxy],i).then(f).catch(h):o(e,r,[n._actionDirect,n._actionHTTP,n._actionProxy],i).then(f).catch(h):n._isServiceWorker()?o(e,r,[n._actionHTTPS,n._actionProxy],i).then(f).catch(h):o(e,r,n._isSecureURL(n._location)?[n._actionHTTPS,n._actionProxy]:[n._actionDirect,n._actionHTTPS,n._actionProxy],i).then(f).catch(h)});i._actionPromise.catch(function(t){t.status>400?a(new Error(t.text)):s(n.fetch(e,r))})})}}();
//# sourceMappingURL=../maps/tool/Proxification.min.js.map