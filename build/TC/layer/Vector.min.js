TC.layer=TC.layer||{},TC.Layer||TC.syncLoadJS(TC.apiLocation+"TC/Layer.js"),TC.layer.Vector=function(){var e=this;TC.Layer.apply(e,arguments),e.type=e.options.type||TC.Consts.layerType.VECTOR,e.features=[],e.selectedFeatures=[];var t=function(e){var t=e.indexOf("?");return t>=0?e=e.substr(0,t):(t=e.indexOf("#"),t>=0&&(e=e.substr(0,t))),".kml"===e.substr(e.length-4).toLowerCase()};if(e.url&&(t(e.url)||e.type===TC.Consts.layerType.KML)){e.type=TC.Consts.layerType.KML;var r=function(e){for(var t=e,r=new RegExp("([^/]+.kml)","i"),n=0;3>n;n++){e=decodeURIComponent(e);var i=r.exec(e);if(i.length>1){t=i[1];break}}return t};e.title=e.options.title||r(e.url)}e.wrap=new TC.wrap.layer.Vector(e);var n=e.wrap.createVectorLayer();e.wrap.setLayer(n)},TC.inherit(TC.layer.Vector,TC.Layer),function(){var e=TC.layer.Vector.prototype;e.getTree=function(){var e=this,t=null;if(!e.options.stealth){t={},t.children=[];for(var r=0;r<e.features.length;r++){var n=e.features[r].getPath();if(n.length){var i=TC.Util.addArrayToTree(n,t);i&&(i.legend=e.features[r].getLegend())}}t.name=e.name||t.name,t.title=e.title||t.title,t.uid=e.id}return t};var t=function(e,t,r,n){var i=new $.Deferred;return $.when(t.call(e,[r],n)).then(function(t){i.resolve(t[0]),e.map.$events.trigger($.Event(TC.Consts.event.FEATUREADD,{layer:e,feature:t[0]}))}),i},r=function(e,t,r,n,i){var a=new $.Deferred,s=e.options.styles&&e.options.styles[n]||TC.Cfg.styles[n],o=$.extend(!0,{},s,i);return TC.loadJS(!TC.feature||TC.feature&&!TC.feature[r],[TC.apiLocation+"TC/feature/"+r+".js"],function(){for(var n=TC.feature[r],i=new Array(t.length),s=[],l=0,u=t.length;u>l;l++){var f,d=t[l];d instanceof n?(f=d,f.layer=e):(o.layer=e,f=new n(d,o)),i[l]=f,e.features[e.features.length]=f,f.wrap.isNative(d)||(s[s.length]=f.wrap.feature),f.options.showPopup&&f.showPopup()}s.length&&e.wrap.addFeatures(s),a.resolve(i)}),a};e.addPoint=function(e,r){return t(this,this.addPoints,e,r)},e.addPoints=function(e,t){return r(this,e,"Point",TC.Consts.geom.POINT,t)},e.addMarker=function(e,r){return t(this,this.addMarkers,e,r)},e.addMarkers=function(e,t){return r(this,e,"Marker","marker",t)},e.addPolyline=function(e,r){return t(this,this.addPolylines,e,r)},e.addPolylines=function(e,t){return r(this,e,"Polyline",TC.Consts.geom.POLYLINE,t)},e.addMultiPolyline=function(e,r){return t(this,this.addMultiPolylines,e,r)},e.addMultiPolylines=function(e,t){return r(this,e,"MultiPolyline",TC.Consts.geom.POLYLINE,t)},e.addPolygon=function(e,r){return t(this,this.addPolygons,e,r)},e.addPolygons=function(e,t){return r(this,e,"Polygon",TC.Consts.geom.POLYGON,t)},e.addMultiPolygon=function(e,r){return t(this,this.addMultiPolygons,e,r)},e.addMultiPolygons=function(e,t){return r(this,e,"MultiPolygon",TC.Consts.geom.POLYGON,t)},e.addCircle=function(e,r){return t(this,this.addCircles,e,r)},e.addCircles=function(e,t){return r(this,e,"Circle",TC.Consts.geom.POLYGON,t)},e.addFeature=function(e){var t,r=this;return TC.feature&&(TC.feature.Point&&e instanceof TC.feature.Point?t=r.addPoint(e):TC.feature.Polyline&&e instanceof TC.feature.Polyline?t=r.addPolyline(e):TC.feature.Polygon&&e instanceof TC.feature.Polygon?t=r.addPolygon(e):TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon?t=r.addMultiPolygon(e):TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline?t=r.addMultiPolyline(e):TC.feature.Circle&&e instanceof TC.feature.Circle&&(t=r.addCircle(e))),t},e.removeFeature=function(e){this.wrap.removeFeature(e)},e.getFeatureById=function(e){var t=null,r=this.wrap.getFeatureById(e);return r&&(t=r._wrap.parent),t},e.clearFeatures=function(){var e=this;e.features&&e.wrap&&(e.features.length=0,e.wrap.clearFeatures())},e.describeFeatureType=function(e,t){var r=this,n=$.Deferred();return $.ajax({url:r.wrap.getDescribeFeatureTypeUrl(),type:"GET",dataType:"xml"}).then(function(e){var t="http://www.w3.org/2001/XMLSchema",r=e.getElementsByTagNameNS(t,"complexType")[0];if(r){for(var i=r.getElementsByTagNameNS(t,"element"),a=new Array(i.length),s=0,o=i.length;o>s;s++){var l=i[s];a[s]={name:l.getAttribute("name"),type:l.getAttribute("type"),nillable:"true"===l.getAttribute("nillable")?!0:!1,minOccurs:parseInt(l.getAttribute("minOccurs")),maxOccurs:parseInt(l.getAttribute("maxOccurs"))}}n.resolve(a)}else{var u=e.getElementsByTagName("Exception")[0];u&&n.reject(u.getElementsByTagName("ExceptionText")[0].innerHTML)}},function(e,t,r){n.reject(r)}),n.then(function(t){$.isFunction(e)&&e(t)},function(e){$.isFunction(t)&&t(e)}),n.promise()},e["import"]=function(e){this.wrap["import"](e)},e.setNodeVisibility=function(e,t){var r=this;r.state=TC.Layer.state.LOADING,r.map.$events.trigger($.Event(TC.Consts.event.BEFOREUPDATE)),r.map.$events.trigger($.Event(TC.Consts.event.BEFORELAYERUPDATE,{layer:r})),r.tree||(r.tree=r.getTree());var n=r.findNode(e,r.tree);if(n===r.tree)r.setVisibility(t);else{var i=r._cache.visibilityStates;i[e]=t?TC.Consts.visibility.VISIBLE:TC.Consts.visibility.NOT_VISIBLE;var a,s,o=!1;for(a=0;a<r.features.length;a++)if(s=r.features[a],s.id==e){o=!0,s.setVisibility(t);break}if(!o)for(a=0;a<r.features.length;a++)s=r.features[a],void 0===s._path&&(s._path="/"+s.getPath().join("/")),s._path===e&&s.setVisibility(t)}r.state=TC.Layer.state.IDLE,r.map.$events.trigger($.Event(TC.Consts.event.LAYERUPDATE,{layer:r})),r.map.$events.trigger($.Event(TC.Consts.event.UPDATE))},e.getNodeVisibility=function(e){var t=this,r=TC.Layer.prototype.getNodeVisibility.call(t,e);t.tree||(t.tree=t.getTree());var n=t.findNode(e,t.tree);if(n===t.tree)r=t.getVisibility()?TC.Consts.visibility.VISIBLE:TC.Consts.visibility.NOT_VISIBLE;else{var i=t._cache.visibilityStates,a=i[e];void 0!==a&&(r=a)}return r},e.setModifiable=function(e){this.wrap.setModifiable(e)},e.applyEdits=function(e,t,r){return this.wrap.sendTransaction(e,t,r)},e.refresh=function(){return this.wrap.reloadSource()}}();