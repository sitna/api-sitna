TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control.js"),function(){TC.Consts.url.GOOGLEMAPS="//maps.googleapis.com/maps/api/js?v=3";var e=TC.Consts.url.GOOGLEMAPS;TC.Cfg.proxyExceptions=TC.Cfg.proxyExceptions||[],TC.Cfg.proxyExceptions.push(TC.Consts.url.GOOGLEMAPS),TC.control.StreetView=function(){var t=this;this._templatePromise=$.Deferred(),t._sv=null,t._mapActiveControl=null,TC.Control.apply(t,arguments),t.options.googleMapsKey&&(e+="&key="+t.options.googleMapsKey),t.viewDiv=null,t._$viewDiv=null,t._startLonLat=null},TC.inherit(TC.control.StreetView,TC.Control);var t=TC.control.StreetView.prototype;t.CLASS="tc-ctl-sv",t.template={},TC.isDebug?(t.template[t.CLASS]=TC.apiLocation+"TC/templates/StreetView.html",t.template[t.CLASS+"-view"]=TC.apiLocation+"TC/templates/StreetViewView.html"):(t.template[t.CLASS]=function(){function e(e,t){return e.w('<div class="tc-ctl-sv-btn" title="').h("i18n",t,{},{$key:"sv.tip"}).w('"><div class="tc-ctl-sv-drag"></div></div>')}return dust.register(t.CLASS,e),e.__dustBody=!0,e},t.template[t.CLASS+"-view"]=function(){function e(e,t){return e.w('<div class="tc-ctl-sv-btn-close" title="').h("i18n",t,{},{$key:"closeStreetView"}).w('"></div>')}return dust.register(t.CLASS+"-view",e),e.__dustBody=!0,e});var s=function(e){e._$div.find("."+e.CLASS+"-btn").addClass(TC.Consts.classes.CHECKED),$(e.map.div).addClass(e.CLASS+"-active")},o=function(e){e.layer.clearFeatures(),e._$div.find("."+e.CLASS+"-btn").removeClass(TC.Consts.classes.CHECKED),e._$div.find("."+e.CLASS+"-drag").removeClass(TC.Consts.classes.HIDDEN),$(e.map.div).removeClass(e.CLASS+"-active"),e._startLonLat=null},a=function(e){var t=!1,s=e._$div.find("."+e.CLASS+"-btn"),a=e._$div.find("."+e.CLASS+"-drag"),r=s[0].getBoundingClientRect(),n=a[0].getBoundingClientRect();if(a.addClass(TC.Consts.classes.HIDDEN),n.top<r.top||n.top>r.bottom||n.left<r.left||n.left>r.right){t=!0;for(var i=e.map.getExtent(),l=[i[2],i[3]],C=(new Array(16),0);16>C;C++)e.layer.addMarker(l,{cssClass:"tc-marker-sv-"+C,width:48,height:48,anchor:[0,1]});var v=e.map.div.getBoundingClientRect(),c=(n.left+n.right)/2-v.left,p=n.bottom-v.top,d=e.map.wrap.getCoordinateFromPixel([c,p]);e.callback(d)}else o(e);return t};t.register=function(e){var t=this;t._$viewDiv||(t.viewDiv=TC.Util.getDiv(t.options.viewDiv),t._$viewDiv=$(t.viewDiv).addClass(t.CLASS+"-view "+TC.Consts.classes.HIDDEN),t.options.viewDiv||t._$viewDiv.insertBefore(e.div)),TC.Control.prototype.register.call(t,e),t.layer=null;for(var r=t.CLASS+"-layer",n=0;n<e.workLayers.length;n++){var i=e.workLayers[n];if(i.type===TC.Consts.layerType.VECTOR&&i.id===r){t.layer=i;break}}t.layer||e.loaded(function(){$.when(e.addLayer({id:r,stealth:!0,type:TC.Consts.layerType.VECTOR})).then(function(e){t.layer=e})}),t._templatePromise.then(function(){TC.loadJS(!$.fn.drag,[TC.apiLocation+"lib/jquery/jquery.event.drag.js",TC.apiLocation+"lib/jquery/jquery.event.drop.js"],function(){var e=t._$div.find("."+t.CLASS+"-drag");e.drag(function(t,s){e.css({transform:"translate("+s.deltaX+"px, "+s.deltaY+"px)"})}).drag("start",function(e,o){s(t),e.preventDefault(),e.stopPropagation()}).drag("end",function(s,o){a(t),e.css({transform:"none"})})});var e=t._$viewDiv;e.find("."+t.CLASS+"-btn-close").on("mouseup",function(s){$(t.map.div).removeClass(TC.Consts.classes.COLLAPSED).trigger("resize"),e.addClass(TC.Consts.classes.HIDDEN).removeClass(TC.Consts.classes.VISIBLE),t._$div.find("."+t.CLASS+"-drag").removeClass(TC.Consts.classes.HIDDEN),t.layer.wrap.setDraggable(!1),o(t),t._sv.setVisible(!1),s.stopPropagation(),t._previousActiveControl&&t._previousActiveControl.activate()})},function(e,t,s){TC.error("Error de renderizado Streetview")})},t.render=function(){var e=this;TC.Control.prototype.render.call(e,function(){dust.cache[e.CLASS+"-view"]?dust.render(e.CLASS+"-view",null,function(t,s){setTimeout(function(){e._$viewDiv.html(s),t&&TC.error(t),e._templatePromise.resolve()},300)}):TC.error("No hay dust.cache para StreetView")})};var r=0;t.callback=function(t){var s=this,a="EPSG:4326",n=function(e){if(s._sv){var t=e.getBounds();lonLat=TC.Util.reproject([(t[0]+t[2])/2,(t[1]+t[3])/2],s.map.crs,a),s._sv.setPosition({lng:lonLat[0],lat:lonLat[1]})}},i=function(e){if(s._sv){var t=e.getBounds();s._startLonLat=[(t[0]+t[2])/2,(t[1]+t[3])/2]}},l=s.map.getLoadingIndicator();l&&(r=l.addWait(r));var C=$(s.map.div),v=function(e,o){s.layer.clearFeatures();var r,l;if(e){var v=e.getPosition();r=TC.Util.reproject([v.lng(),v.lat()],a,s.map.crs),l=e.getPov().heading}else r=t,l=0;if(s.map.addMarker(r,{cssClass:"tc-marker-sv-"+(Math.round(16*l/360)+16)%16,width:48,height:48,anchor:[.4791666666666667,.7083333333333333],layer:s.layer,showsPopup:!1}),$.when.apply(this,s.map._markerDeferreds).then(function(e){s.layer.wrap.setDraggable(!0,n,i)}),o){var c=function(){s.map.setCenter(r)};C.hasClass(TC.Consts.classes.COLLAPSED)?c():setTimeout(c,1200)}};TC.loadJS(!window.google||!google.maps,e,function(){if(window.google){v();var e=s._$viewDiv,n=TC.Util.reproject(t,s.map.crs,a),i=e.hasClass(TC.Consts.classes.VISIBLE),c="transitionend.tc";e.off(c).on(c,function(e){("width"===e.originalEvent.propertyName||"height"===e.originalEvent.propertyName)&&(i||(i=!0,google.maps.event.trigger(s._sv,"resize"),C.addClass(TC.Consts.classes.COLLAPSED).trigger("resize")))});var p={position:new google.maps.LatLng(n[1],n[0]),pov:{heading:0,pitch:0},zoom:1,zoomControlOptions:{position:google.maps.ControlPosition.LEFT_TOP},panControlOptions:{position:google.maps.ControlPosition.LEFT_TOP}};s._sv?s._sv.setOptions(p):(s._sv=new google.maps.StreetViewPanorama(e[0],p),google.maps.event.addListener(s._sv,"position_changed",function(){v(s._sv,e.hasClass(TC.Consts.classes.VISIBLE))}),google.maps.event.addListener(s._sv,"pov_changed",function(){if(s.layer.features&&s.layer.features.length>0){var e=s.layer.features[0];delete e.options.url,e.options.cssClass="tc-marker-sv-"+(Math.round(16*s._sv.getPov().heading/360)+16)%16,e.setStyle(e.options),s.layer.refresh()}}),google.maps.event.addListener(s._sv,"status_changed",function(){var t=s._sv.getStatus();l&&l.removeWait(r),t===google.maps.StreetViewStatus.OK?e.hasClass(TC.Consts.classes.VISIBLE)||(s._sv.setVisible(!0),v(s._sv,!0),s.map.activeControl&&(s._previousActiveControl=s.map.activeControl,s.map.activeControl.deactivate(!0)),setTimeout(function(){e.css("left","").css("top",""),e.removeClass(TC.Consts.classes.HIDDEN).addClass(TC.Consts.classes.VISIBLE)},200)):(TC.alert(s.getLocaleString(t===google.maps.StreetViewStatus.ZERO_RESULTS?"noStreetView":"streetViewUnknownError")),s._startLonLat?s.callback(s._startLonLat):(s.layer.wrap.setDraggable(!1),o(s)))})),v(s._sv)}else o(s)})}}();