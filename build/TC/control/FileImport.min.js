TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control.js"),TC.control.FileImport=function(){var t=this;TC.Control.apply(t,arguments),t.formats=$.isArray(t.options.formats)?t.options.formats:[TC.Consts.format.KML,TC.Consts.format.GML,TC.Consts.format.GML2,TC.Consts.format.GEOJSON,TC.Consts.format.WKT,TC.Consts.format.GPX],t.apiAttribution="",t.mainDataAttribution="",t.dataAttributions=[]},TC.inherit(TC.control.FileImport,TC.Control),function(){var t=TC.control.FileImport.prototype;t.CLASS="tc-ctl-file",t.template=TC.isDebug?TC.apiLocation+"TC/templates/FileImport.html":function(){function o(t,o){return t.w("<h2>").h("i18n",o,{},{$key:"openFile"}).w("</h2><div><p>").h("i18n",o,{},{$key:"fileImport.instructions"}).w('</p><div class="tc-ctl-file-open"><label class="tc-button tc-ctl-file-open-label tc-icon-button"><input type="file" class="tc-ctl-file-open-ipt tc-button" accept="').s(o.get(["formats"],!1),o,{block:e},{}).w('" />').h("i18n",o,{},{$key:"openFile"}).w("</label></div></div>")}function e(t,o){return t.w(".").f(o.getPath(!0,[]),o,"h").h("sep",o,{block:n},{})}function n(t,o){return t.w(",")}return dust.register(t.CLASS,o),o.__dustBody=!0,e.__dustBody=!0,n.__dustBody=!0,o},t.register=function(t){var o=this;TC.Control.prototype.register.call(o,t),o.options.enableDragAndDrop&&t.wrap.enableDragAndDrop(o.options),t.on(TC.Consts.event.FEATURESIMPORT,function(e){var n="."+TC.Consts.format.GPX.toLowerCase();e.fileName.toLowerCase().indexOf(n)!==e.fileName.length-n.length&&t.addLayer({id:TC.getUID(),title:e.fileName,type:TC.Consts.layerType.VECTOR}).then(function(n){for(var r="EPSG:4326",a=function(t){var e=t.geometry;if(e){var n=/^([-+]?\d{1,3}([.,]\d+)?)\,?\s*([-+]?\d{1,2}([.,]\d+)?)$/.exec(e.join(" "));n&&n.length>=3&&Math.abs(n[1])<=180&&Math.abs(n[3])<=90&&t.setCoords(TC.Util.reproject(e,r,o.map.crs))}return t},i=0,s=e.features.length;s>i;i++){var l=a(e.features[i]);n.addFeature(l)}setTimeout(function(){t.zoomToFeatures(n.features)},100)})}).on(TC.Consts.event.FEATURESIMPORTERROR,function(t){var e,n=t.file.name;e=".kmz"===n.toLowerCase().substr(n.length-4)?"fileImport.error.reasonKmz":"fileImport.error.reasonUnknown",TC.error(o.getLocaleString(e,{fileName:n}),TC.Consts.msgErrorMode.TOAST);var r=new FileReader;r.onload=function(t){TC.error("Error en la subida de un archivo: \n\n	 Nombre del archivo: "+n+" \n	 Contenido del archivo: \n\n"+t.target.result,TC.Consts.msgErrorMode.EMAIL)},r.readAsText(t.file)})},t.render=function(){var t=this;t.renderData({formats:t.formats},function(){t._$div.find("input[type=file]").on(TC.Consts.event.CLICK,function(t){$(this).wrap("<form>").closest("form").get(0).reset(),$(this).unwrap()}).on("change",function(o){t.map&&(console.log("salta el change"),t.map.wrap.loadFiles(o.target.files))})})}}();