TC.control=TC.control||{},TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control.js"),TC.Consts.event.POINT="point.tc",TC.control.Measure=function(){var e=this;TC.Control.apply(e,arguments),this.renderPromise().then(function(){e.measureMode=e.options.mode,e.history=[],e.historyIndex=0,e.reset=!0,e.wrap=new TC.wrap.control.Measure(e),e._$len=e._$div.find(".tc-ctl-meas-val-len"),e._$area=e._$div.find(".tc-ctl-meas-val-area"),e._$peri=e._$div.find(".tc-ctl-meas-val-peri"),e.setMode(e.options.mode)})},TC.inherit(TC.control.Measure,TC.Control),function(){var e=TC.control.Measure.prototype;e.CLASS="tc-ctl-meas",e.template=TC.isDebug?TC.apiLocation+"TC/templates/Measure.html":function(){function t(e,t){return e.w("<h2>").h("i18n",t,{},{$key:"measure"}).w('</h2><div class="tc-ctl-meas-select"><form><label class="tc-ctl-meas-btn-len"><input type="radio" name="mode" value="polyline" /><span>').h("i18n",t,{},{$key:"length"}).w('</span></label><label class="tc-ctl-meas-btn-area"><input type="radio" name="mode" value="polygon" /><span>').h("i18n",t,{},{$key:"areaAndPerimeter"}).w('</span></label></form></div><div class="tc-ctl-meas-len tc-hidden"><div class="tc-ctl-meas-lines"></div><div class="tc-ctl-meas-txt">').h("i18n",t,{},{$key:"length"}).w(': <span class="tc-ctl-meas-val-len"></span></div></div><div class="tc-ctl-meas-area tc-hidden"><div class="tc-ctl-meas-polygon"></div><div class="tc-ctl-meas-txt">').h("i18n",t,{},{$key:"area"}).w(': <span class="tc-ctl-meas-val-area"></span>, ').h("i18n",t,{},{$key:"perimeter"}).w(': <span class="tc-ctl-meas-val-peri"></span></div></div>')}return dust.register(e.CLASS,t),t.__dustBody=!0,t},e.render=function(e){var t=this;TC.Control.prototype.render.call(t,function(){TC.loadJS(!TC.control.Draw,TC.apiLocation+"TC/control/Draw.js",function(){t.options.mode&&t._$div.find(".tc-ctl-meas-select").addClass(TC.Consts.classes.HIDDEN),t._$div.find("span").on(TC.Consts.event.CLICK,function(e){var n=$(this).closest("label").find("input[type=radio][name=mode]"),s=n.val();n.prop("checked",!0),t.setMode(s,!0)}),$.isFunction(e)&&e()})})},e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e),t.renderPromise().then(function(){e.loaded(function(){t.layerPromise=e.addLayer({id:TC.getUID(),title:"Medici√≥n",stealth:!0,type:TC.Consts.layerType.VECTOR,styles:{point:$.extend({},e.options.styles.point,{fillOpacity:0}),line:e.options.styles.line,polygon:e.options.styles.polygon}}),$.when(t.layerPromise).then(function(n){t.layer=n,t.layer.map.putLayerOnTop(t.layer),TC.loadJS(!TC.control.Draw,TC.apiLocation+"TC/control/Draw.js",function(){t.drawLines=new TC.control.Draw({div:t._$div.find(".tc-ctl-meas-lines"),mode:TC.Consts.geom.POLYLINE,measure:!0,layer:t.layer}),t.drawPolygons=new TC.control.Draw({div:t._$div.find(".tc-ctl-meas-polygon"),mode:TC.Consts.geom.POLYGON,measure:!0,layer:t.layer}),$.when(e.addControl(t.drawLines),e.addControl(t.drawPolygons)).then(function(){var e=function(e){var n="m"===e.units?0:3;e.area?t._$area.html(e.area.toFixed(n).replace(".",",")+" "+e.units+"&sup2;"):0===e.area&&t.resetValues(),e.perimeter?t._$peri.html(e.perimeter.toFixed(n).replace(".",",")+" "+e.units):0===e.perimeter&&t.resetValues(),e.length?t._$len.html(e.length.toFixed(n).replace(".",",")+" "+e.units):0===e.length&&t.resetValues()};t.drawLines.$events.on(TC.Consts.event.MEASURE+" "+TC.Consts.event.MEASUREPARTIAL,function(t){e(t)}).on(TC.Consts.event.DRAWCANCEL,function(){t.cancel()}),t.drawPolygons.$events.on(TC.Consts.event.MEASURE+" "+TC.Consts.event.MEASUREPARTIAL,function(t){e(t)}).on(TC.Consts.event.DRAWCANCEL,function(){t.cancel()})}),t.setMode(t.options.mode)})})})})},e.activate=function(){var e=this;TC.Control.prototype.activate.call(e)},e.deactivate=function(){var e=this;TC.Control.prototype.deactivate.call(e)},e.setMode=function(e,t){var n=this;n.mode=e;var s,a,o;switch(e){case TC.Consts.geom.POLYLINE:n.drawLines.activate(),s=n._$div.find(".tc-ctl-meas-len"),a=n._$div.find(".tc-ctl-meas-area"),o=TC.Consts.event.CONTROLACTIVATE;break;case TC.Consts.geom.POLYGON:n.drawPolygons.activate(),s=n._$div.find(".tc-ctl-meas-area"),a=n._$div.find(".tc-ctl-meas-len"),o=TC.Consts.event.CONTROLACTIVATE;break;case null:case void 0:n.drawLines&&n.drawLines.isActive&&n.drawLines.cancel(),n.drawPolygons&&n.drawPolygons.isActive&&n.drawPolygons.cancel(),s=$(),a=n._$div.find(".tc-ctl-meas-area,.tc-ctl-meas-len"),o=TC.Consts.event.CONTROLDEACTIVATE;break;default:n.drawLines.activate(),s=n._$div.find(".tc-ctl-meas-area,.tc-ctl-meas-len"),a=$(),o=TC.Consts.event.CONTROLACTIVATE}n.resetValues();var l;e?(l=n._$div.find("input[type=radio][name=mode][value="+e+"]").prop("checked",!0).addClass(TC.Consts.classes.CHECKED),l.next().addClass(TC.Consts.classes.CHECKED)):(l=n._$div.find("input[type=radio][name=mode]").prop("checked",!1).removeClass(TC.Consts.classes.CHECKED),l.next().removeClass(TC.Consts.classes.CHECKED)),s.removeClass(TC.Consts.classes.HIDDEN),a.addClass(TC.Consts.classes.HIDDEN),o&&n.map&&n.map.$events.trigger($.Event(o,{control:n})),window.meas=n},e.cancel=function(){this.setMode(null,!1)},e.resetValues=function(){var e=this;e.NOMEASURE="-",e._$len&&(e._$len.text(e.NOMEASURE),e._$area.text(e.NOMEASURE),e._$peri.text(e.NOMEASURE))}}();