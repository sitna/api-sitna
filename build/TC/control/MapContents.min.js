TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.MapContents=function(){TC.Control.apply(this,arguments);this.layerTrees={}};TC.inherit(TC.control.MapContents,TC.Control);!function(){var e=TC.control.MapContents.prototype;e.CLASS="tc-ctl-mc";var t="tcLayer",r="tcImg";e.render=function(e){this.map&&this.renderData(this.map.getLayerTree(),e)};e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e);t.render(function(){for(var r=0,n=e.layers.length;r<n;r++)t.updateLayerTree(e.layers[r]);e.on(TC.Consts.event.ZOOM+" "+TC.Consts.event.PROJECTIONCHANGE,function(){t.updateScale()}).on(TC.Consts.event.UPDATEPARAMS,function(e){var r=e.layer.names;!function e(t){var n=!1;if(t)if($.inArray(t.name,r)>=0)n=!0;else for(var a=0;a<t.children.length;a++)if(e(t.children[a])){n=!0;break}return n}(t.layerTrees[e.layer.id])&&0!==r.length?t.updateLayerTree(e.layer):t.update()}).on(TC.Consts.event.LAYERVISIBILITY,function(e){t.updateLayerVisibility(e.layer)}).on(TC.Consts.event.LAYERADD,function(e){t.updateLayerTree(e.layer)}).on(TC.Consts.event.VECTORUPDATE+" "+TC.Consts.event.FEATUREADD+" "+TC.Consts.event.FEATURESADD,function(e){t._updateLayerTreeTimeout&&clearTimeout(t._updateLayerTreeTimeout);t._updateLayerTreeTimeout=setTimeout(function(){if(t.map.workLayers.indexOf(e.layer)>-1){t.updateLayerTree(e.layer);delete t._updateLayerTreeTimeout}},100)}).on(TC.Consts.event.LAYERREMOVE,function(e){t.removeLayer(e.layer)}).on(TC.Consts.event.LAYERORDER,function(e){t.updateLayerOrder(e.layer,e.oldIndex,e.newIndex)})})};e.updateScale=function(){};e.updateLayerVisibility=function(e){};e.updateLayerTree=function(e){this.layerTrees[e.id]=e.getTree()};e.updateLayerOrder=function(e,r,n){if(r>=0&&r!==n)for(var a,o,i=this.getLayerUIElements(),s=this.map.workLayers.length-1;s>=0;s--){var l=this.map.workLayers[s];o=a;i.each(function(e,r){var n=$(r);if(n.data(t)===l){a=n;return!1}});if(l===e){o?o.after(a):i.parent().prepend(a);break}}};e.removeLayer=function(e){this.update()};e.getLayerUIElements=function(){return this._$div.find("ul").first().children()};e.styleLegendImage=function(e,t){if(!e.attr("src")){var n=e.data(r);e.off("error.tc").on("error.tc",function(){var r=e.attr("src");if(-1===r.indexOf(t.url)){var n=/^(https?:\/\/)/i;n.test(r)&&n.test(t.url)&&(r=r.replace(r.match(n)[1],t.url.match(n)[1]))}e.off("error.tc");e.attr("src",t instanceof TC.layer.Raster?t.getByProxy_(r):TC.proxify(r))}.bind(t));if(t&&t.options.method&&"POST"===t.options.method)t.getLegendGraphicImage().done(function(r){e.attr("src",t.getLegendUrl(r))}).fail(function(e){TC.error(e)});else{if(/[&?]REQUEST=getLegendGraphic/i.test(n)){var a=e.parent(),o=a.css("color"),i=o.indexOf("("),s=o.indexOf(")");if(i>=0&&s>i){color=o.substr(0,s).substr(i+1).split(",");o="0x";for(var l=0;l<3;l++){var c=parseInt(color[l]).toString(16);o+=1===c.length?"0"+c:c}}else o.replace("#","0x");n+="&LEGEND_OPTIONS=fontName:"+a.css("font-family")+";fontSize:"+parseInt(a.css("font-size"))+";fontColor:"+o+";fontAntiAliasing:true";t.params&&t.params.sld_body&&(n=TC.Util.addURLParameters(n,{sld_body:t.params.sld_body}));e.data(r,t.getLegendUrl(n))}e.attr("src",t.getLegendUrl(n))}}}}();