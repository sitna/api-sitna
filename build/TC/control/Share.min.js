TC.control=TC.control||{};TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control");TC.control.Share=function(t){this._classSelector="."+this.CLASS;TC.Control.apply(this,arguments);var e=t||{};this._$dialogDiv=$(TC.Util.getDiv(e.dialogDiv));e.dialogDiv||this._$dialogDiv.appendTo("body");this.render()};TC.inherit(TC.control.Share,TC.Control);!function(){var t=TC.control.Share.prototype;t.CLASS="tc-ctl-share";t.QR_MAX_LENGTH=150;t.MAILTO_MAX_LENGTH=256;t.IFRAME_WIDTH="600px";t.IFRAME_HEIGHT="450px";t.MOBILEFAV="Siga las instrucciones del navegador del dispositivo m\xf3vil para a\xf1adir como favorito. Se guardar\xe1 el estado actual del mapa.";t.NAVALERT=" +D para guardar en marcadores.";t.render=function(t){var e=this;e.getRenderedHtml(e.CLASS+"-dialog",null,function(t){e._$dialogDiv.html(t)}).then(function(){TC.Control.prototype.render.call(e,function(){if(TC.Util.detectChrome()||TC.Util.detectIE()>=10||TC.Util.detectFirefox()>=41){e._$div.find("button").removeClass("hide");e._$div.find("input[type=text]").removeAttr("data-original-title")}TC.Util.detectMobile()||e._$div.find(".share-whatsapp").addClass(TC.Consts.classes.HIDDEN);var a=e._$div.find("."+e.CLASS+"-url-box");e._$div.find("span:not(.tc-beta)").on(TC.Consts.event.CLICK,function(t){var e=$(this).closest("label").find("input[type=radio][name=format]").val();a.removeClass(TC.Consts.classes.HIDDEN);a.not(".tc-"+e).addClass(TC.Consts.classes.HIDDEN)});$.isFunction(t)&&t()})})};t.getLocation=function(){var t=window.location.href;window.location.hash&&(t=t.substr(0,t.indexOf(window.location.hash)));return t};t.generateLink=function(){var t=window.location.href,e=t.indexOf("#");e>0&&(t=t.substring(0,e));if(this.extraParams){var a=TC.Util.getQueryStringParams(t);$.extend(a,this.extraParams);var o=t.indexOf("?");o>=0&&(t=t.substring(0,o));t=t.concat("?",$.param(a))}TC.Util.getParameterByName("lang").length>0&&(t=t.indexOf("&")>-1?t.replace("lang="+TC.Util.getParameterByName("lang")+"&",""):t.replace("?lang="+TC.Util.getParameterByName("lang"),""));const i=this.exportControlStates(),n=i.length?{ctl:i}:void 0;var r=this.map.getMapState(n),l=t.concat("#",r);this._$div.find("."+this.CLASS+"-alert").toggleClass(TC.Consts.classes.HIDDEN,l.length<=TC.Consts.URL_MAX_LENGTH);return l};t.generateIframe=function(t){var e=t||this.generateLink();if(e)return'<iframe style="width:'+this.IFRAME_WIDTH+";height:"+this.IFRAME_HEIGHT+';" src="'+e+'"></iframe>'};t.exportControlStates=function(){const t=this;return t.map?t.map.controls.map(function(t){return t.exportState()}).filter(function(t){return t}):[]};t.importControlStates=function(t){const e=this;e.map&&t.forEach(function(t){const a=e.map.getControlById(t.id);a&&a.importState(t)})};t.register=function(e){var a=this;TC.Control.prototype.register.call(a,e);a.MOBILEFAV=a.getLocaleString("mobileBookmarks.instructions");a.NAVALERT=a.getLocaleString("bookmarks.instructions");var o=function(t){var e=$(t).parent().find("input[type=text]");e.val(e.hasClass("tc-url")?a.generateLink():a.generateIframe());e.select()};a._$div.on("click","h2",function(t){a._$div.find(".tc-url input[type=text]").val(a.generateLink());a._$div.find(".tc-iframe input[type=text]").val(a.generateIframe())});a._$div.on("click",".tc-ctl-share-url-box button",function(t){o(t.target);document.execCommand("copy");var e=$(this);e.text(a.getLocaleString("copied"));setTimeout(function(){e.text(a.getLocaleString("copy"));!function(){document.getSelection().removeAllRanges();document.getSelection().addRange(document.createRange())}()},1e3)});a._$div.on("click","input[type=text]",function(t){o(t.target)});a._$div.on("click",".ga-share-icon.disabled",function(t){t.stopImmediatePropagation();t.preventDefault();return!1});a._$div.on("click","a.share-email",function(t){t.preventDefault();var o=a.generateLink();if(o){const t=encodeURIComponent(o+"\n");t.length>a.MAILTO_MAX_LENGTH&&e.toast(a.getLocaleString("urlTooLongForMailto"),{type:TC.Consts.msgType.WARNING});window.location.href="mailto:?body="+t}});a._$div.on("click","a.qr-generator",function(t){t.preventDefault();var e=a.generateLink();e&&TC.loadJS("undefined"==typeof QRCode,[TC.apiLocation+"lib/qrcode/qrcode.min.js"],function(){e.length>a.QR_MAX_LENGTH&&(e=TC.Util.shortenUrl(e));if(void 0!==e){TC.Util.showModal(a._$dialogDiv.find(a._classSelector+"-qr-dialog"));var t=a._$dialogDiv.find(".qrcode");t.empty();new QRCode(t[0],e)}else TC.error(a.getLocaleString("urlTooLongForShortener"))})});a._$div.on("click","a.share-fb",function(t){t.preventDefault();var e=a.generateLink();if(e){var o=TC.Util.shortenUrl(e);void 0!==o?window.open("https://www.facebook.com/sharer/sharer.php?u="+encodeURIComponent(o)):TC.error(a.getLocaleString("urlTooLongForShortener"));return!1}});a._$div.on("click","a.share-twitter",function(t){t.preventDefault();var e=a.generateLink();if(e){var o=TC.Util.shortenUrl(e);if(void 0!==o){var i=encodeURIComponent(window.document.title?window.document.title:"Visor API SITNA");window.open("https://twitter.com/intent/tweet?text="+i+"&amp;url="+encodeURIComponent(o))}else TC.error(a.getLocaleString("urlTooLongForShortener"));return!1}});TC.Util.detectMobile()&&a._$div.on("click","a.share-whatsapp",function(t){t.preventDefault();var e=a.generateLink();if(e){var o=TC.Util.shortenUrl(e),i="whatsapp://send?text=";location.href=void 0!==o?i+encodeURIComponent(o):i+encodeURIComponent(e);return!1}});a._$div.on("click","a.share-star",function(e){e.preventDefault();var o=a.generateLink(),i=document.title;if(TC.Util.detectMobile())alert(t.MOBILEFAV);else if(window.sidebar&&window.sidebar.addPanel)window.sidebar.addPanel(i,o,"");else if(window.sidebar&&/Firefox/i.test(navigator.userAgent)||window.opera&&window.print){window.location.href=o;alert((/Mac/i.test(navigator.userAgent)?"Cmd":"Ctrl")+t.NAVALERT)}else if(window.external&&"AddFavorite"in window.external)window.external.AddFavorite(o,i);else{window.location.href=o;alert((/Mac/i.test(navigator.userAgent)?"Cmd":"Ctrl")+t.NAVALERT)}return!1});e.loaded(function(){const t=e.state&&e.state.ctl;t&&a.importControlStates(t)})};t.template={};if(TC.isDebug){t.template[t.CLASS]=TC.apiLocation+"TC/templates/Share.html";t.template[t.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/ShareDialog.html"}else{t.template[t.CLASS]=function(){dust.register(t.CLASS,e);function e(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"share"}).w(' <span class="tc-beta tc-hidden">').h("i18n",e,{},{$key:"beta"}).w('</span></h2><div><div class="ga-share-icons"><a class="ga-share-icon share-email" target="_blank" data-toggle="tooltip" data-placement="top" title="').h("i18n",e,{},{$key:"sendMapByEmail"}).w('"href="#"><i class="icon-envelope-alt"></i></a><a class="ga-share-icon qr-generator" target="_blank" data-toggle="tooltip" data-placement="top" title="').h("i18n",e,{},{$key:"createQrCode"}).w('"href="#"><i class="icon-qrcode"></i></a><a class="ga-share-icon share-fb" target="_blank" data-toggle="tooltip" data-placement="top" title="').h("i18n",e,{},{$key:"shareMapToFacebook"}).w('"href="#"><i class="icon-facebook"></i></a><a class="ga-share-icon share-twitter" target="_blank" data-toggle="tooltip" data-placement="top" title="').h("i18n",e,{},{$key:"shareMapToTwitter"}).w('"href="#"><i class="icon-twitter"></i></a><a class="ga-share-icon share-whatsapp" target="_blank" data-toggle="tooltip" data-placement="top" title="').h("i18n",e,{},{$key:"shareMapToWhatsapp"}).w('"href="#"><i class="icon-whatsapp"></i></a><a class="ga-share-icon share-star" target="_blank" data-toggle="tooltip" data-placement="top" title="').h("i18n",e,{},{$key:"addToBookmarks"}).w('"href="#"><i class="icon-star"></i></a></div><div class="tc-ctl-share-select"><form><label class="tc-ctl-share-btn-url"><input type="radio" checked="checked" name="format" value="url" /><span>').h("i18n",e,{},{$key:"shareLink"}).w('</span></label><label class="tc-ctl-share-btn-iframe"><input type="radio" name="format" value="iframe" /><span>').h("i18n",e,{},{$key:"embedMap"}).w('</span></label></form></div><div class="tc-ctl-share-url-box tc-group tc-url"><input type="text" class="tc-textbox tc-url" readonly data-toggle="tooltip" data-placement="top" title="').h("i18n",e,{},{$key:"shareLink.tip.1"}).w('" /><button class="tc-button hide" title="').h("i18n",e,{},{$key:"shareLink.tip.2"}).w('">').h("i18n",e,{},{$key:"copy"}).w('</button></div><div class="tc-ctl-share-url-box tc-group tc-iframe tc-hidden"><input type="text" class="tc-textbox tc-iframe" readonly data-toggle="tooltip" data-placement="top" title="').h("i18n",e,{},{$key:"embedMap.tip.1"}).w('" /><button class="tc-button hide" title="').h("i18n",e,{},{$key:"embedMap.tip.2"}).w('">').h("i18n",e,{},{$key:"copy"}).w('</button></div><div class="tc-ctl-share-alert tc-alert alert-warning tc-hidden"><p>').h("i18n",e,{},{$key:"tooManyLayersLoaded|s"}).w("</p> </div></div>")}e.__dustBody=!0;return e};t.template[t.CLASS+"-dialog"]=function(){dust.register(t.CLASS+"-dialog",e);function e(t,e){return t.w('<div class="tc-ctl-share-qr-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",e,{},{$key:"qrCode"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><div class="qrcode"></div></div><div class="tc-modal-footer"><button type="button" class="tc-button tc-modal-close">').h("i18n",e,{},{$key:"close"}).w("</button></div></div></div>")}e.__dustBody=!0;return e}}}();