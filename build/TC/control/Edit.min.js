TC.control=TC.control||{},TC.control.SWCacheClient||TC.syncLoadJS(TC.apiLocation+"TC/control/SWCacheClient.js"),TC.Consts.editMode={SELECT:"select",ADDPOINT:"addpoint",ADDLINE:"addline",ADDPOLYGON:"addpolygon"},TC.Consts.editStyles={NEW:"temporary",SELECTED:"select",DEFAULT:"default"},TC.Consts.event.POINT="point.tc",TC.Consts.event.BEFOREFEATUREMODIFY="beforefeaturemodify.tc",TC.Consts.event.FEATUREMODIFY="featuremodify.tc",TC.Consts.event.FEATURESSELECT="featureselect.tc",TC.Consts.event.FEATURESUNSELECT="featureunselect.tc",function(){var e=0,t=function(){return"NewFeature."+e++},n=function(e,t){var n=$.Deferred();return TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){var o,a;switch(!0){case t instanceof TC.feature.Polygon:a=TC.Consts.geom.POLYGON;break;case t instanceof TC.feature.Polyline:a=TC.Consts.geom.POLYLINE;break;case t instanceof TC.feature.Point:a=TC.Consts.geom.POINT;break;case t instanceof TC.feature.MultiPolygon:a=TC.Consts.geom.MULTIPOLYGON;break;case t instanceof TC.feature.MultiPolyline:a=TC.Consts.geom.MULTIPOLYLINE}o={id:t.id||t.provId,attributes:t.data,type:a,geometry:t.geometry},localforage.setItem(e,o).then(function(){n.resolve({feature:t})})["catch"](function(e){n.reject({feature:t,error:e})})}),n.promise()},o=function(e){var t=$.Deferred();return TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.removeItem(e).then(function(){t.resolve(e)})["catch"](function(e){t.reject(e)})}),t.promise()},a=function(e){var t=$.Deferred();return TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.getItem(e).then(function(n){t.resolve({key:e,feature:n})})["catch"](function(e){t.reject(e)})}),t.promise()},s=function(e,t){return e.LOCAL_STORAGE_KEY_PREFIX+(t||e.layer.id)},i=function(e,t){return s(e,t)+e.LOCAL_STORAGE_ADDED_KEY_PREFIX},r=function(e,t){return s(e,t)+e.LOCAL_STORAGE_MODIFIED_KEY_PREFIX},l=function(e,t){return s(e,t)+e.LOCAL_STORAGE_REMOVED_KEY_PREFIX},c=function(e){e._$deleteBtn.prop("disabled",!0),e._$joinBtn.prop("disabled",!0),e._$splitBtn.prop("disabled",!0)},d=function(e){var t=!1;return(TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon||TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline)&&e.geometry.length>1&&(t=!0),t},u=function(e,t){e._$deleteBtn.prop("disabled",0===t.length),e._$joinBtn.prop("disabled",t.length<2),e._$splitBtn.prop("disabled",0===t.filter(d).length)},f=function(e,t){e._$saveBtn.prop("disabled",t),e._$discardBtn.prop("disabled",t),self.checkedOut=!t},y=function(e,t){"undefined"!=typeof t?f(e,!t):TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){var t=s(e);localforage.keys().then(function(n){if(n){for(var o=!0,a=0,s=n.length;s>a;a++)if(0===n[a].indexOf(t)){o=!1;break}f(e,o)}})})},C=function(e,t){var n=$.Deferred(),o=e._changesLayers[t.id];if(o)n.resolve(o);else{o=e._changesLayers[t.id]=new TC.layer.Vector({id:TC.getUID(),title:t.title+" - cambios pendientes",stealth:!0,styles:e.getChangesLayerStyle(t)});var a=e.map.layers.indexOf(t);e.map.insertLayer(o,a+1,function(){n.resolve(o)})}return n.promise()};TC.control.Edit=function(){var e=this;TC.control.SWCacheClient.apply(this,arguments),e._classSelector="."+e.CLASS,e.$events=$(e),e.wrap=new TC.wrap.control.Edit(e),e._layerDeferred=$.Deferred(),e.layer=null,e.checkedOut=!1,e.callback=arguments[2]&&$.isFunction(arguments[2])?arguments[2]:e.options.callback?e.options.callback:null,e.multi=e.options.multi?e.options.multi:!1,e.eraseActionConfirmTxt=e.options.eraseText?e.options.eraseText:"¿Está seguro de eliminar esta(s) geometría(s)?",e.cancelActionConfirmTxt=e.options.cancelText?e.options.eraseText:"Si continua todos los cambios se perderán. ¿Desea continuar?",e.styles=e.options.styles,e.features={},e.attributeEditor=null,e.pointDraw=null,e.lineDraw=null,e.polygonDraw=null,e.snapping="boolean"==typeof e.options.snapping?e.options.snapping:!0,e._changesLayers={},e._showsChanges="boolean"==typeof e.options.showChanges?e.options.showChanges:!0,$.isFunction(e.options.getChangesLayerStyleFunction)&&(e.getChangesLayerStyleFunction=e.getChangesLayerStyle),e.$events.on(TC.Consts.event.FEATUREADD,function(o){var a=o.feature;a.provId=t();var s=e._changesLayers[e.layer.id];e.features[e.layer.id].added.push(a),s.addFeature(a),n(i(e)+a.provId,a).then(function(){y(e,!0),TC.toast("Adición guardada")},function(){TC.error("Fallo al guardar adición")})}).on(TC.Consts.event.FEATUREREMOVE,function(t){var a=t.feature,s=a.provId||a.id,c=function(){y(e),TC.toast("Eliminación guardada")},d=function(){TC.error("Fallo al guardar eliminación")},u=e._changesLayers[e.layer.id],f=e.features[e.layer.id],C=f.added.indexOf(a);if(0>C){var p=l(e);C=f.modified.indexOf(a),0>C?(C=f.removed.indexOf(a),0>C&&(f.removed.push(a),u.addFeature(a),n(p+a.id,a).then(c,d))):(f.modified.splice(C,1),f.removed.push(a),o(r(e)+a.id).then(function(){c(),n(p+a.id,a).then(c,d)},d))}else u.removeFeature(a),f.added.splice(C,1),o(i(e)+s).then(c,d)}).on(TC.Consts.event.FEATUREMODIFY,function(t){var o=t.feature,a=o.provId||o.id,s=function(){y(e,!0),TC.toast("Modificación guardada")},l=function(){TC.error("Fallo al guardar modificación")},c=e._changesLayers[e.layer.id],d=e.features[e.layer.id],u=d.added.indexOf(o);0>u?(u=d.modified.indexOf(o),0>u&&(c.addFeature(o),d.modified.push(o)),n(r(e)+a,o).then(s,l)):n(i(e)+a,o).then(s,l)}).on(TC.Consts.event.FEATUREADD+" "+TC.Consts.event.FEATUREREMOVE+" "+TC.Consts.event.FEATUREMODIFY,function(t){if(e.serviceWorkerEnabled&&navigator.onLine){var n=e.layer.wrap.getGetFeatureUrl(),o=e.layer.wrap.getDescribeFeatureTypeUrl();n&&o&&e.createCache(e.LOCAL_STORAGE_KEY_PREFIX+e.layer.id,{urlList:[n,o]})}}).on(TC.Consts.event.CONTROLDEACTIVATE,function(e){}).on(TC.Consts.event.FEATURESSELECT,function(t){var n=e.getSelectedFeatures();u(e,n),n.length&&n[0].showPopup(e.attributeEditor)}).on(TC.Consts.event.FEATURESUNSELECT,function(t){u(e,e.getSelectedFeatures())})},TC.inherit(TC.control.Edit,TC.control.SWCacheClient);var p=TC.control.Edit.prototype;p.CLASS="tc-ctl-edit",p.LOCAL_STORAGE_KEY_PREFIX="TC.offline.edit.",p.LOCAL_STORAGE_ADDED_KEY_PREFIX=".added.",p.LOCAL_STORAGE_MODIFIED_KEY_PREFIX=".modified.",p.LOCAL_STORAGE_REMOVED_KEY_PREFIX=".removed.",p.template={},TC.isDebug?(p.template[p.CLASS]=TC.apiLocation+"TC/templates/Edit.html",p.template[p.CLASS+"-attr"]=TC.apiLocation+"TC/templates/EditAttributes.html"):(p.template[p.CLASS]=function(){function e(e,o){return e.w("<h2>").h("i18n",o,{},{$key:"featureEdit"}).w(' <span class="tc-beta">').h("i18n",o,{},{$key:"beta"}).w('</span></h2><div class="tc-ctl-edit-layer"><select class="tc-combo tc-ctl-edit-layer-sel"><option value="">').h("i18n",o,{},{$key:"selectLayerToEdit"}).w("</option>").s(o.get(["layers"],!1),o,{block:t},{}).w('</select><input type="checkbox" id="tc-ctl-edit-view-changes-cb"').x(o.get(["showChanges"],!1),o,{block:n},{}).w(' /><label class="tc-ctl-edit-view-changes" for="tc-ctl-edit-view-changes-cb">').h("i18n",o,{},{$key:"highlightUnsyncedChanges"}).w('</label></div><div class="tc-ctl-edit-mode"><form><label class="tc-ctl-edit-btn-select" title="').h("i18n",o,{},{$key:"select"}).w('"><input type="radio" name="mode" value="select" /><span>').h("i18n",o,{},{$key:"select"}).w('</span></label><label class="tc-ctl-edit-btn-point" title="').h("i18n",o,{},{$key:"newPoint"}).w('"><input type="radio" name="mode" value="addpoint" /><span>').h("i18n",o,{},{$key:"newPoint"}).w('</span></label><label class="tc-ctl-edit-btn-line" title="').h("i18n",o,{},{$key:"newLine"}).w('"><input type="radio" name="mode" value="addline" /><span>').h("i18n",o,{},{$key:"newLine"}).w('</span></label><label class="tc-ctl-edit-btn-polygon" title="').h("i18n",o,{},{$key:"newPolygon"}).w('"><input type="radio" name="mode" value="addpolygon" /><span>').h("i18n",o,{},{$key:"newPolygon"}).w('</span></label></form></div><div class="tc-ctl-edit-select tc-hidden"><button class="tc-ctl-btn tc-ctl-edit-btn-delete" disabled title="').h("i18n",o,{},{$key:"delete"}).w('">').h("i18n",o,{},{$key:"delete"}).w('</button><button class="tc-ctl-btn tc-ctl-edit-btn-join" disabled title="').h("i18n",o,{},{$key:"joinGeometries.tooltip"}).w('">').h("i18n",o,{},{$key:"joinGeometries"}).w('</button><button class="tc-ctl-btn tc-ctl-edit-btn-split" disabled title="').h("i18n",o,{},{$key:"splitGeometry"}).w('">').h("i18n",o,{},{$key:"splitGeometry"}).w('</button><button class="tc-ctl-btn tc-ctl-edit-btn-cancel" disabled title="').h("i18n",o,{},{$key:"cancel"}).w('">').h("i18n",o,{},{$key:"cancel"}).w('</button></div><div class="tc-ctl-edit-point tc-hidden"></div><div class="tc-ctl-edit-line tc-hidden"></div><div class="tc-ctl-edit-polygon tc-hidden"></div><div class="tc-ctl-edit-save"><button class="tc-button tc-icon-button tc-ctl-edit-btn-save" disabled title="').h("i18n",o,{},{$key:"syncChanges"}).w('">').h("i18n",o,{},{$key:"syncChanges"}).w('</button><button class="tc-button tc-icon-button tc-ctl-edit-btn-discard" disabled title="').h("i18n",o,{},{$key:"discardChanges"}).w('">').h("i18n",o,{},{$key:"discardChanges"}).w("</button></div>")}function t(e,t){return e.w('<option value="').f(t.get(["id"],!1),t,"h").w('">').f(t.get(["title"],!1),t,"h").w("</option>")}function n(e,t){return e.w(" checked")}return dust.register(p.CLASS,e),e.__dustBody=!0,t.__dustBody=!0,n.__dustBody=!0,e},p.template[p.CLASS+"-attr"]=function(){function e(e,n){return n=n.shiftBlocks(N),e.w('<div class="tc-ctl-edit-attr"><h3>').h("i18n",n,{},{$key:"attributeEdit"}).w('</h3><div class="tc-ctl-edit-attr-body"><table><tbody>').s(n.get(["data"],!1),n,{block:t},{}).w('</tbody></table></div><div class="tc-ctl-edit-attr-footer"><button class="tc-button tc-ctl-edit-btn-attr-ok">').h("i18n",n,{},{$key:"ok"}).w('</button><button class="tc-button tc-ctl-edit-btn-attr-cancel">').h("i18n",n,{},{$key:"cancel"}).w("</button></div></div>")}function t(e,t){return t=t.shiftBlocks(N),e.w("<tr><th>").f(t.get(["name"],!1),t,"h").w("</th><td>").x(t.get(["readOnly"],!1),t,{"else":n,block:I},{}).w("</td></tr>")}function n(e,t){return t=t.shiftBlocks(N),e.x(t.get(["availableValues"],!1),t,{block:o},{}).h("select",t,{block:s},{key:t.get(["type"],!1)})}function o(e,t){return t=t.shiftBlocks(N),e.w('<select class="tc-combo" name="').f(t.get(["name"],!1),t,"h").w('"><option value=""></option>').s(t.get(["availableValues"],!1),t,{block:a},{}).w("</select>")}function a(e,t){return t=t.shiftBlocks(N),e.w('<option value="').f(t.getPath(!0,[]),t,"h").w('">').f(t.getPath(!0,[]),t,"h").w("</option>")}function s(e,t){return t=t.shiftBlocks(N),e.h("none",t,{block:i},{}).h("eq",t,{block:r},{value:"int"}).h("eq",t,{block:l},{value:"integer"}).h("eq",t,{block:c},{value:"double"}).h("eq",t,{block:d},{value:"boolean"}).h("eq",t,{block:u},{value:"date"}).h("eq",t,{block:f},{value:"time"}).h("eq",t,{block:y},{value:"dateTime"}).h("eq",t,{block:C},{value:"byte"}).h("eq",t,{block:g},{value:"long"}).h("eq",t,{block:v},{value:"negativeInteger"}).h("eq",t,{block:h},{value:"nonNegativeInteger"}).h("eq",t,{block:m},{value:"nonPositiveInteger"}).h("eq",t,{block:b},{value:"positiveInteger"}).h("eq",t,{block:T},{value:"short"}).h("eq",t,{block:_},{value:"unsignedLong"}).h("eq",t,{block:E},{value:"unsignedInt"}).h("eq",t,{block:k},{value:"unsignedShort"}).h("eq",t,{block:L},{value:"unsignedByte"}).h("eq",t,{block:w},{value:"float"}).h("eq",t,{block:S},{value:"decimal"})}function i(e,t){return t=t.shiftBlocks(N),e.b(t.getBlock("inputText"),t,{},{})}function r(e,t){return t=t.shiftBlocks(N),e.b(t.getBlock("inputNumber"),t,{},{})}function l(e,t){return t=t.shiftBlocks(N),e.b(t.getBlock("inputNumber"),t,{},{})}function c(e,t){return t=t.shiftBlocks(N),e.b(t.getBlock("inputNumber"),t,{},{})}function d(e,t){return t=t.shiftBlocks(N),e.b(t.getBlock("inputCheckbox"),t,{},{})}function u(e,t){return t=t.shiftBlocks(N),e.b(t.getBlock("inputDate"),t,{},{})}function f(e,t){return t=t.shiftBlocks(N),e.b(t.getBlock("inputTime"),t,{},{})}function y(e,t){return t=t.shiftBlocks(N),e.b(t.getBlock("inputDatetime"),t,{},{})}function C(e,t){return t=t.shiftBlocks(N),e.b(t.getBlock("inputNumber"),t,{},{})}function g(e,t){return t=t.shiftBlocks(N),e.b(t.getBlock("inputNumber"),t,{},{})}function v(e,t){return t=t.shiftBlocks(N),e.b(t.getBlock("inputNumber"),t,{},{})}function h(e,t){return t=t.shiftBlocks(N),e.b(t.getBlock("inputNumber"),t,{},{})}function m(e,t){return t=t.shiftBlocks(N),e.b(t.getBlock("inputNumber"),t,{},{})}function b(e,t){return t=t.shiftBlocks(N),e.b(t.getBlock("inputNumber"),t,{},{})}function T(e,t){return t=t.shiftBlocks(N),e.b(t.getBlock("inputNumber"),t,{},{})}function _(e,t){return t=t.shiftBlocks(N),e.b(t.getBlock("inputNumber"),t,{},{})}function E(e,t){return t=t.shiftBlocks(N),e.b(t.getBlock("inputNumber"),t,{},{})}function k(e,t){return t=t.shiftBlocks(N),e.b(t.getBlock("inputNumber"),t,{},{})}function L(e,t){return t=t.shiftBlocks(N),e.b(t.getBlock("inputNumber"),t,{},{})}function w(e,t){return t=t.shiftBlocks(N),e.b(t.getBlock("inputNumber"),t,{},{})}function S(e,t){return t=t.shiftBlocks(N),e.b(t.getBlock("inputNumber"),t,{},{})}function $(e,t){return t=t.shiftBlocks(N),e.w('<input type="text" class="tc-textbox" name="').f(t.get(["name"],!1),t,"h").w('" value="').f(t.get(["value"],!1),t,"h").w('" />')}function O(e,t){return t=t.shiftBlocks(N),e.w('<input type="number" class="tc-textbox" name="').f(t.get(["name"],!1),t,"h").w('" value="').f(t.get(["value"],!1),t,"h").w('" />')}function B(e,t){return t=t.shiftBlocks(N),e.w('<input type="checkbox" name="').f(t.get(["name"],!1),t,"h").w('"').x(t.get(["value"],!1),t,{block:D},{}).w("/>")}function D(e,t){return t=t.shiftBlocks(N),e.w(" checked")}function A(e,t){return t=t.shiftBlocks(N),e.w('<input type="date" class="tc-textbox" name="').f(t.get(["name"],!1),t,"h").w('" value="').f(t.get(["value"],!1),t,"h").w('" />')}function F(e,t){return t=t.shiftBlocks(N),e.w('<input type="time" class="tc-textbox" name="').f(t.get(["name"],!1),t,"h").w('" value="').f(t.get(["value"],!1),t,"h").w('" />')}function P(e,t){return t=t.shiftBlocks(N),e.w('<input type="datetime" class="tc-textbox" name="').f(t.get(["name"],!1),t,"h").w('" value="').f(t.get(["value"],!1),t,"h").w('" />')}function I(e,t){return t=t.shiftBlocks(N),e.f(t.get(["value"],!1),t,"h")}dust.register(p.CLASS+"-attr",e);var N={inputText:$,inputNumber:O,inputCheckbox:B,inputDate:A,inputTime:F,inputDatetime:P};return e.__dustBody=!0,t.__dustBody=!0,n.__dustBody=!0,o.__dustBody=!0,a.__dustBody=!0,s.__dustBody=!0,i.__dustBody=!0,r.__dustBody=!0,l.__dustBody=!0,c.__dustBody=!0,d.__dustBody=!0,u.__dustBody=!0,f.__dustBody=!0,y.__dustBody=!0,C.__dustBody=!0,g.__dustBody=!0,v.__dustBody=!0,h.__dustBody=!0,m.__dustBody=!0,b.__dustBody=!0,T.__dustBody=!0,_.__dustBody=!0,E.__dustBody=!0,k.__dustBody=!0,L.__dustBody=!0,w.__dustBody=!0,S.__dustBody=!0,$.__dustBody=!0,O.__dustBody=!0,B.__dustBody=!0,D.__dustBody=!0,A.__dustBody=!0,F.__dustBody=!0,P.__dustBody=!0,I.__dustBody=!0,e}),p.register=function(t){var n=this;TC.control.SWCacheClient.prototype.register.call(n,t),t.addControl("popup",{closeButton:!0}).then(function(e){n.attributeEditor=e}),t.on(TC.Consts.event.LAYERUPDATE,function(t){if(t.layer.type===TC.Consts.layerType.WFS&&!t.layer.options.stealth){var o=t.layer,c=n.features[t.layer.id]=n.features[t.layer.id]||{added:[],modified:[],removed:[]};C(n,o).then(function(t){n.layer!==o&&t.setVisibility(!1);var d=s(n,o.id),u=i(n,o.id),f=r(n,o.id),y=l(n,o.id);TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){TC.getUID();localforage.keys().then(function(n){if(n)for(var s=0,i=n.length;i>s;s++){var r=n[s];0===r.indexOf(d)&&a(r).then(function(n){var a,s=n.key;if(0===s.indexOf(y)){a=s.substr(y.length);var i=o.getFeatureById(a);o.removeFeature(i),t.addFeature(i),c.removed.push(i)}else if(0===s.indexOf(f)){a=s.substr(f.length);var i=o.getFeatureById(a);i&&(t.addFeature(i),c.modified.push(i),i.wrap.setGeometry(n.feature.geometry),i.setData(n.feature.attributes))}else if(0===s.indexOf(u)){a=s.substr(u.length);var r=parseInt(a.substr(a.lastIndexOf(".")+1));e=Math.max(e,r+1);var l;switch(n.feature.type){case TC.Consts.geom.POINT:l=o.addPoint(n.feature.geometry);break;case TC.Consts.geom.POLYLINE:l=o.addPolyline(n.feature.geometry);break;case TC.Consts.geom.POLYGON:l=o.addPolygon(n.feature.geometry);break;case TC.Consts.geom.MULTIPOLYLINE:l=o.addMultiPolyline(n.feature.geometry);break;case TC.Consts.geom.MULTIPOLYGON:l=o.addMultiPolygon(n.feature.geometry)}l.then(function(e){t.addFeature(e),c.added.push(e),e.provId=a,e.setData(n.feature.attributes)})}})}})})})}}).on(TC.Consts.event.LAYERADD,function(e){e.layer.type!==TC.Consts.layerType.WFS||e.layer.options.stealth||(n.features[e.layer.id]=n.features[e.layer.id]||{added:[],modified:[],removed:[]},$("<option>").attr("value",e.layer.id).html(e.layer.title||e.layer.id).appendTo(n._$layerSelect))}).on(TC.Consts.event.LAYERREMOVE,function(e){if(e.layer.type===TC.Consts.layerType.WFS&&!e.layer.options.stealth){var t=n._$layerSelect.find("option[value="+e.layer.id+"]");t.filter(":selected").length>0&&n.setLayer(null),t.remove()}}).on(TC.Consts.event.POPUP,function(e){if(e.control===n.attributeEditor){for(var t=e.control.currentFeature,o=n.attributes.slice(),a={},s=n._joinedFeatureAttributes||[],i=0,r=o.length;r>i;i++){var l=t.getData()||{},c=o[i];c.value=l[c.name],"id"===c.name&&(c.readOnly=!0),c.availableValues=[];for(var d=0,u=s.length;u>d;d++){var f=s[d][c.name];void 0!==f&&""!==f&&(c.availableValues[c.availableValues.length]=f)}a[c.name]=c.type}o.sort(function(e,t){return(e.readOnly?!t.readOnly:t.readOnly)?!e.readOnly-!t.readOnly:e.name>t.name?1:e.name<t.name?-1:0}),n.getRenderedHtml(n.CLASS+"-attr",{data:o},function(e){var o=n.attributeEditor.$contentDiv;o.html(e);var s=o.find("input"),i=o.find("select");s.on("input",function(e){var t=$(e.target),n=i.filter("[name="+t.attr("name")+"]");n.val()!==t.val()&&n.val("")}),i.on("change",function(e){var t=$(e.target);s.filter("[name="+t.attr("name")+"]").val(t.val())}),o.find("."+n.CLASS+"-btn-attr-ok").on("click",function(){var e={};s.each(function(t,n){s=$(n);var o=s.attr("name"),i=s.val();switch(a[o]){case"int":case"integer":case"byte":case"long":case"negativeInteger":case"nonNegativeInteger":case"nonPositiveInteger":case"positiveInteger":case"short":case"unsignedLong":case"unsignedInt":case"unsignedShort":case"unsignedByte":i=parseInt(i),Number.isNaN(i)||(e[o]=i);break;case"double":case"float":case"decimal":i=parseFloat(i),Number.isNaN(i)||(e[o]=i);break;case"date":case"time":case"dateTime":e[o]=new Date(i);break;case"boolean":e[o]=!!i;break;case void 0:break;default:e[o]=i}}),t.setData(e),n.$events.trigger($.Event(TC.Consts.event.FEATUREMODIFY,{feature:t,layer:n.layer})),n.attributeEditor.hide()}),o.find("."+n.CLASS+"-btn-attr-cancel").on("click",function(){n.attributeEditor.hide()})})}}),t.loaded(function(){if(n.options.layer)n.setLayer(n.options.layer);else{var e=t.workLayers.filter(function(e){return e.type===TC.Consts.layerType.WFS&&!e.options.stealth});n.setLayer(1===e.length?e[0].id:null)}n.showChanges(n._showsChanges),n.renderPromise().then(function(){var e="draw";$.when.apply(n,[t.addControl(e,{div:n._$div.find("."+n.CLASS+"-point"),mode:TC.Consts.geom.POINT,layer:!1}),t.addControl(e,{div:n._$div.find("."+n.CLASS+"-line"),mode:TC.Consts.geom.POLYLINE,layer:!1}),t.addControl(e,{div:n._$div.find("."+n.CLASS+"-polygon"),mode:TC.Consts.geom.POLYGON,layer:!1})]).then(function(e,t,o){n.pointDraw=e,n.lineDraw=t,n.polygonDraw=o;var a=function(e){var t,o=e.geometry;switch(n.geometryType){case TC.Consts.geom.POINT:t=TC.feature.Point;break;case TC.Consts.geom.POLYLINE:t=TC.feature.Polyline;break;case TC.Consts.geom.POLYGON:t=TC.feature.Polygon;break;case TC.Consts.geom.MULTIPOLYLINE:t=TC.feature.MultiPolyline;break;case TC.Consts.geom.MULTIPOLYGON:t=TC.feature.MultiPolygon}t&&(o=new t(o.geometry,{geometryName:n.layer.options.geometryName})),n.layer.addFeature(o),n.$events.trigger($.Event(TC.Consts.event.FEATUREADD,{feature:o}))},s=function(){n.cancel()};e.on(TC.Consts.event.DRAWEND,a).on(TC.Consts.event.DRAWCANCEL,s),t.on(TC.Consts.event.DRAWEND,a).on(TC.Consts.event.DRAWCANCEL,s),o.on(TC.Consts.event.DRAWEND,a).on(TC.Consts.event.DRAWCANCEL,s),n.options.modes&&$.isArray(n.options.modes)&&1==n.options.modes.length&&n.setMode(n.options.modes[0],null)})})})},p.render=function(e){var t=this,n=[];if(t.map)for(var o=0,a=t.map.workLayers.length;a>o;o++){var s=t.map.workLayers[o];s.type!==TC.Consts.layerType.WFS||s.options.stealth||n.push({id:s.id,title:s.title||s.id})}TC.Control.prototype.renderData.call(t,{layers:n,showChanges:t.showChanges},function(){if(t._$layerDiv=t._$div.find(t._classSelector+"-layer"),t._$layerSelect=t._$layerDiv.find(t._classSelector+"-layer-sel").on("change",function(e){t.setLayer(t._$layerSelect.val())}),t._$layerDiv.find("#"+t.CLASS+"-view-changes-cb").on("change",function(e){t.showChanges($(e.target).prop("checked"))}),t._$cancelBtn=t._$div.find(t._classSelector+"-btn-cancel").on("click",function(){t.cancel()}),t._$deleteBtn=t._$div.find(t._classSelector+"-btn-delete").on("click",function(){TC.confirm(t.eraseActionConfirmTxt,function(){t.deleteFeatures(t.getSelectedFeatures())})}),t._$joinBtn=t._$div.find(t._classSelector+"-btn-join").on("click",function(){t.joinFeatures(t.getSelectedFeatures())}),t._$splitBtn=t._$div.find(t._classSelector+"-btn-split").on("click",function(){t.splitFeatures(t.getSelectedFeatures())}),t._$saveBtn=t._$div.find(t._classSelector+"-btn-save").on("click",function(){t.applyEdits()}),t._$discardBtn=t._$div.find(t._classSelector+"-btn-discard").on("click",function(){t.discardEdits()}),t.options.modes&&$.isArray(t.options.modes)&&t.options.modes.length>0){for(var n in TC.Consts.editMode)"string"==typeof n&&t.options.modes.indexOf(TC.Consts.editMode[n])<0&&($("label"+t._classSelector+"-btn-"+TC.Consts.editMode[n],t._$div).remove(),$("div"+t._classSelector+"-"+TC.Consts.editMode[n],t._$div).remove());if(1==t.options.modes.length){var o=t.options.modes[0];$("label"+t._classSelector+"-btn-"+o,t._$div).css("display","none")}}t._$div.find("input[type=radio][name=mode]").on("change",function(){var e=$(this),n=e.val(),o=t.mode===n?void 0:n;t.setMode(o)}),$.isFunction(e)&&e()})},p.setLayer=function(e){var t=this;t.layer=map.getLayer(e),t.setMode(null);var n="input[type=radio][name=mode]";t.layer?(C(t,t.layer).then(function(e){for(var n in t._changesLayers){var o=t._changesLayers[n];o.setVisibility(t._showsChanges&&o===e)}}),t.layer.describeFeatureType().then(function(e){t.attributes=e.filter(function(e){switch(e.type){case"gml:LinearRingPropertyType":case"gml:PolygonPropertyType":return t.geometryType=TC.Consts.geom.POLYGON,!1;case"gml:MultiPolygonPropertyType":case"gml:MultiSurfacePropertyType":return t.geometryType=TC.Consts.geom.MULTIPOLYGON,!1;case"gml:LineStringPropertyType":return t.geometryType=TC.Consts.geom.POLYLINE,!1;case"gml:MultiLineStringPropertyType":return t.geometryType=TC.Consts.geom.MULTIPOLYLINE,!1;case"gml:PointPropertyType":case"gml:MultiPointPropertyType":return t.geometryType=TC.Consts.geom.POINT,!1;case"gml:BoxPropertyType":return t.geometryType=TC.Consts.geom.RECTANGLE,!1;case"gml:GeometryCollectionPropertyType":case"gml:GeometryAssociationType":return!1;default:return!0}});for(var o=0,a=t.attributes.length;a>o;o++){var s=t.attributes[o];s.type=s.type.substr(s.type.indexOf(":")+1)}t.renderPromise().then(function(){y(t),t._$div.find(t._classSelector+"-layer-sel").val(t.layer.id),$rb=t._$div.find(n);var e;switch(t.geometryType){case TC.Consts.geom.POINT:e="[value=select],[value="+TC.Consts.editMode.ADDPOINT+"]";break;case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:e="[value=select],[value="+TC.Consts.editMode.ADDLINE+"]";break;case TC.Consts.geom.POLYGON:case TC.Consts.geom.MULTIPOLYGON:e="[value=select],[value="+TC.Consts.editMode.ADDPOLYGON+"]";break;default:e="[value]"}var o=$rb.filter(e).attr("disabled",!1);$rb.not(o).attr("disabled",!0)})}),t._layerDeferred.resolve(t.layer)):(t.renderPromise().then(function(){y(t,!1),$rb=t._$div.find(n).attr("disabled",!0),$rb.each(function(e,t){$(t).prop("checked",!1)})}),t._layerDeferred.resolve(null))},p.setMode=function(e){var t=this;t.mode=e,c(t);var n,o,a=function(e){e&&(t.snapping&&(e.snapping=t.layer),e.activate())};switch(e){case TC.Consts.editMode.SELECT:n=t._$div.find(t._classSelector+"-select"),o=t._$div.find(t._classSelector+"-point,"+t._classSelector+"-line,"+t._classSelector+"-polygon"),t.activate();break;case TC.Consts.editMode.ADDPOINT:n=t._$div.find(t._classSelector+"-point"),o=t._$div.find(t._classSelector+"-select,"+t._classSelector+"-line,"+t._classSelector+"-polygon"),a(t.pointDraw);break;case TC.Consts.editMode.ADDLINE:n=t._$div.find(t._classSelector+"-line"),o=t._$div.find(t._classSelector+"-select,"+t._classSelector+"-point,"+t._classSelector+"-polygon"),a(t.lineDraw);break;case TC.Consts.editMode.ADDPOLYGON:n=t._$div.find(t._classSelector+"-polygon"),o=t._$div.find(t._classSelector+"-select,"+t._classSelector+"-point,"+t._classSelector+"-line"),a(t.polygonDraw);break;default:n=$(),o=t._$div.find(t._classSelector+"-select,"+t._classSelector+"-point,"+t._classSelector+"-line,"+t._classSelector+"-polygon"),t.isActive&&t.deactivate(),t.pointDraw&&t.pointDraw.isActive&&t.pointDraw.deactivate(),t.lineDraw&&t.lineDraw.isActive&&t.lineDraw.deactivate(),t.polygonDraw&&t.polygonDraw.isActive&&t.polygonDraw.deactivate()}var s;e?(s=t._$div.find("input[type=radio][name=mode][value="+e+"]").prop("checked",!0).addClass(TC.Consts.classes.CHECKED),s.next().addClass(TC.Consts.classes.CHECKED)):(s=t._$div.find("input[type=radio][name=mode]").prop("checked",!1).removeClass(TC.Consts.classes.CHECKED),s.next().removeClass(TC.Consts.classes.CHECKED)),n.removeClass(TC.Consts.classes.HIDDEN),o.addClass(TC.Consts.classes.HIDDEN)},p.showChanges=function(e){var t=this;t._showsChanges=e;for(var n in t._changesLayers){var o=t._changesLayers[n];o.setVisibility(e&&t.layer&&n===t.layer.id)}},p.cancel=function(){var e=this;e.options.modes&&$.isArray(e.options.modes)&&1==e.options.modes.length?e.setMode(e.options.modes[0],null):e.setMode(null,!1),e.wrap.cancel(!0,e.cancelActionConfirmTxt)},p.onFeatureClick=function(e){self.activeControl&&self.activeControl.isExclusive()||e.feature.show()},p.activate=function(e){var t=this;TC.Control.prototype.activate.call(t);var n=e||{};t._$cancelBtn.prop("disabled",!1),$.when(t.getLayer()).then(function(){t.wrap.activate(n.mode?n.mode:t.mode),TC.Control.prototype.activate.call(t)})},p.deactivate=function(){var e=this;TC.Control.prototype.deactivate.call(e),e.wrap.cancel(!0),e._$cancelBtn.prop("disabled",!0),e.wrap.deactivate()},p.isExclusive=function(){return!0},p.joinFeatures=function(e){var t=this;if(t.geometryType===TC.Consts.geom.MULTIPOLYLINE||t.geometryType===TC.Consts.geom.MULTIPOLYGON||t.geometryType===TC.Consts.geom.MULTIPOINT){if(t._joinedFeatureAttributes=[],e.length>1){for(var n=e.map(function(e){return t._joinedFeatureAttributes[t._joinedFeatureAttributes.length]=e.getData(),e.geometry}),o=n.reduce(function(e,t){return e.concat(t)}),a=new e[0].constructor(o),s=0,i=e.length;i>s;s++){var r=e[s];t.layer.removeFeature(r),t.$events.trigger($.Event(TC.Consts.event.FEATUREREMOVE,{feature:r}))}t.layer.addFeature(a).then(function(e){t.setSelectedFeatures([a]),t.$events.trigger($.Event(TC.Consts.event.FEATUREADD,{feature:e})),e.showPopup(t.attributeEditor)})}u(t,[a])}},p.splitFeatures=function(e){for(var t=this,n=e.filter(d),o=n.map(function(e){return e.geometry}),a=[],s=0,i=n.length;i>s;s++)for(var r=n[s],l=r.getData(),c=o[s],f=0,y=c.length;y>f;f++)a[a.length]=new r.constructor([c[f]],{data:l});for(var s=0,C=n.length;C>s;s++){var r=n[s];t.layer.removeFeature(r),t.$events.trigger($.Event(TC.Consts.event.FEATUREREMOVE,{feature:r}))}for(var p=new Array(a.length),s=0,C=a.length;C>s;s++){var g=p[s]=t.layer.addFeature(a[s]);g.then(function(e){t.$events.trigger($.Event(TC.Consts.event.FEATUREADD,{feature:e}))})}$.when.apply(this,p).then(function(){t.setSelectedFeatures(a)}),u(t,a)},p.deleteFeatures=function(e){var t=this;t.wrap.deleteFeatures(e),0===t.layer.features.length&&t._$deleteBtn.prop("disabled",!0)},p.applyEdits=function(){var e=this;if(e.layer){var t=e.features[e.layer.id];e.layer.applyEdits(t.added,t.modified,t.removed).then(function(){e.discardEdits(),e.map.toast("Cambios sincronizados con éxito con el servidor")},function(e){TC.error("Error ["+e.code+"] al guardar cambios: "+e.reason)})}},p.discardEdits=function(){var e=this;e._joinedFeatureAttributes=[];var t=s(e);TC.loadJS(!window.localforage,[TC.Consts.url.LOCALFORAGE],function(){localforage.keys().then(function(n){if(n){for(var o=0,a=n.length;a>o;o++){var s=n[o];0===s.indexOf(t)&&localforage.removeItem(s)}if(e.layer){var i=e.features[e.layer.id];i.added.length=0,i.modified.length=0,i.removed.length=0,e.setSelectedFeatures([]),e.attributeEditor.hide();var r=e._changesLayers[e.layer.id];r.clearFeatures(),e.deleteCache(t).then(function(){e.layer.refresh()})}y(e,!1)}})})},p.getSelectedFeatures=function(){return this.wrap.getSelectedFeatures()},p.setSelectedFeatures=function(e){return this.wrap.setSelectedFeatures(e)},p.getLayer=function(){var e=this;return e.layer||e._layerDeferred},p.getChangesLayerStyle=function(e){var t=function(t){for(var n,o=e.wrap.getRGBA(t),a=0;3>a;a++)o[a]=255-o[a];return n=(65536*o[0]+256*o[1]+o[2]).toString(16),4===n.length?n="00"+n:5===n.length&&(n="0"+n),"#"+n},n=[1,3],o=$.extend(!0,{},e.options.styles);return o.point&&(o.point.strokeColor=t(o.point.strokeColor),o.point.lineDash=n),o.line&&(o.line.strokeColor=t(o.line.strokeColor),o.line.lineDash=n),o.polygon&&(o.polygon.strokeColor=t(o.polygon.strokeColor),o.polygon.lineDash=n),o}}();