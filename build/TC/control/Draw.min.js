TC.control=TC.control||{},TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control.js"),TC.Feature&&TC.feature.Point||TC.syncLoadJS(TC.apiLocation+"TC/feature/Point.js"),TC.Feature&&TC.feature.Polyline||TC.syncLoadJS(TC.apiLocation+"TC/feature/Polyline.js"),TC.Feature&&TC.feature.Polygon||TC.syncLoadJS(TC.apiLocation+"TC/feature/Polygon.js"),TC.Consts.event.DRAWSTART="drawstart.tc",TC.Consts.event.DRAWEND="drawend.tc",TC.Consts.event.DRAWCANCEL="drawcancel.tc",TC.Consts.event.MEASURE="measure.tc",TC.Consts.event.MEASUREPARTIAL="measurepartial.tc",function(){TC.control.Draw=function(){var e=this;TC.Control.apply(e,arguments),e._classSelector="."+e.CLASS,e._pointClass=e.CLASS+"-point",e._lineClass=e.CLASS+"-line",e._polygonClass=e.CLASS+"-polygon",e.history=[],e.historyIndex=0,this.renderPromise().then(function(){e.reset=!0,e.callBack=null,e.measure=!1,e._cancelClick=!1,e.mode=e.options.mode||TC.Consts.geom.POLYLINE,e.options.measure&&(e.measure=e.options.measure),$.isFunction(e.options.callback)&&(e.callBack=e.options.callback),e.wrap=new TC.wrap.control.Draw(e),e._$newBtn=e._$div.find(e._classSelector+"-btn-new").on(TC.Consts.event.CLICK,function(){e["new"]()}),e._$cancelBtn=e._$div.find(e._classSelector+"-btn-cancel").on(TC.Consts.event.CLICK,function(){e.cancel()}),e._$endBtn=e._$div.find(e._classSelector+"-btn-end").on(TC.Consts.event.CLICK,function(){e.end()}),e._$undoBtn=e._$div.find(e._classSelector+"-btn-undo").on(TC.Consts.event.CLICK,function(){e.undo()}),e._$redoBtn=e._$div.find(e._classSelector+"-btn-redo").on(TC.Consts.event.CLICK,function(){e.redo()}),e.$events.on(TC.Consts.event.MEASURE,function(t){e.resetValues()}),e.$events.on(TC.Consts.event.POINT,function(n){e.layer&&e.layer.features&&e.layer.features.length>0&&(e.layer.clearFeatures(),e.resetValues()),e.history.length=e.historyIndex,e.history[e.historyIndex++]=n.point,t(e)}),e.$events.on(TC.Consts.event.DRAWEND,function(t){n(e),e.callBack&&e.callBack(t.geometry)})})},TC.inherit(TC.control.Draw,TC.Control);var e=TC.control.Draw.prototype;e.CLASS="tc-ctl-draw";var t=function(e){e._$endBtn.prop("disabled",0===e.historyIndex||e.mode===TC.Consts.geom.POLYGON&&e.historyIndex<3||e.mode===TC.Consts.geom.POLYLINE&&e.historyIndex<2),e._$redoBtn.prop("disabled",e.history.length===e.historyIndex),e._$undoBtn.prop("disabled",0===e.historyIndex)},n=function(e){e.resetValues(),e._$endBtn.prop("disabled",!0),e._$cancelBtn.prop("disabled",!1)};e.template=TC.isDebug?TC.apiLocation+"TC/templates/Draw.html":function(){function t(e,t){return e.w(' <button class="tc-ctl-btn tc-ctl-draw-btn-new" title="').f(t.get(["tooltip"],!1),t,"h").w('">').h("i18n",t,{},{$key:"new"}).w('</button><button class="tc-ctl-btn tc-ctl-draw-btn-undo" disabled title="').h("i18n",t,{},{$key:"undo"}).w('">').h("i18n",t,{},{$key:"undo"}).w('</button><button class="tc-ctl-btn tc-ctl-draw-btn-redo" disabled title="').h("i18n",t,{},{$key:"redo"}).w('">').h("i18n",t,{},{$key:"redo"}).w('</button><button class="tc-ctl-btn tc-ctl-draw-btn-end" title="').h("i18n",t,{},{$key:"end"}).w('">').h("i18n",t,{},{$key:"end"}).w('</button><button class="tc-ctl-btn tc-ctl-draw-btn-cancel" title="').h("i18n",t,{},{$key:"cancel"}).w('">').h("i18n",t,{},{$key:"cancel"}).w("</button> ")}return dust.register(e.CLASS,t),t.__dustBody=!0,t},e.render=function(e){var t,n=this;switch(n.options.mode){case TC.Consts.geom.POLYLINE:case TC.Consts.geom.MULTIPOLYLINE:t=n.getLocaleString("drawLine"),n._$div.addClass(n._lineClass);break;case TC.Consts.geom.POLYGON:case TC.Consts.geom.MULTIPOLYGON:t=n.getLocaleString("drawPolygon"),n._$div.addClass(n._polygonClass);break;case TC.Consts.geom.POINT:case TC.Consts.geom.MULTIPOINT:t=n.getLocaleString("draw"),n._$div.addClass(n._pointClass);break;default:t=n.getLocaleString("draw")}n.renderData({tooltip:t},function(){$.isFunction(e)&&e()})},e.register=function(e){var t=this;TC.Control.prototype.register.call(t,e),e.loaded(function(){t.options.layer?t.setLayer(t.options.layer):"boolean"!=typeof t.options.layer&&e.loaded(function(){t.layerPromise=e.addLayer({id:TC.getUID(),title:"DrawControl",stealth:!0,type:TC.Consts.layerType.VECTOR,styles:{point:$.extend({},e.options.styles.point,{fillOpacity:0}),line:e.options.styles.line,polygon:e.options.styles.polygon}}),$.when(t.layerPromise).then(function(n){t.layer=n,e.putLayerOnTop(t.layer)})})})},e["new"]=function(){var e=this;e.layer&&e.layer.clearFeatures(),e.setMode(e.mode,!0)},e.undo=function(){var e=this,n=e.wrap.undo();return n&&(e.historyIndex--,t(e),e.historyIndex<=0&&e.resetValues()),n},e.redo=function(){var e=this,n=this.wrap.redo();return n&&(e.historyIndex++,t(e)),n},e.cancel=function(){var e=this;e._cancelClick=!0,this.setMode(null,!1),e.resetValues(),n(e),e.$events.trigger($.Event(TC.Consts.event.DRAWCANCEL,{ctrl:e}))},e.activate=function(){var e=this;switch(e._$newBtn.addClass(TC.Consts.classes.ACTIVE),TC.Control.prototype.activate.call(e),e.wrap.activate(e.mode),e._$div.removeClass(e._pointClass).removeClass(e._lineClass).removeClass(e._polygonClass),e.mode){case TC.Consts.geom.POINT:e._$div.addClass(e._pointClass);break;case TC.Consts.geom.POLYLINE:e._$div.addClass(e._lineClass);break;case TC.Consts.geom.POLYGON:e._$div.addClass(e._polygonClass)}},e.deactivate=function(){var e=this;e._$newBtn&&e._$newBtn.removeClass(TC.Consts.classes.ACTIVE),TC.Control.prototype.deactivate.call(e,!e._cancelClick),e.wrap&&e.wrap.deactivate(),e.resetValues(),e._cancelClick=!1},e.isExclusive=function(){return!0},e.end=function(){var e=this;e.wrap.end(),e.resetValues()},e.setMode=function(e,t){var n=this;e&&(n.mode=e),t&&e?(n.layer&&n.layer.map.putLayerOnTop(n.layer),n.activate()):n.deactivate();var o=t?TC.Consts.event.CONTROLACTIVATE:TC.Consts.event.CONTROLDEACTIVATE;n.map&&n.map.$events.trigger($.Event(o,{control:n}))},e.getLayer=function(){var e=this;return e.options&&"boolean"==typeof e.options.layer&&!e.options.layer?null:e.layer?e.layer:e.layerPromise},e.setLayer=function(e){var t=this;t.map&&(t.layer="string"==typeof e?t.map.getLayer(e):e)},e.resetValues=function(){var e=this;e.history.length=0,e.historyIndex=0,t(e)}}();