TC.control=TC.control||{};TC.control.Click||TC.syncLoadJS(TC.apiLocation+"TC/control/Click");TC.Consts.event.POPUPHIDE=TC.Consts.event.POPUPHIDE||"popuphide.tc";TC.Consts.event.RESULTSPANELCLOSE=TC.Consts.event.RESULTSPANELCLOSE||"resultspanelclose.tc";TC.control.FeatureInfoCommons=function(){const t=this;TC.control.Click.apply(t,arguments);t.resultsLayer=null;t.filterLayer=null;t._layersDeferred=$.Deferred();t.filterFeature=null;t.info=null;t.popup=null;t.resultsPanel=null;t.lastFeatureCount=null;t.tools=[];t._$dialogDiv=$(TC.Util.getDiv(t.options.dialogDiv));t.options.dialogDiv||t._$dialogDiv.appendTo("body")};TC.control.FeatureInfoCommons.displayMode={POPUP:"popup",RESULTS_PANEL:"resultsPanel"};!function(){var t=function(t){return t.info.services?t.info.services.reduce(function(t,e){return t+e.layers.reduce(function(t,e){return t+1},0)},0):0},e="ul.tc-ctl-finfo-features li",s=function(t){$(t.getDisplayTarget()).find("ul."+t.CLASS+"-services li").removeClass(TC.Consts.classes.CHECKED).removeClass(TC.Consts.classes.DISABLED).removeClass(TC.Consts.classes.FROMLEFT).removeClass(TC.Consts.classes.FROMRIGHT)};TC.inherit(TC.control.FeatureInfoCommons,TC.control.Click);var n=TC.control.FeatureInfoCommons.prototype;n.CLASS="tc-ctl-finfo";n.template={};if(TC.isDebug){n.template[n.CLASS]=TC.apiLocation+"TC/templates/FeatureInfo.html";n.template[n.CLASS+"-dialog"]=TC.apiLocation+"TC/templates/FeatureInfoDialog.html";n.template[n.CLASS+"-del-btn"]=TC.apiLocation+"TC/templates/FeatureInfoDeleteButton.html"}else{n.template[n.CLASS]=function(){dust.register(n.CLASS,t);function t(t,s){return t.x(s.get(["elevation"],!1),s,{block:e},{}).w('<ul class="tc-ctl-finfo-services">').s(s.get(["services"],!1),s,{else:l,block:i},{}).w("</ul>").x(s.get(["featureCount"],!1),s,{block:R},{})}t.__dustBody=!0;function e(t,e){return t.w('<div class="tc-ctl-finfo-coords"><span class="tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-crs">CRS: <span class="tc-ctl-finfo-coords-val">').f(e.get(["crs"],!1),e,"h").w("</span></span> ").x(e.get(["isGeo"],!1),e,{else:s,block:o},{}).w(' <span class="tc-ctl-finfo-coords-pair">').h("i18n",e,{},{$key:"ele"}).w(': <span class="tc-ctl-finfo-coords-val">').f(e.get(["elevation"],!1),e,"h").w(" m</span></span></div>")}e.__dustBody=!0;function s(t,e){return t.w('<span class="tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-x">x: <span class="tc-ctl-finfo-coords-val">').f(e.getPath(!1,["coords","0"]),e,"h").w('</span></span> <span class="tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-x">y: <span class="tc-ctl-finfo-coords-val">').f(e.getPath(!1,["coords","1"]),e,"h").w("</span></span> ")}s.__dustBody=!0;function o(t,e){return t.w('<span class="tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-lat">').h("i18n",e,{},{$key:"lat"}).w(': <span class="tc-ctl-finfo-coords-val">').f(e.getPath(!1,["coords","1"]),e,"h").w('</span></span> <span class="tc-ctl-finfo-coords-pair tc-ctl-finfo-coords-lon">').h("i18n",e,{},{$key:"lon"}).w(': <span class="tc-ctl-finfo-coords-val">').f(e.getPath(!1,["coords","0"]),e,"h").w("</span></span> ")}o.__dustBody=!0;function l(t,e){return t.nx(e.get(["elevation"],!1),e,{block:a},{})}l.__dustBody=!0;function a(t,e){return t.w('<li class="tc-ctl-finfo-empty">').h("i18n",e,{},{$key:"noData"}).w("</li>")}a.__dustBody=!0;function i(t,e){return t.w("<li><h3>").x(e.get(["title"],!1),e,{else:r,block:f},{}).w('</h3><div class="tc-ctl-finfo-service-content">').s(e.get(["hasLimits"],!1),e,{else:d,block:D},{}).w("</div></li>")}i.__dustBody=!0;function r(t,e){return t.x(e.getPath(!1,["mapLayer","title"]),e,{else:c,block:u},{})}r.__dustBody=!0;function c(t,e){return t.f(e.getPath(!1,["mapLayer","id"]),e,"h")}c.__dustBody=!0;function u(t,e){return t.f(e.getPath(!1,["mapLayer","title"]),e,"h")}u.__dustBody=!0;function f(t,e){return t.f(e.get(["title"],!1),e,"h")}f.__dustBody=!0;function d(t,e){return t.w('<ul class="tc-ctl-finfo-layers">').s(e.get(["layers"],!1),e,{else:p,block:C},{}).w("</ul>")}d.__dustBody=!0;function p(t,e){return t.w('<li class="tc-ctl-finfo-empty">').h("i18n",e,{},{$key:"noDataAtThisService"}).w("</li>")}p.__dustBody=!0;function C(t,e){return t.w('<li><h4><span class="tc-ctl-finfo-layer-n">').f(e.getPath(!1,["features","length"]),e,"h").w("</span> ").s(e.get(["path"],!1),e,{block:h},{}).w(' </h4> <div class="tc-ctl-finfo-layer-content"><ul class="tc-ctl-finfo-features">').s(e.get(["features"],!1),e,{else:g,block:v},{}).w("</ul></div></li>")}C.__dustBody=!0;function h(t,e){return t.f(e.getPath(!0,[]),e,"h").h("sep",e,{block:y},{})}h.__dustBody=!0;function y(t,e){return t.w(" &bull; ")}y.__dustBody=!0;function g(t,e){return t.w('<li class="tc-ctl-finfo-empty">').h("i18n",e,{},{$key:"noDataInThisLayer"}).w("</li>")}g.__dustBody=!0;function v(t,e){return t.w("<li>").x(e.get(["rawContent"],!1),e,{else:T,block:S},{}).w("</li>")}v.__dustBody=!0;function T(t,e){return t.x(e.get(["error"],!1),e,{else:m,block:b},{})}T.__dustBody=!0;function m(t,e){return t.w("<h5>").f(e.get(["id"],!1),e,"h").w("</h5><table").x(e.get(["geometry"],!1),e,{block:w},{}).w("><tbody>").s(e.get(["attributes"],!1),e,{block:L},{}).w("</tbody></table>").x(e.get(["geometry"],!1),e,{block:_},{})}m.__dustBody=!0;function w(t,e){return t.w(' title="').h("i18n",e,{},{$key:"clickToCenter"}).w('"')}w.__dustBody=!0;function L(t,e){return t.w('<tr><th class="tc-ctl-finfo-attr">').f(e.get(["name"],!1),e,"h").w('</th><td class="tc-ctl-finfo-val">').f(e.get(["value"],!1),e,"h").w("</td></tr>")}L.__dustBody=!0;function _(t,e){return t.w('<div class="tc-ctl-finfo-tools"><button class="tc-ctl-finfo-tools-btn" title="').h("i18n",e,{},{$key:"download"}).w("/").h("i18n",e,{},{$key:"share"}).w('">').h("i18n",e,{},{$key:"download"}).w("/").h("i18n",e,{},{$key:"share"}).w("</button></div>")}_.__dustBody=!0;function b(t,e){return t.w('<span class="tc-ctl-finfo-errors">').h("i18n",e,{},{$key:"fi.error"}).w('<span class="tc-ctl-finfo-error-text">').f(e.get(["error"],!1),e,"h").w("</span></span>")}b.__dustBody=!0;function S(t,e){return t.w("<h5>").h("i18n",e,{},{$key:"feature"}).w("</h5>").h("eq",e,{else:F,block:k},{key:e.get(["rawFormat"],!1),value:"text/html"})}S.__dustBody=!0;function F(t,e){return t.w("<pre>").f(e.get(["rawContent"],!1),e,"h").w("</pre>")}F.__dustBody=!0;function k(t,e){return t.w(" ").x(e.get(["expandUrl"],!1),e,{block:E},{})}k.__dustBody=!0;function E(t,e){return t.h("ne",e,{else:P,block:$},{key:e.get(["expandUrl"],!1),value:""})}E.__dustBody=!0;function P(t,e){return t.w('<iframe src="').f(e.get(["rawUrl"],!1),e,"h").w('" />')}P.__dustBody=!0;function $(t,e){return t.w('<div class="tc-ctl-finfo-features-iframe-cnt"><iframe src="').f(e.get(["rawUrl"],!1),e,"h").w('" /><a class="tc-ctl-finfo-open" onclick="window.open(\'').f(e.get(["expandUrl"],!1),e,"h").w("', '_blank')\" title=\"").h("i18n",e,{},{$key:"expand"}).w('"></a></div>')}$.__dustBody=!0;function D(t,e){return t.w('<span class="tc-ctl-finfo-errors">').f(e.get(["hasLimits"],!1),e,"h").w("</span>")}D.__dustBody=!0;function R(t,e){return t.h("gt",e,{block:M},{key:e.get(["featureCount"],!1),value:"1",type:"number"})}R.__dustBody=!0;function M(t,e){return t.w('<a class="tc-ctl-btn tc-ctl-finfo-btn-prev">').h("i18n",e,{},{$key:"previous"}).w('</a><div class="tc-ctl-finfo-counter"><span class="tc-ctl-finfo-counter-current"></span>/').f(e.get(["featureCount"],!1),e,"h").w('</div><a class="tc-ctl-btn tc-ctl-finfo-btn-next">').h("i18n",e,{},{$key:"next"}).w("</a>")}M.__dustBody=!0;return t};n.template[n.CLASS+"-dialog"]=function(){dust.register(n.CLASS+"-dialog",t);function t(t,e){return t.w('<div class="tc-ctl-finfo-dialog tc-modal"><div class="tc-modal-background tc-modal-close"></div><div class="tc-modal-window"><div class="tc-modal-header"><h3>').h("i18n",e,{},{$key:"feature"}).w('</h3><div class="tc-ctl-popup-close tc-modal-close"></div></div><div class="tc-modal-body"><div class="tc-ctl-finfo-dialog-dl"><h2>').h("i18n",e,{},{$key:"download"}).w('</h2><div><button class="tc-button tc-btn-dl tc-ctl-finfo-dl-btn-kml" data-format="KML" title="KML">KML</button><button class="tc-button tc-btn-dl tc-ctl-finfo-dl-btn-gml" data-format="GML" title="GML">GML</button><button class="tc-button tc-btn-dl tc-ctl-finfo-dl-btn-geojson" data-format="GeoJSON" title="GeoJSON">GeoJSON</button><button class="tc-button tc-btn-dl tc-ctl-finfo-dl-btn-wkt" data-format="WKT" title="WKT">WKT</button></div></div><div class="tc-ctl-finfo-dialog-share"></div></div></div></div>')}t.__dustBody=!0;return t};n.template[n.CLASS+"-del-btn"]=function(){dust.register(n.CLASS+"-del-btn",t);function t(t,e){return t.w('<button class="tc-ctl-finfo-del-btn" title="').h("i18n",e,{},{$key:"deleteFeature"}).w('">').h("i18n",e,{},{$key:"deleteFeature"}).w("</button>")}t.__dustBody=!0;return t}}n.register=function(t){var e,s,n=this;TC.control.Click.prototype.register.call(n,t);e=n.options.resultsLayer?n.options.resultsLayer:{id:n.getUID(),title:n.CLASS+": Results layer",type:TC.Consts.layerType.VECTOR,stealth:!0};s=n.options.filterLayer?n.options.filterLayer:{id:n.getUID(),title:n.CLASS+": Filter layer",stealth:!0,type:TC.Consts.layerType.VECTOR,styles:{line:{strokeColor:n.lineColor,strokeWidth:2},polygon:{strokeColor:n.lineColor,strokeWidth:2,fillColor:"#000",fillOpacity:.3}}};t.loaded(function(){$.when(t.addLayer(e),t.addLayer(s)).then(function(t,e){n.resultsLayer=t;n.filterLayer=e;n._layersDeferred.resolve()})});n.displayMode=n.options.displayMode||TC.control.FeatureInfoCommons.displayMode.POPUP;n.setDisplayMode(n.displayMode);t.on(TC.Consts.event.POPUPHIDE+" "+TC.Consts.event.RESULTSPANELCLOSE,function(t){if(t.control===n.getDisplayControl()&&n.resultsLayer){n.resultsLayer.clearFeatures();clearTimeout(n._removeFilterFeatureTimeout);n._removeFilterFeatureTimeout=setTimeout(function(){n.querying||n.filterLayer.clearFeatures()},0)}})};n.render=function(t){var e=this;e._$div.addClass(TC.Consts.classes.HIDDEN);e.getRenderedHtml(e.CLASS+"-dialog",null,function(t){e._$dialogDiv.html(t).on(TC.Consts.event.CLICK,"button[data-format]",function(t){TC.Util.closeModal();var s=e.resultsLayer.features[e.resultsLayer.features.length-1];e.map.exportFeatures([s],{fileName:s.id,format:$(t.target).data("format")})})})};n.responseCallback=function(t){const e=this;e.querying=!1;if(t.featureCount){e.map.$events.trigger($.Event(TC.Consts.event.FEATUREINFO,$.extend({control:e},t)));e.lastFeatureCount=t.featureCount}else{e.map.$events.trigger($.Event(TC.Consts.event.NOFEATUREINFO,{control:e}));e.lastFeatureCount=0;e.closeResults()}};n.responseError=function(t){const e=this;404===t.status&&e.map.toast(e.getLocaleString("featureInfo.tooManyLayers"),{type:TC.Consts.msgType.ERROR});e.responseCallback({})};n.markerStyle={cssClass:TC.Consts.classes.POINT,anchor:[.5,.5],width:15,height:15,noPrint:!0};n.setDisplayMode=function(t){var e=this;e.displayMode=t;var s=e.map;switch(t){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:if(!e.resultsPanel){var n=s.getControlsByClass("TC.control.ResultsPanel")[0];if(n)e.resultsPanel=n;else{s.on(TC.Consts.event.CONTROLADD,function t(n){if(TC.control.ResultsPanel&&n.control instanceof TC.control.ResultsPanel){e.resultsPanel=n.control;s.off(TC.Consts.event.CONTROLADD,t)}})}}break;default:e.displayMode=TC.control.FeatureInfoCommons.displayMode.POPUP;e.popup||$.when(s.addControl("popup",{closeButton:!0,draggable:e.options.draggable})).then(function(t){e.popup=t;t.caller=e;s.on(TC.Consts.event.POPUP,function(t){e.onShowPopUp(t)});s.on(TC.Consts.event.POPUPHIDE,function(s){s.control===t&&e.popup.$popupDiv.css("width","auto")})})}};n.getDisplayControl=function(){switch(this.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:return this.resultsPanel;default:return this.popup}};n.getDisplayTarget=function(){switch(this.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:return this.resultsPanel.$divTable.get(0);default:return this.popup.$popupDiv.get(0)}};n.displayResults=function(){this.filterFeature.data=$("<div>").append(this._$div.clone().removeClass(TC.Consts.classes.HIDDEN)).html();switch(this.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:$(this.getDisplayTarget()).html(this.filterFeature.data);this.resultsPanel.open(this.filterFeature.data);this.displayResultsCallback();break;default:this.popup&&this.filterFeature.showPopup(this.popup)}};n.getFeatureElement=function(t){var s,n=this;$(n.getDisplayTarget()).find(e).each(function(e,o){var l=$(o),a=l.parents("li").first(),i=a.parents("li").first();n.getFeature(n.info,i.index(),a.index(),l.index())===t&&(s=l)});return s&&s.get(0)};n.getNextFeatureElement=function(t){var e=$(this.getDisplayTarget()).find("ul."+this.CLASS+"-features > li"),s=e.length,n=e.filter("."+TC.Consts.classes.CHECKED),o=e.index(n.get(0));return e.get((o+t+s)%s)};n.closeResults=function(){switch(this.displayMode){case TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL:this.resultsPanel&&this.resultsPanel.isVisible()&&this.resultsPanel.close();break;default:this.popup&&this.popup.isVisible()&&this.popup.hide()}};n.displayResultsCallback=function(){var n,o=this,l=$(o.getDisplayTarget()).find("."+o.CLASS).first(),a="click";l.on(a,e,function(t){o.highlightFeature(this)});a="mouseenter";l.on(a,e,function(t){$(this).parents("."+o.CLASS+"-layers > li").hasClass(TC.Consts.classes.CHECKED)&&o.highlightFeature(this)});a=TC.Consts.event.CLICK;n="."+o.CLASS+"-btn-next";l.on(a,n,function(t){o.highlightFeature(o.getNextFeatureElement(1),1);return!1});n="."+o.CLASS+"-btn-prev";l.on(a,n,function(t){o.highlightFeature(o.getNextFeatureElement(-1),-1);return!1});n="ul."+o.CLASS+"-layers h4";l.on(a,n,function(n){var a=$(n.target).parents("li").first();if(a.hasClass(TC.Consts.classes.CHECKED))"none"===l.find(".tc-ctl-finfo-btn-next").css("display")&&t(o)>1&&s(o);else{o.highlightFeature(a.find(e).first()[0]);o.displayMode===TC.control.FeatureInfoCommons.displayMode.POPUP&&o.popup.fitToView(!0)}});n="."+o.CLASS+"-tools-btn";l.on(a,n,function(t){var e=new $.Deferred;o._shareCtl?e.resolve():o.map.addControl("share",{div:o._$dialogDiv.find(".tc-modal-body .tc-ctl-finfo-dialog-share")}).then(function(t){o._shareCtl=t;e.resolve()});$.when(e).then(function(){TC.Util.showModal(o._$dialogDiv.find("."+o.CLASS+"-dialog"),{openCallback:function(){o.onShowModal()}})})});if(o.info)if(o.info.defaultFeature){$(o.getFeatureElement(o.info.defaultFeature)).addClass(TC.Consts.classes.DEFAULT);o.highlightFeature(o.info.defaultFeature)}else o.highlightFeature(l.find(e).first()[0]);l.find("table").on("click",function(t){if(!$(this).parent().hasClass(TC.Consts.classes.DISABLED)){if(o.resultsLayer.features[0]){o.map.on(TC.Consts.event.ZOOM,function t(){o._zooming=!1;o.map.off(TC.Consts.event.ZOOM,t)});o._zooming=!0;o.map.zoomToFeatures([o.resultsLayer.features[0]],{animate:!0})}t.stopPropagation()}});l.find("table a").on("click",function(t){t.stopPropagation()});if(Modernizr.touch&&o.displayMode===TC.control.FeatureInfoCommons.displayMode.RESULTS_PANEL&&"none"!==l.find("."+o.CLASS+"-btn-prev").css("display")){o.resultsPanel&&o.resultsPanel._$div.swipe("disable");t(o)>1&&l.swipe({swipeLeft:function(t){o.highlightFeature(o.getNextFeatureElement(1),1);t.stopPropagation()},swipeRight:function(t){o.highlightFeature(o.getNextFeatureElement(-1),-1);t.stopPropagation()}})}};n.onShowPopUp=function(t){this.map;if(t.control===this.popup){this.displayResultsCallback();this.fitSize()}};n.onShowModal=function(){};n.insertLinks=function(){const t=this.getLocaleString("open"),e=this.getLocaleString("linkInNewWindow");this._$div.find("td."+this.CLASS+"-val").each(function(s,n){const o=$(n),l=o.text();TC.Util.isURL(l)&&o.html('<a href="'+l+'" target="_blank" title="'+e+'">'+t+"</a>")})};n.highlightFeature=function(t,e){(function(t,e){if(!t._zooming){var n,o,l,a;if(this instanceof TC.Feature){n=this;var i=t.getFeatureElement(n);i&&(o=$(i))}else o=$(this);a=(l=o.parents("li").first()).parents("li").first();s(t);o.addClass(TC.Consts.classes.CHECKED);l.addClass(TC.Consts.classes.CHECKED);a.addClass(TC.Consts.classes.CHECKED);if(e>0){o.addClass(TC.Consts.classes.FROMLEFT);l.addClass(TC.Consts.classes.FROMLEFT);a.addClass(TC.Consts.classes.FROMLEFT)}else if(e<0){o.addClass(TC.Consts.classes.FROMRIGHT);l.addClass(TC.Consts.classes.FROMRIGHT);a.addClass(TC.Consts.classes.FROMRIGHT)}var r=a.index(),c=l.index(),u=o.index();n=n||t.getFeature(t.info,r,c,u);$(t.getDisplayTarget()).find("."+t.CLASS+"-counter-current").html(t.getFeatureIndex(t.info,r,c,u)+1);var f=t.resultsLayer.features.slice();if(f.filter(function(t){return n&&n.id===t.id}).length>0)return;for(var d=0;d<f.length;d++){var p=f[d];p!==t.filterFeature&&t.resultsLayer.removeFeature(p)}n&&n.geometry?t.resultsLayer.addFeature(n):o.addClass(TC.Consts.classes.DISABLED)}}).call(t,this,e)};n.fitSize=function(){var t=this,e=$(t.getDisplayTarget()),s=0;e.find(".tc-ctl-finfo-features li").each(function(t,e){s=Math.max(s,$(e).position().left+$(e).width())});s&&e.width(s+50)};n.getFeature=function(t,e,s,n){var o;t&&t.services&&(o=t.services[e])&&(o=o.layers[s])&&(o=o.features[n]);return o};n.getFeatureIndex=function(t,e,s,n){var o=-1;if(t)for(var l=0;l<=e;l++)for(var a=t.services[l],i=l===e?s:a.layers.length-1,r=0;r<=i;r++)for(var c=a.layers[r],u=r===s?n:c.features.length-1,f=0;f<=u;f++)o+=1;return o};n.beforeRequest=function(t){this.querying=!0;this.map.$events.trigger($.Event(TC.Consts.event.BEFOREFEATUREINFO,{xy:t.xy,control:this}));this.closeResults();if(this.map&&this.resultsLayer){this.lastFeatureCount=null;this.resultsLayer.clearFeatures();this.info=null}};n.activate=function(){this.wrap&&this.wrap.activate();TC.Control.prototype.activate.call(this)};n.deactivate=function(t){this.popup&&this.popup.hide();this.resultsLayer.clearFeatures();this.filterLayer.clearFeatures();this.wrap&&this.wrap.deactivate();TC.Control.prototype.deactivate.call(this,t)}}();