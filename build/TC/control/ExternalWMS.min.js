TC.control=TC.control||{},TC.Control||TC.syncLoadJS(TC.apiLocation+"TC/Control.js"),TC.control.ExternalWMS=function(t){if(TC.isLegacy)return void console.warn("El control ExternalWMS no soporta modo legacy");var e=this;this.count=0,this._addedUrls=[],TC.Control.apply(e,arguments)},TC.inherit(TC.control.ExternalWMS,TC.Control),function(){var t=TC.control.ExternalWMS.prototype;t.CLASS="tc-ctl-xwms",t.markServicesAsSelected=function(t){if(t.length>0){var e=$(t[0]);e.attr("disabled","true"),e.addClass("tc-ctl-xwms-option-selected")}},t.register=function(t){if(TC.isLegacy)return void console.warn("El control ExternalWMS no soporta modo legacy");var e=this;TC.Control.prototype.register.call(e,t),e._$div.on("change","select",function(t){if(""!=this.value){var r=this.value;0===r.indexOf("//")&&(r=location.protocol+r),e._$div.find("input").val(r),$(this).val("")}});var r=function(t){for(var e=["version","service","request"],r=0;r<e.length;r++)t=TC.Util.removeURLParameter(t,e[r]);return t.match(/\?$/)&&(t=t.substr(0,t.length-1)),t};e._$div.on("click","button[name='agregar']",function(t){var o=e._$div.find("input").val();if(o)if(/^((https?|ftp):)?(\/\/)?(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(\#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i.test(o))if(e._addedUrls.indexOf(o)>-1)TC.alert(e.getLocaleString("serviceAlreadyAdded"));else{o=r(o);var u=e.map.getControlsByClass("TC.control.LoadingIndicator")[0];u.show();var n=e._$div.find("button");n.attr("disabled","true");var i={id:"xwms"+ ++e.count,type:"WMS",url:o,hideTree:!1},a=new TC.layer.Raster(i);a.getCapabilitiesPromise().then(function(t){if("undefined"==typeof t.Capability)return TC.alert(e.getLocaleString("noLayersFoundInService")),u.hide(),void n.removeAttr("disabled");var r=t.Capability.Layer;if(r.CRS&&-1==r.CRS.indexOf(e.map.crs))return TC.alert(e.getLocaleString("serviceSrsNotCompatible")),u.hide(),void n.removeAttr("disabled");e.map.$events.trigger($.Event(TC.Consts.event.EXTERNALSERVICEADDED,{layer:a})),e._$div.find("input").val("");var i=e._$div.find("select option[value='"+o+"']");e.markServicesAsSelected(i),e._addedUrls.push(o),u.hide(),n.removeAttr("disabled")},function(t){TC.alert(e.getLocaleString("serviceCouldNotBeLoaded")+":\n"+t),u.hide(),n.removeAttr("disabled")})}else TC.alert(e.getLocaleString("typeAValidAddress"));else TC.alert(e.getLocaleString("typeAnAddress"))}),t.on(TC.Consts.event.LAYERADD,function(t){var r=t.layer.url,o=e._$div.find("select option").filter(function(t,e){return TC.Util.addProtocol(e.value)===TC.Util.addProtocol(r)});e.markServicesAsSelected(o),e._addedUrls.push(r)})},t.template={},t.template[t.CLASS]=TC.isDebug?TC.apiLocation+"TC/templates/ExternalWMS.html":function(){function e(t,e){return t.x(e.get(["title"],!1),e,{block:r},{}).w('<div><div class="tc-group tc-ctl-xwms-cnt"> <select id="add-wms-select" class="tc-combo" title="WMS (Web Map Service)"><option value="">WMS</option>').s(e.get(["suggestions"],!1),e,{block:o},{}).w('</select><input type="text" class="tc-textbox" placeholder="').h("i18n",e,{},{$key:"writeAddressOrSelect"}).w('" /></div><div class="tc-group tc-group tc-ctl-xwms-cnt" style="text-align:right;"><button type="button" class="tc-button tc-icon-button" title="').h("i18n",e,{},{$key:"addService.title"}).w('" name="agregar">').h("i18n",e,{},{$key:"addService"}).w("</button></div></div>")}function r(t,e){return t.w("<h2>").h("i18n",e,{},{$key:"addMaps"}).w("</h2>")}function o(t,e){return t.w('<optgroup label="').f(e.get(["group"],!1),e,"h").w('">').s(e.get(["items"],!1),e,{block:u},{}).w("</optgroup>")}function u(t,e){return t.w('<option value="').f(e.get(["url"],!1),e,"h").w('">').f(e.get(["name"],!1),e,"h").w("</option>")}return dust.register(t.CLASS,e),e.__dustBody=!0,r.__dustBody=!0,o.__dustBody=!0,u.__dustBody=!0,e},t.render=function(t){var e=this;e.renderData(e.options)}}();