{"version":3,"sources":["control/FeatureInfo.js"],"names":["TC","control","FeatureInfoCommons","syncLoadJS","apiLocation","FeatureInfo","apply","this","arguments","wrap","Consts","classes","FROMLEFT","FROMRIGHT","inherit","ctlProto","prototype","roundCoordinates","obj","precision","result","Array","isArray","i","len","slice","length","Math","round","toFixed","register","map","self","Promise","resolve","reject","call","then","ctl","document","createElement","appendChild","div","error","callback","coords","xy","querying","elevationTool","getElevationTool","tool","elevationRequest","getElevation","crs","coordinates","filterLayer","title","getLocaleString","markerOptions","Util","extend","options","styles","marker","markerStyle","set","showsPopup","clearFeatures","highlightedFeature","filterFeature","addMarker","putLayerOnTop","renderResults","geometry","displayElevation","loading","displayResults","visibleLayers","workLayers","layer","type","layerType","WMS","getVisibility","names","resolution","getResolution","getFeatureInfo","setTimeout","responseCallback","services","service","j","layers","features","splice","info","defaultFeature","insertLinks","sharedFeatureInfo","querySelectorAll","CLASS","forEach","li","classList","add","CHECKED","sharedFeature","featureObj","ii","mapLayers","some","ml","url","s","jj","name","l","k","kk","feature","id","f","hash","hex_md5","JSON","stringify","data","getData","DEGREE_PRECISION","h","alert","addLayer","getUID","VECTOR","owner","stealth","sharedFeatureLayer","addFeature","zoomToFeatures","label","addEventListener","event","CLICK","e","stopPropagation","passive","displayResultsCallback","getDisplayControl","getDisplayTarget","elm","HIDDEN","elevationCoords","currentFeature","currentCoords","elevPoint","elevationValues","closeResults","isGeo","value","METER_PRECISION","formatCoord","renderData","tValue","sValue","locale","Cfg","elevationString","formatNumber","heightString","toLocaleString","maximumFractionDigits","elevationDisplay","querySelector","heightDisplay","toggle","innerHTML","loadSharedFeature","filter","item","getDisgregatedLayerNames","indexOf","msgErrorMode","TOAST","loadJS","window","HASH","beforeRequest","r","serviceUrl","layerName","featureId"],"mappings":"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","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.control.FeatureInfoCommons) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/control/FeatureInfoCommons');\r\n}\r\n\r\n(function () {\r\n    TC.control.FeatureInfo = function () {\r\n        var self = this;\r\n        TC.control.FeatureInfoCommons.apply(this, arguments);\r\n        self.wrap = new TC.wrap.control.FeatureInfo(self);\r\n\r\n        TC.Consts.classes.FROMLEFT = 'tc-fromleft';\r\n        TC.Consts.classes.FROMRIGHT = 'tc-fromright';\r\n    };\r\n\r\n    TC.inherit(TC.control.FeatureInfo, TC.control.FeatureInfoCommons);\r\n\r\n    var ctlProto = TC.control.FeatureInfo.prototype;\r\n\r\n    var roundCoordinates = function roundCoordinates(obj, precision) {\r\n        var result;\r\n        var n = 20;\r\n        if (Array.isArray(obj)) {\r\n            result = obj.slice();\r\n            for (var i = 0, len = result.length; i < len; i++) {\r\n                result[i] = roundCoordinates(result[i]);\r\n            }\r\n        }\r\n        else if (typeof obj === \"number\") {\r\n            result = Math.round(obj.toFixed(precision));\r\n        }\r\n        else {\r\n            result = obj;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            TC.control.FeatureInfoCommons.prototype.register.call(self, map).then(\r\n                function (ctl) {\r\n                    // Le ponemos un padre al div. Evitamos con esto que se añada el div al mapa (no es necesario, ya que es un mero buffer)\r\n                    document.createElement('div').appendChild(self.div);\r\n                    resolve(ctl);\r\n                },\r\n                error => reject(error)\r\n            );\r\n        });\r\n    };\r\n\r\n    ctlProto.callback = function (coords, xy) {\r\n        const self = this;\r\n\r\n        self.querying = true;\r\n\r\n        const elevationTool = self.getElevationTool();\r\n        elevationTool.then(function (tool) {\r\n            if (tool) {\r\n                self.elevationRequest = tool.getElevation({\r\n                    crs: self.map.crs,\r\n                    coordinates: [coords]\r\n                });\r\n            }\r\n        });\r\n\r\n        if (self.map && self.filterLayer) {\r\n            //aquí se pone el puntito temporal\r\n            var title = self.getLocaleString('featureInfo');\r\n            var markerOptions = TC.Util.extend({}, self.map.options.styles.marker, self.markerStyle, { title: title, set: title, showsPopup: false });\r\n            self.filterLayer.clearFeatures();\r\n            self.highlightedFeature = null;\r\n            self.filterFeature = null;\r\n            self.filterLayer.addMarker(coords, markerOptions).then(function afterMarkerAdd(marker) {\r\n                ////cuando se queda el puntito es porque esto sucede tras el cierre de la popup\r\n                ////o sea\r\n                ////lo normal es que primero se ejecute esto, y luego se procesen los eventos FEATUREINFO o NOFEATUREINFO\r\n                ////pero en el caso raro (la primera vez), ocurre al revés. Entonces, ya se habrá establecido lastFeatureCount (no será null)\r\n                //if (self.lastFeatureCount === null) {\r\n                //    self.map.putLayerOnTop(self.filterLayer);\r\n                //    self.filterFeature = marker;\r\n                //}\r\n                //else {\r\n                //    self.filterLayer.clearFeatures();\r\n                //}\r\n                self.map.putLayerOnTop(self.filterLayer);\r\n                self.filterFeature = marker;\r\n\r\n                elevationTool.then(function (tool) {\r\n                    self.renderResults({ coords: marker.geometry, displayElevation: tool, loading: true }, function () {\r\n                        self.displayResults();\r\n                    });\r\n                });\r\n\r\n                var visibleLayers = false;\r\n                for (var i = 0; i < self.map.workLayers.length; i++) {\r\n                    var layer = self.map.workLayers[i];\r\n                    if (layer.type === TC.Consts.layerType.WMS) {\r\n                        if (layer.getVisibility() && layer.names.length > 0) {\r\n                            visibleLayers = true;\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n                var resolution = self.map.getResolution();\r\n                if (visibleLayers) {\r\n                    self.wrap.getFeatureInfo(coords, resolution);\r\n                }\r\n                else {\r\n                    // Metemos setTimeout para salirnos del hilo. Sin él se corre el riesgo de que se ejecute esto antes del evento BEFOREFEATUREINFO\r\n                    setTimeout(function () {\r\n                        self.responseCallback({ coords: coords });\r\n                    });\r\n                }\r\n            });\r\n        }\r\n    };\r\n\r\n    ctlProto.responseCallback = function (options) {\r\n        const self = this;\r\n\r\n        TC.control.FeatureInfoCommons.prototype.responseCallback.call(self, options);\r\n        if (self.filterFeature) {\r\n            var services = options.services;\r\n\r\n            // Eliminamos capas sin resultados\r\n            if (services) {\r\n                for (var i = 0; i < services.length; i++) {\r\n                    var service = services[i];\r\n                    for (var j = 0; j < service.layers.length; j++) {\r\n                        if (!service.layers[j].features.length) {\r\n                            service.layers.splice(j, 1);\r\n                            j = j - 1;\r\n                        }\r\n                    }\r\n                    if (!service.layers.length) {\r\n                        services.splice(i, 1);\r\n                        i = i - 1;\r\n                    }\r\n                }\r\n            }\r\n\r\n            self.info.defaultFeature = options.defaultFeature;\r\n\r\n            if (self.elevationRequest) {\r\n                options.displayElevation = true;\r\n            }\r\n            self.renderResults(options, function () {\r\n                self.insertLinks();\r\n\r\n                if (self.sharedFeatureInfo) {\r\n                    self.div.querySelectorAll('ul.' + self.CLASS + '-services li').forEach(function (li) {\r\n                        li.classList.add(TC.Consts.classes.CHECKED);\r\n                    })\r\n                    var sharedFeature;\r\n                    var featureObj = self.sharedFeatureInfo;\r\n                    for (var i = 0, ii = self.info.services.length; i < ii; i++) {\r\n                        var service = self.info.services[i];\r\n                        if (service.mapLayers.some(function (ml) { return ml.url === featureObj.s })) {\r\n                            for (var j = 0, jj = service.layers.length; j < jj; j++) {\r\n                                var layer = service.layers[j];\r\n                                if (layer.name === featureObj.l) {\r\n                                    for (var k = 0, kk = layer.features.length; k < kk; k++) {\r\n                                        var feature = layer.features[k];\r\n                                        if (feature.id === featureObj.f) {\r\n                                            sharedFeature = feature;\r\n                                            var hash = hex_md5(JSON.stringify({\r\n                                                data: feature.getData(),\r\n                                                geometry: roundCoordinates(feature.geometry, TC.Consts.DEGREE_PRECISION) // Redondeamos a la precisión más fina (grado)\r\n                                            }));\r\n                                            if (featureObj.h !== hash) {\r\n                                                TC.alert(self.getLocaleString('finfo.featureChanged.warning'));\r\n                                            }\r\n                                            break;\r\n                                        }\r\n                                    }\r\n                                    break;\r\n                                }\r\n                            }\r\n                            break;\r\n                        }\r\n                    }\r\n                    if (sharedFeature) {\r\n                        self.highlightedFeature = sharedFeature;\r\n                        self.map.addLayer({\r\n                            id: self.getUID(),\r\n                            type: TC.Consts.layerType.VECTOR,\r\n                            title: self.getLocaleString('foi'),\r\n                            owner: self,\r\n                            stealth: true\r\n                        }).then(function (layer) {\r\n                            self.sharedFeatureLayer = layer;\r\n                            self.filterLayer.clearFeatures();\r\n                            self.filterFeature = null;\r\n                            layer.addFeature(sharedFeature);\r\n                            self.map.zoomToFeatures([sharedFeature]);\r\n                        });\r\n                    }\r\n                    delete self.sharedFeatureInfo;\r\n                }\r\n                else {\r\n                    self.displayResults();\r\n                }\r\n                //capturamos el click de label y enlaces para no propagarlos a las tablas y que haga zoom cuando no se quiere\r\n                self.div.querySelectorAll('ul.' + self.CLASS + '-services label, ul.' + self.CLASS + '-services a').forEach(function (label) {\r\n                    label.addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                        e.stopPropagation();\r\n                    }, { passive: true })\r\n                })\r\n            });\r\n        }\r\n    };\r\n\r\n    ctlProto.displayResultsCallback = function () {\r\n        const self = this;\r\n        TC.control.FeatureInfoCommons.prototype.displayResultsCallback.call(self);\r\n\r\n        if (self.elevationRequest) {\r\n            const ctl = self.getDisplayControl();\r\n            self.getDisplayTarget().querySelectorAll(`.${self.CLASS}-elev,.${self.CLASS}-height`).forEach(elm => elm.classList.add(TC.Consts.classes.HIDDEN));\r\n            self.elevationRequest.then(function (elevationCoords) {\r\n                if (ctl.currentFeature && elevationCoords.length) {\r\n                    const currentCoords = ctl.currentFeature.geometry;\r\n                    const elevPoint = elevationCoords[0];\r\n                    if (currentCoords[0] === elevPoint[0] && currentCoords[1] === elevPoint[1]) {\r\n                        const elevationValues = elevationCoords.length ? elevationCoords[0].slice(2) : null;\r\n                        self.displayElevation(elevationValues);\r\n                    }\r\n                }\r\n                //self.elevationRequest = null;\r\n            });\r\n        }\r\n        else if (!self.querying && (!self.info || !self.info.services)) {\r\n            self.closeResults();\r\n        }\r\n    };\r\n\r\n    ctlProto.renderResults = function (options, callback) {\r\n        const self = this;\r\n        if (self.filterFeature) {\r\n            const currentCoords = self.filterFeature.geometry;\r\n            if (options.coords && currentCoords[0] === options.coords[0] && currentCoords[1] === options.coords[1]) {\r\n                options.isGeo = self.map.wrap.isGeo();\r\n                if (options.coords) {\r\n                    options.crs = self.map.crs;\r\n                    options.coords = options.coords.map(function (value) {\r\n                        const precision = options.isGeo ? TC.Consts.DEGREE_PRECISION : TC.Consts.METER_PRECISION;\r\n                        return TC.Util.formatCoord(value, precision);\r\n                    });\r\n                }\r\n                self.renderData(options, callback);\r\n            }\r\n        }\r\n    };\r\n\r\n    ctlProto.displayElevation = function (value) {\r\n        const self = this;\r\n        let tValue, sValue;\r\n        if (Array.isArray(value)) {\r\n            tValue = value[0];\r\n            sValue = value.length > 1 ? value[1] : null;\r\n        }\r\n        else {\r\n            tValue = value;\r\n            sValue = null;\r\n        }\r\n        const locale = self.map.options.locale || TC.Cfg.locale;\r\n        let elevationString = tValue === null ? '-' : TC.Util.formatNumber(Math.round(tValue), locale) + ' m';\r\n        let heightString = sValue ? sValue.toLocaleString(locale, { maximumFractionDigits: 1 }) + ' m' : '-';\r\n        const elevationDisplay = self.getDisplayTarget().querySelector(`.${self.CLASS}-elev`);\r\n        const heightDisplay = self.getDisplayTarget().querySelector(`.${self.CLASS}-height`);\r\n        elevationDisplay.classList.toggle(TC.Consts.classes.HIDDEN, tValue === null);\r\n        heightDisplay.classList.toggle(TC.Consts.classes.HIDDEN, !sValue);\r\n        elevationDisplay.querySelector(`.${self.CLASS}-coords-val`).innerHTML = elevationString;\r\n        heightDisplay.querySelector(`.${self.CLASS}-coords-val`).innerHTML = heightString;\r\n    };\r\n\r\n    ctlProto.loadSharedFeature = function (featureObj) {\r\n        // Función para dar compatibilidad hacia atrás, ahora las features se comparten por URL\r\n        const self = this;\r\n        if (featureObj) {\r\n            //buscamos si la feature compartida pertenece a alguna de las capas añadidas\r\n            if (self.map.workLayers.filter(function (item, i) {\r\n                return item.type === TC.Consts.layerType.WMS && item.url === featureObj.s && item.getDisgregatedLayerNames().indexOf(featureObj.l) >= 0\r\n            }).length === 0) {\r\n                TC.error(self.getLocaleString('sharedFeatureNotValid'), TC.Consts.msgErrorMode.TOAST);\r\n                return;\r\n            }\r\n            self.sharedFeatureInfo = featureObj;\r\n            TC.loadJS(\r\n                !window.hex_md5,\r\n                [TC.apiLocation + TC.Consts.url.HASH],\r\n                function () {\r\n                    // Creamos una consulta getFeatureInfo ad-hoc, con la resolución a la que estaba la consulta original.\r\n                    const coords = [-100, -100];\r\n                    self.beforeRequest({ xy: coords }); // xy negativo para que no se vea el marcador, ya que no sabemos dónde ponerlo.\r\n                    //aquí se pone el puntito temporal\r\n                    self.filterLayer.clearFeatures();\r\n                    self.filterFeature = null;\r\n                    self.filterLayer.addMarker(coords).then(function (marker) {\r\n                        self.filterFeature = marker;\r\n                        self.wrap.getFeatureInfo(featureObj.xy, featureObj.r, {\r\n                            serviceUrl: featureObj.s,\r\n                            layerName: featureObj.l,\r\n                            featureId: featureObj.f\r\n                        });\r\n                    });\r\n                }\r\n            );\r\n        }\r\n    };\r\n\r\n})();"]}