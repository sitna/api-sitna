{"version":3,"sources":["control/FeatureInfo.js"],"names":["TC","control","FeatureInfoCommons","syncLoadJS","apiLocation","FeatureInfo","self","this","apply","arguments","wrap","Consts","classes","FROMLEFT","FROMRIGHT","options","displayElevation","loadJS","tool","Elevation","elevationOptions","elevation","inherit","ctlProto","prototype","roundCoordinates","obj","precision","result","Array","isArray","i","len","slice","length","Math","round","toFixed","register","map","call","document","createElement","appendChild","div","callback","coords","xy","querying","elevationRequest","getElevation","crs","coordinates","filterLayer","title","getLocaleString","markerOptions","Util","extend","styles","marker","markerStyle","set","showsPopup","clearFeatures","filterFeature","addMarker","then","putLayerOnTop","visibleLayers","workLayers","layer","type","layerType","WMS","getVisibility","names","resolution","getResolution","getFeatureInfo","setTimeout","responseCallback","services","service","j","layers","features","splice","info","defaultFeature","locale","Cfg","isGeo","value","formatNumber","DEGREE_PRECISION","METER_PRECISION","renderData","insertLinks","sharedFeatureInfo","querySelectorAll","CLASS","forEach","li","classList","add","CHECKED","sharedFeature","featureObj","ii","mapLayers","some","ml","url","s","jj","name","l","k","kk","feature","id","f","hash","hex_md5","JSON","stringify","data","getData","geometry","h","alert","highlightedFeature","addLayer","getUID","VECTOR","stealth","sharedFeatureLayer","addFeature","zoomToFeatures","displayResults","resultsLayer","displayResultsCallback","ctl","getDisplayControl","getDisplayTarget","querySelector","HIDDEN","elevationCoords","currentFeature","currentCoords","elevationValue","elevationString","elevationDisplay","toggle","innerHTML","loadSharedFeature","filter","item","getDisgregatedLayerNames","indexOf","error","msgErrorMode","TOAST","window","HASH","beforeRequest","r","serviceUrl","layerName","featureId"],"mappings":"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","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.control.FeatureInfoCommons) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/control/FeatureInfoCommons');\r\n}\r\n\r\n(function () {\r\n    TC.control.FeatureInfo = function () {\r\n        var self = this;\r\n        TC.control.FeatureInfoCommons.apply(this, arguments);\r\n        self.wrap = new TC.wrap.control.FeatureInfo(self);\r\n\r\n        TC.Consts.classes.FROMLEFT = 'tc-fromleft';\r\n        TC.Consts.classes.FROMRIGHT = 'tc-fromright';\r\n\r\n        if (self.options.displayElevation) {\r\n            TC.loadJS(\r\n                !TC.tool || !TC.tool.Elevation,\r\n                TC.apiLocation + 'TC/tool/Elevation',\r\n                function () {\r\n                    const elevationOptions = typeof self.options.displayElevation === 'boolean' ? {} : self.options.displayElevation;\r\n                    self.elevation = new TC.tool.Elevation(elevationOptions);\r\n                }\r\n            );\r\n        }\r\n    };\r\n\r\n    TC.inherit(TC.control.FeatureInfo, TC.control.FeatureInfoCommons);\r\n\r\n    var ctlProto = TC.control.FeatureInfo.prototype;\r\n\r\n    var roundCoordinates = function roundCoordinates(obj, precision) {\r\n        var result;\r\n        var n = 20;\r\n        if (Array.isArray(obj)) {\r\n            result = obj.slice();\r\n            for (var i = 0, len = result.length; i < len; i++) {\r\n                result[i] = roundCoordinates(result[i]);\r\n            }\r\n        }\r\n        else if (typeof obj === \"number\") {\r\n            result = Math.round(obj.toFixed(precision));\r\n        }\r\n        else {\r\n            result = obj;\r\n        }\r\n        return result;\r\n    };\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n        const result = TC.control.FeatureInfoCommons.prototype.register.call(self, map);\r\n\r\n        // Le ponemos un padre al div. Evitamos con esto que se añada el div al mapa (no es necesario, ya que es un mero buffer)\r\n        document.createElement('div').appendChild(self.div);\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.callback = function (coords, xy) {\r\n        var self = this;\r\n\r\n        if (self.elevation) {\r\n            self.querying = true;\r\n\r\n            self.elevationRequest = self.elevation.getElevation({\r\n                crs: self.map.crs,\r\n                coordinates: coords\r\n            });\r\n        }\r\n\r\n        if (self.map && self.filterLayer) {\r\n            //aquí se pone el puntito temporal\r\n            var title = self.getLocaleString('featureInfo');\r\n            var markerOptions = TC.Util.extend({}, self.map.options.styles.marker, self.markerStyle, { title: title, set: title, showsPopup: false });\r\n            self.filterLayer.clearFeatures();\r\n            self.filterFeature = null;\r\n            self.filterLayer.addMarker(coords, markerOptions).then(function (marker) {\r\n                ////cuando se queda el puntito es porque esto sucede tras el cierre de la popup\r\n                ////o sea\r\n                ////lo normal es que primero se ejecute esto, y luego se procesen los eventos FEATUREINFO o NOFEATUREINFO\r\n                ////pero en el caso raro (la primera vez), ocurre al revés. Entonces, ya se habrá establecido lastFeatureCount (no será null)\r\n                //if (self.lastFeatureCount === null) {\r\n                //    self.map.putLayerOnTop(self.filterLayer);\r\n                //    self.filterFeature = marker;\r\n                //}\r\n                //else {\r\n                //    self.filterLayer.clearFeatures();\r\n                //}\r\n                self.map.putLayerOnTop(self.filterLayer);\r\n                self.querying = true;\r\n                self.filterFeature = marker;\r\n\r\n                var visibleLayers = false;\r\n                for (var i = 0; i < self.map.workLayers.length; i++) {\r\n                    var layer = self.map.workLayers[i];\r\n                    if (layer.type === TC.Consts.layerType.WMS) {\r\n                        if (layer.getVisibility() && layer.names.length > 0) {\r\n                            visibleLayers = true;\r\n                            break;\r\n                        }\r\n                    }\r\n                }\r\n                var resolution = self.map.getResolution();\r\n                if (visibleLayers) {\r\n                    self.wrap.getFeatureInfo(coords, resolution);\r\n                }\r\n                else {\r\n                    self.querying = false;\r\n                    // Metemos setTimeout para salirnos del hilo. Sin él se corre el riesgo de que se ejecute esto antes del evento BEFOREFEATUREINFO\r\n                    setTimeout(function () {\r\n                        self.responseCallback({ coords: coords });\r\n                    });\r\n                }\r\n            });\r\n        }\r\n    };\r\n\r\n    ctlProto.responseCallback = function (options) {\r\n        const self = this;\r\n\r\n        TC.control.FeatureInfoCommons.prototype.responseCallback.call(self, options);\r\n\r\n        if (self.filterFeature) {\r\n            var services = options.services;\r\n\r\n            // Eliminamos capas sin resultados\r\n            if (services) {\r\n                for (var i = 0; i < services.length; i++) {\r\n                    var service = services[i];\r\n                    for (var j = 0; j < service.layers.length; j++) {\r\n                        if (!service.layers[j].features.length) {\r\n                            service.layers.splice(j, 1);\r\n                            j = j - 1;\r\n                        }\r\n                    }\r\n                    if (!service.layers.length) {\r\n                        services.splice(i, 1);\r\n                        i = i - 1;\r\n                    }\r\n                }\r\n            }\r\n\r\n            self.info.defaultFeature = options.defaultFeature;\r\n\r\n            var locale = self.map.options.locale || TC.Cfg.locale;\r\n            options.isGeo = self.map.wrap.isGeo();\r\n            if (self.elevationRequest) {\r\n                options.displayElevation = true;\r\n            }\r\n            if (options.coords) {\r\n                options.crs = self.map.crs;\r\n                options.coords = options.coords.map(function (value) {\r\n                    return TC.Util.formatNumber(value.toFixed(options.isGeo ? TC.Consts.DEGREE_PRECISION : TC.Consts.METER_PRECISION), locale);\r\n                });\r\n            }\r\n            if ((services && services.length) || self.elevationRequest) {\r\n                self.renderData(options, function () {\r\n                    self.insertLinks();\r\n\r\n                    if (self.sharedFeatureInfo) {\r\n                        self.div.querySelectorAll('ul.' + self.CLASS + '-services li').forEach(function (li) {\r\n                            li.classList.add(TC.Consts.classes.CHECKED);\r\n                        })\r\n                        var sharedFeature;\r\n                        var featureObj = self.sharedFeatureInfo;\r\n                        for (var i = 0, ii = self.info.services.length; i < ii; i++) {\r\n                            var service = self.info.services[i];\r\n                            if (service.mapLayers.some(function (ml) { return ml.url === featureObj.s })) {\r\n                                for (var j = 0, jj = service.layers.length; j < jj; j++) {\r\n                                    var layer = service.layers[j];\r\n                                    if (layer.name === featureObj.l) {\r\n                                        for (var k = 0, kk = layer.features.length; k < kk; k++) {\r\n                                            var feature = layer.features[k];\r\n                                            if (feature.id === featureObj.f) {\r\n                                                sharedFeature = feature;\r\n                                                var hash = hex_md5(JSON.stringify({\r\n                                                    data: feature.getData(),\r\n                                                    geometry: roundCoordinates(feature.geometry, TC.Consts.DEGREE_PRECISION) // Redondeamos a la precisión más fina (grado)\r\n                                                }));\r\n                                                if (featureObj.h !== hash) {\r\n                                                    TC.alert(self.getLocaleString('finfo.featureChanged.warning'));\r\n                                                }\r\n                                                break;\r\n                                            }\r\n                                        }\r\n                                        break;\r\n                                    }\r\n                                }\r\n                                break;\r\n                            }\r\n                        }\r\n                        if (sharedFeature) {\r\n                            self.highlightedFeature = sharedFeature;\r\n                            self.map.addLayer({\r\n                                id: self.getUID(),\r\n                                type: TC.Consts.layerType.VECTOR,\r\n                                title: self.getLocaleString('foi'),\r\n                                stealth: true\r\n                            }).then(function (layer) {\r\n                                self.sharedFeatureLayer = layer;\r\n                                self.filterLayer.clearFeatures();\r\n                                self.filterFeature = null;\r\n                                layer.addFeature(sharedFeature);\r\n                                self.map.zoomToFeatures([sharedFeature]);\r\n                            });\r\n                        }\r\n                        delete self.sharedFeatureInfo;\r\n                    }\r\n                    else {\r\n                        self.displayResults();\r\n                    }\r\n                });\r\n            }\r\n            else {\r\n                self.resultsLayer.clearFeatures();\r\n                self.filterLayer.clearFeatures();\r\n                self.filterFeature = null;\r\n            }\r\n        }\r\n    };\r\n\r\n    ctlProto.displayResultsCallback = function () {\r\n        const self = this;\r\n        TC.control.FeatureInfoCommons.prototype.displayResultsCallback.call(self);\r\n\r\n        if (self.elevationRequest) {\r\n            const ctl = self.getDisplayControl();\r\n            self.getDisplayTarget().querySelector(`.${self.CLASS}-elev`).classList.add(TC.Consts.classes.HIDDEN);\r\n            self.elevationRequest.then(function (elevationCoords) {\r\n                if (ctl.currentFeature) {\r\n                    const currentCoords = ctl.currentFeature.geometry;\r\n                    if (currentCoords[0] === elevationCoords[0][0] && currentCoords[1] === elevationCoords[0][1]) {\r\n                        const elevationValue = elevationCoords.length ? elevationCoords[0][2] : null;\r\n                        self.displayElevation(elevationValue);\r\n                    }\r\n                }\r\n                self.elevationRequest = null;\r\n            });\r\n        }\r\n    };\r\n\r\n    ctlProto.displayElevation = function (value) {\r\n        const self = this;\r\n        const locale = self.map.options.locale || TC.Cfg.locale;\r\n        const elevationString = value === null ? '-' : TC.Util.formatNumber(Math.round(value), locale) + ' m';\r\n        const elevationDisplay = self.getDisplayTarget().querySelector(`.${self.CLASS}-elev`);\r\n        elevationDisplay.classList.toggle(TC.Consts.classes.HIDDEN, value === null);\r\n        elevationDisplay.querySelector(`.${self.CLASS}-coords-val`).innerHTML = elevationString;\r\n    };\r\n\r\n    ctlProto.loadSharedFeature = function (featureObj) {\r\n        // Función para dar compatibilidad hacia atrás, ahora las features se comparten por URL\r\n        const self = this;\r\n        if (featureObj) {\r\n            //buscamos si la feature compartida pertenece a alguna de las capas añadidas\r\n            if (self.map.workLayers.filter(function (item, i) {\r\n                return item.type === TC.Consts.layerType.WMS && item.url === featureObj.s && item.getDisgregatedLayerNames().indexOf(featureObj.l) >= 0\r\n            }).length === 0) {\r\n                TC.error(self.getLocaleString('sharedFeatureNotValid'), TC.Consts.msgErrorMode.TOAST);\r\n                return;\r\n            }\r\n            self.sharedFeatureInfo = featureObj;\r\n            TC.loadJS(\r\n                !window.hex_md5,\r\n                [TC.apiLocation + TC.Consts.url.HASH],\r\n                function () {\r\n                    // Creamos una consulta getFeatureInfo ad-hoc, con la resolución a la que estaba la consulta original.\r\n                    const coords = [-100, -100];\r\n                    self.beforeRequest({ xy: coords }); // xy negativo para que no se vea el marcador, ya que no sabemos dónde ponerlo.\r\n                    //aquí se pone el puntito temporal\r\n                    self.filterLayer.clearFeatures();\r\n                    self.filterFeature = null;\r\n                    self.filterLayer.addMarker(coords).then(function (marker) {\r\n                        self.filterFeature = marker;\r\n                        self.wrap.getFeatureInfo(featureObj.xy, featureObj.r, {\r\n                            serviceUrl: featureObj.s,\r\n                            layerName: featureObj.l,\r\n                            featureId: featureObj.f\r\n                        });\r\n                    });\r\n                }\r\n            );\r\n        }\r\n    };\r\n\r\n})();"]}