{"version":3,"sources":["control/Geolocation.js"],"names":["Math","hypot","y","length","arguments","i","Infinity","sqrt","lastTime","vendors","hasPerformance","window","performance","now","x","max","requestAnimationFrame","cancelAnimationFrame","callback","element","currTime","Date","getTime","timeToCall","id","setTimeout","clearTimeout","rAF","startTime","timestamp","offset","this","TC","control","Control","syncLoadJS","apiLocation","Consts","event","DIALOG","Geolocation","options","_classSelector","CLASS","_layerPromises","Const","Classes","ACTIVE","CLOSED","SELECTEDTRACK","DRAWACTIVATED","SIMULATIONACTIVATED","Selector","SIMULATE","DRAW","EDIT","DELETE","SAVE","CANCEL","EXPORT","STOP","PAUSE","BACKWARD","FORWARD","SPEED","LocalStorageKey","TRACKING","TRACKINGTEMP","TRACKINGSHOWADVERTISEMENT","GPSSHOWADVERTISEMENT","TEST","Message","VALIDATENAME","Event","POSITIONCHANGE","GPSPOSITIONCHANGE","GPSPOSITIONERROR","STATEUPDATED","GPSADD","TRACKSNAPPING","DRAWTRACK","CLEARTRACK","IMPORTEDTRACK","MimeMap","KML","GPX","SupportedFileExtensions","Tabs","GPS","Layers","TRACK","apply","opts","_dialogDiv","Util","getDiv","dialogDiv","$","_$dialogDiv","document","body","appendChild","delta","walkingSpeed","snappingTolerance","exportsState","storageCRS","inherit","ctlProto","prototype","CHART_SIZE","MIN_HEIGHT","MAX_HEIGHT","MIN_WIDTH","MEDIUM_WIDTH","MAX_WIDTH","featuresToShare","TOOLSCLOSE","TOOLSOPEN","template","compiler","main","container","depth0","helpers","partials","data","alias1","nullContext","alias2","escapeExpression","alias3","lambda","lookupProperty","parent","propertyName","Object","hasOwnProperty","call","name","hash","loc","start","line","column","end","useData","1","3","5","7","9","11","stack1","fn","program","inverse","noop","12","14","15","17","13","16","18","onFeatureRemove","e","self","layer","feature","wrap","simulateMarker","layerTrack","clearSelection","register","map","result","hillDeltaThreshold","elevation","addLayer","getUID","type","layerType","VECTOR","owner","stealth","title","then","layerGPS","styles","point","radius","fillColor","fillOpacity","track","renderTrack","checked","bind","strokeColor","fontColor","labelOutlineColor","labelOutlineWidth","label","getData","trim","toLowerCase","strokeOpacity","strokeWidth","lineDash","layerTracking","fontSize","on","FEATURESIMPORT","featuresImport","fileName","target","dropTarget","kmlPattern","format","gpxPattern","indexOf","clear","importTrack","test","features","forEach","Point","setStyle","Polyline","working","isFunction","PROJECTIONCHANGE","elevationChartData","coords","reproject","oldCrs","newCrs","onShowDownloadDialog","caller","render","getRenderedHtml","html","innerHTML","getDownloadDialog","_downloadDialog","controlId","createElement","_downloadDialogExtNode","content","firstChild","renderData","off","FEATUREREMOVE","isDisabled","toast","getLocaleString","msgType","WARNING","wait","getLoadingIndicator","addWait","importedFileName","addPromises","len","push","addFeature","Promise","all","processImportedFeatures","notReproject","layout","accordion","div","classList","contains","classes","COLLAPSED","controls","filter","ctl","containerControl","add","remove","querySelector","click","isShared","trigger","prepareFeaturesToShare","trackUid","resolve","reject","storageData","availableTracks","saved","uid","toString","precision","pow","DEGREE_PRECISION","storageFeatures","ol","GeoJSON","readFeatures","promises","Array","f","idx","Feature","createFeature","tcFeatures","fObj","Marker","geom","MARKER","POINT","POLYLINE","MultiPolyline","MULTIPOLYLINE","compactGeometry","geometry","getDownloadFileName","elem","filename","textContent","regex","RegExp","join","replace","getFormattedDate","interpolationPanel","checkboxElevations","allFeatures","originalDialogFeatures","getFeatures","every","currentOptions","getOptions","controlOptions","getDownloadDialogOptions","openCallback","open","setOptions","displayElevation","modalBody","divToExtensions","radioDlSource","querySelectorAll","disableOriginalsRadio","condition","originalsRadio","DISABLED","feat","noZ","c","val","interpolationPanelIsHidden","HIDDEN","setInterpolationPanelVisibility","observer","MutationObserver","mutations","m","attributeName","mutation","oldValue","disconnect","config","attributes","attributeOldValue","observe","addEventListener","toggle","item","dataset","hasChangeEvent","async","featuresToDownload","value","featuresFromDialog","cachedProfile","getElevationProfileFromCache","toDownload","clone","setCoords","elevationFromServiceChartData","elevCoords","getCurrentPoints","LOADING","cachedFeature","getElevationFromServiceOnCache","console","log","tool","getElevationTool","cloned","setGeometry","crs","cacheElevationFromService","ERROR","duration","setFeatures","mdtRadio","dispatchEvent","resolution","sampleNumber","visibilityTrack","sel","span","CLICK","tagName","parentElement","newFormat","option","matches","passive","activateButton","deactivateButton","trackSearch","trackImportFile","trackSave","trackAdd","trackContinue","trackRenew","trackClose","trackAdvertisementOK","trackList","trackToolPanelOpened","_showAlerMsg","trackName","trackWPT","detectMobile","matchMedia","File","FileReader","FileList","Blob","disabled","form","insertBefore","reset","insertAdjacentElement","removeChild","_layerError","LAYERERROR","clearFileInput","alert","_cleaning","loadFiles","files","activateTracking","_activateTrackingBtns","deactivateTracking","_deactivateTrackingBtns","trackSearchListener","searchTerm","lis","from","li","style","display","trackLis","searchIcon","visibility","r","some","_filter","saveTrack","addWaypoint","list","_edit","edit","elm","input","focus","uiSimulate","simulate","editControls","simulateControls","cnt","parentNode","hidden","EventTarget","listenerBySelector","_loadTrack","removeWait","_drawTrack","listElement","index","scrollTop","offsetHeight","_stopOtherTracks","trackLiId","listItem","btnSimulate","btnPause","setAttribute","btnDraw","trackLi","getSelectedTrack","drawTrack","simulate_paused","simulateTrack","removeTrack","editTrackName","export","dialog","removeAttribute","simulateTrackEnd","simulate_speed","simulate_pausedElapse","closeModal","_tracking","sessionTracking","storage","setSessionLocalValue","undefined","localforage","removeItem","checkboxes","loadJS","url","LOCALFORAGE","setItem","getAttribute","setVisibility","bindTracks","activate","deactivate","markerStyle","lineStyle","setFormatInfoNewPosition","newPosition","locale","getMapLocale","on3DView","geoCoords","view3D","position","toLocaleString","mdt","round","getHeightFromMDT","isGeo","z","altitude","accuracy","speed","minimumFractionDigits","maximumFractionDigits","getTrackInfoPanel","_infoPanelPromise","infoPanel","ctlPromise","resultsPanelOptions","titles","collapsed","addResultsPanelInfo","controlContainer","POSITION","RIGHT","addControl","displayOn","getControlsByClass","toUpperCase","substring","resultsPanelInfo","renderInfoNewPosition","d","pd","isMinimized","ResultsPanel","panel","contentType","TABLE","close","renderPromise","_onWindowBlurred","_onWindowFocused","_onWindowVisibility","duringTrackingToolsPanel","currentPoint","formattedToStorage","advertisement","setTracking","onWindowFocused","videoScreenOn","paused","play","fromStorageToSession","onWindowVisibility","prefixes","getHiddenProperty","addWindowEvents","fromSessionToStorage","detectSafari","browserFeatures","touch","navigator","userAgent","match","getSessionLocalValue","JSON","stringify","getItem","showAdvertisement","registeredShowAdvertisement","checkbox","showModal","_askTracking","closeCallback","trackingAvailable","isActive","error","code","DOMException","QUOTA_EXCEEDED_ERR","media","WebM","MP4","sourceWebM","src","sourceMP4","_deactivateTracking","geopositionTracking","pause","removeEventListener","hasCoordinates","getStoredTracks","tracks","onResolve","toResolve","elevationProfileCache","profile","parse","keys","k","exec","key","res","rej","v","results","concat","tracksArray","_orderTracks","catch","err","sort","a","b","localeCompare","setStoredTracks","t","getAvailableTracks","_isEmpty","currentSelectedTrack","currentSelectedTrackId","newLi","DOMParser","parseFromString","setSelectedTrack","chartProgressInit","d3","D3C3","dataDiv","select","node","getBoundingClientRect","miDiv","width","height","miProgressDiv","miProgressTextDiv","top","left","bottom","right","zIndex","chartProgressClear","chartSetProgress","previous","current","distance","doneTime","resultsPanelChart","isVisible","done","progress","p","dist","measure","ele","parseInt","toFixed","ele2","findIndex","_getTime","timeFrom","timeTo","diff","daysDifference","floor","hoursDifference","h","minutesDifference","s","extend","slice","min","chart","show","withLegend","hasElevation","activateSnapping","drawTrackingData","elevationTrack","elevationFromServiceCache","isOnCache","a1","a2","arr_diff","isLine","calcDistance","arr","prev","utmCrs","dx","dy","getChartData","matchingFeature","getTrackingData","geoJSON","parser","GeometryLayout","XYZM","XYZ","time","XYM","elevationGain","getElevationGain","elevations","showLegend","waitId","getElevation","coordinates","partialCallback","ec","maxElevation","Number","NEGATIVE_INFINITY","minElevation","POSITIVE_INFINITY","elevationFromServiceProfileData","elevationGainOptions","Elevation","loadDataOnChart","finally","trackUID","parseFloat","resized","setCurrentFeature","currentFeature","onResize","elevationChart","destroy","resultsPanelChartData","msg","minHeight","maxHeight","minWidth","mediumWidth","maxWidth","one","DRAWCHART","c3","openOn","closeOn","ctx","onmouseout","removeElevationTooltip","tooltip","getElevationTooltip","addResultsPanelChart","getVisibility","getOpacity","deactivateSnapping","RESULTSPANELMIN","RESULTSPANELMAX","RESULTSPANELCLOSE","clearFeatures","message","_save","formatted","clean","newTrack","getHashToCompare","trackObject","toGetHash","hex_md5","HASH","sameTrackUID","savedTrack","clonedTrack","jsonFormat","explodeGeometry","getGeometry","getCoordinates","setCoordinates","writeFeatures","getTrackIndex","random","waypointName","heading","trackId","newName","dataId","confirm","selectedTrack","clearSelectedTrack","selected","showFeatures","showsPopup","first","last","addMarker","splice","cssClass","anchor","notExport","formattedFromStorage","showElevationMarker","getElevationChartTooltip","hideElevationMarker","fileInput","loading","LoadingIndicator","onGeolocateError","errorMsg","geolocation","currentPosition","clearWatch","currentPositionTrk","watch","currentPositionWaiting","PERMISSION_DENIED","POSITION_UNAVAILABLE","TIMEOUT","obj","exportState","state","layerState","importState","enable","featureOptions"],"mappings":"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","sourcesContent":["(function () {\r\n    Math.hypot = Math.hypot || function () {\r\n        var y = 0;\r\n        var length = arguments.length;\r\n\r\n        for (var i = 0; i < length; i++) {\r\n            if (arguments[i] === Infinity || arguments[i] === -Infinity) {\r\n                return Infinity;\r\n            }\r\n            y += arguments[i] * arguments[i];\r\n        }\r\n        return Math.sqrt(y);\r\n    };\r\n}());\r\n(function () {\r\n    var lastTime = 0,\r\n        vendors = ['ms', 'moz', 'webkit', 'o'],\r\n        // Feature check for performance (high-resolution timers)\r\n        hasPerformance = !!(window.performance && window.performance.now);\r\n\r\n    for (var x = 0, max = vendors.length; x < max && !window.requestAnimationFrame; x += 1) {\r\n        window.requestAnimationFrame = window[vendors[x] + 'RequestAnimationFrame'];\r\n        window.cancelAnimationFrame = window[vendors[x] + 'CancelAnimationFrame']\r\n            || window[vendors[x] + 'CancelRequestAnimationFrame'];\r\n    }\r\n\r\n    if (!window.requestAnimationFrame) {\r\n        window.requestAnimationFrame = function (callback, element) {\r\n            var currTime = new Date().getTime();\r\n            var timeToCall = Math.max(0, 16 - (currTime - lastTime));\r\n            var id = window.setTimeout(function () { callback(currTime + timeToCall); },\r\n                timeToCall);\r\n            lastTime = currTime + timeToCall;\r\n            return id;\r\n        };\r\n    }\r\n\r\n    if (!window.cancelAnimationFrame) {\r\n        window.cancelAnimationFrame = function (id) {\r\n            clearTimeout(id);\r\n        };\r\n    }\r\n\r\n    // Add new wrapper for browsers that don't have performance\r\n    if (!hasPerformance) {\r\n        // Store reference to existing rAF and initial startTime\r\n        var rAF = window.requestAnimationFrame,\r\n            startTime = +new Date;\r\n\r\n        // Override window rAF to include wrapped callback\r\n        window.requestAnimationFrame = function (callback, element) {\r\n            // Wrap the given callback to pass in performance timestamp\r\n            var wrapped = function (timestamp) {\r\n                // Get performance-style timestamp\r\n                var performanceTimestamp = (timestamp < 1e12) ? timestamp : timestamp - startTime;\r\n\r\n                return callback(performanceTimestamp);\r\n            };\r\n\r\n            // Call original rAF with wrapped callback\r\n            rAF(wrapped, element);\r\n        }\r\n    }\r\n})();\r\n(function () {\r\n    // Polyfill window.performance.now\r\n    if (!window.performance) {\r\n        window.performance = {\r\n            offset: Date.now(),\r\n            now: function () {\r\n                return Date.now() - this.offset;\r\n            }\r\n        };\r\n    } else if (window.performance && !window.performance.now) {\r\n        window.performance.offset = Date.now();\r\n        window.performance.now = function () {\r\n            return Date.now() - window.performance.offset;\r\n        };\r\n    }\r\n}());\r\n\r\nTC.control = TC.control || {};\r\n\r\nif (!TC.Control) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/Control');\r\n}\r\n\r\nTC.Consts.event.DIALOG = TC.Consts.event.DIALOG || 'dialog.tc';\r\n\r\nTC.control.Geolocation = function (options) {\r\n    var self = this;\r\n    self._classSelector = '.' + self.CLASS;\r\n\r\n    self._layerPromises = {};\r\n\r\n    self.Const = {\r\n        Classes: {\r\n            ACTIVE: 'tc-ctl-geolocation-active',\r\n            CLOSED: 'closed',\r\n            SELECTEDTRACK: 'selectedTrack',\r\n            DRAWACTIVATED: 'draw-activated',\r\n            SIMULATIONACTIVATED: 'simulation-activated'\r\n        },\r\n        Selector: {\r\n            SIMULATE: '.tc-btn-simulate',\r\n            DRAW: '.tc-draw',\r\n            EDIT: '.tc-btn-edit',\r\n            DELETE: '.tc-btn-delete',\r\n            SAVE: '.tc-btn-save',\r\n            CANCEL: '.tc-btn-cancel',\r\n            EXPORT: '.tc-btn-export',\r\n            STOP: '.tc-btn-stop',\r\n            PAUSE: '.tc-btn-pause',\r\n            BACKWARD: '.tc-btn-backward',\r\n            FORWARD: '.tc-btn-forward',\r\n            SPEED: '.tc-spn-speed'\r\n        },\r\n        LocalStorageKey: {\r\n            TRACKING: 'trk',\r\n            TRACKINGTEMP: 'trktemp',\r\n            TRACKINGSHOWADVERTISEMENT: 'trkAdvertisement',\r\n            GPSSHOWADVERTISEMENT: 'gpsAdvertisement',\r\n            TEST: 'test'\r\n        },\r\n        Message: {\r\n            VALIDATENAME: '',\r\n        },\r\n        Event: {\r\n            POSITIONCHANGE: 'positionchange.tc.geolocation',\r\n            GPSPOSITIONCHANGE: 'gpspositionchange.tc.geolocation',\r\n            GPSPOSITIONERROR: 'positionerror.tc.geolocation',\r\n            STATEUPDATED: 'stateupdated.tc.geolocation',\r\n            GPSADD: 'gpsadd.tc.geolocation',\r\n            TRACKSNAPPING: 'tracksnapping.tc.geolocation',\r\n            DRAWTRACK: 'drawtrack.tc.geolocation',\r\n            CLEARTRACK: 'cleartrack.tc.geolocation',\r\n            IMPORTEDTRACK: 'importedtrack.tc.geolocation'\r\n        },\r\n        MimeMap: {\r\n            KML: 'application/vnd.google-earth.kml+xml',\r\n            GPX: 'application/gpx+xml'\r\n        },\r\n        SupportedFileExtensions: [\r\n            '.kml',\r\n            '.gpx'\r\n        ],\r\n        Tabs: {\r\n            GPS: \"gps\"\r\n        },\r\n        Layers: {\r\n            GPS: \"gps\",\r\n            TRACK: \"track\",\r\n            TRACKING: \"tracking\"\r\n        }\r\n    };\r\n\r\n    TC.Control.apply(self, arguments);\r\n\r\n    var opts = options || {};\r\n    self._dialogDiv = TC.Util.getDiv(opts.dialogDiv);\r\n    if (window.$) {\r\n        self._$dialogDiv = $(self._dialogDiv);\r\n    }\r\n    if (!opts.dialogDiv) {\r\n        document.body.appendChild(self._dialogDiv);\r\n    }\r\n    self.delta = 500;\r\n    self.walkingSpeed = 5000;\r\n\r\n    self.snappingTolerance = self.options.snappingTolerance || 50;\r\n\r\n    self.exportsState = true;\r\n\r\n    self.storageCRS = 'EPSG:4326';\r\n};\r\n\r\nTC.inherit(TC.control.Geolocation, TC.Control);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.Geolocation.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-geolocation';\r\n\r\n    ctlProto.CHART_SIZE = {\r\n        MIN_HEIGHT: 75,\r\n        MAX_HEIGHT: 128,\r\n\r\n        MIN_WIDTH: 315,\r\n        MEDIUM_WIDTH: 310,\r\n        MAX_WIDTH: 445\r\n    };\r\n\r\n    ctlProto.featuresToShare = [];\r\n\r\n    TC.Consts.event.TOOLSCLOSE = TC.Consts.event.TOOLSCLOSE || 'toolsclose.tc';\r\n    TC.Consts.event.TOOLSOPEN = TC.Consts.event.TOOLSOPEN || 'toolsopen.tc';\r\n\r\n    ctlProto.template = {};\r\n    ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/tc-ctl-geolocation.hbs\";\r\n    ctlProto.template[ctlProto.CLASS + '-track-node'] = TC.apiLocation + \"TC/templates/tc-ctl-geolocation-track-node.hbs\";\r\n    ctlProto.template[ctlProto.CLASS + '-track-snapping-node'] = TC.apiLocation + \"TC/templates/tc-ctl-geolocation-track-snapping-node.hbs\";\r\n    ctlProto.template[ctlProto.CLASS + '-dialog'] = TC.apiLocation + \"TC/templates/tc-ctl-geolocation-dialog.hbs\";\r\n    ctlProto.template[ctlProto.CLASS + '-tracking-toast'] = TC.apiLocation + \"TC/templates/tc-ctl-geolocation-tracking-toast.hbs\";\r\n    ctlProto.template[ctlProto.CLASS + '-ext-dldlog'] = TC.apiLocation + \"TC/templates/tc-ctl-geolocation-ext-dldlog.hbs\";\r\n\r\n    var onFeatureRemove = function (e) {\r\n        const self = this;\r\n        const layer = e.layer;\r\n\r\n        if (e.feature === self.wrap.simulateMarker) {\r\n            return;\r\n        }\r\n\r\n        if (e.layer === self.layerTrack) {\r\n            self.clearSelection();\r\n        }\r\n    };\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n        const result = TC.Control.prototype.register.call(self, map);\r\n\r\n        self.wrap = new TC.wrap.control.Geolocation(self);\r\n        self.wrap.register(map);\r\n\r\n        self.hillDeltaThreshold = ((self.options && self.options.hillDeltaThreshold) ||\r\n                                    (self.map.options.elevation && self.map.options.elevation.hillDeltaThreshold)) ||\r\n                                    20;\r\n\r\n        map.addLayer({\r\n            id: self.getUID(),\r\n            type: TC.Consts.layerType.VECTOR,\r\n            owner: self,\r\n            stealth: true,\r\n            title: 'Posicionar.GPS',\r\n        }).then(function (layer) {\r\n            self.layerGPS = layer;\r\n        });\r\n        map.addLayer({\r\n            id: self.getUID(),\r\n            type: TC.Consts.layerType.VECTOR,\r\n            owner: self,\r\n            stealth: true,\r\n            title: 'Posicionar.Tracking',\r\n            styles: {\r\n                point: {\r\n                    radius: 3,\r\n                    fillColor: \"#00ced1\",\r\n                    fillOpacity: function () {\r\n                        return this.track.renderTrack.checked ? 1 : 0;\r\n                    }.bind(self),\r\n                    strokeColor: \"#ffffff\",\r\n                    fontColor: \"#00ced1\",\r\n                    labelOutlineColor: \"#ffffff\",\r\n                    labelOutlineWidth: 1,\r\n                    label: function (feature) {\r\n                        var name = feature.getData()['name'];\r\n                        if (name && (name + '').trim().length > 0) {\r\n                            name = (name + '').trim().toLowerCase();\r\n                        } else {\r\n                            name = '';\r\n                        }\r\n\r\n                        return name;\r\n                    }\r\n                },\r\n                line: {\r\n                    strokeOpacity: function () {\r\n                        return this.track.renderTrack.checked ? 1 : 0;\r\n                    }.bind(self),\r\n                    strokeWidth: 2,\r\n                    strokeColor: \"#00ced1\",\r\n                    lineDash: [.1, 6]\r\n                }\r\n            }\r\n        }).then(function (layer) {\r\n            self.layerTracking = layer;\r\n        });\r\n        map.addLayer({\r\n            id: self.getUID(),\r\n            type: TC.Consts.layerType.VECTOR,\r\n            owner: self,\r\n            stealth: true,\r\n            title: 'Posicionar.Track',\r\n            styles: {\r\n                line: {\r\n                    strokeWidth: 2,\r\n                    strokeColor: \"#C52737\"\r\n                },\r\n                point: {\r\n                    radius: function (feature) {\r\n                        var name = feature.getData()['name'];\r\n                        if (name && (name + '').trim().length > 0) {\r\n                            return 3;\r\n                        } else {\r\n                            return 6;\r\n                        }\r\n\r\n                        return 3;\r\n                    },\r\n                    fillColor: \"#C52737\",\r\n                    strokeColor: \"#ffffff\",\r\n                    fontColor: \"#C52737\",\r\n                    fontSize: 10,\r\n                    labelOutlineColor: \"#ffffff\",\r\n                    labelOutlineWidth: 2,\r\n                    label: function (feature) {\r\n                        var name = feature.getData()['name'];\r\n                        if (name && (name + '').trim().length > 0) {\r\n                            name = (name + '').trim().toLowerCase();\r\n                        } else {\r\n                            name = '';\r\n                        }\r\n\r\n                        return name;\r\n                    }\r\n                }\r\n            }\r\n        }).then(function (layer) {\r\n            self.layerTrack = layer;\r\n        });\r\n\r\n        map.on(TC.Consts.event.FEATURESIMPORT, function (e) {\r\n            const self = this;\r\n\r\n            const featuresImport = function (e) {\r\n                const fileName = e.fileName;\r\n                const target = e.dropTarget;\r\n                var kmlPattern = '.' + TC.Consts.format.KML.toLowerCase();\r\n                var gpxPattern = '.' + TC.Consts.format.GPX.toLowerCase();\r\n\r\n                // GLS: es un GPX?\r\n                if (fileName.toLowerCase().indexOf(gpxPattern) === fileName.length - gpxPattern.length ||\r\n                    // GLS: es un KML y viene desde el upload de Geolocation?\r\n                    (fileName.toLowerCase().indexOf(kmlPattern) === fileName.length - kmlPattern.length && target === self)) {\r\n\r\n                    self.clear(self.Const.Layers.TRACK);\r\n                    self.importTrack(e);\r\n\r\n                    if (/.kml$/g.test(fileName.toLowerCase()) && self.layerTrack) {\r\n                        if (self.layerTrack.styles) {\r\n                            self.layerTrack.features.forEach(function (feature) {\r\n                                if (feature instanceof TC.feature.Point && self.layerTrack.styles.point) {\r\n                                    feature.setStyle(self.layerTrack.styles.point);\r\n                                } else if (feature instanceof TC.feature.Polyline && self.layerTrack.styles.line) {\r\n                                    feature.setStyle(self.layerTrack.styles.line);\r\n                                }\r\n                            });\r\n                        }\r\n                    }\r\n                } else {\r\n                    //GLS: si es un KML pero viene desde el mapa o es otro tipo de archivo que no es ni GPX ni KML, lo ignoramos\r\n                    return;\r\n                }\r\n            };\r\n\r\n            if (self.working && TC.Util.isFunction(self.working.then)) {\r\n                self.working.then(featuresImport(e));\r\n            } else {\r\n                self.working = true;\r\n                featuresImport(e);\r\n            }\r\n\r\n        }.bind(self));\r\n\r\n        map.on(TC.Consts.event.PROJECTIONCHANGE, function (e) {\r\n            if (self.elevationChartData) {\r\n                self.elevationChartData.coords = TC.Util.reproject(self.elevationChartData.coords, e.oldCrs, e.newCrs);\r\n            }\r\n        });\r\n\r\n        map.on(TC.Consts.event.DIALOG, function (e) {\r\n            if (e.control) {\r\n                self.onShowDownloadDialog(e.control.caller);\r\n            }\r\n        });\r\n\r\n        return result;\r\n    };\r\n\r\n    ctlProto.render = function (callback) {\r\n        const self = this;\r\n        return self.getRenderedHtml(self.CLASS + '-dialog', null, function (html) {\r\n            self._dialogDiv.innerHTML = html;\r\n        }).then(function () {\r\n            return self.getDownloadDialog().then(() => {\r\n                self._downloadDialog.caller = self;\r\n                self.getRenderedHtml(self.CLASS + '-ext-dldlog', { controlId: self.id }, function (html) {\r\n                    var template = document.createElement('template');\r\n                    template.innerHTML = html;\r\n                    self._downloadDialogExtNode = template.content ? template.content.firstChild : template.firstChild;\r\n                    return self.renderData({ controlId: self.id }, callback);\r\n                });\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.importTrack = function (options) {\r\n        var self = this;\r\n\r\n        self.map.off(TC.Consts.event.FEATUREREMOVE, onFeatureRemove);\r\n\r\n        if (!self.isDisabled) {\r\n            if (options.fileName && options.features && options.features.length > 0) {\r\n\r\n                var wait = self.getLoadingIndicator().addWait();\r\n                self.importedFileName = options.fileName;\r\n                const addPromises = [];\r\n                for (var i = 0, len = options.features.length; i < len; i++) {\r\n                    addPromises.push(self.layerTrack.addFeature(options.features[i]));\r\n                }\r\n                Promise.all(addPromises).then(function () {\r\n\r\n                    self.wrap.processImportedFeatures({ wait: wait, notReproject: options.notReproject });\r\n\r\n                    if (self.layerTrack) { // Si tenemos capa es que todo ha ido bien y gestionamos el despliegue del control\r\n                        // Desplegamos el control \"ubicar\" al importar mediante drag&drop\r\n                        if (self.map && self.map.layout && self.map.layout.accordion) {\r\n                            if (self.div.classList.contains(TC.Consts.classes.COLLAPSED)) {\r\n                                self.map.controls\r\n                                    .filter(function (ctl) {\r\n                                        // Todos los otros controles que no cuelgan de otro control\r\n                                        return ctl !== self && !ctl.containerControl;\r\n                                    })\r\n                                    .forEach(function (ctl) {\r\n                                        ctl.div.classList.add(TC.Consts.classes.COLLAPSED);\r\n                                    });\r\n                            }\r\n                        }\r\n\r\n                        self.div.classList.remove(TC.Consts.classes.COLLAPSED);\r\n                        self.div.querySelector('.' + self.CLASS + '-btn-tracks > span').click();\r\n\r\n                        if (!options.isShared) {\r\n                            // abrimos el panel de herramientas\r\n                            self.map.trigger(TC.Consts.event.TOOLSOPEN);\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n        } else if (/.gpx$/g.test(options.fileName.toLowerCase())) {\r\n            self.map.toast(self.getLocaleString(\"geo.trk.import.disabled\"), { type: TC.Consts.msgType.WARNING });\r\n        }\r\n    };\r\n\r\n    ctlProto.prepareFeaturesToShare = function (trackUid) {\r\n        const self = this;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            if (trackUid) {\r\n\r\n                var storageData = self.availableTracks.filter(function (saved) {\r\n                    return saved.uid.toString() === trackUid.toString();\r\n                })[0].data;\r\n\r\n                // Aplicamos una precisin un dgito mayor que la del mapa, si no, al compartir algunas parcelas se deforman demasiado\r\n                var precision = Math.pow(10, TC.Consts.DEGREE_PRECISION + 1);\r\n\r\n                var storageFeatures = new ol.format.GeoJSON().readFeatures(storageData);\r\n                const promises = new Array(storageFeatures.length);\r\n                storageFeatures.forEach(function (f, idx) {\r\n                    promises[idx] = TC.wrap.Feature.createFeature(f);\r\n                });\r\n\r\n                Promise.all(promises).then(function (tcFeatures) {\r\n                    self.featuresToShare = tcFeatures.map(function (f) {\r\n                        const fObj = {};\r\n                        var layerStyle;\r\n                        switch (true) {\r\n                            case TC.feature.Marker && f instanceof TC.feature.Marker:\r\n                                fObj.type = TC.Consts.geom.MARKER;\r\n                                break;\r\n                            case TC.feature.Point && f instanceof TC.feature.Point:\r\n                                fObj.type = TC.Consts.geom.POINT;\r\n                                break;\r\n                            case TC.feature.Polyline && f instanceof TC.feature.Polyline:\r\n                                fObj.type = TC.Consts.geom.POLYLINE;\r\n                                break;\r\n                            case TC.feature.MultiPolyline && f instanceof TC.feature.MultiPolyline:\r\n                                fObj.type = TC.Consts.geom.MULTIPOLYLINE;\r\n                                break;\r\n                        }\r\n                        fObj.id = f.id;\r\n                        fObj.geom = TC.Util.compactGeometry(f.geometry, precision);\r\n                        fObj.data = f.getData();\r\n\r\n                        return fObj;\r\n                    });\r\n\r\n                    resolve();\r\n                });\r\n            } else {\r\n                resolve();\r\n            }\r\n        });\r\n\r\n\r\n    };\r\n\r\n    const getDownloadFileName = function (elem) {\r\n        const self = this;\r\n        var filename = elem.querySelector('span').textContent;\r\n        var regex = new RegExp(self.Const.SupportedFileExtensions.join('|'), 'gi');\r\n        return filename.replace(regex, '') + \"_\" + TC.Util.getFormattedDate(new Date(), true);\r\n    };\r\n\r\n    const getElevationFromService = async function (feature) {\r\n        const self = this;\r\n        let cachedFeature = getElevationFromServiceOnCache(feature);\r\n        if (cachedFeature) {\r\n            console.log('Tengo datos en cache');\r\n            return cachedFeature.data;\r\n        } else {\r\n            console.log('NO tengo datos en cache');\r\n            const tool = await self.getElevationTool();\r\n            if (tool) {\r\n                let cloned = feature.clone();\r\n                try {\r\n                    let toDownload = await tool.setGeometry({ features: [cloned], crs: self.map.crs });\r\n                    cacheElevationFromService(feature, toDownload[0]);\r\n                    return toDownload[0];\r\n                } catch (e) {\r\n                    return null;\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\n    var interpolationPanel = null; /* tengo que dejar fuera la vble porque con const y let dentro del bloque una vez cerrado el modal no funciona. \r\n    Ejecuta la intruccin pero no produce cambios en el HTML, es como si se quedase alguna referencia interna pocha */\r\n    var checkboxElevations = null; /* pasa lo mismo que con el panel ??? */\r\n    ctlProto.onShowDownloadDialog = function (caller, allFeatures) {\r\n        const self = this;\r\n        const originalDialogFeatures = self._downloadDialog.getFeatures();\r\n\r\n        // llega desde el panel del perfil del track: hacemos que el dilogo sea igual que cuando llega desde la lista aunque lo invoque featureTools\r\n        if (caller !== self && self._downloadDialog.getFeatures().every(f => f && f.layer === self.layerTrack)) {\r\n            let currentOptions = self._downloadDialog.getOptions();\r\n            let controlOptions = self.getDownloadDialogOptions();\r\n            currentOptions.elevation = controlOptions.elevation;            \r\n            delete currentOptions.openCallback;            \r\n\r\n            self._downloadDialog.open(self._downloadDialog.getFeatures(), currentOptions);\r\n        }\r\n\r\n        // normalizamos el nombre del archivo de la descarga\r\n        if (originalDialogFeatures.length === 1 && originalDialogFeatures.every((f) => f && f.fileName)) {\r\n            self._downloadDialog.setOptions({ fileName: originalDialogFeatures[0].fileName });\r\n        }\r\n\r\n        // si no tenemos configurada la opcin del perfil desde MDT retornamos sin gestionar nada ms\r\n        if (!self.options.displayElevation) {\r\n            return;\r\n        }\r\n\r\n        // llega desde la lista de tracks || llega desde el panel del perfil de un track \r\n        if (caller === self || self._downloadDialog.getFeatures().every(f => f && f.layer === self.layerTrack)) {\r\n            if (!self._downloadDialog.modalBody.querySelector('.' + self.CLASS + \"-ext-dldlog\")) {\r\n                let divToExtensions = self._downloadDialog.modalBody.querySelector('.' + self._downloadDialog.CLASS + \"-ext\");\r\n                if (divToExtensions) {\r\n                    divToExtensions.appendChild(self._downloadDialogExtNode);\r\n\r\n                    checkboxElevations = self._downloadDialog.modalBody.querySelector('.' + self._downloadDialog.CLASS + \"-elev input[type='checkbox']\");\r\n                    interpolationPanel = self._downloadDialog.modalBody.querySelector('.' + self._downloadDialog.CLASS + \"-ip\");\r\n                    const radioDlSource = self._downloadDialog.modalBody.querySelectorAll(`input[type=radio][name=\"${self.id}-dldlog-source\"]`);\r\n\r\n                    // si el track no tiene elevaciones y solo contamos con las del MDT ocultamos el botn de descargar originales                    \r\n                    const disableOriginalsRadio = function (condition) {\r\n                        const originalsRadio = radioDlSource[0];\r\n                        if (condition) {\r\n                            if (!originalsRadio.classList.contains(TC.Consts.classes.DISABLED)) {\r\n                                originalsRadio.classList.add(TC.Consts.classes.DISABLED);\r\n                            }\r\n                        } else {\r\n                            originalsRadio.classList.remove(TC.Consts.classes.DISABLED);\r\n                        }\r\n                    };\r\n                    let feature = originalDialogFeatures.filter((feat) => {\n                        return TC.feature.Polyline && feat instanceof TC.feature.Polyline;\n                    })[0];\r\n                    let coord = feature.geometry[0];\r\n                    let noZ = feature.geometry[0].length === 2;\r\n                    if (noZ) {\r\n                        disableOriginalsRadio(noZ);\r\n                    } else if (feature.geometry[0].length > 2) {\r\n                        disableOriginalsRadio(feature.geometry.map((c) => c[2]).every((val) => val === 0));\r\n                    }\r\n\r\n\r\n                    const interpolationPanelIsHidden = function () {\r\n                        return interpolationPanel && interpolationPanel.classList.contains(TC.Consts.classes.HIDDEN);\r\n                    };\r\n                    const setInterpolationPanelVisibility = function () {\r\n                        if (radioDlSource[0].checked && !interpolationPanelIsHidden()) {\r\n                            interpolationPanel.classList.add(TC.Consts.classes.HIDDEN);\r\n                        } else if (radioDlSource[0].checked) {\r\n                            let observer = new MutationObserver(function (mutations) {\r\n                                mutations.filter(m => m.attributeName === \"class\").forEach(function (mutation) {\r\n                                    if (mutation.oldValue.indexOf(TC.Consts.classes.HIDDEN) > -1) {\r\n                                        if (radioDlSource[0].checked) {\r\n                                            interpolationPanel.classList.add(TC.Consts.classes.HIDDEN);\r\n                                            observer.disconnect();\r\n                                        } else {\r\n                                            observer.disconnect();\r\n                                        }\r\n                                    }\r\n                                });\r\n                            });\r\n\r\n                            let config = { attributes: true, attributeOldValue: true };\r\n                            observer.observe(interpolationPanel, config);\r\n                        } else {\r\n                            if (interpolationPanelIsHidden() && checkboxElevations.checked) {\r\n                                interpolationPanel.classList.remove(TC.Consts.classes.HIDDEN);\r\n                            }\r\n                        }\r\n                    };\r\n\r\n                    if (checkboxElevations) {\r\n                        if (checkboxElevations.checked) {\r\n                            setInterpolationPanelVisibility();\r\n                            self._downloadDialogExtNode.classList.remove(TC.Consts.classes.HIDDEN);\r\n                        } else if (!self._downloadDialogExtNode.classList.contains(TC.Consts.classes.HIDDEN)) {\r\n                            self._downloadDialogExtNode.classList.add(TC.Consts.classes.HIDDEN);\r\n                        }\r\n                        checkboxElevations.addEventListener(\"change\", function () {\r\n                            setInterpolationPanelVisibility();\r\n                            self._downloadDialogExtNode.classList.toggle(TC.Consts.classes.HIDDEN);\r\n                        });\r\n                    }\r\n\r\n                    if (radioDlSource) {\r\n                        setInterpolationPanelVisibility();\r\n                        radioDlSource.forEach(item => {\r\n                            if (item.dataset.hasChangeEvent) {\r\n                                return;\r\n                            }\r\n                            item.dataset.hasChangeEvent = true;\r\n                            item.addEventListener(\"change\", async function (e) {\r\n                                if (e.target.checked) {\r\n                                    setInterpolationPanelVisibility();\r\n                                    let featuresToDownload;\r\n                                    if (e.target.value === \"track\") {\r\n                                        featuresToDownload = originalDialogFeatures;\r\n                                    } else {\r\n                                        let featuresFromDialog = originalDialogFeatures;\r\n                                        let feature = featuresFromDialog.filter((feat) => {\r\n                                            return TC.feature.Polyline && feat instanceof TC.feature.Polyline;\r\n                                        })[0];\r\n\r\n                                        if (allFeatures) {\r\n                                            featuresToDownload = featuresFromDialog.filter((feat) => {\r\n                                                return TC.feature.Point && feat instanceof TC.feature.Point;\r\n                                            });\r\n                                        }\r\n\r\n                                        let uid = feature.uid;\r\n                                        let cachedProfile = getElevationProfileFromCache(uid);\r\n                                        if (cachedProfile) {\r\n                                            // Clonamos la feature para presevar la geometra original por si el usuario cambia de nuevo a track\r\n                                            let toDownload = feature.clone();\r\n                                            toDownload.setCoords(cachedProfile.data.elevationFromServiceChartData.elevCoords);\r\n                                            if (allFeatures) {\r\n                                                if (!featuresToDownload) {\r\n                                                    featuresToDownload = (getCurrentPoints.call(self) || []);\r\n                                                }\r\n                                                featuresToDownload.push(toDownload);\r\n                                            } else {\r\n                                                featuresToDownload = toDownload;\r\n                                            }\r\n                                        } else {\r\n                                            self._downloadDialog.modalBody.classList.add(TC.Consts.classes.LOADING);\r\n\r\n                                            let toDownload = await getElevationFromService.call(self, feature);\r\n                                            if (toDownload) {\r\n                                                if (allFeatures) {\r\n                                                    featuresToDownload.push(toDownload);\r\n                                                } else {\r\n                                                    featuresToDownload = toDownload;\r\n                                                }\r\n                                            } else {\r\n                                                self.map.toast(self.getLocaleString(\"elevation.error\"), { type: TC.Consts.msgType.ERROR, duration: 5000 });\r\n                                                radioDlSource[0].checked = true;\r\n                                            }\r\n\r\n                                            self._downloadDialog.modalBody.classList.remove(TC.Consts.classes.LOADING);\r\n                                        }\r\n                                    }\r\n\r\n                                    self._downloadDialog.setFeatures(featuresToDownload);\r\n                                }\r\n                            });\r\n                        });\r\n\r\n                        if (radioDlSource[0].classList.contains(TC.Consts.classes.DISABLED)) {\r\n                            const mdtRadio = radioDlSource[1];\r\n                            mdtRadio.checked = true;\r\n                            mdtRadio.dispatchEvent(new Event('change'));\r\n                        }\r\n                    }\r\n\r\n                    if (originalDialogFeatures.length === 1 && originalDialogFeatures[0].fileName) {\r\n                        self._downloadDialog.setOptions({ fileName: originalDialogFeatures[0].fileName });\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    ctlProto.getDownloadDialogOptions = function (fileName) {\r\n        const self = this;\r\n\r\n        const options = {\r\n            title: self.getLocaleString('download'),\r\n            fileName: fileName,\r\n            openCallback: function () {\r\n                self.onShowDownloadDialog(self, true);\r\n            }\r\n        };\r\n        if (self.options.displayElevation) {\r\n            options.elevation = {\r\n                resolution: (self.options.displayElevation && self.options.displayElevation.resolution) || (self.map.options.elevation && self.map.options.elevation.resolution) || 20,\r\n                sampleNumber: (self.options.displayElevation && self.options.displayElevation.sampleNumber) || (self.map.options.elevation && self.map.options.elevation.sampleNumber) || 0,\r\n                checked: true\r\n            };\r\n        } else {\r\n            options.elevation = {\r\n                checked: true\r\n            };\r\n        }        \r\n\r\n        return options;\r\n    };\r\n\r\n    var visibilityTrack = true;\r\n    ctlProto.renderData = function (data, callback) {\r\n        const self = this;\r\n\r\n        var sel = self.Const.Selector;\r\n\r\n        return TC.Control.prototype.renderData.call(self, data, function () {\r\n\r\n            const options = self.div.querySelectorAll(self._classSelector + '-panel');\r\n            self.div.querySelectorAll('.' + self.CLASS + '-select span').forEach(function (span) {\r\n                span.addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                    var label = e.target;\r\n                    while (label && label.tagName !== 'LABEL') {\r\n                        label = label.parentElement;\r\n                    }\r\n                    const newFormat = label.querySelector(`input[type=radio][name=\"${self.id}-mode\"]`).value;\r\n\r\n                    options.forEach(function (option) {\r\n                        option.classList.toggle(TC.Consts.classes.HIDDEN, !option.matches('.' + self.CLASS + '-' + newFormat));\r\n                    });\r\n                }, { passive: true });\r\n            });\r\n\r\n            self.track = {\r\n                activateButton: self.div.querySelector(self._classSelector + '-track-ui-activate'),\r\n                deactivateButton: self.div.querySelector(self._classSelector + '-track-ui-deactivate'),\r\n                trackSearch: self.div.querySelector(self._classSelector + '-track-available-srch'),\r\n                trackImportFile: self.div.querySelector(self._classSelector + '-track-import'),\r\n                trackSave: self.div.querySelector(self._classSelector + '-track-save'),\r\n                trackAdd: self.div.querySelector(self._classSelector + '-track-add-wpt'),\r\n                trackContinue: self._dialogDiv.querySelector('.tc-ctl-geolocation-track-continue'),\r\n                trackRenew: self._dialogDiv.querySelector('.tc-ctl-geolocation-track-new'),\r\n                trackClose: self._dialogDiv.querySelector('.tc-ctl-geolocation-continue-track-dialog button.tc-modal-close'),\r\n                //trackAddSegment: self.div.querySelector('#tc-ctl-geolocation-track-segment'),\r\n                trackAdvertisementOK: self._dialogDiv.querySelector('.tc-ctl-geolocation-track-advert-ok')\r\n            };\r\n\r\n            self.track.trackList = self.div.querySelector(self._classSelector + '-track-available-lst');\r\n\r\n            self.track.trackToolPanelOpened = self.div.querySelector('#tc-ctl-geolocation-track-panel-opened-' + self.id);\r\n\r\n            self.div.querySelector('.' + ctlProto.CLASS + '-track-panel-help').addEventListener('click', function () {\r\n                _showAlerMsg.call(self);\r\n            });\r\n\r\n            self.track.trackName = self.div.querySelector(self._classSelector + '-track-title');\r\n\r\n            self.track.trackWPT = self.div.querySelector(self._classSelector + '-track-waypoint');\r\n\r\n            if (TC.Util.detectMobile()) {\r\n                if (matchMedia('screen and (max-height: 50em) and (max-width: 50em)').matches)\r\n                    self.track.trackToolPanelOpened.checked = false;\r\n            }\r\n\r\n            if (window.File && window.FileReader && window.FileList && window.Blob) {\r\n                self.track.trackImportFile.disabled = false;\r\n                // GLS: Eliminamos el archivo subido, sin ello no podemos subir el mismo archivo seguido varias veces\r\n                self.track.trackImportFile.addEventListener(TC.Consts.event.CLICK, function (e) {\r\n                    // Envolvemos el input en un form\r\n                    const input = this;\r\n                    const form = document.createElement('form');\r\n                    const parent = input.parentElement;\r\n                    parent.insertBefore(form, input);\r\n                    form.appendChild(input);\r\n                    form.reset();\r\n                    // Desenvolvemos el input del form\r\n                    form.insertAdjacentElement('afterend', input);\r\n                    parent.removeChild(form);\r\n                }, { passive: true });\r\n\r\n                const _layerError = function () {\r\n                    self.map.off(TC.Consts.event.LAYERERROR, _layerError);\r\n                    self.clearFileInput(self.track.trackImportFile);\r\n\r\n                    TC.alert(self.getLocaleString(\"geo.trk.upload.error3\"));\r\n                };\r\n\r\n                self.track.trackImportFile.addEventListener('change', function (e) {\r\n                    if (!self._cleaning) { // Valido que el evento import no lo provoco yo al limpiar el fileinput (al limpiar se lanza el change)                        \r\n                        self.clear(self.Const.Layers.TRACK);\r\n\r\n                        if (self.map) {\r\n                            self.map.on(TC.Consts.event.LAYERERROR, _layerError);\r\n                            self.map.wrap.loadFiles(e.target.files, { control: self });\r\n                        }\r\n                    }\r\n                });\r\n            } else {\r\n                console.log('no es posible la importacin');\r\n            }\r\n\r\n            self.track.activateButton.addEventListener('click', function () {\r\n                self.activateTracking();\r\n                _activateTrackingBtns.call(self);\r\n\r\n            });\r\n            self.track.deactivateButton.addEventListener('click', function () {\r\n                self.deactivateTracking();\r\n                _deactivateTrackingBtns.call(self);\r\n            });\r\n\r\n            var _filter = function (searchTerm) {\r\n                searchTerm = searchTerm.toLowerCase();\r\n                //tc-ctl-geolocation-track-available-empty\r\n                const lis = Array.from(self.track.trackList.querySelectorAll('li'));\r\n                lis.forEach(function (li) {\r\n                    li.style.display = 'none';\r\n                });\r\n                const trackLis = lis.filter(function (li) {\r\n                    return li.matches('li:not([class]),li.' + self.Const.Classes.SELECTEDTRACK);\r\n                });\r\n\r\n                const searchIcon = self.div.querySelector(self._classSelector + '-track-search-icon');\r\n                if (searchTerm.length === 0) {\r\n                    trackLis.forEach(function (li) {\r\n                        li.style.display = '';\r\n                    });\r\n                    searchIcon.style.visibility = 'visible';\r\n                } else {\r\n                    searchIcon.style.visibility = 'hidden';\r\n                    var r = new RegExp(searchTerm, 'i');\r\n                    trackLis.forEach(function (li) {\r\n                        li.style.display = r.test(li.querySelector('span').textContent) ? '' : 'none';\r\n                    });\r\n\r\n                    if (!trackLis.some(function (li) {\r\n                        return li.style.display === '';\r\n                    })) {\r\n                        lis.forEach(function (li) {\r\n                            if (li.matches('[class^=\"tc-ctl-geolocation-track-not\"]')) {\r\n                                li.style.display = '';\r\n                            }\r\n                        });\r\n                    }\r\n                }\r\n            };\r\n            const trackSearchListener = function () {\r\n                _filter(this.value.toLowerCase().trim());\r\n            };\r\n            self.track.trackSearch.addEventListener(\"keyup\", trackSearchListener);\r\n            self.track.trackSearch.addEventListener(\"search\", trackSearchListener);\r\n\r\n            // en el panel\r\n            self.track.trackSave.addEventListener('click', self.saveTrack.bind(self));\r\n            self.track.trackAdd.addEventListener('click', self.addWaypoint.bind(self));\r\n\r\n            const list = self.div.querySelector(self._classSelector + '-track-available-lst');\r\n\r\n            // en lista\r\n            var _edit = function (edit, elm) {\r\n                if (elm.tagName !== 'LI') {\r\n                    elm = elm.parentElement;\r\n                }\r\n\r\n                const input = elm.querySelector('input');\r\n                const span = elm.querySelector('span');\r\n\r\n                if (edit) {\r\n\r\n                    input.classList.remove(TC.Consts.classes.HIDDEN);\r\n                    input.focus();\r\n                    input.value = span.textContent;\r\n                    span.classList.add(TC.Consts.classes.HIDDEN);\r\n\r\n                    elm.querySelector(sel.SIMULATE).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.EDIT).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.DELETE).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.DRAW).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.EXPORT).classList.add(TC.Consts.classes.HIDDEN);\r\n\r\n                    elm.querySelector(sel.SAVE).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.CANCEL).classList.remove(TC.Consts.classes.HIDDEN);\r\n                } else {\r\n\r\n                    input.classList.add(TC.Consts.classes.HIDDEN);\r\n                    span.classList.remove(TC.Consts.classes.HIDDEN);\r\n\r\n                    elm.querySelector(sel.SIMULATE).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.EDIT).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.DELETE).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.DRAW).classList.remove(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.EXPORT).classList.remove(TC.Consts.classes.HIDDEN);\r\n\r\n                    elm.querySelector(sel.SAVE).classList.add(TC.Consts.classes.HIDDEN);\r\n                    elm.querySelector(sel.CANCEL).classList.add(TC.Consts.classes.HIDDEN);\r\n                }\r\n            };\r\n\r\n            self.uiSimulate = function (simulate, elm) {\r\n                if (elm) {\r\n                    var editControls = [\r\n                        sel.SIMULATE,\r\n                        sel.EDIT,\r\n                        sel.DELETE,\r\n                        sel.EXPORT\r\n                    ];\r\n                    var simulateControls = [\r\n                        sel.STOP,\r\n                        sel.PAUSE,\r\n                        sel.BACKWARD,\r\n                        sel.FORWARD,\r\n                        sel.SPEED\r\n                    ];\r\n                    var cnt = elm.tagName === 'LI' ? elm : elm.parentNode;\r\n\r\n                    editControls.forEach(function (ctl) {\r\n                        cnt.querySelector(ctl).hidden = simulate;\r\n                    });\r\n\r\n                    simulateControls.forEach(function (ctl) {\r\n                        cnt.querySelector(ctl).hidden = !simulate;\r\n                    });\r\n                }\r\n            };\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(sel.SIMULATE, function (e) {\r\n                var wait = self.getLoadingIndicator().addWait();\r\n\r\n                e.target.parentElement.querySelector(sel.SPEED).textContent = 'x 1';\r\n\r\n                _loadTrack(self, e.target).then(function () { //Para evitar el bloqueo de la interfaz en mviles\r\n                    self.getLoadingIndicator().removeWait(wait)\r\n                });\r\n            }));\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(sel.DRAW, function (e) {\r\n                var wait = self.getLoadingIndicator().addWait();\r\n\r\n                _drawTrack(self, e.target).then(function () {\r\n                    self.getLoadingIndicator().removeWait(wait);\r\n                });\r\n            }));\r\n\r\n            self.on(self.Const.Event.IMPORTEDTRACK, function (e) {\r\n                if (!self.isDisabled) {\r\n                    const listElement = self.track.trackList.querySelector('li[data-id=\"' + e.index + '\"]');\r\n                    _drawTrack(self, listElement.querySelector(sel.DRAW));\r\n                    setTimeout(function () {\r\n                        self.track.trackList.scrollTop = e.index * listElement.offsetHeight;\r\n                    }, 100);\r\n                } else {\r\n                    self.map.toast(self.getLocaleString(\"geo.trk.import.disabled\"), { type: TC.Consts.msgType.WARNING });\r\n                }\r\n            });\r\n\r\n            const _stopOtherTracks = function (self, trackLiId) {\r\n                self.track.trackList.querySelectorAll('li[data-id]').forEach(function (listItem) {\r\n                    if (listItem.dataset.id !== trackLiId) {\r\n                        const btnSimulate = listItem.querySelector(sel.SIMULATE);\r\n                        const btnPause = listItem.querySelector(sel.PAUSE);\r\n\r\n                        btnSimulate.classList.remove(self.Const.Classes.SIMULATIONACTIVATED);\r\n                        btnSimulate.setAttribute('title', self.getLocaleString(\"tr.lst.simulate\"));\r\n                        btnPause.classList.remove('play');\r\n                        btnPause.setAttribute('title', self.getLocaleString(\"tr.lst.pause\"));\r\n\r\n                        self.uiSimulate(false, listItem);\r\n                        _edit(false, listItem);\r\n                    }\r\n                });\r\n\r\n                self.clear(self.Const.Layers.TRACK);\r\n            };\r\n\r\n            var _drawTrack = function (self, btnDraw) {\r\n                return new Promise(function (resolve, reject) {\r\n\r\n                    const trackLi = btnDraw.parentElement;\r\n\r\n                    setTimeout(function () {\r\n                        if (trackLi.classList.contains(self.Const.Classes.SELECTEDTRACK)) {\r\n                            self.uiSimulate(false, btnDraw);\r\n\r\n                            self.clear(self.Const.Layers.TRACK);\r\n                            self.map.off(TC.Consts.event.FEATUREREMOVE, onFeatureRemove);\r\n\r\n                            btnDraw.setAttribute('title', btnDraw.textContent);\r\n                        }\r\n                        else if (self.getSelectedTrack()) { // GLS: si hay elemento seleccionado actuamos\r\n                            _stopOtherTracks(self, trackLi.dataset.id);\r\n                            self.working = self.drawTrack(trackLi);\r\n                        } else {\r\n                            self.working = self.drawTrack(trackLi);\r\n                        }\r\n\r\n                        /* GLS: 15/02/2019 Preparamos la feature por si se comparte, necesito hacerlo aqu \r\n                           porque la gestin en asncrona y todo el flujo de exportacin es sncrono */\r\n                        if (trackLi.classList.contains(self.Const.Classes.SELECTEDTRACK)) {\r\n                            self.prepareFeaturesToShare(trackLi.dataset.uid).then(function () {\r\n                                resolve();\r\n                            });\r\n                        } else {\r\n                            resolve();\r\n                        }\r\n                    }, 0);\r\n                });\r\n            };\r\n\r\n            var _loadTrack = function (self, btnSimulate) {\r\n                return new Promise(function (resolve, reject) {\r\n                    setTimeout(function () {\r\n                        const trackLi = btnSimulate.parentElement;\r\n\r\n                        _stopOtherTracks(self, trackLi.dataset.id);\r\n                        self.uiSimulate(false, self.getSelectedTrack());\r\n                        self.uiSimulate(true, btnSimulate);\r\n\r\n                        self.simulate_paused = false;\r\n                        self.simulateTrack(trackLi);\r\n\r\n                        resolve();\r\n                    }, 0);\r\n                });\r\n            };\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.EDIT, function (e) {\r\n                _edit(true, e.target);\r\n            }));\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.DELETE, function (e) {\r\n                self.removeTrack(e.target.parentElement);\r\n            }));\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.SAVE, function (e) {\r\n                var newName = e.target.parentElement.querySelector('input').value;\r\n                if (newName.trim().length === 0) {\r\n                    TC.alert(self.getLocaleString('geo.trk.edit.alert'));\r\n                }\r\n                else {\r\n                    self.editTrackName(e.target.parentElement.dataset.id, e.target.parentElement.querySelector('input').value);\r\n                    _edit(false, e.target);\r\n                }\r\n            }));\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.CANCEL, function (e) {\r\n                _edit(false, e.target);\r\n            }));\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.EXPORT, function (e) {\r\n                const parent = e.target.parentElement;\r\n                e.target.setAttribute('disabled', \"\");\r\n\r\n                self.export(parent).then((features) => {\r\n                    self.getDownloadDialog().then(function (dialog) {\r\n                        const options = self.getDownloadDialogOptions(getDownloadFileName.call(self, parent));\r\n                        dialog.open(features.map((f) => { f.uid = parent.dataset.uid; return f; }), options);\r\n\r\n                        e.target.removeAttribute('disabled');\r\n                    });\r\n                });\r\n            }));\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.STOP, function (e) {\r\n                self.uiSimulate(false, e.target);\r\n                self.wrap.simulateTrackEnd();\r\n                const btnPause = e.target.parentElement.querySelector(sel.PAUSE);\r\n                btnPause.classList.remove('play');\r\n                btnPause.setAttribute('title', self.getLocaleString('tr.lst.pause'));\r\n\r\n                e.target.parentElement.querySelector(sel.SPEED).textContent = 'x 1';\r\n                self.simulate_speed = 1;\r\n            }));\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.PAUSE, function (e) {\r\n                self.simulate_paused = !e.target.classList.contains('play');\r\n                if (self.simulate_paused)\r\n                    self.simulate_pausedElapse = -1;\r\n\r\n                e.target.setAttribute('title', self.getLocaleString(self.simulate_paused ? 'tr.lst.play' : 'tr.lst.pause'));\r\n                e.target.classList.toggle('play', !!self.simulate_paused);\r\n            }));\r\n\r\n            var lapse = 0.5;\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.BACKWARD, function (e) {\r\n                if (self.simulate_speed == 1)\r\n                    self.simulate_speed = lapse;\r\n                else self.simulate_speed = self.simulate_speed / 2;\r\n\r\n                e.target.parentElement.querySelector(self._classSelector + \" \" + sel.FORWARD).disabled = false;\r\n\r\n                e.target.parentElement.querySelector(sel.SPEED).textContent = self.simulate_speed < 1 ? '/ ' + (1 / self.simulate_speed) : 'x ' + self.simulate_speed;\r\n\r\n                if (self.simulate_speed == 0.000244140625) {\r\n                    e.target.disabled = true;\r\n                }\r\n            }));\r\n\r\n            list.addEventListener('click', TC.EventTarget.listenerBySelector(self._classSelector + ' ' + sel.FORWARD, function (e) {\r\n                self.simulate_speed = self.simulate_speed / lapse;\r\n\r\n                e.target.parentElement.querySelector(sel.SPEED).textContent = self.simulate_speed < 1 ? '/ ' + (1 / self.simulate_speed) : 'x ' + self.simulate_speed;\r\n\r\n                e.target.parentElement.querySelector(self._classSelector + \" \" + sel.BACKWARD).disabled = false;\r\n\r\n                if (self.simulate_speed == 4096) {\r\n                    e.target.disabled = true;\r\n                }\r\n            }));\r\n\r\n\r\n            // popup\r\n            self.track.trackContinue.addEventListener('click', function () {\r\n                // cerramos popup y continuamos con el track de session y almacenando en session\r\n                TC.Util.closeModal();\r\n                // al obtener la posicin se almacena en session y continuamos almacenando en session mientras se mueve\r\n                _tracking.call(self);\r\n            });\r\n            self.track.trackRenew.addEventListener('click', function () {\r\n                // eliminamos el track actual de session - restablecemos el tracking\r\n                delete self.sessionTracking;\r\n                TC.Util.storage.setSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP, undefined);\r\n                localforage.removeItem(self.Const.LocalStorageKey.TRACKINGTEMP);\r\n                // cerramos el popup\r\n                TC.Util.closeModal();\r\n                // al obtener la posicin se almacena en session y continuamos almacenando en session mientras se mueve\r\n                _tracking.call(self);\r\n            });\r\n            self.track.trackClose.addEventListener('click', function () {\r\n                _deactivateTrackingBtns.call(self);\r\n            });\r\n            //self.track.trackAddSegment.addEventListener('click', function () {\r\n            //    TC.alert('pendiente');\r\n            //    // cerramos el popup\r\n            //    TC.Util.closeModal();\r\n            //});\r\n\r\n            // popup advertencia\r\n            self.track.trackAdvertisementOK.addEventListener('click', function () {\r\n\r\n                const checkboxes = document.body.querySelectorAll('input[name*=\"Advertisement\"]:checked');\r\n\r\n                if (checkboxes.length > 0) {\r\n                    const promise = new Promise(function (resolve, reject) {\r\n                        if (window.localforage)\r\n                            resolve();\r\n                        else {\r\n                            TC.loadJS(!window.localforage, [TC.Consts.url.LOCALFORAGE], function () {\r\n                                resolve();\r\n                            });\r\n                        }\r\n                    });\r\n\r\n                    promise.then(function () {\r\n                        localforage.setItem(checkboxes[0].getAttribute('name'), false);\r\n                    });\r\n                }\r\n\r\n                TC.Util.closeModal();\r\n            });\r\n\r\n            self.track.renderTrack = document.querySelector('#tc-ctl-geolocation-track-render-' + self.id);\r\n            self.track.renderTrack.addEventListener('change', function () {\r\n                if (self.track.activateButton.classList.contains(TC.Consts.classes.HIDDEN)) {\r\n                    self.layerTracking.setVisibility(this.checked);\r\n                }\r\n\r\n                visibilityTrack = this.checked;\r\n            });\r\n\r\n            if (window.localforage)\r\n                self.bindTracks();\r\n            else {\r\n                TC.loadJS(!window.localforage, [TC.Consts.url.LOCALFORAGE], function () {\r\n                    self.bindTracks();\r\n                });\r\n            }\r\n\r\n            if (TC.Util.isFunction(callback)) {\r\n                callback();\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.activate = function () {\r\n        //var self = this;\r\n        //TC.Control.prototype.activate.call(self);\r\n    };\r\n\r\n    ctlProto.deactivate = function () {\r\n        var self = this;\r\n\r\n        TC.Util.closeModal();\r\n        self.clearSelection();\r\n        self.deactivateTracking();\r\n        //TC.Control.prototype.deactivate.call(self);\r\n    };\r\n\r\n    var _activateTrackingBtns = function () {\r\n        var self = this;\r\n\r\n        self.track.activateButton.classList.add(TC.Consts.classes.HIDDEN);\r\n        self.track.deactivateButton.classList.remove(TC.Consts.classes.HIDDEN);\r\n    };\r\n\r\n    var _deactivateTrackingBtns = function () {\r\n        var self = this;\r\n\r\n        self.track.activateButton.classList.remove(TC.Consts.classes.HIDDEN);\r\n        self.track.deactivateButton.classList.add(TC.Consts.classes.HIDDEN);\r\n    };\r\n\r\n    var _showAlerMsg = function () {\r\n        var self = this;\r\n        self.map.toast(self.div.querySelector(\".alert-warning\").innerHTML, {\r\n            duration: 10000\r\n        });\r\n    };\r\n\r\n    ctlProto.markerStyle = {\r\n        radius: 7,\r\n        fillColor: [255, 0, 0, 100],\r\n        strokeColor: [255, 255, 255, 255],\r\n        strokeWidth: 2\r\n    };\r\n\r\n    ctlProto.lineStyle = {\r\n        strokeWidth: 2,\r\n        strokeColor: [0, 206, 209, 255]\r\n    };\r\n\r\n    ctlProto.setFormatInfoNewPosition = function (newPosition) {\r\n        var self = this;\r\n\r\n        var data = {};\r\n        var locale = TC.Util.getMapLocale(self.map);\r\n\r\n        if (self.map.on3DView) {\r\n            var geoCoords = self.map.crs !== self.map.view3D.crs ? TC.Util.reproject(newPosition.position, self.map.crs, self.map.view3D.crs) : newPosition.position;\r\n            data.x = geoCoords[0].toLocaleString(locale);\r\n            data.y = geoCoords[1].toLocaleString(locale);\r\n\r\n            data.mdt = Math.round(self.map.view3D.getHeightFromMDT(geoCoords)).toLocaleString(locale);\r\n\r\n            data.isGeo = true;\r\n\r\n        } else {\r\n            data.x = Math.round(newPosition.position[0]).toLocaleString(locale);\r\n            data.y = Math.round(newPosition.position[1]).toLocaleString(locale);\r\n        }\r\n\r\n        data.z = (Math.round(newPosition.altitude).toLocaleString(locale));\r\n        data.accuracy = (Math.round(newPosition.accuracy).toLocaleString(locale));\r\n        data.speed = newPosition.speed.toLocaleString(locale, { minimumFractionDigits: 1, maximumFractionDigits: 1 });\r\n\r\n        return data;\r\n    };\r\n\r\n    ctlProto.getTrackInfoPanel = function () {\r\n        const self = this;\r\n        if (!self.track._infoPanelPromise) {\r\n            self.track._infoPanelPromise = new Promise(function (resolve, reject) {\r\n                if (!self.track.infoPanel) {\r\n\r\n                    var resultsPanelOptions = {\r\n                        content: \"table\",\r\n                        titles: {\r\n                            main: self.getLocaleString(\"geo.mylocation\"),\r\n                            max: self.getLocaleString(\"geo.mylocation.show\")\r\n                        },\r\n                        classes: {\r\n                            collapsed: \"tracking\"\r\n                        }\r\n                    };\r\n\r\n                    var ctlPromise;\r\n                    const addResultsPanelInfo = function (controlContainer) {\r\n                        resultsPanelOptions.position = controlContainer.POSITION.RIGHT;\r\n                        ctlPromise = controlContainer.addControl('resultsPanel', resultsPanelOptions);\r\n                    };\r\n\r\n                    if (self.options.displayOn) {\r\n                        var controlContainer = self.map.getControlsByClass('TC.control.' + self.options.displayOn[0].toUpperCase() + self.options.displayOn.substring(1))[0];\r\n                        if (!controlContainer) {\r\n                            self.map.addControl(self.options.displayOn).then(addResultsPanelInfo);\r\n                        } else {\r\n                            addResultsPanelInfo(controlContainer);\r\n                        }\r\n                    } else {\r\n                        resultsPanelOptions.div = document.createElement('div');\r\n                        self.map.div.appendChild(resultsPanelOptions.div);\r\n                        ctlPromise = self.map.addControl('resultsPanel', resultsPanelOptions);\r\n                    }\r\n\r\n                    ctlPromise.then(function (resultsPanelInfo) {\r\n                        self.track.infoPanel = resultsPanelInfo;\r\n                        resolve(resultsPanelInfo);\r\n                    });\r\n                } else {\r\n                    resolve(self.track.infoPanel);\r\n                }\r\n            });\r\n        }\r\n        return self.track._infoPanelPromise;\r\n    };\r\n\r\n    ctlProto.renderInfoNewPosition = function (d) {\r\n        const self = this;\r\n\r\n        self.getRenderedHtml(self.CLASS + '-tracking-toast', self.setFormatInfoNewPosition(d.pd), function (html) {\r\n            self.getTrackInfoPanel().then(function (infoPanel) {\r\n                if (!infoPanel.isMinimized()) {\r\n                    self.map.getControlsByClass(TC.control.ResultsPanel)\r\n                        .filter(panel => panel.content === panel.contentType.TABLE && panel !== infoPanel)\r\n                        .forEach(function (panel) {\r\n                            panel.close();\r\n                        });\r\n                    infoPanel.renderPromise().then(function () {\r\n                        infoPanel.open(html);\r\n                    });\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\n\r\n    var duringTrackingToolsPanel = function () {\r\n        var self = this;\r\n\r\n        if (!self.track.trackToolPanelOpened.checked) {\r\n            self.map.trigger(TC.Consts.event.TOOLSCLOSE);\r\n        }\r\n    };\r\n\r\n    var _tracking = function () {\r\n        var self = this;\r\n\r\n        self.activate();\r\n\r\n        _activateTrackingBtns.call(self);\r\n        duringTrackingToolsPanel.call(self);\r\n\r\n        self.on(self.Const.Event.POSITIONCHANGE, function (d) {\r\n\r\n            self.currentPoint = d.pd;\r\n            self.renderInfoNewPosition(d);\r\n\r\n            self.track.trackName.disabled = false;\r\n            self.track.trackSave.disabled = false;\r\n\r\n            self.track.trackWPT.disabled = false;\r\n            self.track.trackAdd.disabled = false;\r\n\r\n            // cada vez que se registra una nueva posicin almacenamos en sessionStorage\r\n            TC.Util.storage.setSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP, self.wrap.formattedToStorage(self.layerTracking).features);\r\n        });\r\n        self.on(self.Const.Event.STATEUPDATED, function (data) {\r\n            //self.track.htmlMarker.setAttribute('src', data.moving ? 'layout/idena/img/geo-marker-heading.png' : 'layout/idena/img/geo-marker.png');\r\n        });\r\n\r\n        self.clear(self.Const.Layers.TRACKING);\r\n\r\n        advertisement.call(self, self.Const.LocalStorageKey.TRACKINGSHOWADVERTISEMENT);\r\n\r\n        self.wrap.setTracking(true);\r\n    };\r\n\r\n    /* inicio gestin suspensin de la pantalla en mviles */\r\n    var _onpauseVideo;\r\n    var addVideoKeepScreenOn = function () {\r\n        var self = this;\r\n\r\n        if (!self.videoScreenOn) {\r\n            var media = {\r\n                WebM: \"data:video/webm;base64,GkXfo0AgQoaBAUL3gQFC8oEEQvOBCEKCQAR3ZWJtQoeBAkKFgQIYU4BnQI0VSalmQCgq17FAAw9CQE2AQAZ3aGFtbXlXQUAGd2hhbW15RIlACECPQAAAAAAAFlSua0AxrkAu14EBY8WBAZyBACK1nEADdW5khkAFVl9WUDglhohAA1ZQOIOBAeBABrCBCLqBCB9DtnVAIueBAKNAHIEAAIAwAQCdASoIAAgAAUAmJaQAA3AA/vz0AAA=\",\r\n                MP4: \"data:video/mp4;base64,AAAAHGZ0eXBpc29tAAACAGlzb21pc28ybXA0MQAAAAhmcmVlAAAAG21kYXQAAAGzABAHAAABthADAowdbb9/AAAC6W1vb3YAAABsbXZoZAAAAAB8JbCAfCWwgAAAA+gAAAAAAAEAAAEAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAIVdHJhawAAAFx0a2hkAAAAD3wlsIB8JbCAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAQAAAAAAIAAAACAAAAAABsW1kaWEAAAAgbWRoZAAAAAB8JbCAfCWwgAAAA+gAAAAAVcQAAAAAAC1oZGxyAAAAAAAAAAB2aWRlAAAAAAAAAAAAAAAAVmlkZW9IYW5kbGVyAAAAAVxtaW5mAAAAFHZtaGQAAAABAAAAAAAAAAAAAAAkZGluZgAAABxkcmVmAAAAAAAAAAEAAAAMdXJsIAAAAAEAAAEcc3RibAAAALhzdHNkAAAAAAAAAAEAAACobXA0dgAAAAAAAAABAAAAAAAAAAAAAAAAAAAAAAAIAAgASAAAAEgAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABj//wAAAFJlc2RzAAAAAANEAAEABDwgEQAAAAADDUAAAAAABS0AAAGwAQAAAbWJEwAAAQAAAAEgAMSNiB9FAEQBFGMAAAGyTGF2YzUyLjg3LjQGAQIAAAAYc3R0cwAAAAAAAAABAAAAAQAAAAAAAAAcc3RzYwAAAAAAAAABAAAAAQAAAAEAAAABAAAAFHN0c3oAAAAAAAAAEwAAAAEAAAAUc3RjbwAAAAAAAAABAAAALAAAAGB1ZHRhAAAAWG1ldGEAAAAAAAAAIWhkbHIAAAAAAAAAAG1kaXJhcHBsAAAAAAAAAAAAAAAAK2lsc3QAAAAjqXRvbwAAABtkYXRhAAAAAQAAAABMYXZmNTIuNzguMw==\"\r\n            };\r\n\r\n            self.videoScreenOn = document.createElement('video');\r\n            self.videoScreenOn.setAttribute(\"loop\", \"\");\r\n            self.videoScreenOn.setAttribute(\"muted\", \"\");\r\n            self.videoScreenOn.setAttribute(\"webkit-playsinline\", \"\");\r\n            self.videoScreenOn.setAttribute(\"playsinline\", \"\");\r\n            self.videoScreenOn.setAttribute(\"style\", \"transform: translateZ(0px);\");\r\n\r\n            var sourceWebM = document.createElement('source');\r\n            sourceWebM.src = media.WebM;\r\n            sourceWebM.type = \"video/webm\";\r\n            self.videoScreenOn.appendChild(sourceWebM);\r\n\r\n            var sourceMP4 = document.createElement('source');\r\n            sourceMP4.src = media.MP4;\r\n            sourceMP4.type = \"video/mp4\";\r\n            self.videoScreenOn.appendChild(sourceMP4);\r\n        }\r\n\r\n        self.videoScreenOn.play();\r\n    };\r\n    var removeVideoKeepScreenOn = function () {\r\n        var self = this;\r\n        if (self.videoScreenOn) {\r\n            self.videoScreenOn.pause();\r\n        }\r\n    };\r\n\r\n    var _onWindowBlurred;\r\n    var onWindowBlurred = function () {\r\n        var self = this;\r\n\r\n        fromSessionToStorage.apply(self);\r\n    };\r\n\r\n    var _onWindowFocused;\r\n    var onWindowFocused = function () {\r\n        var self = this;\r\n\r\n        if (self.videoScreenOn.paused)\r\n            self.videoScreenOn.play();\r\n\r\n        fromStorageToSession.apply(self);\r\n    };\r\n\r\n    var getHiddenProperty = function () {\r\n        var prefixes = ['webkit', 'moz', 'ms', 'o'];\r\n\r\n        if ('hidden' in document) return 'hidden';\r\n\r\n        for (var i = 0; i < prefixes.length; i++) {\r\n            if ((prefixes[i] + 'Hidden') in document)\r\n                return prefixes[i] + 'Hidden';\r\n        }\r\n\r\n        return null;\r\n    };\r\n    var _onWindowVisibility;\r\n    var onWindowVisibility = function () {\r\n        var self = this;\r\n\r\n        var hidden = getHiddenProperty();\r\n\r\n        if (!document[hidden])\r\n            onWindowFocused.apply(self);\r\n\r\n        console.log('video is: ' + self.videoScreenOn.paused);\r\n    };\r\n    var addWindowEvents = function () {\r\n        var self = this;\r\n\r\n        if (!_onWindowVisibility)\r\n            _onWindowVisibility = onWindowVisibility.bind(self);\r\n\r\n        if (!_onWindowBlurred)\r\n            _onWindowBlurred = onWindowBlurred.bind(self);\r\n\r\n        if (!_onWindowFocused)\r\n            _onWindowFocused = onWindowFocused.bind(self);\r\n\r\n        window.addEventListener('visibilitychange', _onWindowVisibility, false);\r\n\r\n        // ipad / iphone / ipod (Safari mobile, not Android default browsers not Chrome Mobile that is)\r\n        if (TC.Util.detectSafari() && TC.browserFeatures.touch() && !navigator.userAgent.match(/Android/i) && !navigator.userAgent.match(/CriOS/i)) {\r\n            window.addEventListener('pagehide', _onWindowBlurred, false);\r\n            window.addEventListener('pageshow', _onWindowFocused, false);\r\n        } else { // the rest            \r\n            window.addEventListener('blur', _onWindowBlurred, false);\r\n            window.addEventListener('focus', _onWindowFocused, false);\r\n        }\r\n    }\r\n    var removeWindowEvents = function () {\r\n\r\n        window.removeEventListener('visibilitychange', _onWindowVisibility, false);\r\n\r\n        // ipad / iphone / ipod (Safari mobile, not Android default browsers not Chrome Mobile that is)\r\n        if (TC.Util.detectSafari() && TC.browserFeatures.touch() && !navigator.userAgent.match(/Android/i) && !navigator.userAgent.match(/CriOS/i)) {\r\n            window.removeEventListener('pagehide', _onWindowBlurred, false);\r\n            window.removeEventListener('pageshow', _onWindowFocused, false);\r\n        } else { // the rest            \r\n            window.removeEventListener('blur', _onWindowBlurred, false);\r\n            window.removeEventListener('focus', _onWindowFocused, false);\r\n        }\r\n    };\r\n\r\n    var fromSessionToStorage = function () {\r\n        var self = this;\r\n\r\n        var sessionTracking = TC.Util.storage.getSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP);\r\n        if (sessionTracking && sessionTracking.length > 0)\r\n            localforage.setItem(self.Const.LocalStorageKey.TRACKINGTEMP, typeof (sessionTracking) === \"string\" ? sessionTracking : JSON.stringify(sessionTracking));\r\n    };\r\n    var fromStorageToSession = function () {\r\n        var self = this;\r\n\r\n        localforage.getItem(self.Const.LocalStorageKey.TRACKINGTEMP).then(function (storageData) {\r\n            if (storageData !== null && storageData !== \"null\" && storageData.length > 0) {\r\n                TC.Util.storage.setSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP, storageData);\r\n            }\r\n        });\r\n    };\r\n    /* final gestin suspensin de la pantalla en mviles */\r\n\r\n    var advertisement = function (showAdvertisement) {\r\n        var self = this;\r\n\r\n        var done = new Promise(function (resolve, reject) {\r\n            if (window.localforage)\r\n                resolve();\r\n            else {\r\n                TC.loadJS(!window.localforage, [TC.Consts.url.LOCALFORAGE], function () {\r\n                    resolve();\r\n                });\r\n            }\r\n        });\r\n\r\n        done.then(function () {\r\n            localforage.getItem(showAdvertisement).then(function (registeredShowAdvertisement) {\r\n                if (registeredShowAdvertisement == null) {\r\n                    const dialog = self._dialogDiv.querySelector('.tc-ctl-geolocation-track-advert-dialog');\r\n                    const checkbox = dialog.querySelector('input[type=\"checkbox\"]');\r\n                    checkbox.setAttribute('name', showAdvertisement);\r\n                    checkbox.checked = false;\r\n\r\n                    document.querySelector('#pageBlurMsg').textContent = TC.Util.detectMobile() ? self.getLocaleString('geo.trk.page.blur') : self.getLocaleString('geo.trk.page.blur.desktop');\r\n\r\n                    dialog.querySelector('h3').textContent = showAdvertisement == self.Const.LocalStorageKey.GPSSHOWADVERTISEMENT ?\r\n                        self.getLocaleString(\"geo.track.activate\") + \" \" + self.getLocaleString(\"geo.gps\") :\r\n                        self.getLocaleString('geo.track.activate.title');\r\n\r\n                    TC.Util.showModal(self._dialogDiv.querySelector('.tc-ctl-geolocation-track-advert-dialog'));\r\n                }\r\n            });\r\n        });\r\n\r\n        self.map.toast(!TC.Util.detectMobile() ? self.getLocaleString('geo.trk.page.blur.desktop') : self.getLocaleString('geo.trk.page.blur'), {\r\n            type: TC.Consts.msgType.WARNING\r\n        });\r\n    };\r\n\r\n    ctlProto._askTracking = function (callback) {\r\n        var self = this;\r\n\r\n        TC.Util.showModal(self._dialogDiv.querySelector('.tc-ctl-geolocation-continue-track-dialog'), {\r\n            closeCallback: function () {\r\n\r\n                if (TC.Util.isFunction(callback)) {\r\n                    callback();\r\n                }\r\n            }\r\n        });\r\n\r\n        return true;\r\n    };\r\n\r\n    ctlProto.activateTracking = function () {\r\n        var self = this;\r\n        var trackingAvailable = true;\r\n\r\n        if (!self.isActive) {\r\n            self.activate();\r\n        }\r\n\r\n        self.clear(self.Const.Layers.TRACKING);\r\n\r\n        try {\r\n            TC.Util.storage.setSessionLocalValue(self.Const.LocalStorageKey.TEST, self.Const.LocalStorageKey.TEST);\r\n        } catch (error) {\r\n            if (error.code === DOMException.QUOTA_EXCEEDED_ERR)\r\n                TC.alert(self.getLocaleString(\"geo.error.trackinglocalstorage\"));\r\n            else TC.error(error);\r\n\r\n            trackingAvailable = false;\r\n        }\r\n\r\n        if (trackingAvailable) {\r\n            addVideoKeepScreenOn.apply(self);\r\n            addWindowEvents.apply(self);\r\n\r\n            self.sessionTracking = TC.Util.storage.getSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP);\r\n            if (self.sessionTracking) {\r\n                var asked = self._askTracking(function () {\r\n                    _deactivateTrackingBtns.call(self);\r\n                });\r\n\r\n                if (!asked) {\r\n                    self.track.trackRenew.click();\r\n                }\r\n            } else _tracking.call(self);\r\n        } else { _deactivateTrackingBtns.call(self); }\r\n    };\r\n\r\n    ctlProto.deactivateTracking = function () {\r\n        var self = this;\r\n\r\n        var _deactivateTracking = function () {\r\n\r\n            self.getTrackInfoPanel().then(panel => panel.close());\r\n\r\n            fromSessionToStorage.apply(self);\r\n\r\n            self.wrap.setTracking(false);\r\n\r\n\r\n            delete self.geopositionTracking;\r\n\r\n            if (!visibilityTrack) {\r\n                self.div.querySelector(self._classSelector + '-track-render').querySelector('label').click();\r\n            }\r\n\r\n            removeVideoKeepScreenOn.apply(self);\r\n            removeWindowEvents.apply(self);\r\n\r\n            self.off(self.Const.Event.POSITIONCHANGE);\r\n            self.off(self.Const.Event.STATEUPDATED);\r\n\r\n            _deactivateTrackingBtns.call(self);\r\n\r\n            self.track.trackName.value = '';\r\n            self.track.trackName.disabled = true;\r\n            self.track.trackSave.disabled = true;\r\n\r\n            self.track.trackWPT.value = '';\r\n            self.track.trackWPT.disabled = true;\r\n            self.track.trackAdd.disabled = true;\r\n\r\n            self.clear(self.Const.Layers.TRACKING);\r\n            self.clear(self.Const.Layers.GPS);\r\n\r\n            //TC.Control.prototype.deactivate.call(self);\r\n\r\n            return true;\r\n        };\r\n\r\n        if (self.wrap.hasCoordinates()) {\r\n            self.map.toast(self.getLocaleString(\"geo.trk.deactivate.alert\"), {\r\n                duration: 10000\r\n            });\r\n            //TC.alert(self.getLocaleString(\"geo.trk.deactivate.alert\"));\r\n            return _deactivateTracking();\r\n        } else return _deactivateTracking();\r\n    };\r\n\r\n    /* Obtengo los tracks desde localForage */\r\n    ctlProto.getStoredTracks = function () {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            var tracks = [];\r\n\r\n            const onResolve = function (toResolve) {\r\n                // estamos en la carga inicial\r\n                if (elevationProfileCache.length === 0) {\r\n                    toResolve\r\n                        .filter(elm => { return elm.profile })\r\n                        .forEach((elm) => elevationProfileCache.push({ uid: elm.uid, data: JSON.parse(elm.profile) }));\r\n                }\r\n                resolve(toResolve);\r\n            };\r\n\r\n            localforage.keys()\r\n                .then(function (keys) {\r\n                    keys = keys.filter(function (k) {\r\n                        if (!(k.indexOf(self.Const.LocalStorageKey.TRACKINGTEMP) === 0) && k.indexOf(self.Const.LocalStorageKey.TRACKING) === 0) {\r\n                            return /trk#\\d/i.exec(k);\r\n                        }\r\n                        return false;\r\n                    });\r\n\r\n                    if (keys.length == 0) {\r\n                        self.availableTracks = tracks;\r\n                        onResolve(tracks);\r\n                    }\r\n\r\n                    const promises = new Array(keys.length);\r\n                    keys.forEach(function (key, idx) {\r\n                        promises[idx] = new Promise(function (res, rej) {\r\n                            localforage.getItem(key, function (e, v) {\r\n                                res(v);\r\n                            });\r\n                        });\r\n                    });\r\n\r\n                    Promise.all(promises).then(function (results) {\r\n                        if (results && results.length) {\r\n                            results.forEach(function (r) {\r\n                                var r = JSON.parse(r);\r\n                                if (r instanceof Array) {\r\n                                    tracks = tracks.concat(r);\r\n                                } else {\r\n                                    tracks.push(r);\r\n                                }\r\n                            });\r\n\r\n                            var tracksArray = tracks.length > 1 ? _orderTracks(tracks) : tracks;\r\n                            self.availableTracks = tracksArray;\r\n                            onResolve(tracksArray);\r\n                        }\r\n                    });\r\n                })\r\n                .catch((err) => {\r\n                    console.log('Capturamos error que se produce por configuracin del navegador.');\r\n                    TC.error(self.getLocaleString('couldNotAccessLocalStorage'));\r\n                });\r\n        });\r\n    };\r\n\r\n    /**\r\n     * Recibe una sucesin de tracks y la ordena por nombre.\r\n     */\r\n    var _orderTracks = function (tracks) {\r\n        var tracksArray = [];\r\n\r\n        for (var index in tracks) {\r\n            if (tracks[index] && typeof (tracks[index]) === \"object\") {\r\n                tracksArray.push(tracks[index]);\r\n                tracksArray.sort(function (a, b) {\r\n                    if (typeof (a.name) === \"string\") {\r\n                        return TC.Util.isFunction(a.name.localeCompare) ? a.name.localeCompare(b.name) : 0;\r\n                    } else { return 0; }\r\n                });\r\n            }\r\n        }\r\n\r\n        return tracksArray;\r\n    };\r\n\r\n    /* Almaceno los tracks mediante localForage, actualizo la vble availableTracks y actualizo la lista de tracks */\r\n    ctlProto.setStoredTracks = function (tracks) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            const promises = [];\r\n            tracks.forEach(function (t) {\r\n                promises.push(new Promise(function (res, rej) {\r\n                    localforage.setItem(self.Const.LocalStorageKey.TRACKING + \"#\" + t.uid, JSON.stringify(t), function (e, v) {\r\n                        res(v);\r\n                    });\r\n                }));\r\n            });\r\n\r\n            Promise.all(promises).then(function () {\r\n                self.getStoredTracks().then(function () {\r\n                    self.bindTracks();\r\n                    resolve();\r\n                });\r\n            });\r\n        });\r\n    };\r\n\r\n    /* Obtengo los tracks desde vble local */\r\n    ctlProto.getAvailableTracks = function () {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            if (!self.availableTracks) {\r\n                self.getStoredTracks().then(function (availableTracks) {\r\n                    resolve(availableTracks);\r\n                });\r\n            }\r\n            else {\r\n                resolve(self.availableTracks);\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.bindTracks = function () {\r\n        var self = this;\r\n\r\n        const listItems = self.track.trackList.querySelectorAll('li');\r\n        listItems.forEach(function (li) {\r\n            li.style.display = 'none';\r\n        });\r\n\r\n        self.getAvailableTracks().then(function (tracks) {\r\n\r\n            if (_isEmpty(tracks)) {\r\n                self.track.trackList.querySelectorAll('li[class^=\"tc-ctl-geolocation-track-available-empty\"]').forEach(function (li) {\r\n                    li.style.display = '';\r\n                });\r\n                self.track.trackSearch.disabled = true;\r\n            }\r\n            else {\r\n                const currentSelectedTrack = self.getSelectedTrack();\r\n                var currentSelectedTrackId;\r\n                if (currentSelectedTrack) {\r\n                    currentSelectedTrackId = currentSelectedTrack.dataset.uid\r\n                }\r\n                self.track.trackList.querySelectorAll('li[data-id]').forEach(function (li) {\r\n                    self.track.trackList.removeChild(li);\r\n                });\r\n\r\n                for (var i = 0; i < tracks.length; i++) {\r\n                    var t = tracks[i];\r\n                    if (typeof (t) === \"object\") {\r\n                        self.getRenderedHtml(self.CLASS + '-track-node', {\r\n                            id: i, uid: t.uid, name: t.name ? t.name.trim() : ''\r\n                        }, function (html) {\r\n                            const parser = new DOMParser();\r\n                            const newLi = parser.parseFromString(html, 'text/html').body.firstChild;\r\n                            self.track.trackList.appendChild(newLi);\r\n                        });\r\n                    }\r\n                }\r\n\r\n                if (currentSelectedTrackId) {\r\n                    self.setSelectedTrack(self.track.trackList.querySelector('li[data-uid=\"' + currentSelectedTrackId + '\"]'));\r\n                }\r\n\r\n                self.track.trackSearch.disabled = false;\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.chartProgressInit = function () {\r\n        const self = this;\r\n\r\n        if (!window.d3) {\r\n            TC.syncLoadJS(TC.Consts.url.D3C3);\r\n        }\r\n\r\n        const dataDiv = d3.select(\".c3-event-rects,.c3-event-rects-single\").node().getBoundingClientRect();\r\n        self.miDiv = document.createElement('div');\r\n        self.miDiv.classList.add('miDiv');\r\n        self.miDiv.style.width = dataDiv.width + 'px';\r\n        self.miDiv.style.height = dataDiv.height + 'px';\r\n\r\n        self.miProgressDiv = document.createElement('div');\r\n        self.miProgressDiv.classList.add(\r\n            'miProgressDiv',\r\n            self.CLASS + '-track-elevation-chart-progress',\r\n            TC.Consts.classes.HIDDEN);\r\n        self.miProgressDiv.style.width = '0%';\r\n        self.miProgressDiv.style.height = dataDiv.height + 'px';\r\n\r\n        self.miProgressTextDiv = document.createElement('div');\r\n        self.miProgressTextDiv.classList.add(\r\n            'miProgressTextDiv',\r\n            'tc-ctl-geolocation-track-elevation-chart-progress',\r\n            'text');\r\n        self.miProgressTextDiv.style.width = dataDiv.width + 'px';\r\n        self.miProgressTextDiv.style.height = dataDiv.height + 'px';\r\n\r\n        self.miDiv.style.top = dataDiv.top + 'px';\r\n        self.miDiv.style.left = dataDiv.left + 'px';\r\n        self.miDiv.style.bottom = dataDiv.bottom + 'px';\r\n        self.miDiv.style.right = dataDiv.right + 'px';\r\n        self.miDiv.style.position = 'absolute';\r\n        self.miDiv.style.zIndex = 10008;\r\n        self.miDiv.style.display = 'none';\r\n\r\n        self.miProgressDiv.appendChild(self.miProgressTextDiv);\r\n        self.miDiv.appendChild(self.miProgressDiv);\r\n        document.body.appendChild(self.miDiv);\r\n\r\n    };\r\n\r\n    ctlProto.chartProgressClear = function () {\r\n        const self = this;\r\n        if (self.miDiv) {\r\n            self.miDiv.parentElement.removeChild(self.miDiv);\r\n            self.miDiv = null;\r\n            self.miProgressDiv = null;\r\n            self.miProgressTextDiv = null;\r\n        }\r\n    };\r\n\r\n    ctlProto.chartSetProgress = function (previous, current, distance, doneTime) {\r\n        var self = this;\r\n\r\n        if (!self.resultsPanelChart.isVisible() || self.resultsPanelChart.isMinimized()) {\r\n            return;\r\n        }\r\n\r\n        if (self.miDiv && self.miDiv.style.display === 'none') {\r\n            self.miDiv.style.display = '';\r\n        }\r\n\r\n        self.miProgressDiv.classList.remove(TC.Consts.classes.HIDDEN);\r\n\r\n        var done = previous.d;\r\n        var progress = (done + Math.hypot(previous.p[0] - current[0], previous.p[1] - current[1])) / distance * 100;\r\n\r\n        self.miProgressDiv.style.width = progress + '%';\r\n\r\n        var locale = self.map.options.locale && self.map.options.locale.replace('_', '-') || undefined;\r\n        var ele = parseInt(current[2].toFixed(0)).toLocaleString(locale);\r\n        var dist;\r\n        var measure;\r\n        if ((done / 1000) < 1) {\r\n            dist = Math.round((done / 1000) * 1000);\r\n            measure = ' m';\r\n        } else {\r\n            dist = Math.round((done / 1000) * 100) / 100;\r\n            measure = ' km';\r\n        }\r\n\r\n        dist = dist.toLocaleString(locale);\r\n\r\n        let ele2;\r\n        let index = self.elevationChartData.coords.findIndex((p) => p.join() === current.join());\r\n        if (self.elevationChartData.elevationFromServiceChartData) {\r\n            ele2 = self.elevationChartData.elevationFromServiceChartData.ele[index];\r\n        }\r\n        self.miProgressTextDiv.innerHTML = '<div><span>' + ele + ' m' + (ele2 ? ' / ' + ele2 + ' m' : '') + '</span>' + '<br>' + '<span>' + dist + measure + '</span></div>' + (doneTime ? '<br><span>' + doneTime.toString + '</span>' : '');\r\n\r\n    };\r\n\r\n    ctlProto._getTime = function (timeFrom, timeTo) {\r\n        var diff = timeTo - timeFrom;\r\n        var d = {};\r\n        var daysDifference = Math.floor(diff / 1000 / 60 / 60 / 24);\r\n        diff -= daysDifference * 1000 * 60 * 60 * 24;\r\n\r\n        var hoursDifference = Math.floor(diff / 1000 / 60 / 60);\r\n        diff -= hoursDifference * 1000 * 60 * 60;\r\n\r\n        d.h = hoursDifference + (daysDifference * 24);\r\n\r\n        var minutesDifference = Math.floor(diff / 1000 / 60);\r\n        diff -= minutesDifference * 1000 * 60;\r\n\r\n        d.m = minutesDifference;\r\n\r\n        d.s = Math.floor(diff / 1000);\r\n\r\n        return TC.Util.extend({}, d, { toString: (\"00000\" + d.h).slice(-2) + ':' + (\"00000\" + d.m).slice(-2) + ':' + (\"00000\" + d.s).slice(-2) });\r\n    };\r\n\r\n    ctlProto.simulateTrack = function (li) {\r\n        var self = this;\r\n\r\n        self.simulate_speed = 1;\r\n\r\n        self.drawTrack(li, false).then(function () {\r\n            if (self.elevationChartData &&\r\n                self.elevationChartData.min === 0 &&\r\n                self.elevationChartData.max === 0) {   // no tenemos elevacin original\r\n                self.map.toast(self.getLocaleString(\"geo.trk.simulate.empty\"), { duration: 10000 });\r\n                self.resultsPanelChart.chart.chart.show('ele2', { withLegend: true });\r\n                self.hasElevation = false; // establecemos a false para que no muestra el progreso en el perfil ya que siempre ser elevacin 0\r\n            }\r\n\r\n            self.wrap.simulateTrack();\r\n        });\r\n    };\r\n\r\n    ctlProto.drawTrack = function (li, activateSnapping) {\r\n        var self = this;\r\n\r\n        duringTrackingToolsPanel.call(self);\r\n        return new Promise(function (resolve, reject) {\r\n            self.setSelectedTrack(li);\r\n            self.drawTrackingData(li).then(function () {\r\n                self.elevationTrack(li).then(() => {\r\n                    self.activate();\r\n\r\n                    resolve();\r\n                });\r\n            });\r\n        });\r\n    };\r\n\r\n    const elevationProfileCache = [];\r\n\r\n    const getElevationProfileFromCache = function (uid) {\r\n        return elevationProfileCache.filter(function (elm) {\r\n            return elm.uid.toString() === uid.toString();\r\n        })[0];\r\n    };\r\n\r\n    const cacheElevationProfile = function (feature, data, trackUID) {\r\n        const self = this;\r\n        var result = getElevationProfileFromCache(trackUID);\r\n        if (!result) {\r\n            result = {\r\n                uid: parseFloat(trackUID)\r\n            };\r\n            elevationProfileCache.push(result);\r\n            self.getAvailableTracks().then(function (tracks) {\r\n                if (tracks) {\r\n                    let index = tracks.findIndex((t) => { return t.uid.toString() === trackUID });\r\n                    if (index > -1) {\r\n                        tracks[index].profile = JSON.stringify(data);\r\n                        self.setStoredTracks(tracks);\r\n                    }\r\n                }\r\n            });\r\n        }\r\n        result.data = data;\r\n        return result;\r\n    };\r\n\r\n    const elevationFromServiceCache = [];\r\n\r\n    var arr_diff = function (a1, a2) {\r\n\r\n        var a = [], diff = [];\r\n\r\n        for (var i = 0; i < a1.length; i++) {\r\n            a[a1[i]] = true;\r\n        }\r\n\r\n        for (var i = 0; i < a2.length; i++) {\r\n            if (a[a2[i]]) {\r\n                delete a[a2[i]];\r\n            } else {\r\n                a[a2[i]] = true;\r\n            }\r\n        }\r\n\r\n        for (var k in a) {\r\n            diff.push(k);\r\n        }\r\n\r\n        return diff;\r\n    };\r\n\r\n    const getElevationFromServiceOnCache = function (feature) {\r\n        let isOnCache = elevationFromServiceCache.filter(function (elm) {\r\n            return elm.feature === feature;\r\n        })[0];\r\n        if (!isOnCache) {\r\n            return elevationFromServiceCache.filter(function (elm) {\r\n                return arr_diff(elm.feature.geometry, feature.geometry).length === 0;\r\n                //return elm.feature.geometry === feature.geometry; aunque sean iguales da falso ???\r\n            })[0];\r\n        } else {\r\n            return isOnCache;\r\n        }\r\n    };\r\n\r\n    const cacheElevationFromService = function (feature, data) {\r\n        var result = getElevationFromServiceOnCache(feature);\r\n        if (!result) {\r\n            result = {\r\n                feature: feature\r\n            };\r\n            elevationFromServiceCache.push(result);\r\n        }\r\n        result.data = data;\r\n        return result;\r\n    };\r\n    const isLine = function (feat) {\r\n        return TC.feature.Polyline && feat instanceof TC.feature.Polyline;\r\n    };\r\n    const getCurrentPolyline = function () {\r\n        return this.layerTrack.features\r\n            .filter(function (feat) {\r\n                return isLine(feat);\r\n            })[0];\r\n    };\r\n    const getCurrentPoints = function () {\r\n        return this.layerTrack.features\r\n            .filter(function (feat) { // filtrando por Point se cuelan los Marker\r\n                return TC.feature.Marker && !(feat instanceof TC.feature.Marker) &&\r\n                    !isLine(feat);\r\n            });\r\n    };\r\n    const calcDistance = function (point, idx, arr) {\r\n        const self = this;\r\n        let prev = idx === 0 ? point : arr[idx - 1];\r\n        if (self.map.crs !== self.map.options.utmCrs) {\r\n            point = TC.Util.reproject(point, self.map.crs, self.map.options.utmCrs);\r\n            prev = TC.Util.reproject(prev, self.map.crs, self.map.options.utmCrs);\r\n        }\r\n        const dx = point[0] - prev[0];\r\n        const dy = point[1] - prev[1];\r\n        return Math.sqrt(dx * dx + dy * dy);\r\n    };\r\n    const getFromElevationTool = function (coords) {\r\n        const self = this;\r\n\r\n        return new Promise(async (resolve, reject) => {\r\n            if (coords.length === 1) {\r\n                // Espera una lnea, metemos un segundo punto\r\n                coords = coords.slice();\r\n                coords.push(coords[0]);\r\n            }\r\n            const li = self.map.getLoadingIndicator();\r\n            const waitId = li && li.addWait();\r\n\r\n            if (!self.elevation) {\r\n                await self.getElevationTool();\r\n            }\r\n\r\n            const callback = function (elevCoords) {\r\n                console.log('Recibimos respuesta parcial');\r\n                if (elevCoords.every((ec) => ec.some((e) => e === null))) {\r\n                    console.log('Todas las elevaciones son null pasamos de repintar');\r\n                    return;\r\n                }\r\n\r\n                let distance = 0.0;\r\n                let maxElevation = Number.NEGATIVE_INFINITY;\r\n                let minElevation = Number.POSITIVE_INFINITY;\r\n                const profile = elevCoords\r\n                    .map(function (point, idx, arr) {\r\n                        distance += calcDistance.call(self, point, idx, arr);\r\n                        let ele = point[2];\r\n                        if (typeof ele === 'number') {\r\n                            maxElevation = Math.max(ele, maxElevation);\r\n                            minElevation = Math.min(ele, minElevation);\r\n                        }\r\n                        return [distance, ele];\r\n                    });\r\n\r\n                let elevationFromServiceProfileData = {\r\n                    ele: profile.map(function (elm) {\r\n                        return elm[1];\r\n                    }),\r\n                    type: 'area-spline',\r\n                    max: maxElevation,\r\n                    min: minElevation\r\n                };\r\n\r\n                self.elevationChartData.elevationFromServiceChartData = elevationFromServiceProfileData;\r\n\r\n                const elevationGainOptions = {\r\n                    coords: elevCoords\r\n                };\r\n                if (self.hillDeltaThreshold) {\r\n                    elevationGainOptions.hillDeltaThreshold = self.hillDeltaThreshold;\r\n                }\r\n                TC.Util.extend(self.elevationChartData.elevationFromServiceChartData, TC.tool.Elevation.getElevationGain(elevationGainOptions));\r\n\r\n                // Cacheamos las coordenadas con la elevacin del servicio\r\n                self.elevationChartData.elevationFromServiceChartData.elevCoords = elevCoords;\r\n                // Cacheamos el perfil -> ahora lo hacemos en el finally de la instruccin que invoca esta funcin\r\n                //cacheElevationProfile.call(self, getCurrentPolyline.call(self), self.elevationChartData);\r\n\r\n                self.resultsPanelChart.loadDataOnChart(self.elevationChartData);\r\n            };\r\n            self.elevation.getElevation({\r\n                crs: self.map.crs,\r\n                coordinates: coords,\r\n                resolution: 0,\r\n                partialCallback: callback\r\n            }).then(function (result) {\r\n                console.log('Recibimos respuesta final');\r\n                li && li.removeWait(waitId);\r\n                resolve();\r\n            }).catch(function (error) {\r\n                //self.resetElevationProfile();                \r\n                li && li.removeWait(waitId);\r\n                reject();\r\n            });\r\n        });\r\n    };\r\n\r\n    const getChartData = function (li) {\r\n        const self = this;\r\n\r\n        return new Promise(async function (resolve, reject) {\r\n            let matchingFeature = getCurrentPolyline.call(self);\r\n            let cachedProfile = getElevationProfileFromCache(li.dataset.uid);\r\n            if (!cachedProfile) {\r\n                const track = await self.getTrackingData(li);\r\n                if (track.data) {\r\n                    let geoJSON = track.data;\r\n\r\n                    const JSONParser = new TC.wrap.parser.JSON();\r\n                    let features = JSONParser.readFeatures(geoJSON).filter((f) => {\r\n                        return isLine(f) &&\r\n                            ((track.layout === ol.geom.GeometryLayout.XYZM ||\r\n                                track.layout === ol.geom.GeometryLayout.XYZ) || self.options.displayElevation)\r\n                    });\r\n\r\n                    if (features.length > 0) {\r\n                        let line = features[0];\r\n                        let time = {};\r\n                        // track con tiempo\r\n                        if (track.layout == ol.geom.GeometryLayout.XYZM ||\r\n                            track.layout == ol.geom.GeometryLayout.XYM) {\r\n                            let diff = 0;\r\n                            if (track.layout == ol.geom.GeometryLayout.XYZM) {\r\n                                diff = line.geometry[line.geometry.length - 1][3] - line.geometry[0][3];\r\n                            } else {\r\n                                diff = line.geometry[line.geometry.length - 1][2] - line.geometry[0][2];\r\n                            }\r\n                            time = {\r\n                                s: Math.floor((diff / 1000) % 60),\r\n                                m: Math.floor(((diff / (1000 * 60)) % 60)),\r\n                                h: Math.floor(((diff / (1000 * 60 * 60)) % 24))\r\n                            };\r\n                        }\r\n                        let distance = 0;\r\n                        const profile = line.geometry\r\n                            .map(function (point, idx, arr) {\r\n                                distance += calcDistance.call(self, point, idx, arr);\r\n                                return [distance, point[2]];\r\n                            });\r\n\r\n                        let elevationGain = TC.Util.getElevationGain({ coords: line.geometry, hillDeltaThreshold: self.hillDeltaThreshold });\r\n                        let elevations = profile.map((e) => {\r\n                            return e[1] || 0\r\n                        });\r\n                        self.elevationChartData = TC.Util.extend({}, {\r\n                            time: time,\r\n                            x: profile.map((p) => { return p[0] }),\r\n                            ele: elevations,\r\n                            min: Math.min(...elevations),\r\n                            max: Math.max(...elevations),\r\n                            coords: line.geometry\r\n                        }, elevationGain);\r\n\r\n                        if (self.options.displayElevation) {\r\n                            let wait = self.getLoadingIndicator().addWait();\r\n\r\n                            self.elevationChartData.showLegend = true;\r\n                            getFromElevationTool.call(self, line.geometry).then((result) => {\r\n                                //13/11/2020\r\n                                // Comentado con Carlos y Fer y no es necesario repintar al resolverse la promesa \r\n                                // porque con el ltimo partialCallback ya tenemos el resultado final\r\n                                // self.resultsPanelChart.loadDataOnChart(self.elevationChartData);\r\n                            }).catch((error) => {\r\n                                self.map.toast(self.getLocaleString(\"elevation.error\"), { type: TC.Consts.msgType.ERROR, duration: 5000 });\r\n                            }).finally(() => {\r\n                                cacheElevationProfile.call(self, matchingFeature, self.elevationChartData, li.dataset.uid);\r\n                                self.getLoadingIndicator().removeWait(wait);\r\n                            });\r\n\r\n                            resolve(self.elevationChartData);\r\n                        } else if (self.elevationChartData.min === 0 && self.elevationChartData.max === 0) {\r\n                            resolve(null);\r\n                        } else {\r\n                            resolve(self.elevationChartData);\r\n                        }\r\n                    } else {\r\n                        resolve(null);\r\n                    }\r\n                } else {\r\n                    resolve(null);\r\n                }\r\n            } else {\r\n                if (!self.options.displayElevation) {\r\n                    delete cachedProfile.data.elevationFromServiceChartData;\r\n                }\r\n                self.elevationChartData = cachedProfile.data;\r\n                resolve(self.elevationChartData);\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.elevationTrack = function (li, resized) {\r\n        var self = this;\r\n\r\n        return new Promise((resolve, reject) => {\r\n            const setCurrentFeature = function () {\r\n                if (self.resultsPanelChart) {\r\n                    self.resultsPanelChart.currentFeature = self.layerTrack.features.filter((feature) => {\r\n                        return !(TC.feature.Marker && feature instanceof TC.feature.Marker) && !(TC.feature.Point && feature instanceof TC.feature.Point)\r\n                    })[0];\r\n                    const currentSelectedTrack = self.getSelectedTrack();\r\n                    if (currentSelectedTrack) {\r\n                        self.resultsPanelChart.currentFeature.uid = currentSelectedTrack.dataset.uid;\r\n                        self.resultsPanelChart.currentFeature.fileName = getDownloadFileName.call(self, currentSelectedTrack);\r\n                    }\r\n                }\r\n            };\r\n\r\n            if (resized) {\r\n                self.wrap.simulateTrackEnd(resized);\r\n                self.uiSimulate(false, li);\r\n                return;\r\n            }\r\n\r\n            if (!self.onResize) {\r\n                self.onResize = self.elevationTrack.bind(self, li, true);\r\n                window.addEventListener(\"resize\", self.onResize, false);\r\n            }\r\n\r\n            if (self.track.elevationChart) {\r\n                self.track.elevationChart = self.track.elevationChart.destroy();\r\n            }\r\n\r\n            const resultsPanelChartData = function () {\r\n                getChartData.call(self, li).then(function (data) {\r\n                    if (data != null) {\r\n                        if (data.time) data.time = (\"00000\" + data.time.h).slice(-2) + ':' + (\"00000\" + data.time.m).slice(-2) + ':' + (\"00000\" + data.time.s).slice(-2);\r\n                        //data.coords = self.elevationChartData.coords;\r\n                        self.hasElevation = true;\r\n                    }\r\n                    else {\r\n                        self.hasElevation = false;\r\n                        data = {\r\n                            msg: self.getLocaleString(\"geo.trk.chart.chpe.empty\")\r\n                        };\r\n                    }\r\n\r\n                    data.minHeight = self.CHART_SIZE.MIN_HEIGHT;\r\n                    data.maxHeight = self.CHART_SIZE.MAX_HEIGHT;\r\n\r\n                    data.minWidth = self.CHART_SIZE.MIN_WIDTH;\r\n                    data.mediumWidth = self.CHART_SIZE.MEDIUM_WIDTH;\r\n                    data.maxWidth = self.CHART_SIZE.MAX_WIDTH;\r\n\r\n                    self.map.one(TC.Consts.event.DRAWCHART, function (e) {\r\n                        self.chartProgressInit();\r\n                        resolve();\r\n                    });\r\n\r\n                    // 10/02/2020 gestionamos el borrado desde featureTools\r\n                    onFeatureRemove = onFeatureRemove.bind(self);\r\n                    self.map.on(TC.Consts.event.FEATUREREMOVE, onFeatureRemove);\r\n\r\n                    self.map.trigger(self.Const.Event.DRAWTRACK, { data: data });\r\n                });\r\n            };\r\n\r\n            if (!self.resultsPanelChart) {\r\n\r\n                if (!window.c3) {\r\n                    TC.syncLoadJS(TC.Consts.url.D3C3 || TC.apiLocation + 'lib/d3c3/d3c3.min.js');\r\n                }\r\n\r\n                var resultsPanelOptions = {\r\n                    content: \"chart\",\r\n                    titles: {\r\n                        main: self.getLocaleString(\"geo.trk.chart.chpe\"),\r\n                        max: self.getLocaleString(\"geo.trk.chart.chpe\")\r\n                    },\r\n                    openOn: self.Const.Event.DRAWTRACK,\r\n                    closeOn: self.Const.Event.CLEARTRACK,\r\n                    chart: {\r\n                        ctx: self,\r\n                        onmouseout: ctlProto.removeElevationTooltip,\r\n                        tooltip: ctlProto.getElevationTooltip\r\n                    }\r\n                };\r\n\r\n                var ctlPromise;\r\n                const addResultsPanelChart = function (controlContainer) {\r\n                    resultsPanelOptions.position = controlContainer.POSITION.RIGHT;\r\n                    ctlPromise = controlContainer.addControl('resultsPanel', resultsPanelOptions);\r\n                };\r\n\r\n                if (self.options.displayOn) {\r\n                    var controlContainer = self.map.getControlsByClass('TC.control.' + self.options.displayOn[0].toUpperCase() + self.options.displayOn.substring(1))[0];\r\n                    if (!controlContainer) {\r\n                        self.map.addControl(self.options.displayOn).then(addResultsPanelChart);\r\n                    } else {\r\n                        addResultsPanelChart(controlContainer);\r\n                    }\r\n                } else {\r\n                    resultsPanelOptions.div = document.createElement('div');\r\n                    self.map.div.appendChild(resultsPanelOptions.div);\r\n                    ctlPromise = self.map.addControl('resultsPanel', resultsPanelOptions);\r\n                }\r\n\r\n                ctlPromise.then(function (resultsPanelChart) {\r\n                    resultsPanelChart.caller = self;\r\n                    self.resultsPanelChart = resultsPanelChart;\r\n\r\n                    setCurrentFeature();\r\n                    resultsPanelChart.renderPromise().then(function () {\r\n\r\n                        resultsPanelChart.activateSnapping = function (e) {\r\n                            if (self.layerTrack && (!self.layerTrack.getVisibility() && self.layerTrack.getOpacity() == 0))\r\n                                self.wrap.deactivateSnapping.call(self.wrap);\r\n                        };\r\n                        resultsPanelChart.deactivateSnapping = function (e) {\r\n                            if (self.layerTrack && self.layerTrack.getVisibility() && self.layerTrack.getOpacity() > 0)\r\n                                self.wrap.activateSnapping.call(self.wrap);\r\n                        };\r\n\r\n                        resultsPanelChart.div.addEventListener('mouseover', resultsPanelChart.deactivateSnapping);\r\n                        resultsPanelChart.div.addEventListener('mouseout', resultsPanelChart.activateSnapping);\r\n\r\n                        self.map\r\n                            .on(TC.Consts.event.RESULTSPANELMIN, function () {\r\n                                if (self.miDiv) {\r\n                                    self.miDiv.style.display = 'none';\r\n                                }\r\n                            })\r\n                            .on(TC.Consts.event.RESULTSPANELMAX, function () {\r\n                                if (self.miDiv) {\r\n                                    self.miDiv.style.display = 'none';\r\n                                }\r\n                            })\r\n                            .on(TC.Consts.event.RESULTSPANELCLOSE, function (e) {\r\n                                if (self.miDiv) {\r\n                                    self.miDiv.style.display = 'none';\r\n                                }\r\n                            });\r\n\r\n                        resultsPanelChartData();\r\n                    });\r\n                });\r\n            } else {\r\n                setCurrentFeature();\r\n                self.resultsPanelChart.open();\r\n                resultsPanelChartData();\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.clear = function (layerType) {\r\n        var self = this;\r\n\r\n        if (self.onResize) {\r\n            window.removeEventListener(\"resize\", self.onResize, false);\r\n            self.onResize = undefined;\r\n        }\r\n\r\n        if (layerType == self.Const.Layers.TRACK) {\r\n\r\n            self.layerTrack.clearFeatures();\r\n\r\n            // grfico perfil de elevacin\r\n            if (self.resultsPanelChart)\r\n                self.resultsPanelChart.close();\r\n            delete self.elevationChartData;\r\n\r\n            // overlay de la simulacin\r\n            self.wrap.simulateTrackEnd();\r\n\r\n            self.wrap.clear();\r\n\r\n            // eliminamos la seleccin en la lista de tracks\r\n            self.track.trackList.querySelectorAll('li').forEach(function (li) {\r\n                li.classList.remove(self.Const.Classes.SELECTEDTRACK);\r\n            });\r\n\r\n            self.map.trigger(self.Const.Event.CLEARTRACK);\r\n\r\n            self.featuresToShare = [];\r\n\r\n            //TC.Control.prototype.deactivate.call(self);\r\n\r\n        } else {\r\n            self.layerTracking.clearFeatures();\r\n            self.layerGPS.clearFeatures();\r\n        }\r\n    };\r\n\r\n    ctlProto.saveTrack = function (options) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            let message = options.message || self.getLocaleString(\"geo.trk.save.alert\");\r\n\r\n            var _save = function (layer) {\r\n                let wait;\r\n                wait = self.getLoadingIndicator().addWait();\r\n\r\n                let trackName = options.importedFileName || self.track.trackName.value.trim();\r\n\r\n                let tracks = self.availableTracks;\r\n                if (!tracks) {\r\n                    tracks = [];\r\n                }\r\n\r\n                let formatted = self.wrap.formattedToStorage(layer, true, options.notReproject);\r\n\r\n                let clean = function (wait) {\r\n                    self.track.trackName.value = '';\r\n                    self.track.trackName.disabled = true;\r\n                    self.track.trackSave.disabled = true;\r\n\r\n                    self.track.trackWPT.value = '';\r\n                    self.track.trackWPT.disabled = true;\r\n                    self.track.trackAdd.disabled = true;\r\n\r\n                    self.getLoadingIndicator().removeWait(wait);\r\n\r\n                    duringTrackingToolsPanel.call(self);\r\n                };\r\n\r\n                let newTrack = {\r\n                    name: trackName,\r\n                    data: formatted.features,\r\n                    layout: formatted.layout,\r\n                    crs: self.storageCRS\r\n                };\r\n\r\n                const getHashToCompare = function (trackObject) {\r\n                    // reemplazamos los ids contenidos en la geomtra que provocan falsos negativos.\r\n                    let toGetHash = JSON.parse(JSON.stringify(trackObject));\r\n                    const regex = /(\\\"id\\\"\\s?\\:\\s?\\\"[a-z0-9]+\\\")/gi;\n                    toGetHash.data = toGetHash.data.replace(regex, '\"\"');\r\n\r\n                    return hex_md5(JSON.stringify(toGetHash));                    \r\n                };\r\n\r\n                TC.loadJS(\r\n                    !window.hex_md5,\r\n                    [TC.apiLocation + TC.Consts.url.HASH],\r\n                    function () {\r\n                        let hash = getHashToCompare(newTrack);\r\n\r\n                        let sameTrackUID = tracks.map(function (savedTrack) {\r\n                            let clonedTrack = JSON.parse(JSON.stringify(savedTrack));\r\n                            delete clonedTrack.uid;\r\n                            delete clonedTrack.profile;                            \r\n\r\n                            if (hash === getHashToCompare(clonedTrack)) {\r\n                                return savedTrack.uid;\r\n                            } else {\r\n                                const jsonFormat = new ol.format.GeoJSON();\r\n                                // validamos si se trata de un track exportado/importado ya que se compacta la geometra\r\n                                let features = jsonFormat.readFeatures(clonedTrack.data);\r\n                                // Aplicamos una precisin un dgito mayor que la del mapa, si no, al compartir algunas parcelas se deforman demasiado\r\n                                let precision = Math.pow(10, TC.Consts.DEGREE_PRECISION + 1);\r\n\r\n                                features.forEach(function (feature) {\r\n                                    let geom = TC.Util.explodeGeometry(TC.Util.compactGeometry(feature.getGeometry().getCoordinates(), precision));\r\n                                    feature.getGeometry().setCoordinates(geom);\r\n                                });\r\n\r\n                                clonedTrack.data = jsonFormat.writeFeatures(features);\r\n\r\n                                if (hash === hex_md5(JSON.stringify(clonedTrack))) {\r\n                                    return savedTrack.uid;\r\n                                } else {\r\n                                    return null;\r\n                                }\r\n                            }\r\n\r\n                        }).filter(function (uid) {\r\n                            return uid !== null\r\n                        });\r\n\r\n                        const getTrackIndex = function (uid) {\r\n                            return self.getStoredTracks().then(function () {\r\n                                self.bindTracks();\r\n\r\n                                let index;\r\n                                for (var i = 0; i < self.availableTracks.length; i++) {\r\n                                    if (self.availableTracks[i].uid === uid) {\r\n                                        index = i;\r\n                                        break;\r\n                                    }\r\n                                }\r\n\r\n                                return index;\r\n                            });\r\n                        };\r\n\r\n                        if (sameTrackUID.length === 0) {\r\n                            newTrack.uid = Date.now() + Math.random();\r\n                            tracks.push(newTrack);\r\n                            tracks = _orderTracks(tracks);\r\n\r\n                            try {\r\n                                self.setStoredTracks(tracks).then(function () {\r\n                                    self.map.toast(message, { duration: 3000 });\r\n\r\n                                    clean(wait);\r\n\r\n                                    getTrackIndex(newTrack.uid).then(function (index) {\r\n                                        resolve(index);\r\n                                    });\r\n                                });\r\n\r\n                            } catch (error) {\r\n                                TC.alert(self.getLocaleString(\"geo.error.savelocalstorage\") + ': ' + error.message);\r\n                                clean(wait);\r\n                                reject(error);\r\n                            }\r\n                        } else {\r\n                            console.log('Ya existe un track con ese mismo hash');\r\n\r\n                            clean(wait);\r\n\r\n                            getTrackIndex(sameTrackUID[0]).then(function (index) {\r\n                                resolve(index);\r\n                            });\r\n                        }\r\n                    });\r\n\r\n            };\r\n\r\n            const createTCFeatures = function (features) {\r\n                return new Promise(function (resolve, reject) {\r\n                    var featurePromises = features.filter(function (feature) {\r\n                        return !feature._wrap;\r\n                    }).forEach(function (elm) {\r\n                        return TC.wrap.Feature.createFeature(elm);\r\n                    });\r\n\r\n                    Promise.all(featurePromises).then(function (tcFeatures) {\r\n                        resolve();\r\n                    });\r\n                });\r\n            };\r\n\r\n            if (self.importedFileName)\r\n                _save(self.layerTrack);\r\n            else if (self.track.trackName.value.trim().length == 0) {\r\n                self.track.trackName.value = new Date().toLocaleString();\r\n                _save(self.layerTracking);\r\n            }\r\n            else {\r\n                _save(self.layerTracking);\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.addWaypoint = function () {\r\n        var self = this;\r\n\r\n        var waypointName = self.track.trackWPT.value.trim();\r\n        if (!waypointName) {\r\n            waypointName = new Date().toLocaleString();\r\n        }\r\n\r\n        var wait = self.getLoadingIndicator().addWait();\r\n\r\n        duringTrackingToolsPanel.call(self);\r\n\r\n        self.wrap.addWaypoint(self.currentPoint.position, {\r\n            name: waypointName,\r\n            ele: self.currentPoint.heading,\r\n            time: new Date().getTime() // GLS: lo quito ya que hemos actualizado la funcin que gestiona la fechas para la exportacin a GPX - espera la fecha en segundos -> / 1000 // para la exportacin a GPX - espera la fecha en segundos\r\n        });\r\n\r\n        self.track.trackWPT.value = '';\r\n        self.track.trackWPT.disabled = true;\r\n        self.track.trackAdd.disabled = true;\r\n\r\n        // cada vez que se aade un waypoint almacenamos en sessionStorage\r\n        TC.Util.storage.setSessionLocalValue(self.Const.LocalStorageKey.TRACKINGTEMP, self.wrap.formattedToStorage(self.layerTracking).features);\r\n\r\n        self.getLoadingIndicator().removeWait(wait);\r\n    };\r\n\r\n    ctlProto.editTrackName = function (trackId, newName) {\r\n        var self = this;\r\n\r\n        self.getAvailableTracks().then(function (tracks) {\r\n            if (tracks) {\r\n                if (tracks[trackId]) {\r\n                    tracks[trackId].name = newName;\r\n\r\n                    self.setStoredTracks(tracks);\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.removeTrack = function (li) {\r\n        var self = this;\r\n\r\n        self.getAvailableTracks().then(function (tracks) {\r\n            if (tracks) {\r\n                var dataId = li.dataset.id;\r\n                if (tracks[dataId]) {\r\n                    var uid = tracks[dataId].uid;\r\n\r\n                    TC.confirm(self.getLocaleString(\"geo.trk.delete.alert\"), function () {\r\n\r\n                        const selectedTrack = self.getSelectedTrack();\r\n                        if (selectedTrack && selectedTrack.dataset.id === dataId) {\r\n                            self.clear(self.Const.Layers.TRACK);\r\n                        }\r\n\r\n                        localforage.removeItem(self.Const.LocalStorageKey.TRACKING + '#' + uid).then(function () {\r\n                            self.getStoredTracks().then(function () {\r\n                                self.bindTracks();\r\n                            });\r\n                        }).catch(function (err) {\r\n                            console.log(err);\r\n                        });\r\n\r\n                    }, function () { });\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.setSelectedTrack = function (li) {\r\n        var self = this;\r\n\r\n        if (!self.isActive) {\r\n            self.activate();\r\n        }\r\n\r\n        self.track.trackList.querySelectorAll('li[data-id] > span').forEach(function (span) {\r\n            span.setAttribute('title', span.textContent);\r\n        });\r\n        self.track.trackList.querySelectorAll('li').forEach(function (li) {\r\n            li.classList.remove(self.Const.Classes.SELECTEDTRACK);\r\n        });\r\n\r\n        li.classList.add(self.Const.Classes.SELECTEDTRACK);\r\n\r\n        li.setAttribute('title', self.getLocaleString(\"tr.lst.clear\") + \" \" + li.querySelector('span').textContent);\r\n        li.querySelector(self.Const.Selector.DRAW).setAttribute('title', li.getAttribute('title'));\r\n    };\r\n\r\n    ctlProto.getSelectedTrack = function () {\r\n        var self = this;\r\n\r\n        return self.track.trackList.querySelector('li.' + self.Const.Classes.SELECTEDTRACK);\r\n    };\r\n\r\n    ctlProto.clearSelectedTrack = function () {\r\n        const self = this;\r\n\r\n        const selected = self.getSelectedTrack();\r\n        if (selected) {\r\n\r\n            if (self.onResize) {\r\n                window.removeEventListener('resize', self.onResize, false);\r\n                self.onResize = undefined;\r\n            }\r\n\r\n            selected.classList.remove(self.Const.Classes.SELECTEDTRACK);\r\n            selected.setAttribute('title', selected.textContent);\r\n            selected.querySelector(self.Const.Selector.DRAW).setAttribute('title', selected.getAttribute('title'));\r\n        }\r\n    };\r\n\r\n    ctlProto.clearSelection = function () {\r\n        var self = this;\r\n        self.wrap.deactivateSnapping();\r\n        var selected = self.getSelectedTrack();\r\n        if (selected) {\r\n            self.clearSelectedTrack();\r\n        }\r\n        if (self.resultsPanelChart) {\r\n\r\n            self.resultsPanelChart.div.removeEventListener('mouseover', self.resultsPanelChart.deactivateSnapping);\r\n            self.resultsPanelChart.div.removeEventListener('mouseout', self.resultsPanelChart.activateSnapping);\r\n\r\n            self.resultsPanelChart.close();\r\n        }\r\n\r\n        self.clear(self.Const.Layers.TRACK);\r\n    };\r\n\r\n    ctlProto.drawTrackingData = function (li) {\r\n        const self = this;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            self.wrap.clear();\r\n\r\n            self.getTrackingData(li).then(function (track) {\r\n                var data = track.data;\r\n                if (track.data)\r\n                    self.wrap.drawTrackingData(track).then(function () {\r\n                        var showFeatures = self.layerTrack.features;\r\n                        if (showFeatures && showFeatures.length > 0) {\r\n\r\n                            var coordinates = showFeatures.filter(function (feature) {\r\n                                feature.showsPopup = false;\r\n                                if (TC.feature.MultiPolyline && feature instanceof TC.feature.MultiPolyline) {\r\n                                    return true;\r\n                                } else if (feature instanceof TC.feature.Polyline) {\r\n                                    return true;\r\n                                }\r\n                                return false;\r\n                            }).map(function (feature) {\r\n                                if (TC.feature.MultiPolyline && feature instanceof TC.feature.MultiPolyline) {\r\n                                    return feature.geometry[0];\r\n                                } else if (feature instanceof TC.feature.Polyline) {\r\n                                    return feature.geometry;\r\n                                }\r\n                            })[0];\r\n\r\n                            if (coordinates) {\r\n                                var first = coordinates[0];\r\n                                var last = coordinates[coordinates.length - 1];\r\n\r\n                                if (first && !(first === last)) {\r\n                                    self.layerTrack.addMarker(first.slice().splice(0, 2), {\r\n                                        showsPopup: false, cssClass: self.CLASS + '-track-marker-icon-end', anchor: [0.5, 1], notExport: true\r\n                                    });\r\n                                }\r\n\r\n                                if (last) {\r\n                                    self.layerTrack.addMarker(last.slice().splice(0, 2), {\r\n                                        showsPopup: false, cssClass: self.CLASS + '-track-marker-icon', anchor: [0.5, 1], notExport: true\r\n                                    });\r\n                                }\r\n                            }\r\n                        }\r\n                        self.layerTrack.setVisibility(true);\r\n                        resolve();\r\n                    });\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.getTrackingData = function (li) {\r\n        const self = this;\r\n        return new Promise(function (resolve, reject) {\r\n            self.getAvailableTracks().then(function (tracks) {\r\n                if (tracks) {\r\n                    const dataId = li.dataset.id;\r\n                    if (tracks[dataId]) {\r\n                        var track = tracks[dataId].data;\r\n\r\n                        // GLS: tengo que transformar de 4326 al crs del mapa en el momento de pintar, porque si lo hacemos al cargar la lista\r\n                        // y despus hay cambio de crs, en el momento de pintar no s desde qu crs debo tranformar\r\n                        track = self.wrap.formattedFromStorage(track);\r\n\r\n                        resolve({ data: track, layout: tracks[dataId].layout });\r\n                    }\r\n                } else {\r\n                    resolve();\r\n                }\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.export = function (li) {\r\n        var self = this;\r\n        return self.wrap.export(li);\r\n    };\r\n\r\n    ctlProto.getElevationTooltip = function (d) {\r\n        const self = this;\r\n        self.wrap.showElevationMarker(d);\r\n\r\n        return self.resultsPanelChart.getElevationChartTooltip(d);\r\n    };\r\n\r\n    ctlProto.removeElevationTooltip = function () {\r\n        var self = this;\r\n        self.wrap.hideElevationMarker();\r\n    }\r\n\r\n    ctlProto.clearFileInput = function (fileInput) {\r\n        const form = document.createElement('form');\r\n        const parent = fileInput.parentElement;\r\n        parent.insertBefore(form, fileInput);\r\n        form.appendChild(fileInput);\r\n        form.reset();\r\n        // Desenvolvemos el input del form\r\n        form.insertAdjacentElement('afterend', fileInput);\r\n        parent.removeChild(form);\r\n    };\r\n\r\n    ctlProto.getLoadingIndicator = function () {\r\n        var self = this;\r\n\r\n        if (!self.loading) {\r\n            self.loading = self.map.getControlsByClass(TC.control.LoadingIndicator);\r\n            if (self.loading && self.loading.length > 0)\r\n                self.loading = self.loading[0];\r\n        }\r\n\r\n        return self.loading;\r\n    };\r\n\r\n    ctlProto.onGeolocateError = function (error) {\r\n        var self = this;\r\n\r\n        if (navigator.geolocation) {\r\n            if (self.currentPosition)\r\n                navigator.geolocation.clearWatch(self.currentPosition);\r\n            if (self.currentPositionTrk) {\r\n                self.currentPositionTrk = self.currentPositionTrk instanceof Array ? self.currentPositionTrk : [self.currentPositionTrk];\r\n\r\n                self.currentPositionTrk.forEach(function (watch) {\r\n                    navigator.geolocation.clearWatch(watch);\r\n                });\r\n\r\n                self.currentPositionTrk = [];\r\n            }\r\n        }\r\n\r\n        if (self.currentPositionWaiting)\r\n            self.getLoadingIndicator().removeWait(self.currentPositionWaiting);\r\n\r\n        var errorMsg;\r\n        switch (error.code) {\r\n            case error.PERMISSION_DENIED:\r\n                errorMsg = self.getLocaleString(\"geo.error.permission_denied\");\r\n                break;\r\n            case error.POSITION_UNAVAILABLE:\r\n                errorMsg = self.getLocaleString(\"geo.error.position_unavailable\");\r\n                break;\r\n            case error.TIMEOUT:\r\n                errorMsg = self.getLocaleString(\"geo.error.timeout\");\r\n                break;\r\n            default:\r\n                errorMsg = self.getLocaleString(\"geo.error.default\");\r\n                break;\r\n        }\r\n\r\n        self.map.toast(errorMsg, { type: TC.Consts.msgType.WARNING });\r\n\r\n        if (!self.geopositionTracking && self.track) {\r\n            self.track.activateButton.classList.remove(TC.Consts.classes.HIDDEN);\r\n            self.track.deactivateButton.classList.add(TC.Consts.classes.HIDDEN);\r\n        }\r\n    };\r\n\r\n    var _isEmpty = function (obj) {\r\n        return !obj || obj.length === 0;\r\n    };\r\n\r\n    ctlProto.exportState = function () {\r\n        const self = this;\r\n        if (self.exportsState) {\r\n            const state = {};\r\n            if (self.layerTrack && self.track) {\r\n                var features = self.layerTrack.features;\r\n\r\n                if (features.length > 0 && self.featuresToShare && self.featuresToShare.length > 0) {\r\n                    state.features = self.featuresToShare;\r\n                } else {\r\n                    const layerState = self.layerTrack.exportState({\r\n                        features: features\r\n                    });\r\n\r\n                    state.features = layerState.features;\r\n                }\r\n\r\n                state.id = self.id;\r\n                const selectedTrack = self.getSelectedTrack();\r\n                if (selectedTrack) {\r\n                    state.trackName = selectedTrack.querySelector('span').innerHTML;\r\n                }\r\n                return state;\r\n            }\r\n        }\r\n        return null;\r\n    };\r\n\r\n    ctlProto.importState = function (state) {\r\n        const self = this;\r\n        if (self.map) {\r\n            if (state.features && state.features.length) {\r\n                self.enable();\r\n\r\n                if (state.features.length > 0) {\r\n                    const promises = new Array(state.features.length);\r\n                    state.features.forEach(function (f, idx) {\r\n                        const featureOptions = { data: f.data, id: f.id, showsPopup: f.showsPopup };\r\n                        var addFn;\r\n                        var geom = TC.Util.explodeGeometry(f.geom);\r\n                        switch (f.type) {\r\n                            case TC.Consts.geom.POLYLINE:\r\n                                promises[idx] = new TC.feature.Polyline(geom, featureOptions);\r\n                                break;\r\n                            case TC.Consts.geom.MULTIPOLYLINE:\r\n                                promises[idx] = new TC.feature.MultiPolyline(geom, featureOptions);\r\n                                break;\r\n                            case TC.Consts.geom.MARKER:\r\n                                promises[idx] = new TC.feature.Marker(geom, featureOptions);\r\n                                break;\r\n                            case TC.Consts.geom.POINT:\r\n                                promises[idx] = new TC.feature.Point(geom, featureOptions);\r\n                                break;\r\n                        }\r\n                    });\r\n\r\n                    Promise.all(promises).then(function (tcFeatures) {\r\n                        var options = { features: tcFeatures, fileName: state.trackName, notReproject: true, isShared: true };\r\n                        if (!self.availableTracks) {\r\n                            self.getStoredTracks().then(function () {\r\n                                self.importTrack(options);\r\n                            });\r\n                        } else {\r\n                            self.importTrack(options);\r\n                        }\r\n                    });\r\n                }\r\n            }\r\n        }\r\n    };\r\n})();"]}