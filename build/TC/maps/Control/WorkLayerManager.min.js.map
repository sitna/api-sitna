{"version":3,"sources":["control/WorkLayerManager.js"],"names":["TC","control","TOC","syncLoadJS","apiLocation","WorkLayerManager","options","apply","this","arguments","layers","queries","inherit","ctlProto","prototype","CLASS","CLICKEVENT","Consts","classes","DRAG","DRAGEND","event","TOOLSOPEN","template","isDebug","dust","register","body_0","chk","ctx","w","h","$key","s","get","block","body_1","__dustBody","p","rebase","getPath","x","else","body_2","body_3","body_5","body_6","f","nx","body_8","body_9","body_10","body_13","body_14","body_16","body_17","body_18","body_19","body_4","body_7","body_11","body_12","body_15","findLayerElement","ctl","layer","getLayerUIElements","filter","li","dataset","layerId","id","getElligibleLayersNumber","length","shouldBeDelAllVisible","some","unremovable","moveLayer","listItem","oldIndex","newIndex","callback","layerItems","targetItem","sourceLayer","map","getLayer","targetLayer","newIdx","i","insertLayer","render","self","_set1stRenderPromise","renderData","Util","extend","getLayerTree","addUIEventListeners","loadJS","window","Sortable","workLayers","stealth","forEach","updateLayerTree","ul","div","querySelector","_sortable","create","handle","animation","onSort","e","item","addEventListener","EventTarget","listenerBySelector","elm","target","tagName","parentElement","swap","oldIdx","sortableItems","toArray","buffer","sort","listItems","elmIdx","indexOf","test","key","focus","stopPropagation","blur","Promise","reject","resolve","call","then","loaded","updateScale","on","LAYEROPACITY","value","Math","round","opacity","FEATURESIMPORT","fileName","features","pattern","format","GPX","toLowerCase","one","LAYERADD","title","layout","accordion","classList","contains","COLLAPSED","controls","containerControl","add","trigger","remove","WFSQuery","queryControl","Object","addControl","onExternalServiceAdded","checkbox","matches","setVisibility","checked","inputRangeListener","range","setOpacity","removeLayer","confirm","getLocaleString","a","info","querySelectorAll","img","styleLegendImage","toggle","HIDDEN","CHECKED","renderModalDialog","updateLayerVisibility","visible","getVisibility","delBtn","dragHandle","isBase","MapContents","alreadyExists","len","push","loadJSInOrder","url","templating","domReadyPromise","layerTitle","wrap","getServiceTitle","layerData","hideTitle","hide","renderOptions","customLegend","isRaster","layerNames","path","shift","name","names","getInfo","legend","metadata","hasInfo","hasOwnProperty","tree","children","j","md","formatDescription","getSimpleMimeType","checkWFSAvailable","method","getLegendGraphicImage","src","catch","err","error","getLegendImgByPost","out","DOMParser","parseFromString","body","firstChild","layerNode","isGroup","layerNodes","getAllLayerNodes","node","getName","getLayerNodes","typeElm","className","normalizeLayerNode","tip","mapDiv","typeElmRect","getBoundingClientRect","document","createElement","innerHTML","style","top","offsetTop","right","offsetWidth","left","offsetLeft","appendChild","removeChild","lis","layerList","l","layerIdx","inserted","ii","referenceLi","insertAdjacentElement","elligibleLayersNum","numElm","emptyElm","contentElm","textContent","VISIBLE","isVisible","isVisibleByScale","updateLayerOrder","idx","splice","numberElm","nChildren","Array","from","queryButton","fncResolve","LOADING","setAttribute","getCapProm","getWFSCapabilitiesPromise","noWFSAvailabeManage","console","log","all","capabilities","getDisgregatedLayerNames","FeatureTypes","substring"],"mappings":"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","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.control.TOC) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/control/TOC');\r\n}\r\n\r\nTC.control.WorkLayerManager = function (options) {\r\n    var self = this;\r\n    TC.control.TOC.apply(self, arguments);\r\n    self.layers = [];\r\n    self.queries = self.options.queries;\r\n};\r\n\r\nTC.inherit(TC.control.WorkLayerManager, TC.control.TOC);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.WorkLayerManager.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-wlm';\r\n    ctlProto.CLICKEVENT = 'click';\r\n\r\n    TC.Consts.classes.DRAG = TC.Consts.classes.DRAG || 'tc-drag';\r\n    TC.Consts.classes.DRAGEND = TC.Consts.classes.DRAGEND || 'tc-dragend';\r\n\r\n    TC.Consts.event.TOOLSOPEN = TC.Consts.event.TOOLSOPEN || 'toolsopen.tc';\r\n\r\n    ctlProto.template = {};\r\n    if (TC.isDebug) {\r\n        ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/WorkLayerManager.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-elm'] = TC.apiLocation + \"TC/templates/WorkLayerManagerElement.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-type-sgl'] = TC.apiLocation + \"TC/templates/WorkLayerManagerTooltipSingle.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-type-grp'] = TC.apiLocation + \"TC/templates/WorkLayerManagerTooltipGroup.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-type-grp-node'] = TC.apiLocation + \"TC/templates/WorkLayerManagerTooltipGroupNode.html\";\r\n    }\r\n    else {\r\n        ctlProto.template[ctlProto.CLASS] = function () { dust.register(ctlProto.CLASS, body_0); function body_0(chk, ctx) { return chk.w(\"<h2>\").h(\"i18n\", ctx, {}, { \"$key\": \"loadedLayers\" }).w(\"<span class=\\\"tc-ctl-wlm-n\\\"></span><button class=\\\"tc-ctl-wlm-del-all tc-hidden\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"removeAllLayersFromMap\" }).w(\"\\\"></button></h2><div class=\\\"tc-ctl-wlm-empty\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"noData\" }).w(\"</div><div class=\\\"tc-ctl-wlm-content tc-hidden\\\"><form><ul>\").s(ctx.get([\"workLayers\"], false), ctx, { \"block\": body_1 }, {}).w(\"</ul></form></div>\"); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.p(\"tc-ctl-wlm-elm\", ctx, ctx.rebase(ctx.getPath(true, [])), {}); } body_1.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-elm'] = function () { dust.register(ctlProto.CLASS + '-elm', body_0); function body_0(chk, ctx) { return chk.w(\"<li class=\\\"tc-ctl-wlm-elm\\\" tabindex=\\\"-1\\\"><div class=\\\"tc-ctl-wlm-lyr\\\">\").x(ctx.get([\"path\"], false), ctx, { \"block\": body_1 }, {}).w(\"</div><div class=\\\"tc-ctl-wlm-type\\\"></div><div class=\\\"tc-ctl-wlm-path\\\" title=\\\"\").s(ctx.get([\"path\"], false), ctx, { \"else\": body_2, \"block\": body_3 }, {}).w(\"\\\">\").s(ctx.get([\"path\"], false), ctx, { \"else\": body_5, \"block\": body_6 }, {}).w(\"</div><div class=\\\"tc-ctl-wlm-buttons\\\"><div class=\\\"tc-ctl-wlm-btn-info\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"infoFromThisLayer\" }).w(\"\\\"></div><input type=\\\"range\\\" value=\\\"\").f(ctx.get([\"opacity\"], false), ctx, \"h\").w(\"\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"transparencyOfThisLayer\" }).w(\"\\\" /><input type=\\\"checkbox\\\" \").nx(ctx.get([\"hide\"], false), ctx, { \"block\": body_8 }, {}).w(\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"visibilityOfThisLayer\" }).w(\"\\\" /></div><div class=\\\"tc-ctl-wlm-info tc-hidden\\\">\").x(ctx.get([\"abstract\"], false), ctx, { \"block\": body_9 }, {}).x(ctx.get([\"customLegend\"], false), ctx, { \"else\": body_10, \"block\": body_13 }, {}).x(ctx.get([\"metadata\"], false), ctx, { \"block\": body_14 }, {}).w(\"</div><div class=\\\"tc-ctl-wlm-dd \").x(ctx.get([\"hide\"], false), ctx, { \"block\": body_16 }, {}).w(\"\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"dragToReorder\" }).w(\"\\\"></div><div class=\\\"tc-ctl-wlm-del \").x(ctx.get([\"unremovable\"], false), ctx, { \"block\": body_17 }, {}).w(\" \").nx(ctx.get([\"hide\"], false), ctx, { \"block\": body_18 }, {}).w(\"\\\" \").nx(ctx.get([\"unremovable\"], false), ctx, { \"block\": body_19 }, {}).w(\"></div></li>\"); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.f(ctx.get([\"title\"], false), ctx, \"h\"); } body_1.__dustBody = !0; function body_2(chk, ctx) { return chk.f(ctx.get([\"title\"], false), ctx, \"h\"); } body_2.__dustBody = !0; function body_3(chk, ctx) { return chk.f(ctx.getPath(true, []), ctx, \"h\").h(\"sep\", ctx, { \"block\": body_4 }, {}); } body_3.__dustBody = !0; function body_4(chk, ctx) { return chk.w(\" &bull; \"); } body_4.__dustBody = !0; function body_5(chk, ctx) { return chk.f(ctx.get([\"title\"], false), ctx, \"h\"); } body_5.__dustBody = !0; function body_6(chk, ctx) { return chk.f(ctx.getPath(true, []), ctx, \"h\").h(\"sep\", ctx, { \"block\": body_7 }, {}); } body_6.__dustBody = !0; function body_7(chk, ctx) { return chk.w(\" &bull; \"); } body_7.__dustBody = !0; function body_8(chk, ctx) { return chk.w(\"checked=\\\"checked\\\"\"); } body_8.__dustBody = !0; function body_9(chk, ctx) { return chk.w(\"<div class=\\\"tc-ctl-wlm-abstract\\\"><h4>\").h(\"i18n\", ctx, {}, { \"$key\": \"abstract\" }).w(\"</h4><div><pre>\").f(ctx.get([\"abstract\"], false), ctx, \"h\", [\"s\"]).w(\"</pre></div></div>\"); } body_9.__dustBody = !0; function body_10(chk, ctx) { return chk.x(ctx.get([\"legend\"], false), ctx, { \"block\": body_11 }, {}); } body_10.__dustBody = !0; function body_11(chk, ctx) { return chk.w(\"<div class=\\\"tc-ctl-wlm-legend\\\" data-layer-name=\\\"\").f(ctx.get([\"layerNames\"], false), ctx, \"h\").w(\"\\\"><h4>\").h(\"i18n\", ctx, {}, { \"$key\": \"content\" }).w(\"</h4>\").s(ctx.get([\"legend\"], false), ctx, { \"block\": body_12 }, {}).w(\"</div>\"); } body_11.__dustBody = !0; function body_12(chk, ctx) { return chk.w(\"<div><p>\").f(ctx.get([\"title\"], false), ctx, \"h\").w(\"</p><img data-img=\\\"\").f(ctx.get([\"src\"], false), ctx, \"h\").w(\"\\\" /></div>\"); } body_12.__dustBody = !0; function body_13(chk, ctx) { return chk.w(\"<ul class=\\\"tc-ctl-wlm-custom-legend\\\">\").f(ctx.get([\"customLegend\"], false), ctx, \"h\", [\"s\"]).w(\"</ul>\"); } body_13.__dustBody = !0; function body_14(chk, ctx) { return chk.w(\"<div class=\\\"tc-ctl-wlm-metadata\\\"><h4>\").h(\"i18n\", ctx, {}, { \"$key\": \"metadata\" }).w(\"</h4><ul>\").s(ctx.get([\"metadata\"], false), ctx, { \"block\": body_15 }, {}).w(\"</ul></div>\"); } body_14.__dustBody = !0; function body_15(chk, ctx) { return chk.w(\"<li><a href=\\\"\").f(ctx.get([\"url\"], false), ctx, \"h\", [\"s\"]).w(\"\\\" type=\\\"\").f(ctx.get([\"format\"], false), ctx, \"h\").w(\"\\\" title=\\\"\").f(ctx.get([\"formatDescription\"], false), ctx, \"h\").w(\"\\\" target=\\\"_blank\\\">\").f(ctx.get([\"formatDescription\"], false), ctx, \"h\").w(\"</a></li>\"); } body_15.__dustBody = !0; function body_16(chk, ctx) { return chk.w(\"tc-hidden\"); } body_16.__dustBody = !0; function body_17(chk, ctx) { return chk.w(\"disabled\"); } body_17.__dustBody = !0; function body_18(chk, ctx) { return chk.w(\"tc-hidden\"); } body_18.__dustBody = !0; function body_19(chk, ctx) { return chk.w(\"title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"removeLayerFromMap\" }).w(\"\\\"\"); } body_19.__dustBody = !0; return body_0; };\r\n        ctlProto.template[ctlProto.CLASS + '-type-sgl'] = function () { dust.register(ctlProto.CLASS + '-type-sgl', body_0); function body_0(chk, ctx) { return chk.h(\"i18n\", ctx, {}, { \"$key\": \"singleLayer\" }); } body_0.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-type-grp'] = function () { dust.register(ctlProto.CLASS + '-type-grp', body_0); function body_0(chk, ctx) { return chk.w(\"<div>\").h(\"i18n\", ctx, {}, { \"$key\": \"groupLayerThatContains\" }).w(\":</div><ul>\").s(ctx.get([\"Layer\"], false), ctx, { \"block\": body_1 }, {}).w(\"</ul>\"); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.p(\"tc-ctl-wlm-type-grp-node\", ctx, ctx.rebase(ctx.getPath(true, [])), {}); } body_1.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-type-grp-node'] = function () { dust.register(ctlProto.CLASS + '-type-grp-node', body_0); function body_0(chk, ctx) { return chk.w(\"<li class=\\\"tc-ctl-wlm-tip-grp-elm\\\"><span>\").f(ctx.get([\"Title\"], false), ctx, \"h\").w(\"</span><ul>\").s(ctx.get([\"Layer\"], false), ctx, { \"block\": body_1 }, {}).w(\"</ul></li>\"); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.p(\"tc-ctl-wlm-type-grp-node\", ctx, ctx.rebase(ctx.getPath(true, [])), {}); } body_1.__dustBody = !0; return body_0 };\r\n    }\r\n\r\n    const findLayerElement = function (ctl, layer) {\r\n        return ctl.getLayerUIElements().filter(function (li) {\r\n            return li.dataset.layerId === layer.id;\r\n        })[0];\r\n    };\r\n\r\n    var getElligibleLayersNumber = function (ctl) {\r\n        return ctl.layers.length;\r\n    };\r\n\r\n    const shouldBeDelAllVisible = function (ctl) {\r\n        return !ctl.layers.some(function (layer) { return layer.unremovable });\r\n    };\r\n\r\n    const moveLayer = function (ctl, listItem, oldIndex, newIndex, callback) {\r\n        const layerItems = ctl.getLayerUIElements();\r\n        var targetItem;\r\n        if (newIndex > oldIndex) {\r\n            targetItem = layerItems[newIndex - 1];\r\n        }\r\n        else if (newIndex < oldIndex) {\r\n            targetItem = layerItems[newIndex + 1];\r\n        }\r\n        else {\r\n            return;\r\n        }\r\n        const sourceLayer = ctl.map.getLayer(listItem.dataset.layerId);\r\n        const targetLayer = ctl.map.getLayer(targetItem.dataset.layerId);\r\n        var newIdx = -1;\r\n        for (var i = 0; i < ctl.map.layers.length; i++) {\r\n            if (targetLayer === ctl.map.layers[i]) {\r\n                newIdx = i;\r\n                break;\r\n            }\r\n        }\r\n        if (newIdx >= 1 && newIdx < ctl.map.layers.length) {\r\n            ctl.map.insertLayer(sourceLayer, newIdx, callback);\r\n        }\r\n    };\r\n\r\n    ctlProto.render = function (callback, options) {\r\n        const self = this;\r\n        return self._set1stRenderPromise(self.map ? self.renderData(options ? TC.Util.extend(self.map.getLayerTree(), options) : self.map.getLayerTree(), function () {\r\n            self.addUIEventListeners();\r\n            TC.loadJS(\r\n                !window.Sortable,\r\n                [TC.apiLocation + 'lib/sortable/Sortable.min.js'],\r\n                function () {\r\n                    self.map.workLayers\r\n                        .filter(function (layer) {\r\n                            return !layer.stealth;\r\n                        })\r\n                        .forEach(function (layer) {\r\n                            self.updateLayerTree(layer);\r\n                        });\r\n\r\n\r\n                    const ul = self.div.querySelector('ul');\r\n                    self._sortable = Sortable.create(ul, {\r\n                        handle: '.' + self.CLASS + '-dd',\r\n                        animation: 150,\r\n                        onSort: function (e) {\r\n                            moveLayer(self, e.item, e.oldIndex, e.newIndex);\r\n                        }\r\n                    });\r\n\r\n                    ul.addEventListener('keydown', TC.EventTarget.listenerBySelector('li', function (e) {\r\n                        // Para mover capas con el teclado.\r\n                        var elm = e.target;\r\n                        while (elm.tagName !== 'LI') {\r\n                            elm = elm.parentElement;\r\n                            if (!elm) {\r\n                                return;\r\n                            }\r\n                        }\r\n                        const swap = function (oldIdx, newIdx) {\r\n                            const sortableItems = self._sortable.toArray();\r\n                            const buffer = sortableItems[oldIdx];\r\n                            sortableItems[oldIdx] = sortableItems[newIdx];\r\n                            sortableItems[newIdx] = buffer;\r\n                            self._sortable.sort(sortableItems);\r\n                            moveLayer(self, elm, oldIdx, newIdx);\r\n                        };\r\n                        const listItems = self.getLayerUIElements();\r\n                        const elmIdx = listItems.indexOf(elm);\r\n                        switch (true) {\r\n                            case /Up$/.test(e.key):\r\n                                if (elmIdx > 0) {\r\n                                    swap(elmIdx, elmIdx - 1);\r\n                                    elm.focus();\r\n                                    e.stopPropagation();\r\n                                }\r\n                                break;\r\n                            case /Down$/.test(e.key):\r\n                                if (elmIdx < listItems.length - 1) {\r\n                                    swap(elmIdx, elmIdx + 1);\r\n                                    elm.focus();\r\n                                    e.stopPropagation();\r\n                                }\r\n                                break;\r\n                            case /Enter$/.test(e.key):\r\n                                elm.blur();\r\n                                e.stopPropagation();\r\n                                break;\r\n                            default:\r\n                                break;\r\n                        }\r\n                    }));\r\n\r\n                    if (typeof callback === 'function') {\r\n                        callback();\r\n                    }\r\n                }\r\n            );\r\n        }) : Promise.reject());\r\n    };\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            TC.control.TOC.prototype.register.call(self, map).then(function () {\r\n\r\n                map.loaded(function () {                   \r\n                    self.updateScale();\r\n                });\r\n\r\n                map\r\n                    .on(TC.Consts.event.LAYEROPACITY, function (e) {\r\n                        const li = findLayerElement(self, e.layer);\r\n                        if (li) {\r\n                            li.querySelector('input[type=range]').value = Math.round(e.opacity * 100);\r\n                        }\r\n                    })\r\n                    .on(TC.Consts.event.FEATURESIMPORT, function (e) {\r\n                        var fileName = e.fileName;\r\n                        if (e.features && e.features.length > 0) { // GLS: Escuchamos al evento FEATURESIMPORT para poder desplegar el control de capas cargadas\r\n                            // Ignoramos los GPX (se supone que los gestionar√° Geolocation)\r\n                            var pattern = '.' + TC.Consts.format.GPX.toLowerCase();\r\n                            if (e.fileName.toLowerCase().indexOf(pattern) === e.fileName.length - pattern.length) {\r\n                                return;\r\n                            }\r\n\r\n                            map.one(TC.Consts.event.LAYERADD, function (e) {\r\n                                if (e && e.layer && e.layer.title == fileName) {\r\n                                    // Desplegamos el control capas cargadas\r\n                                    if (self.map && self.map.layout && self.map.layout.accordion) {\r\n                                        if (self.div.classList.contains(TC.Consts.classes.COLLAPSED)) {\r\n                                            self.map.controls\r\n                                                .filter(function (ctl) {\r\n                                                    // Todos los otros controles que no cuelgan de otro control\r\n                                                    return ctl !== self && !ctl.containerControl;\r\n                                                })\r\n                                                .forEach(function (ctl) {\r\n                                                    ctl.div.classList.add(TC.Consts.classes.COLLAPSED);\r\n                                                });\r\n                                        }\r\n                                    }\r\n\r\n                                    // abrimos el panel de herramientas\r\n                                    self.map.trigger(TC.Consts.event.TOOLSOPEN);\r\n\r\n                                    self.div.classList.remove(TC.Consts.classes.COLLAPSED);\r\n                                }\r\n                            });\r\n                        }\r\n                    });\r\n                if (self.queries) {\r\n                    if (!TC.control.WFSQuery) {\r\n                        TC.syncLoadJS(TC.apiLocation + 'TC/Control/WFSQuery');\r\n                    }\r\n                    ctlProto.queryControl = new TC.control.WFSQuery(null, self.queries instanceof Object ? self.queries : null);\r\n                    self.map.addControl(ctlProto.queryControl);\r\n                }\r\n                resolve(self);\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.onExternalServiceAdded = function (e) {\r\n        // Este control no tiene que aceptar servicios externos directamente\r\n    };\r\n\r\n    ctlProto.addUIEventListeners = function () {\r\n        const self = this;\r\n\r\n        self.div.addEventListener(self.CLICKEVENT, TC.EventTarget.listenerBySelector('input[type=checkbox]', function (e) {\r\n            // al estar en ipad el evento pasa a ser touchstart en la constante: TC.Consts.event.CLICK, los checkbox no funcionan bien con este evento\r\n            const checkbox = e.target;\r\n            var li = checkbox;\r\n            do {\r\n                li = li.parentElement;\r\n            }\r\n            while (li && !li.matches('li.' + self.CLASS + '-elm'));\r\n\r\n            const layer = self.map.getLayer(li.dataset.layerId);\r\n            layer.setVisibility(checkbox.checked);\r\n            e.stopPropagation();\r\n        }));\r\n\r\n        const inputRangeListener = function (e) {\r\n            const range = e.target;\r\n            var li = range;\r\n            do {\r\n                li = li.parentElement;\r\n            }\r\n            while (li && li.tagName !== 'LI');\r\n\r\n            const layer = self.map.getLayer(li.dataset.layerId);\r\n            layer.setOpacity(range.value / 100);\r\n        };\r\n        self.div.addEventListener('change', TC.EventTarget.listenerBySelector('input[type=range]', inputRangeListener));\r\n        self.div.addEventListener('input', TC.EventTarget.listenerBySelector('input[type=range]', inputRangeListener));\r\n\r\n        self.div.addEventListener(self.CLICKEVENT, TC.EventTarget.listenerBySelector('.' + self.CLASS + '-del' + ':not(.disabled)', function (e) {\r\n            var li = e.target;\r\n            do {\r\n                li = li.parentElement;\r\n            }\r\n            while (li && li.tagName !== 'LI');\r\n            const layer = self.map.getLayer(li.dataset.layerId);\r\n            self.map.removeLayer(layer);\r\n        }));\r\n\r\n        self.div.addEventListener(self.CLICKEVENT, TC.EventTarget.listenerBySelector('.' + self.CLASS + '-del-all', function (e) {\r\n            TC.confirm(self.getLocaleString('layersRemove.confirm'), function () {\r\n                self.getLayerUIElements()\r\n                    .map(function (li) {\r\n                        return self.map.getLayer(li.dataset.layerId);\r\n                    })\r\n                    .forEach(function (layer) {\r\n                        self.map.removeLayer(layer);\r\n                    });\r\n            });\r\n        }));\r\n\r\n        self.div.addEventListener(self.CLICKEVENT, TC.EventTarget.listenerBySelector('.' + self.CLASS + '-btn-info', function (e) {\r\n            const a = e.target;\r\n            var li = a;\r\n            do {\r\n                li = li.parentElement;\r\n            }\r\n            while (li && li.tagName !== 'LI');\r\n            const info = li.querySelector('.' + self.CLASS + '-info');\r\n            const layer = self.map.getLayer(li.dataset.layerId);\r\n            // Cargamos la imagen de la leyenda\r\n            info.querySelectorAll('.' + self.CLASS + '-legend img').forEach(function (img) {\r\n                self.styleLegendImage(img, layer);\r\n            });\r\n            info.classList.toggle(TC.Consts.classes.HIDDEN);\r\n\r\n            if (li.querySelector('input[type=\"checkbox\"]').checked) {\r\n                const dragHandle = li.querySelector('.' + self.CLASS + '-dd');\r\n                dragHandle.classList.toggle(TC.Consts.classes.HIDDEN, !info.classList.contains(TC.Consts.classes.HIDDEN));\r\n            }\r\n\r\n            a.classList.toggle(TC.Consts.classes.CHECKED);\r\n        }));\r\n\r\n        self.div.addEventListener(self.CLICKEVENT, TC.EventTarget.listenerBySelector('.' + self.CLASS + '-btn-query', function (e) {\r\n            if (e.target.classList.contains('tc-unavailable') || e.target.classList.contains('tc-loading')) {\r\n                return;\r\n            }\r\n            const a = e.target;\r\n            var li = a;\r\n            do {\r\n                li = li.parentElement;\r\n            }\r\n            while (li && li.tagName !== 'LI');\r\n            const layer = self.map.getLayer(li.dataset.layerId);\r\n            self.queryControl.renderModalDialog(layer);\r\n        }));\r\n    };\r\n\r\n    ctlProto.updateLayerVisibility = function (layer) {\r\n        const self = this;\r\n        const li = findLayerElement(self, layer);\r\n        if (li) {\r\n            const visible = layer.getVisibility();\r\n            li.querySelector('input[type=\"checkbox\"]').checked = visible;\r\n            const delBtn = li.querySelector('.' + self.CLASS + '-del');\r\n            const info = li.querySelector('.' + self.CLASS + '-info');\r\n            const dragHandle = li.querySelector('.' + self.CLASS + '-dd');\r\n            if (visible) {\r\n                delBtn.classList.add(TC.Consts.classes.HIDDEN);\r\n                if (info.classList.contains(TC.Consts.classes.HIDDEN)) {\r\n                    dragHandle.classList.remove(TC.Consts.classes.HIDDEN);\r\n                }\r\n            }\r\n            else {\r\n                delBtn.classList.remove(TC.Consts.classes.HIDDEN);\r\n                if (info.classList.contains(TC.Consts.classes.HIDDEN)) {\r\n                    dragHandle.classList.add(TC.Consts.classes.HIDDEN);\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    ctlProto.updateLayerTree = function (layer) {\r\n        var self = this;        \r\n\r\n        var getLegendImgByPost = function (layer) {\r\n            return new Promise(function (resolve, reject) {\r\n                if (layer && layer.options.method && layer.options.method === \"POST\") {\r\n                    layer.getLegendGraphicImage()\r\n                        .then(function (src) {\r\n                            resolve(src);\r\n                        })\r\n                        .catch(function (err) { TC.error(err); });\r\n                } else {\r\n                    resolve();\r\n                }\r\n            });\r\n        };\r\n\r\n        if (!layer.isBase && !layer.options.stealth) {\r\n            TC.control.MapContents.prototype.updateLayerTree.call(self, layer);\r\n\r\n            var alreadyExists = false;\r\n            for (var i = 0, len = self.layers.length; i < len; i++) {\r\n                if (layer === self.layers[i]) {\r\n                    alreadyExists = true;\r\n                    break;\r\n                }\r\n            }\r\n\r\n            if (!alreadyExists) {\r\n                var template = self.CLASS + '-elm';\r\n                self.layers.push(layer);\r\n\r\n                TC.loadJSInOrder(\r\n                    !window.dust,\r\n                    TC.url.templating,\r\n                    function () {\r\n                        var domReadyPromise;\r\n                        var layerTitle = layer.title || layer.wrap.getServiceTitle();\r\n                        var layerData = {\r\n                            title: layer.options.hideTitle ? '' : layerTitle,\r\n                            hide: layer.renderOptions && layer.renderOptions.hide ? true : false,\r\n                            opacity: layer.renderOptions && layer.renderOptions.opacity ? (layer.renderOptions.opacity * 100) : 100,\r\n                            customLegend: layer.customLegend,\r\n                            unremovable: layer.unremovable\r\n                        };\r\n                        var isRaster = layer.isRaster();\r\n                        if (isRaster) {\r\n                            layerData.layerNames = layer.layerNames;\r\n                            var path = layer.getPath();\r\n                            path.shift();\r\n                            layerData.path = path;\r\n                            var name = layer.names[0];\r\n                            var info = layer.wrap.getInfo(name);\r\n                            layerData.legend = info.legend;\r\n                            layerData['abstract'] = info['abstract'];\r\n                            var hasInfo = (info.hasOwnProperty('abstract') || info.hasOwnProperty('legend') || info.hasOwnProperty('metadata'));\r\n                            var metadata;\r\n                            if (layer.tree && layer.tree.children && layer.tree.children.length && layer.tree.children[0].children && layer.tree.children[0].children.length) {\r\n                                metadata = null;\r\n                            }\r\n                            else {\r\n                                metadata = info.metadata;\r\n                                if (metadata) {\r\n                                    for (var j = 0, len = metadata.length; j < len; j++) {\r\n                                        var md = metadata[j];\r\n                                        md.formatDescription = self.getLocaleString(TC.Util.getSimpleMimeType(md.format)) || self.getLocaleString('viewMetadata');\r\n                                    }\r\n                                }\r\n                            }\r\n                            layerData.metadata = metadata;\r\n                            if (self.queries) {\r\n                                domReadyPromise = checkWFSAvailable(layer);\r\n                            }\r\n                        }\r\n\r\n\r\n                        getLegendImgByPost(layer).then(function (src) {\r\n                            if (src) {\r\n                                legend.src = src; // ya se ha validado en getLegendImgByPost\r\n                            }\r\n\r\n                            dust.render(template, layerData, function (err, out) {\r\n                                const parser = new DOMParser();\r\n                                const li = parser.parseFromString(out, 'text/html').body.firstChild;\r\n                                var layerNode;\r\n                                var isGroup = false;\r\n                                if (isRaster) {\r\n                                    isGroup = layer.names.length > 1;\r\n                                    if (!isGroup) {\r\n                                        var layerNodes = layer.wrap.getAllLayerNodes();\r\n                                        for (var i = 0; i < layerNodes.length; i++) {\r\n                                            var node = layerNodes[i];\r\n                                            if (layer.wrap.getName(node) === name) {\r\n                                                layerNode = node;\r\n                                                if (layer.wrap.getLayerNodes(node).length > 0) {\r\n                                                    isGroup = true;\r\n                                                }\r\n                                                break;\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                }\r\n\r\n                                const typeElm = li.querySelector('.' + self.CLASS + '-type');\r\n                                const className = isGroup ? self.CLASS + '-type-grp' : self.CLASS + '-type-sgl';\r\n                                typeElm.classList.add(className);\r\n\r\n                                if (!hasInfo) {\r\n                                    li.querySelector('.' + self.CLASS + '-btn-info').classList.add(TC.Consts.classes.HIDDEN);\r\n                                }\r\n\r\n                                if (layerNode) {\r\n                                    layer.wrap.normalizeLayerNode(layerNode);\r\n\r\n                                    dust.render(className, layerNode, function (err, out) {\r\n                                        var tip;\r\n\r\n                                        typeElm.addEventListener('mouseover', function (e) {\r\n                                            const mapDiv = self.map.div;\r\n                                            const typeElmRect = typeElm.getBoundingClientRect();\r\n                                            tip = document.createElement('div');\r\n                                            tip.classList.add(self.CLASS + '-tip');\r\n                                            tip.innerHTML = out;\r\n                                            tip.style.top = (typeElmRect.top - mapDiv.offsetTop) + 'px';\r\n                                            tip.style.right = mapDiv.offsetWidth - (typeElmRect.left - mapDiv.offsetLeft) + 'px';\r\n                                            mapDiv.appendChild(tip);\r\n                                        });\r\n                                        typeElm.addEventListener('mouseout', function (e) {\r\n                                            tip.parentElement.removeChild(tip);\r\n                                        });\r\n                                    });\r\n                                }\r\n                                const ul = self.div.querySelector('ul');\r\n                                li.dataset.layerId = layer.id;\r\n\r\n                                const lis = self.getLayerUIElements();\r\n                                const layerList = self.map.workLayers\r\n                                    .filter(function (l) {\r\n                                        return !l.stealth;\r\n                                    });\r\n                                const layerIdx = layerList.indexOf(layer);\r\n                                var inserted = false;\r\n                                for (var i = 0, ii = lis.length; i < ii; i++) {\r\n                                    const referenceLi = lis[i];\r\n                                    const referenceLayerIdx = layerList.indexOf(self.map.getLayer(referenceLi.dataset.layerId));\r\n                                    if (referenceLayerIdx < layerIdx) {\r\n                                        referenceLi.insertAdjacentElement('beforebegin', li);\r\n                                        inserted = true;\r\n                                        break;\r\n                                    }\r\n                                }\r\n                                if (!inserted) {\r\n                                    ul.appendChild(li);\r\n                                }\r\n\r\n                                if (domReadyPromise) domReadyPromise(li);\r\n                                self.updateScale();\r\n                            });\r\n                        });\r\n                    }\r\n                );\r\n\r\n                var elligibleLayersNum = getElligibleLayersNumber(self);\r\n                const numElm = self.div.querySelector('.' + self.CLASS + '-n');\r\n                const emptyElm = self.div.querySelector('.' + self.CLASS + '-empty');\r\n                const contentElm = self.div.querySelector('.' + self.CLASS + '-content');\r\n                numElm.textContent = elligibleLayersNum;\r\n                if (elligibleLayersNum > 0) {\r\n                    numElm.classList.add(TC.Consts.classes.VISIBLE);\r\n                    emptyElm.classList.add(TC.Consts.classes.HIDDEN);\r\n                    contentElm.classList.remove(TC.Consts.classes.HIDDEN);\r\n                }\r\n                else {\r\n                    numElm.classList.remove(TC.Consts.classes.VISIBLE);\r\n                    emptyElm.classList.remove(TC.Consts.classes.HIDDEN);\r\n                    contentElm.classList.add(TC.Consts.classes.HIDDEN);\r\n                }\r\n\r\n                const deleteAllElm = self.div.querySelector('.' + self.CLASS + '-del-all');\r\n                deleteAllElm.classList.toggle(TC.Consts.classes.HIDDEN, !shouldBeDelAllVisible(self));\r\n            }\r\n        }\r\n    };\r\n\r\n    ctlProto.updateScale = function () {\r\n        var self = this;\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            var layer = self.map.getLayer(li.dataset.layerId);\r\n            if (layer.names) {\r\n                var isVisible = false;\r\n                for (var i = 0; i < layer.names.length; i++) {\r\n                    if (layer.isVisibleByScale(layer.names[i])) {\r\n                        isVisible = true;\r\n                        break;\r\n                    }\r\n                }\r\n                li.classList.toggle(self.CLASS + '-elm-notvisible', !isVisible);\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.updateLayerOrder = function (layer, oldIdx, newIdx) {\r\n        //TC.control.MapContents.prototype.updateLayerOrder.call(this, layer, oldIdx, newIdx);\r\n        const self = this;\r\n        self.map.workLayers\r\n            .filter(function (layer) {\r\n                return !layer.stealth;\r\n            })\r\n            .forEach(function (layer) {\r\n                const li = findLayerElement(self, layer);\r\n                if (li) {\r\n                    li.parentElement.firstChild.insertAdjacentElement('beforebegin', li);\r\n                }\r\n            });\r\n    };\r\n\r\n    ctlProto.removeLayer = function (layer) {\r\n        var self = this;\r\n        var idx = self.layers.indexOf(layer);\r\n        if (idx >= 0) {\r\n            self.layers.splice(idx, 1);\r\n        }\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            if (li.dataset.layerId === layer.id) {\r\n                li.parentElement.removeChild(li);\r\n            }\r\n        });\r\n        const contentElm = self.div.querySelector('.' + self.CLASS + '-content');\r\n        const emptyElm = self.div.querySelector('.' + self.CLASS + '-empty');\r\n        const numberElm = self.div.querySelector('.' + self.CLASS + '-n');\r\n        var nChildren = getElligibleLayersNumber(self);\r\n        numberElm.textContent = nChildren;\r\n        if (nChildren > 0) {\r\n            contentElm.classList.remove(TC.Consts.classes.HIDDEN);\r\n            emptyElm.classList.add(TC.Consts.classes.HIDDEN);\r\n            numberElm.classList.add(TC.Consts.classes.VISIBLE);\r\n        }\r\n        else {\r\n            if (shouldBeDelAllVisible(self)) {\r\n                self.div.querySelector('.' + self.CLASS + '-del-all').classList.add(TC.Consts.classes.HIDDEN);\r\n            }\r\n            contentElm.classList.add(TC.Consts.classes.HIDDEN);\r\n            emptyElm.classList.remove(TC.Consts.classes.HIDDEN);\r\n            numberElm.classList.remove(TC.Consts.classes.VISIBLE);\r\n        }\r\n    };\r\n\r\n    ctlProto.getLayerUIElements = function () {\r\n        const self = this;\r\n        return Array.from(self.div.querySelectorAll(`ul > li.${self.CLASS}-elm`));\r\n    };\r\n\r\n    //analiza la nueva capa a√±adida si tiene habilitado o no el WFS\r\n    const checkWFSAvailable = function (layer) {\r\n        var fncResolve = null;\r\n        var domReadyPromise = new Promise(function (resolve, reject) {\r\n            fncResolve = resolve;\r\n        })\r\n        var cssClassUnavailable = 'tc-unavailable';\r\n\r\n        var queryButton;\r\n        domReadyPromise.then(function (li) {\r\n            queryButton = document.createElement('div');\r\n            queryButton.classList.add(ctlProto.CLASS + '-btn-query');\r\n            queryButton.classList.add(TC.Consts.classes.LOADING);\r\n            queryButton.setAttribute('title', ctlProto.getLocaleString('query.tooltipMagnifBtn'));\r\n            li.querySelector('.' + ctlProto.CLASS + '-btn-info').insertAdjacentElement('afterend', queryButton);\r\n        });\r\n        var getCapProm = layer.getWFSCapabilitiesPromise()\r\n        const noWFSAvailabeManage = function () {\r\n            if (queryButton) {\r\n                queryButton.classList.remove(TC.Consts.classes.LOADING);\r\n                queryButton.classList.add(cssClassUnavailable);\r\n            }\r\n            //queryButton.attr(\"title\", getLocaleString(\"query.tooltipMagnifBtnDisabled\"));\r\n            console.log(\"El servicio \" + (layer.title || layer.tree.title) + \" no tiene disponible el WFS\");\r\n        }\r\n        Promise.all([getCapProm, domReadyPromise]).then(function () {\r\n            var capabilities = arguments[0][0];\r\n            //comprobamos que la solo es una capa y existe en el capabilities del WFS                        \r\n            if (queryButton) {\r\n                queryButton.classList.remove(TC.Consts.classes.LOADING)\r\n                var layers = layer.getDisgregatedLayerNames();\r\n                if (layers.length === 1 && !capabilities.FeatureTypes.hasOwnProperty(layers[0].substring(layers[0].indexOf(\":\") + 1))) {\r\n                    queryButton.classList.add(cssClassUnavailable);\r\n                    //queryButton.attr(\"title\", getLocaleString(\"query.tooltipMagnifBtnDisabled\"));\r\n                    console.log(\"El servicio WFS de \" + (layer.title || layer.tree.title) + \" no dispone de la capa \" + layers[0]);\r\n                }\r\n            }\r\n\r\n        }).catch(noWFSAvailabeManage);\r\n        getCapProm.catch(noWFSAvailabeManage);\r\n        return fncResolve;\r\n    }\r\n})();"]}