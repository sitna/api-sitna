{"version":3,"sources":["control/WorkLayerManager.js"],"names":["TC","control","TOC","syncLoadJS","apiLocation","WorkLayerManager","options","apply","this","arguments","layers","queries","inherit","ctlProto","prototype","CLASS","CLICKEVENT","Consts","classes","DRAG","DRAGEND","event","TOOLSOPEN","template","isDebug","dust","register","body_0","chk","ctx","w","h","$key","s","get","block","body_1","__dustBody","p","rebase","getPath","x","else","body_2","body_3","body_5","body_6","f","nx","body_8","body_9","body_10","body_13","body_14","body_16","body_17","body_18","body_19","body_4","body_7","body_11","body_12","body_15","_dataKeys","findLayerElement","ctl","layer","getLayerUIElements","filter","li","$","data","getElligibleLayersNumber","grep","map","workLayers","lyr","stealth","length","shouldBeDelAllVisible","some","unremovable","moveLayer","listItem","oldIndex","newIndex","callback","layerItems","targetItem","sourceLayer","targetLayer","newIdx","i","insertLayer","render","self","_set1stRenderPromise","renderData","extend","getLayerTree","addUIEventListeners","loadJS","window","Sortable","forEach","updateLayerTree","ul","div","querySelector","_sortable","create","handle","animation","onSort","e","item","addEventListener","EventTarget","listenerBySelector","elm","target","tagName","parentElement","swap","oldIdx","sortableItems","toArray","buffer","sort","listItems","elmIdx","indexOf","test","key","focus","stopPropagation","blur","Promise","reject","resolve","call","then","on","LAYEROPACITY","value","Math","round","opacity","FEATURESIMPORT","fileName","features","pattern","format","GPX","toLowerCase","one","LAYERADD","title","layout","accordion","classList","contains","COLLAPSED","controls","add","trigger","remove","WFSQuery","queryControl","Object","addControl","onExternalServiceAdded","checkbox","matches","setVisibility","checked","inputRangeListener","range","setOpacity","removeLayer","confirm","getLocaleString","a","info","querySelectorAll","img","styleLegendImage","HIDDEN","dragHandle","CHECKED","renderModalDialog","updateLayerVisibility","visible","getVisibility","delBtn","isBase","MapContents","alreadyExists","len","push","loadJSInOrder","url","templating","domReadyPromise","layerTitle","wrap","getServiceTitle","layerData","hideTitle","hide","renderOptions","customLegend","isRaster","layerNames","path","shift","name","names","getInfo","legend","metadata","hasInfo","hasOwnProperty","tree","children","j","md","formatDescription","Util","getSimpleMimeType","checkWFSAvailable","method","getLegendGraphicImage","src","catch","err","error","getLegendImgByPost","out","DOMParser","parseFromString","body","firstChild","layerNode","isGroup","layerNodes","getAllLayerNodes","node","getName","getLayerNodes","typeElm","className","normalizeLayerNode","tip","mapDiv","typeElmRect","getBoundingClientRect","document","createElement","innerHTML","style","top","offsetTop","right","offsetWidth","left","offsetLeft","appendChild","removeChild","lis","layerList","l","layerIdx","inserted","ii","referenceLi","referenceLayer","insertAdjacentElement","updateScale","elligibleLayersNum","numElm","emptyElm","contentElm","textContent","VISIBLE","deleteAllElm","isVisible","isVisibleByScale","notVisibleClass","updateLayerOrder","idx","splice","numberElm","nChildren","result","child","queryButton","fncResolve","LOADING","setAttribute","getCapProm","getWFSCapabilitiesPromise","noWFSAvailabeManage","console","log","all","capabilities","getDisgregatedLayerNames","FeatureTypes","substring"],"mappings":"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","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.control.TOC) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/control/TOC');\r\n}\r\n\r\nTC.control.WorkLayerManager = function (options) {\r\n    var self = this;\r\n    TC.control.TOC.apply(self, arguments);\r\n    self.layers = [];\r\n    self.queries = self.options.queries;\r\n};\r\n\r\nTC.inherit(TC.control.WorkLayerManager, TC.control.TOC);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.WorkLayerManager.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-wlm';\r\n    ctlProto.CLICKEVENT = 'click';\r\n\r\n    TC.Consts.classes.DRAG = TC.Consts.classes.DRAG || 'tc-drag';\r\n    TC.Consts.classes.DRAGEND = TC.Consts.classes.DRAGEND || 'tc-dragend';\r\n\r\n    TC.Consts.event.TOOLSOPEN = TC.Consts.event.TOOLSOPEN || 'toolsopen.tc';\r\n\r\n    ctlProto.template = {};\r\n    if (TC.isDebug) {\r\n        ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/WorkLayerManager.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-elm'] = TC.apiLocation + \"TC/templates/WorkLayerManagerElement.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-type-sgl'] = TC.apiLocation + \"TC/templates/WorkLayerManagerTooltipSingle.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-type-grp'] = TC.apiLocation + \"TC/templates/WorkLayerManagerTooltipGroup.html\";\r\n        ctlProto.template[ctlProto.CLASS + '-type-grp-node'] = TC.apiLocation + \"TC/templates/WorkLayerManagerTooltipGroupNode.html\";\r\n    }\r\n    else {\r\n        ctlProto.template[ctlProto.CLASS] = function () { dust.register(ctlProto.CLASS, body_0); function body_0(chk, ctx) { return chk.w(\"<h2>\").h(\"i18n\", ctx, {}, { \"$key\": \"loadedLayers\" }).w(\"<span class=\\\"tc-ctl-wlm-n\\\"></span><button class=\\\"tc-ctl-wlm-del-all tc-hidden\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"removeAllLayersFromMap\" }).w(\"\\\"></button></h2><div class=\\\"tc-ctl-wlm-empty\\\">\").h(\"i18n\", ctx, {}, { \"$key\": \"noData\" }).w(\"</div><div class=\\\"tc-ctl-wlm-content tc-hidden\\\"><form><ul>\").s(ctx.get([\"workLayers\"], false), ctx, { \"block\": body_1 }, {}).w(\"</ul></form></div>\"); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.p(\"tc-ctl-wlm-elm\", ctx, ctx.rebase(ctx.getPath(true, [])), {}); } body_1.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-elm'] = function () { dust.register(ctlProto.CLASS + '-elm', body_0); function body_0(chk, ctx) { return chk.w(\"<li class=\\\"tc-ctl-wlm-elm\\\" tabindex=\\\"-1\\\"><div class=\\\"tc-ctl-wlm-lyr\\\">\").x(ctx.get([\"path\"], false), ctx, { \"block\": body_1 }, {}).w(\"</div><div class=\\\"tc-ctl-wlm-type\\\"></div><div class=\\\"tc-ctl-wlm-path\\\" title=\\\"\").s(ctx.get([\"path\"], false), ctx, { \"else\": body_2, \"block\": body_3 }, {}).w(\"\\\">\").s(ctx.get([\"path\"], false), ctx, { \"else\": body_5, \"block\": body_6 }, {}).w(\"</div><div class=\\\"tc-ctl-wlm-buttons\\\"><div class=\\\"tc-ctl-wlm-btn-info\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"infoFromThisLayer\" }).w(\"\\\"></div><input type=\\\"range\\\" value=\\\"\").f(ctx.get([\"opacity\"], false), ctx, \"h\").w(\"\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"transparencyOfThisLayer\" }).w(\"\\\" /><input type=\\\"checkbox\\\" \").nx(ctx.get([\"hide\"], false), ctx, { \"block\": body_8 }, {}).w(\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"visibilityOfThisLayer\" }).w(\"\\\" /></div><div class=\\\"tc-ctl-wlm-info tc-hidden\\\">\").x(ctx.get([\"abstract\"], false), ctx, { \"block\": body_9 }, {}).x(ctx.get([\"customLegend\"], false), ctx, { \"else\": body_10, \"block\": body_13 }, {}).x(ctx.get([\"metadata\"], false), ctx, { \"block\": body_14 }, {}).w(\"</div><div class=\\\"tc-ctl-wlm-dd \").x(ctx.get([\"hide\"], false), ctx, { \"block\": body_16 }, {}).w(\"\\\" title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"dragToReorder\" }).w(\"\\\"></div><div class=\\\"tc-ctl-wlm-del \").x(ctx.get([\"unremovable\"], false), ctx, { \"block\": body_17 }, {}).w(\" \").nx(ctx.get([\"hide\"], false), ctx, { \"block\": body_18 }, {}).w(\"\\\" \").nx(ctx.get([\"unremovable\"], false), ctx, { \"block\": body_19 }, {}).w(\"></div></li>\"); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.f(ctx.get([\"title\"], false), ctx, \"h\"); } body_1.__dustBody = !0; function body_2(chk, ctx) { return chk.f(ctx.get([\"title\"], false), ctx, \"h\"); } body_2.__dustBody = !0; function body_3(chk, ctx) { return chk.f(ctx.getPath(true, []), ctx, \"h\").h(\"sep\", ctx, { \"block\": body_4 }, {}); } body_3.__dustBody = !0; function body_4(chk, ctx) { return chk.w(\" &bull; \"); } body_4.__dustBody = !0; function body_5(chk, ctx) { return chk.f(ctx.get([\"title\"], false), ctx, \"h\"); } body_5.__dustBody = !0; function body_6(chk, ctx) { return chk.f(ctx.getPath(true, []), ctx, \"h\").h(\"sep\", ctx, { \"block\": body_7 }, {}); } body_6.__dustBody = !0; function body_7(chk, ctx) { return chk.w(\" &bull; \"); } body_7.__dustBody = !0; function body_8(chk, ctx) { return chk.w(\"checked=\\\"checked\\\"\"); } body_8.__dustBody = !0; function body_9(chk, ctx) { return chk.w(\"<div class=\\\"tc-ctl-wlm-abstract\\\"><h4>\").h(\"i18n\", ctx, {}, { \"$key\": \"abstract\" }).w(\"</h4><div><pre>\").f(ctx.get([\"abstract\"], false), ctx, \"h\", [\"s\"]).w(\"</pre></div></div>\"); } body_9.__dustBody = !0; function body_10(chk, ctx) { return chk.x(ctx.get([\"legend\"], false), ctx, { \"block\": body_11 }, {}); } body_10.__dustBody = !0; function body_11(chk, ctx) { return chk.w(\"<div class=\\\"tc-ctl-wlm-legend\\\" data-tc-layer-name=\\\"\").f(ctx.get([\"layerNames\"], false), ctx, \"h\").w(\"\\\"><h4>\").h(\"i18n\", ctx, {}, { \"$key\": \"content\" }).w(\"</h4>\").s(ctx.get([\"legend\"], false), ctx, { \"block\": body_12 }, {}).w(\"</div>\"); } body_11.__dustBody = !0; function body_12(chk, ctx) { return chk.w(\"<div><p>\").f(ctx.get([\"title\"], false), ctx, \"h\").w(\"</p><img data-tc-img=\\\"\").f(ctx.get([\"src\"], false), ctx, \"h\").w(\"\\\" /></div>\"); } body_12.__dustBody = !0; function body_13(chk, ctx) { return chk.w(\"<ul class=\\\"tc-ctl-wlm-custom-legend\\\">\").f(ctx.get([\"customLegend\"], false), ctx, \"h\", [\"s\"]).w(\"</ul>\"); } body_13.__dustBody = !0; function body_14(chk, ctx) { return chk.w(\"<div class=\\\"tc-ctl-wlm-metadata\\\"><h4>\").h(\"i18n\", ctx, {}, { \"$key\": \"metadata\" }).w(\"</h4><ul>\").s(ctx.get([\"metadata\"], false), ctx, { \"block\": body_15 }, {}).w(\"</ul></div>\"); } body_14.__dustBody = !0; function body_15(chk, ctx) { return chk.w(\"<li><a href=\\\"\").f(ctx.get([\"url\"], false), ctx, \"h\", [\"s\"]).w(\"\\\" type=\\\"\").f(ctx.get([\"format\"], false), ctx, \"h\").w(\"\\\" title=\\\"\").f(ctx.get([\"formatDescription\"], false), ctx, \"h\").w(\"\\\" target=\\\"_blank\\\">\").f(ctx.get([\"formatDescription\"], false), ctx, \"h\").w(\"</a></li>\"); } body_15.__dustBody = !0; function body_16(chk, ctx) { return chk.w(\"tc-hidden\"); } body_16.__dustBody = !0; function body_17(chk, ctx) { return chk.w(\"disabled\"); } body_17.__dustBody = !0; function body_18(chk, ctx) { return chk.w(\"tc-hidden\"); } body_18.__dustBody = !0; function body_19(chk, ctx) { return chk.w(\"title=\\\"\").h(\"i18n\", ctx, {}, { \"$key\": \"removeLayerFromMap\" }).w(\"\\\"\"); } body_19.__dustBody = !0; return body_0; };\r\n        ctlProto.template[ctlProto.CLASS + '-type-sgl'] = function () { dust.register(ctlProto.CLASS + '-type-sgl', body_0); function body_0(chk, ctx) { return chk.h(\"i18n\", ctx, {}, { \"$key\": \"singleLayer\" }); } body_0.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-type-grp'] = function () { dust.register(ctlProto.CLASS + '-type-grp', body_0); function body_0(chk, ctx) { return chk.w(\"<div>\").h(\"i18n\", ctx, {}, { \"$key\": \"groupLayerThatContains\" }).w(\":</div><ul>\").s(ctx.get([\"Layer\"], false), ctx, { \"block\": body_1 }, {}).w(\"</ul>\"); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.p(\"tc-ctl-wlm-type-grp-node\", ctx, ctx.rebase(ctx.getPath(true, [])), {}); } body_1.__dustBody = !0; return body_0 };\r\n        ctlProto.template[ctlProto.CLASS + '-type-grp-node'] = function () { dust.register(ctlProto.CLASS + '-type-grp-node', body_0); function body_0(chk, ctx) { return chk.w(\"<li class=\\\"tc-ctl-wlm-tip-grp-elm\\\"><span>\").f(ctx.get([\"Title\"], false), ctx, \"h\").w(\"</span><ul>\").s(ctx.get([\"Layer\"], false), ctx, { \"block\": body_1 }, {}).w(\"</ul></li>\"); } body_0.__dustBody = !0; function body_1(chk, ctx) { return chk.p(\"tc-ctl-wlm-type-grp-node\", ctx, ctx.rebase(ctx.getPath(true, [])), {}); } body_1.__dustBody = !0; return body_0 };\r\n    }\r\n\r\n    const _dataKeys = {\r\n        layer: 'tcLayer'\r\n    };\r\n\r\n    const findLayerElement = function (ctl, layer) {\r\n        return ctl.getLayerUIElements().filter(function (li) {\r\n            return $(li).data(_dataKeys.layer) === layer;\r\n        })[0];\r\n    };\r\n\r\n    var getElligibleLayersNumber = function (ctl) {\r\n        return $.grep(ctl.map.workLayers, function (lyr) {\r\n            return !lyr.stealth;\r\n        }).length;\r\n    };\r\n\r\n    const shouldBeDelAllVisible = function (ctl) {\r\n        return !ctl.layers.some(function (layer) { return layer.unremovable });\r\n    };\r\n\r\n    const moveLayer = function (ctl, listItem, oldIndex, newIndex, callback) {\r\n        const layerItems = ctl.getLayerUIElements();\r\n        var targetItem;\r\n        if (newIndex > oldIndex) {\r\n            targetItem = layerItems[newIndex - 1];\r\n        }\r\n        else if (newIndex < oldIndex) {\r\n            targetItem = layerItems[newIndex + 1];\r\n        }\r\n        else {\r\n            return;\r\n        }\r\n        const sourceLayer = $(listItem).data(_dataKeys.layer);\r\n        const targetLayer = $(targetItem).data(_dataKeys.layer);\r\n        var newIdx = -1;\r\n        for (var i = 0; i < ctl.map.layers.length; i++) {\r\n            if (targetLayer === ctl.map.layers[i]) {\r\n                newIdx = i;\r\n                break;\r\n            }\r\n        }\r\n        if (newIdx >= 1 && newIdx < ctl.map.layers.length) {\r\n            ctl.map.insertLayer(sourceLayer, newIdx, callback);\r\n        }\r\n    };\r\n\r\n    ctlProto.render = function (callback, options) {\r\n        const self = this;\r\n        return self._set1stRenderPromise(self.map ? self.renderData(options ? $.extend(self.map.getLayerTree(), options) : self.map.getLayerTree(), function () {\r\n            self.addUIEventListeners();\r\n            TC.loadJS(\r\n                !window.Sortable,\r\n                [TC.apiLocation + 'lib/sortable/Sortable.min.js'],\r\n                function () {\r\n                    self.map.workLayers\r\n                        .filter(function (layer) {\r\n                            return !layer.stealth;\r\n                        })\r\n                        .forEach(function (layer) {\r\n                            self.updateLayerTree(layer);\r\n                        });\r\n\r\n\r\n                    const ul = self.div.querySelector('ul');\r\n                    self._sortable = Sortable.create(ul, {\r\n                        handle: '.' + self.CLASS + '-dd',\r\n                        animation: 150,\r\n                        onSort: function (e) {\r\n                            moveLayer(self, e.item, e.oldIndex, e.newIndex);\r\n                        }\r\n                    });\r\n\r\n                    ul.addEventListener('keydown', TC.EventTarget.listenerBySelector('li', function (e) {\r\n                        // Para mover capas con el teclado.\r\n                        var elm = e.target;\r\n                        while (elm.tagName !== 'LI') {\r\n                            elm = elm.parentElement;\r\n                            if (!elm) {\r\n                                return;\r\n                            }\r\n                        }\r\n                        const swap = function (oldIdx, newIdx) {\r\n                            const sortableItems = self._sortable.toArray();\r\n                            const buffer = sortableItems[oldIdx];\r\n                            sortableItems[oldIdx] = sortableItems[newIdx];\r\n                            sortableItems[newIdx] = buffer;\r\n                            self._sortable.sort(sortableItems);\r\n                            moveLayer(self, elm, oldIdx, newIdx);\r\n                        };\r\n                        const listItems = self.getLayerUIElements();\r\n                        const elmIdx = listItems.indexOf(elm);\r\n                        switch (true) {\r\n                            case /Up$/.test(e.key):\r\n                                if (elmIdx > 0) {\r\n                                    swap(elmIdx, elmIdx - 1);\r\n                                    elm.focus();\r\n                                    e.stopPropagation();\r\n                                }\r\n                                break;\r\n                            case /Down$/.test(e.key):\r\n                                if (elmIdx < listItems.length - 1) {\r\n                                    swap(elmIdx, elmIdx + 1);\r\n                                    elm.focus();\r\n                                    e.stopPropagation();\r\n                                }\r\n                                break;\r\n                            case /Enter$/.test(e.key):\r\n                                elm.blur();\r\n                                e.stopPropagation();\r\n                                break;\r\n                            default:\r\n                                break;\r\n                        }\r\n                    }));\r\n\r\n                    if (typeof callback === 'function') {\r\n                        callback();\r\n                    }\r\n                }\r\n            );\r\n        }) : Promise.reject());\r\n    };\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n\r\n        return new Promise(function (resolve, reject) {\r\n            TC.control.TOC.prototype.register.call(self, map).then(function () {\r\n\r\n                map\r\n                    .on(TC.Consts.event.LAYEROPACITY, function (e) {\r\n                        const li = findLayerElement(self, e.layer);\r\n                        if (li) {\r\n                            li.querySelector('input[type=range]').value = Math.round(e.opacity * 100);\r\n                        }\r\n                    })\r\n                    .on(TC.Consts.event.FEATURESIMPORT, function (e) {\r\n                        var fileName = e.fileName;\r\n                        if (e.features && e.features.length > 0) { // GLS: Escuchamos al evento FEATURESIMPORT para poder desplegar el control de capas cargadas\r\n                            // Ignoramos los GPX (se supone que los gestionar√° Geolocation)\r\n                            var pattern = '.' + TC.Consts.format.GPX.toLowerCase();\r\n                            if (e.fileName.toLowerCase().indexOf(pattern) === e.fileName.length - pattern.length) {\r\n                                return;\r\n                            }\r\n\r\n                            map.one(TC.Consts.event.LAYERADD, function (e) {\r\n                                if (e && e.layer && e.layer.title == fileName) {\r\n                                    // Desplegamos el control capas cargadas\r\n                                    if (self.map && self.map.layout && self.map.layout.accordion) {\r\n                                        if (self.div.classList.contains(TC.Consts.classes.COLLAPSED)) {\r\n                                            for (var i = 0; i < self.map.controls.length; i++) {\r\n                                                if (self.map.controls[i] !== self) {\r\n                                                    self.map.controls[i].div.classList.add(TC.Consts.classes.COLLAPSED);\r\n                                                }\r\n                                            }\r\n                                        }\r\n                                    }\r\n\r\n                                    // abrimos el panel de herramientas\r\n                                    self.map.trigger(TC.Consts.event.TOOLSOPEN);\r\n\r\n                                    self.div.classList.remove(TC.Consts.classes.COLLAPSED);\r\n                                }\r\n                            });\r\n                        }\r\n                    });\r\n                if (self.queries) {\r\n                    if (!TC.control.WFSQuery) {\r\n                        TC.syncLoadJS(TC.apiLocation + 'TC/Control/WFSQuery');\r\n                    }\r\n                    ctlProto.queryControl = new TC.control.WFSQuery(null, self.queries instanceof Object ? self.queries : null);\r\n                    self.map.addControl(ctlProto.queryControl);\r\n                }\r\n                resolve(self);\r\n            });\r\n        });\r\n    };\r\n\r\n    ctlProto.onExternalServiceAdded = function (e, map) {\r\n        // Este control no tiene que aceptar servicios externos directamente\r\n    };\r\n\r\n    ctlProto.addUIEventListeners = function () {\r\n        const self = this;\r\n\r\n        self.div.addEventListener(self.CLICKEVENT, TC.EventTarget.listenerBySelector('input[type=checkbox]', function (e) {\r\n            // al estar en ipad el evento pasa a ser touchstart en la constante: TC.Consts.event.CLICK, los checkbox no funcionan bien con este evento\r\n            const checkbox = e.target;\r\n            var li = checkbox;\r\n            do {\r\n                li = li.parentElement;\r\n            }\r\n            while (li && !li.matches('li.' + self.CLASS + '-elm'));\r\n\r\n            const layer = $(li).data(_dataKeys.layer);\r\n            layer.setVisibility(checkbox.checked);\r\n            e.stopPropagation();\r\n        }));\r\n\r\n        const inputRangeListener = function (e) {\r\n            const range = e.target;\r\n            var li = range;\r\n            do {\r\n                li = li.parentElement;\r\n            }\r\n            while (li && li.tagName !== 'LI');\r\n\r\n            const layer = $(li).data(_dataKeys.layer);\r\n            layer.setOpacity(range.value / 100);\r\n        };\r\n        self.div.addEventListener('change', TC.EventTarget.listenerBySelector('input[type=range]', inputRangeListener));\r\n        self.div.addEventListener('input', TC.EventTarget.listenerBySelector('input[type=range]', inputRangeListener));\r\n\r\n        self.div.addEventListener(self.CLICKEVENT, TC.EventTarget.listenerBySelector('.' + self.CLASS + '-del' + ':not(.disabled)', function (e) {\r\n            var li = e.target;\r\n            do {\r\n                li = li.parentElement;\r\n            }\r\n            while (li && li.tagName !== 'LI');\r\n            const layer = $(li).data(_dataKeys.layer);\r\n            self.map.removeLayer(layer);\r\n        }));\r\n\r\n        self.div.addEventListener(self.CLICKEVENT, TC.EventTarget.listenerBySelector('.' + self.CLASS + '-del-all', function (e) {\r\n            TC.confirm(self.getLocaleString('layersRemove.confirm'), function () {\r\n                self.getLayerUIElements()\r\n                    .map(function (li) {\r\n                        return $(li).data(_dataKeys.layer);\r\n                    })\r\n                    .forEach(function (layer) {\r\n                        self.map.removeLayer(layer);\r\n                    });\r\n            });\r\n        }));\r\n\r\n        self.div.addEventListener(self.CLICKEVENT, TC.EventTarget.listenerBySelector('.' + self.CLASS + '-btn-info', function (e) {\r\n            const a = e.target;\r\n            var li = a;\r\n            do {\r\n                li = li.parentElement;\r\n            }\r\n            while (li && li.tagName !== 'LI');\r\n            const info = li.querySelector('.' + self.CLASS + '-info');\r\n            const layer = $(li).data(_dataKeys.layer);\r\n            // Cargamos la imagen de la leyenda\r\n            info.querySelectorAll('.' + self.CLASS + '-legend img').forEach(function (img) {\r\n                self.styleLegendImage(img, layer);\r\n            });\r\n            if (info.classList.contains(TC.Consts.classes.HIDDEN)) {\r\n                info.classList.remove(TC.Consts.classes.HIDDEN);\r\n            }\r\n            else {\r\n                info.classList.add(TC.Consts.classes.HIDDEN);\r\n            }\r\n\r\n            if (li.querySelector('input[type=\"checkbox\"]').checked) {\r\n                const dragHandle = li.querySelector('.' + self.CLASS + '-dd');\r\n                if (info.classList.contains(TC.Consts.classes.HIDDEN)) {\r\n                    dragHandle.classList.remove(TC.Consts.classes.HIDDEN);\r\n                }\r\n                else {\r\n                    dragHandle.classList.add(TC.Consts.classes.HIDDEN);\r\n                }\r\n            }\r\n\r\n            if (a.classList.contains(TC.Consts.classes.CHECKED)) {\r\n                a.classList.remove(TC.Consts.classes.CHECKED);\r\n            }\r\n            else {\r\n                a.classList.add(TC.Consts.classes.CHECKED);\r\n            }\r\n        }));\r\n\r\n        self.div.addEventListener(self.CLICKEVENT, TC.EventTarget.listenerBySelector('.' + self.CLASS + '-btn-query', function (e) {\r\n            if (e.target.classList.contains('tc-unavailable') || e.target.classList.contains('tc-loading')) {\r\n                return;\r\n            }\r\n            const a = e.target;\r\n            var li = a;\r\n            do {\r\n                li = li.parentElement;\r\n            }\r\n            while (li && li.tagName !== 'LI');\r\n            const layer = $(li).data(_dataKeys.layer);\r\n            self.queryControl.renderModalDialog(layer);\r\n        }));\r\n    };\r\n\r\n    ctlProto.updateLayerVisibility = function (layer) {\r\n        const self = this;\r\n        const li = findLayerElement(self, layer);\r\n        if (li) {\r\n            const visible = layer.getVisibility();\r\n            li.querySelector('input[type=\"checkbox\"]').checked = visible;\r\n            const delBtn = li.querySelector('.' + self.CLASS + '-del');\r\n            const info = li.querySelector('.' + self.CLASS + '-info');\r\n            const dragHandle = li.querySelector('.' + self.CLASS + '-dd');\r\n            if (visible) {\r\n                delBtn.classList.add(TC.Consts.classes.HIDDEN);\r\n                if (info.classList.contains(TC.Consts.classes.HIDDEN)) {\r\n                    dragHandle.classList.remove(TC.Consts.classes.HIDDEN);\r\n                }\r\n            }\r\n            else {\r\n                delBtn.classList.remove(TC.Consts.classes.HIDDEN);\r\n                if (info.classList.contains(TC.Consts.classes.HIDDEN)) {\r\n                    dragHandle.classList.add(TC.Consts.classes.HIDDEN);\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    ctlProto.updateLayerTree = function (layer) {\r\n        var self = this;\r\n\r\n        var getLegendImgByPost = function (layer) {\r\n            return new Promise(function (resolve, reject) {\r\n                if (layer && layer.options.method && layer.options.method === \"POST\") {\r\n                    layer.getLegendGraphicImage()\r\n                        .then(function (src) {\r\n                            resolve(src);\r\n                        })\r\n                        .catch(function (err) { TC.error(err); });\r\n                } else {\r\n                    resolve();\r\n                }\r\n            });\r\n        };\r\n\r\n        if (!layer.isBase && !layer.options.stealth) {\r\n            TC.control.MapContents.prototype.updateLayerTree.call(self, layer);\r\n\r\n            var alreadyExists = false;\r\n            for (var i = 0, len = self.layers.length; i < len; i++) {\r\n                if (layer === self.layers[i]) {\r\n                    alreadyExists = true;\r\n                    break;\r\n                }\r\n            }\r\n\r\n            if (!alreadyExists) {\r\n                var template = self.CLASS + '-elm';\r\n                self.layers.push(layer);\r\n\r\n                TC.loadJSInOrder(\r\n                    !window.dust,\r\n                    TC.url.templating,\r\n                    function () {\r\n                        var domReadyPromise;\r\n                        var layerTitle = layer.title || layer.wrap.getServiceTitle();\r\n                        var layerData = {\r\n                            title: layer.options.hideTitle ? '' : layerTitle,\r\n                            hide: layer.renderOptions && layer.renderOptions.hide ? true : false,\r\n                            opacity: layer.renderOptions && layer.renderOptions.opacity ? (layer.renderOptions.opacity * 100) : 100,\r\n                            customLegend: layer.customLegend,\r\n                            unremovable: layer.unremovable\r\n                        };\r\n                        var isRaster = layer.isRaster();\r\n                        if (isRaster) {\r\n                            layerData.layerNames = layer.layerNames;\r\n                            var path = layer.getPath();\r\n                            path.shift();\r\n                            layerData.path = path;\r\n                            var name = layer.names[0];\r\n                            var info = layer.wrap.getInfo(name);\r\n                            layerData.legend = info.legend;\r\n                            layerData['abstract'] = info['abstract'];\r\n                            var hasInfo = (info.hasOwnProperty('abstract') || info.hasOwnProperty('legend') || info.hasOwnProperty('metadata'));\r\n                            var metadata;\r\n                            if (layer.tree && layer.tree.children && layer.tree.children.length && layer.tree.children[0].children && layer.tree.children[0].children.length) {\r\n                                metadata = null;\r\n                            }\r\n                            else {\r\n                                metadata = info.metadata;\r\n                                if (metadata) {\r\n                                    for (var j = 0, len = metadata.length; j < len; j++) {\r\n                                        var md = metadata[j];\r\n                                        md.formatDescription = self.getLocaleString(TC.Util.getSimpleMimeType(md.format)) || self.getLocaleString('viewMetadata');\r\n                                    }\r\n                                }\r\n                            }\r\n                            layerData.metadata = metadata;\r\n                            if (self.queries) {\r\n                                domReadyPromise = checkWFSAvailable(layer);\r\n                            }\r\n                        }\r\n\r\n\r\n                        getLegendImgByPost(layer).then(function (src) {\r\n                            if (src) {\r\n                                legend.src = src; // ya se ha validado en getLegendImgByPost\r\n                            }\r\n\r\n                            dust.render(template, layerData, function (err, out) {\r\n                                const parser = new DOMParser();\r\n                                const li = parser.parseFromString(out, 'text/html').body.firstChild;\r\n                                var layerNode;\r\n                                var isGroup = false;\r\n                                if (isRaster) {\r\n                                    isGroup = layer.names.length > 1;\r\n                                    if (!isGroup) {\r\n                                        var layerNodes = layer.wrap.getAllLayerNodes();\r\n                                        for (var i = 0; i < layerNodes.length; i++) {\r\n                                            var node = layerNodes[i];\r\n                                            if (layer.wrap.getName(node) === name) {\r\n                                                layerNode = node;\r\n                                                if (layer.wrap.getLayerNodes(node).length > 0) {\r\n                                                    isGroup = true;\r\n                                                }\r\n                                                break;\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                }\r\n\r\n                                const typeElm = li.querySelector('.' + self.CLASS + '-type');\r\n                                const className = isGroup ? self.CLASS + '-type-grp' : self.CLASS + '-type-sgl';\r\n                                typeElm.classList.add(className);\r\n\r\n                                if (!hasInfo) {\r\n                                    li.querySelector('.' + self.CLASS + '-btn-info').classList.add(TC.Consts.classes.HIDDEN);\r\n                                }\r\n\r\n                                if (layerNode) {\r\n                                    layer.wrap.normalizeLayerNode(layerNode);\r\n\r\n                                    dust.render(className, layerNode, function (err, out) {\r\n                                        var tip;\r\n                                        \r\n                                        typeElm.addEventListener('mouseover', function (e) {\r\n                                            const mapDiv = self.map.div;\r\n                                            const typeElmRect = typeElm.getBoundingClientRect();\r\n                                            tip = document.createElement('div');\r\n                                            tip.classList.add(self.CLASS + '-tip');\r\n                                            tip.innerHTML = out;\r\n                                            tip.style.top = (typeElmRect.top - mapDiv.offsetTop) + 'px';\r\n                                            tip.style.right = mapDiv.offsetWidth - (typeElmRect.left - mapDiv.offsetLeft) + 'px';\r\n                                            mapDiv.appendChild(tip);\r\n                                        });\r\n                                        typeElm.addEventListener('mouseout', function (e) {\r\n                                            tip.parentElement.removeChild(tip);\r\n                                        });\r\n                                    });\r\n                                }\r\n                                const ul = self.div.querySelector('ul');\r\n                                $(li).data(_dataKeys.layer, layer);\r\n\r\n                                const lis = self.getLayerUIElements();\r\n                                const layerList = self.map.workLayers\r\n                                    .filter(function (l) {\r\n                                        return !l.stealth;\r\n                                    });\r\n                                const layerIdx = layerList.indexOf(layer);\r\n                                var inserted = false;\r\n                                for (var i = 0, ii = lis.length; i < ii; i++) {\r\n                                    const referenceLi = lis[i];\r\n                                    const referenceLayer = $(referenceLi).data(_dataKeys.layer);\r\n                                    const referenceLayerIdx = layerList.indexOf(referenceLayer);\r\n                                    if (referenceLayerIdx < layerIdx) {\r\n                                        referenceLi.insertAdjacentElement('beforebegin', li);\r\n                                        inserted = true;\r\n                                        break;\r\n                                    }\r\n                                }\r\n                                if (!inserted) {\r\n                                    ul.appendChild(li);\r\n                                }\r\n                                if (domReadyPromise) domReadyPromise(li);\r\n                                self.updateScale();\r\n                            });\r\n                        });\r\n                    }\r\n                );\r\n\r\n                var elligibleLayersNum = getElligibleLayersNumber(self);\r\n                const numElm = self.div.querySelector('.' + self.CLASS + '-n');\r\n                const emptyElm = self.div.querySelector('.' + self.CLASS + '-empty');\r\n                const contentElm = self.div.querySelector('.' + self.CLASS + '-content');\r\n                numElm.textContent = elligibleLayersNum;\r\n                if (elligibleLayersNum > 0) {\r\n                    numElm.classList.add(TC.Consts.classes.VISIBLE);\r\n                    emptyElm.classList.add(TC.Consts.classes.HIDDEN);\r\n                    contentElm.classList.remove(TC.Consts.classes.HIDDEN);\r\n                }\r\n                else {\r\n                    numElm.classList.remove(TC.Consts.classes.VISIBLE);\r\n                    emptyElm.classList.remove(TC.Consts.classes.HIDDEN);\r\n                    contentElm.classList.add(TC.Consts.classes.HIDDEN);\r\n                }\r\n\r\n                const deleteAllElm = self.div.querySelector('.' + self.CLASS + '-del-all');\r\n                if (shouldBeDelAllVisible(self)) {\r\n                    deleteAllElm.classList.remove(TC.Consts.classes.HIDDEN);\r\n                } else {\r\n                    deleteAllElm.classList.add(TC.Consts.classes.HIDDEN);\r\n                }\r\n            }\r\n        }\r\n    };\r\n\r\n    ctlProto.updateScale = function () {\r\n        var self = this;\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            var layer = $(li).data(_dataKeys.layer);\r\n            if (layer.names) {\r\n                var isVisible = false;\r\n                for (var i = 0; i < layer.names.length; i++) {\r\n                    if (layer.isVisibleByScale(layer.names[i])) {\r\n                        isVisible = true;\r\n                        break;\r\n                    }\r\n                }\r\n                const notVisibleClass = self.CLASS + '-elm-notvisible';\r\n                if (isVisible) {\r\n                    li.classList.remove(notVisibleClass);\r\n                }\r\n                else {\r\n                    li.classList.add(notVisibleClass);\r\n                }\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.updateLayerOrder = function (layer, oldIdx, newIdx) {\r\n        //TC.control.MapContents.prototype.updateLayerOrder.call(this, layer, oldIdx, newIdx);\r\n        const self = this;\r\n        self.map.workLayers\r\n            .filter(function (layer) {\r\n                return !layer.stealth;\r\n            })\r\n            .forEach(function (layer) {\r\n                const li = findLayerElement(self, layer);\r\n                if (li) {\r\n                    li.parentElement.firstChild.insertAdjacentElement('beforebegin', li);\r\n                }\r\n            });\r\n    };\r\n\r\n    ctlProto.removeLayer = function (layer) {\r\n        var self = this;\r\n        var idx = self.layers.indexOf(layer);\r\n        if (idx >= 0) {\r\n            self.layers.splice(idx, 1);\r\n        }\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            if ($(li).data(_dataKeys.layer) === layer) {\r\n                li.parentElement.removeChild(li);\r\n            }\r\n        });\r\n        const contentElm = self.div.querySelector('.' + self.CLASS + '-content');\r\n        const emptyElm = self.div.querySelector('.' + self.CLASS + '-empty');\r\n        const numberElm = self.div.querySelector('.' + self.CLASS + '-n');\r\n        var nChildren = getElligibleLayersNumber(self);\r\n        numberElm.textContent = nChildren;\r\n        if (nChildren > 0) {\r\n            contentElm.classList.remove(TC.Consts.classes.HIDDEN);\r\n            emptyElm.classList.add(TC.Consts.classes.HIDDEN);\r\n            numberElm.classList.add(TC.Consts.classes.VISIBLE);\r\n        }\r\n        else {\r\n            if (shouldBeDelAllVisible(self)) {\r\n                self.div.querySelector('.' + self.CLASS + '-del-all').classList.add(TC.Consts.classes.HIDDEN);\r\n            }\r\n            contentElm.classList.add(TC.Consts.classes.HIDDEN);\r\n            emptyElm.classList.remove(TC.Consts.classes.HIDDEN);\r\n            numberElm.classList.remove(TC.Consts.classes.VISIBLE);\r\n        }\r\n    };\r\n\r\n    ctlProto.getLayerUIElements = function () {\r\n        const self = this;\r\n        const result = [];\r\n        const children = self.div.querySelector('ul').children;\r\n        for (var i = 0, len = children.length; i < len; i++) {\r\n            child = children[i];\r\n            if (child.matches('li.' + self.CLASS + '-elm')) {\r\n                result[result.length] = child;\r\n            }\r\n        }\r\n        return result;\r\n    };\r\n\r\n    //analiza la nueva capa a√±adida si tiene habilitado o no el WFS\r\n    const checkWFSAvailable = function (layer) {\r\n        var fncResolve = null;\r\n        var domReadyPromise = new Promise(function (resolve, reject) {\r\n            fncResolve = resolve;\r\n        })\r\n        var cssClassUnavailable = 'tc-unavailable';\r\n        \r\n        var queryButton;\r\n        domReadyPromise.then(function (li) {\r\n            queryButton = document.createElement('div');\r\n            queryButton.classList.add(ctlProto.CLASS + '-btn-query');\r\n            queryButton.classList.add(TC.Consts.classes.LOADING);\r\n            queryButton.setAttribute('title', ctlProto.getLocaleString('query.tooltipMagnifBtn'));\r\n            li.querySelector('.' + ctlProto.CLASS + '-btn-info').insertAdjacentElement('afterend', queryButton);\r\n        });\r\n        var getCapProm = layer.getWFSCapabilitiesPromise()\r\n        const noWFSAvailabeManage = function () {\r\n            if (queryButton) {\r\n                queryButton.classList.remove(TC.Consts.classes.LOADING);\r\n                queryButton.classList.add(cssClassUnavailable);\r\n            }\r\n            //queryButton.attr(\"title\", getLocaleString(\"query.tooltipMagnifBtnDisabled\"));\r\n            console.log(\"El servicio \" + (layer.title || layer.tree.title) + \" no tiene disponible el WFS\");\r\n        }\r\n        Promise.all([getCapProm, domReadyPromise]).then(function () {\r\n            var capabilities = arguments[0][0];\r\n            //comprobamos que la solo es una capa y existe en el capabilities del WFS                        \r\n            if (queryButton) {\r\n                queryButton.classList.remove(TC.Consts.classes.LOADING)\r\n                var layers = layer.getDisgregatedLayerNames();\r\n                if (layers.length === 1 && !capabilities.FeatureTypes.hasOwnProperty(layers[0].substring(layers[0].indexOf(\":\") + 1))) {\r\n                    queryButton.classList.add(cssClassUnavailable);\r\n                    //queryButton.attr(\"title\", getLocaleString(\"query.tooltipMagnifBtnDisabled\"));\r\n                    console.log(\"El servicio WFS de \" + (layer.title || layer.tree.title) + \" no dispone de la capa \" + layers[0]);\r\n                }\r\n            }\r\n\r\n        }).catch(noWFSAvailabeManage);\r\n        getCapProm.catch(noWFSAvailabeManage);\r\n        return fncResolve;\r\n    }\r\n})();"],"file":"../../control/WorkLayerManager.min.js"}