{"version":3,"sources":["control/Legend.js"],"names":["TC","control","MapContents","syncLoadJS","apiLocation","Legend","apply","this","arguments","inherit","ctlProto","prototype","CLASS","template","dust","register","body_0","chk","ctx","w","h","$key","s","get","else","body_1","block","body_2","__dustBody","p","rebase","getPath","x","body_11","body_3","f","body_4","body_10","body_5","body_8","body_6","body_7","body_9","map","self","on","Consts","event","VIEWCHANGE","e","view","onLayerAdd","loadGraphics","bind","THREED","LAYERADD","DEFAULT","off","call","getLayerUIElements","forEach","li","layer","getLayer","dataset","layerId","querySelectorAll","l","img","querySelector","undefined","getAttribute","length","styleLegendImage","updateScale","inScale","outOfScale","layersInScale","lis","classList","contains","uid","layerUid","isVisibleByScale","remove","add","toggle","update","getTree","visible","notVisible","hasVisible","_cache","visibilityStates","visibility","NOT_VISIBLE","HAS_VISIBLE","updateLayerVisibility","updateLayerTree","isBase","options","stealth","hideTree","tree","div","classes","HIDDEN","getRenderedHtml","layerTrees","id","then","out","newLi","DOMParser","parseFromString","body","firstChild","ul","innerHTML","setAttribute","insertBefore","catch","err","error","removeLayer","getVisibility"],"mappings":"AAAAA,GAAGC,QAAUD,GAAGC,SAAW,GAEtBD,GAAGC,QAAQC,aACZF,GAAGG,WAAWH,GAAGI,YAAc,0BAGnCJ,GAAGC,QAAQI,OAAS,WAChBL,GAAGC,QAAQC,YAAYI,MAAMC,KAAMC,YAGvCR,GAAGS,QAAQT,GAAGC,QAAQI,OAAQL,GAAGC,QAAQC,cAEzC,WACI,IAAIQ,EAAWV,GAAGC,QAAQI,OAAOM,UAEjCD,EAASE,MAAQ,gBAEjBF,EAASG,SAAW,GACpBH,EAASG,SAASH,EAASE,OAAS,WAAWE,KAAKC,SAASL,EAASE,MAAMI,GAAQ,SAASA,EAAOC,EAAIC,GAAK,OAAOD,EAAIE,EAAE,QAAQC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,WAAWF,EAAE,0EAA8EG,EAAEJ,EAAIK,IAAI,CAAC,eAAe,GAAOL,EAAI,CAACM,KAAOC,EAAOC,MAAQC,GAAQ,IAAIR,EAAE,eAAgBH,EAAOY,YAAW,EAAG,SAASH,EAAOR,EAAIC,GAAK,OAAOD,EAAIE,EAAE,oCAAsCC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,WAAWF,EAAE,SAAUM,EAAOG,YAAW,EAAG,SAASD,EAAOV,EAAIC,GAAK,OAAOD,EAAIY,EAAE,qBAAqBX,EAAIA,EAAIY,OAAOZ,EAAIa,SAAQ,EAAM,KAAK,IAAKJ,EAAOC,YAAW,EAAG,OAAOZ,GACtnBN,EAASG,SAASH,EAASE,MAAQ,SAAW,WAAWE,KAAKC,SAASL,EAASE,MAAQ,QAAQI,GAAQ,SAASA,EAAOC,EAAIC,GAAK,OAAOD,EAAIe,EAAEd,EAAIK,IAAI,CAAC,iBAAiB,GAAOL,EAAI,CAACM,KAAOC,EAAOC,MAAQO,GAAS,IAAKjB,EAAOY,YAAW,EAAG,SAASH,EAAOR,EAAIC,GAAK,OAAOD,EAAIE,EAAE,QAAQa,EAAEd,EAAIK,IAAI,CAAC,aAAa,GAAOL,EAAI,CAACM,KAAOG,EAAOD,MAAQQ,GAAQ,IAAIf,EAAE,sBAAuBgB,EAAEjB,EAAIK,IAAI,CAAC,SAAS,GAAOL,EAAI,KAAKC,EAAE,sBAAwBgB,EAAEjB,EAAIK,IAAI,CAAC,QAAQ,GAAOL,EAAI,KAAKC,EAAE,uCAA0CgB,EAAEjB,EAAIK,IAAI,CAAC,UAAU,GAAOL,EAAI,KAAKC,EAAE,UAAUa,EAAEd,EAAIK,IAAI,CAAC,WAAW,GAAOL,EAAI,CAACQ,MAAQU,GAAQ,IAAIjB,EAAE,qCAAuCG,EAAEJ,EAAIK,IAAI,CAAC,aAAa,GAAOL,EAAI,CAACQ,MAAQW,GAAS,IAAIlB,EAAE,cAAeM,EAAOG,YAAW,EAAG,SAASD,EAAOV,EAAIC,GAAK,OAAOD,EAAIE,EAAE,kDAAqDQ,EAAOC,YAAW,EAAG,SAASM,EAAOjB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,+BAAkCe,EAAON,YAAW,EAAG,SAASQ,EAAOnB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,qCAAuCa,EAAEd,EAAIa,SAAQ,EAAO,CAAC,SAAS,QAAQb,EAAI,CAACM,KAAOc,EAAOZ,MAAQa,GAAQ,IAAIpB,EAAE,yCAA2CC,EAAE,OAAOF,EAAI,GAAG,CAACG,KAAO,kCAAkCF,EAAE,UAAWiB,EAAOR,YAAW,EAAG,SAASU,EAAOrB,EAAIC,GAAK,OAAOD,EAAIe,EAAEd,EAAIa,SAAQ,EAAO,CAAC,SAAS,UAAUb,EAAI,CAACQ,MAAQc,GAAQ,IAAKF,EAAOV,YAAW,EAAG,SAASY,EAAOvB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,uDAA0DgB,EAAEjB,EAAIa,SAAQ,EAAO,CAAC,SAAS,gBAAgBb,EAAI,KAAKC,EAAE,OAAOgB,EAAEjB,EAAIa,SAAQ,EAAO,CAAC,SAAS,gBAAgBb,EAAI,KAAKC,EAAE,sBAAsBgB,EAAEjB,EAAIa,SAAQ,EAAO,CAAC,SAAS,cAAcb,EAAI,KAAKc,EAAEd,EAAIa,SAAQ,EAAO,CAAC,SAAS,UAAUb,EAAI,CAACQ,MAAQe,GAAQ,IAAItB,EAAE,YAAcqB,EAAOZ,YAAW,EAAG,SAASa,EAAOxB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,WAAWgB,EAAEjB,EAAIa,SAAQ,EAAO,CAAC,SAAS,UAAUb,EAAI,KAAKC,EAAE,cAAcgB,EAAEjB,EAAIa,SAAQ,EAAO,CAAC,SAAS,WAAWb,EAAI,KAAKC,EAAE,wBAAyBsB,EAAOb,YAAW,EAAG,SAASW,EAAOtB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,0BAA6BgB,EAAEjB,EAAIa,SAAQ,EAAO,CAAC,SAAS,QAAQb,EAAI,KAAKC,EAAE,MAAOa,EAAEd,EAAIa,SAAQ,EAAO,CAAC,SAAS,UAAUb,EAAI,CAACQ,MAAQgB,GAAQ,IAAIvB,EAAE,OAAQoB,EAAOX,YAAW,EAAG,SAASc,EAAOzB,EAAIC,GAAK,OAAOD,EAAIE,EAAE,iBAAkBgB,EAAEjB,EAAIa,SAAQ,EAAO,CAAC,SAAS,UAAUb,EAAI,KAAKC,EAAE,cAAcgB,EAAEjB,EAAIa,SAAQ,EAAO,CAAC,SAAS,WAAWb,EAAI,KAAKC,EAAE,SAAWuB,EAAOd,YAAW,EAAG,SAASS,EAAQpB,EAAIC,GAAK,OAAOD,EAAIY,EAAE,qBAAqBX,EAAIA,EAAIY,OAAOZ,EAAIa,SAAQ,EAAM,KAAK,IAAKM,EAAQT,YAAW,EAAG,SAASK,EAAQhB,EAAIC,GAAK,OAAOD,EAAIkB,EAAEjB,EAAIK,IAAI,CAAC,iBAAiB,GAAOL,EAAI,IAAI,CAAC,MAAOe,EAAQL,YAAW,EAAG,OAAOZ,GAErmFN,EAASK,SAAW,SAAU4B,GAC1B,MAAMC,EAAOrC,KAEboC,EAAIE,GAAG7C,GAAG8C,OAAOC,MAAMC,WAAY,SAAUC,GACzC,MAAMC,EAAOD,EAAEC,KACTC,EAAaP,EAAKQ,aAAaC,KAAKT,GAEtCM,IAASlD,GAAG8C,OAAOI,KAAKI,OACxBX,EAAIE,GAAG7C,GAAG8C,OAAOC,MAAMQ,SAAUJ,GAC1BD,IAASlD,GAAG8C,OAAOI,KAAKM,SAC/Bb,EAAIc,IAAIzD,GAAG8C,OAAOC,MAAMQ,SAAUJ,KAI1C,OAAOnD,GAAGC,QAAQC,YAAYS,UAAUI,SAAS2C,KAAKd,EAAMD,IAGhEjC,EAAS0C,aAAe,WACpB,MAAMR,EAAOrC,KACbqC,EAAKe,qBAAqBC,QAAQ,SAAUC,GACxC,MAAMC,EAAQlB,EAAKD,IAAIoB,SAASF,EAAGG,QAAQC,SACvCH,GACAD,EAAGK,iBAAiB,MAAQtB,EAAKhC,MAAQ,iBAAiBgD,QAAQ,SAAUO,GACxE,MAAMC,EAAMD,EAAEE,cAAc,OACxBD,QAAmCE,IAA5BF,EAAIG,aAAa,QAA2D,IAAnCH,EAAIG,aAAa,OAAOC,QACxE5B,EAAK6B,iBAAiBL,EAAKN,QAO/CpD,EAASgE,YAAc,WACnB,MAAM9B,EAAOrC,KACPoE,EAAU/B,EAAKhC,MAAQ,gBACvBgE,EAAahC,EAAKhC,MAAQ,mBAEhCgC,EAAKe,qBAAqBC,QAAQ,SAAUC,GACxC,MAAMC,EAAQlB,EAAKD,IAAIoB,SAASF,EAAGG,QAAQC,SAE3C,GAAIH,EAAO,CACP,IAAIe,GAAgB,EACpB,MAAMC,EAAMjB,EAAGK,iBAAiB,MAChCY,EAAIlB,QAAQ,SAAUO,GAClB,GAAIA,EAAEY,UAAUC,SAASpC,EAAKhC,MAAQ,iBAAkB,CACpD,MAAMqE,EAAMd,EAAEH,QAAQkB,SACtB,GAAIpB,EAAMqB,iBAAiBF,GAAM,CAC7BJ,GAAgB,EAChBV,EAAEY,UAAUK,OAAOR,GACnBT,EAAEY,UAAUM,IAAIV,GAChB,MAAMP,EAAMD,EAAEE,cAAc,OACxBD,GACAxB,EAAK6B,iBAAiBL,EAAKN,OAG9B,CACDK,EAAEY,UAAUM,IAAIT,GAChBT,EAAEY,UAAUK,OAAOT,OAI/BE,EAAgBA,IAAkBC,EAAIN,OACtC,IAAKM,EAAIN,OAAQ,CACb,MAAMJ,EAAMP,EAAGQ,cAAc,OACzBD,GACAxB,EAAK6B,iBAAiBL,GAG9BP,EAAGkB,UAAUO,OAAOX,EAASE,GAC7BhB,EAAGkB,UAAUO,OAAOV,GAAaC,OAK7CnE,EAAS6E,OAAS,WACd,MAAM3C,EAAOrC,KAEbqC,EAAKe,qBAAqBC,QAAQ,SAAUC,GACxC,MAAMC,EAAQlB,EAAKD,IAAIoB,SAASF,EAAGG,QAAQC,SAC3C,GAAIH,EAAO,CACPA,EAAM0B,UAEN3B,EAAGK,iBAAiB,MAAMN,QAAQ,SAAUO,GACxC,MAAMc,EAAMd,EAAEH,QAAQkB,SACtB,IAAIO,EAAU7C,EAAKhC,MAAQ,gBACvB8E,EAAa9C,EAAKhC,MAAQ,mBAC1B+E,EAAa/C,EAAKhC,MAAQ,mBAE9B,OAAQkD,EAAM8B,OAAOC,iBAAiBZ,IAClC,KAAKjF,GAAG8C,OAAOgD,WAAWC,YACtB5B,EAAEY,UAAUK,OAAOK,EAASE,GAC5BxB,EAAEY,UAAUM,IAAIK,GAChB,MACJ,KAAK1F,GAAG8C,OAAOgD,WAAWE,YACtB7B,EAAEY,UAAUK,OAAOK,EAASC,GAC5BvB,EAAEY,UAAUM,IAAIM,GAChB,MACJ,QAEIxB,EAAEY,UAAUK,OAAOM,EAAYC,GAC/BxB,EAAEY,UAAUM,IAAII,MAK5B7C,EAAKqD,sBAAsBnC,MAGnClB,EAAK8B,eAGThE,EAASwF,gBAAkB,SAAUpC,GACjC,IAAIlB,EAAOrC,KAEX,IAAKuD,EAAMqC,SAAWrC,EAAMsC,QAAQC,QAAS,CAIzC,GAAIvC,EAAMwC,UAAYxC,EAAMsC,QAAQE,SAAU,CAC1CxC,EAAMyC,KAAO,KACbzC,EAAMwC,SAAWxC,EAAMsC,QAAQE,UAAW,EAE1CxC,EAAM8B,OAAOC,iBAAmB,GAGpC7F,GAAGC,QAAQC,YAAYS,UAAUuF,gBAAgBxC,KAAKd,EAAMkB,GAE5DlB,EAAK4D,IAAInC,cAAc,IAAMzB,EAAKhC,MAAQ,UAAUmE,UAAUM,IAAIrF,GAAG8C,OAAO2D,QAAQC,QAEpF9D,EAAK+D,gBAAgB/D,EAAKhC,MAAQ,QAASgC,EAAKgE,WAAW9C,EAAM+C,KAC5DC,KAAK,SAAUC,GACZ,MACMC,GADS,IAAIC,WACEC,gBAAgBH,EAAK,aAAaI,KAAKC,WACtDnC,EAAM+B,EAAMhD,QAAQkB,SACpBmC,EAAKzE,EAAK4D,IAAInC,cAAc,MAAQzB,EAAKhC,MAAQ,WACjDkE,EAAMuC,EAAGnD,iBAAiB,sBAAwBe,EAAM,MAC9D,GAAmB,IAAfH,EAAIN,OAAc,CAClB,MAAMX,EAAKiB,EAAI,GACfjB,EAAGyD,UAAYN,EAAMM,UACrBzD,EAAG0D,aAAa,QAASP,EAAMzC,aAAa,cAE3C,CACDyC,EAAMhD,QAAQC,QAAUH,EAAM+C,GAC9BQ,EAAGG,aAAaR,EAAOK,EAAGD,YAG9BxE,EAAK2C,WAERkC,MAAM,SAAUC,GACb1H,GAAG2H,MAAMD,OAKzBhH,EAASkH,YAAc,SAAU9D,GACxBA,EAAMqC,QACPnG,GAAGC,QAAQC,YAAYS,UAAUiH,YAAYlE,KAAKnD,KAAMuD,IAIhEpD,EAASuF,sBAAwB,SAAUnC,GACvC,IAAIlB,EAAOrC,KACXqC,EAAKe,qBAAqBC,QAAQ,SAAUC,GACpCA,EAAGG,QAAQC,UAAYH,EAAM+C,IAC7BhD,EAAGkB,UAAUO,OAAO1C,EAAKhC,MAAQ,oBAAqBkD,EAAM+D,oBAKxEnH,EAASiD,mBAAqB,WAE1B,OADapD,KACDiG,IAAInC,cAAc,MADjB9D,KAC8BK,MAAQ,WAAWsD,iBAAiB,MADlE3D,KAC+EK,MAAQ,UApL5G","sourcesContent":["TC.control = TC.control || {};\r\n\r\nif (!TC.control.MapContents) {\r\n    TC.syncLoadJS(TC.apiLocation + 'TC/control/MapContents');\r\n}\r\n\r\nTC.control.Legend = function () {\r\n    TC.control.MapContents.apply(this, arguments);\r\n};\r\n\r\nTC.inherit(TC.control.Legend, TC.control.MapContents);\r\n\r\n(function () {\r\n    var ctlProto = TC.control.Legend.prototype;\r\n\r\n    ctlProto.CLASS = 'tc-ctl-legend';\r\n\r\n    ctlProto.template = {};\r\n    ctlProto.template[ctlProto.CLASS] = TC.apiLocation + \"TC/templates/Legend.html\";\r\n    ctlProto.template[ctlProto.CLASS + '-node'] = TC.apiLocation + \"TC/templates/LegendNode.html\";\r\n\r\n    ctlProto.register = function (map) {\r\n        const self = this;\r\n\r\n        map.on(TC.Consts.event.VIEWCHANGE, function (e) {\r\n            const view = e.view;\r\n            const onLayerAdd = self.loadGraphics.bind(self);\r\n\r\n            if (view === TC.Consts.view.THREED) {                \r\n                map.on(TC.Consts.event.LAYERADD, onLayerAdd);\r\n            } else if (view === TC.Consts.view.DEFAULT) {\r\n                map.off(TC.Consts.event.LAYERADD, onLayerAdd);\r\n            }\r\n        });\r\n\r\n        return TC.control.MapContents.prototype.register.call(self, map);\r\n    };\r\n\r\n    ctlProto.loadGraphics = function () {\r\n        const self = this;\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            const layer = self.map.getLayer(li.dataset.layerId);\r\n            if (layer) {\r\n                li.querySelectorAll('li.' + self.CLASS + '-node-visible').forEach(function (l) {\r\n                    const img = l.querySelector('img');\r\n                    if (img && img.getAttribute('src') !== undefined && img.getAttribute('src').length === 0) {\r\n                        self.styleLegendImage(img, layer);\r\n                    }\r\n                });\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.updateScale = function () {\r\n        const self = this;\r\n        const inScale = self.CLASS + '-node-inscale';\r\n        const outOfScale = self.CLASS + '-node-outofscale';\r\n\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            const layer = self.map.getLayer(li.dataset.layerId);\r\n\r\n            if (layer) {\r\n                let layersInScale = false;\r\n                const lis = li.querySelectorAll('li');\r\n                lis.forEach(function (l) {\r\n                    if (l.classList.contains(self.CLASS + '-node-visible')) {\r\n                        const uid = l.dataset.layerUid;\r\n                        if (layer.isVisibleByScale(uid)) {\r\n                            layersInScale = true;\r\n                            l.classList.remove(outOfScale);\r\n                            l.classList.add(inScale);\r\n                            const img = l.querySelector('img');\r\n                            if (img) {\r\n                                self.styleLegendImage(img, layer);\r\n                            }\r\n                        }\r\n                        else {\r\n                            l.classList.add(outOfScale);\r\n                            l.classList.remove(inScale);\r\n                        }\r\n                    }\r\n                });\r\n                layersInScale = layersInScale || !lis.length;\r\n                if (!lis.length) {\r\n                    const img = li.querySelector('img');\r\n                    if (img) {\r\n                        self.styleLegendImage(img);\r\n                    }\r\n                }\r\n                li.classList.toggle(inScale, layersInScale);\r\n                li.classList.toggle(outOfScale, !layersInScale);\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.update = function () {\r\n        const self = this;\r\n\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            const layer = self.map.getLayer(li.dataset.layerId);\r\n            if (layer) {\r\n                layer.getTree();\r\n\r\n                li.querySelectorAll('li').forEach(function (l) {\r\n                    const uid = l.dataset.layerUid;\r\n                    var visible = self.CLASS + '-node-visible';\r\n                    var notVisible = self.CLASS + '-node-notvisible';\r\n                    var hasVisible = self.CLASS + '-node-hasvisible';\r\n\r\n                    switch (layer._cache.visibilityStates[uid]) {\r\n                        case TC.Consts.visibility.NOT_VISIBLE:\r\n                            l.classList.remove(visible, hasVisible);\r\n                            l.classList.add(notVisible);                            \r\n                            break;\r\n                        case TC.Consts.visibility.HAS_VISIBLE:\r\n                            l.classList.remove(visible, notVisible);\r\n                            l.classList.add(hasVisible);                            \r\n                            break;\r\n                        default:\r\n                            // visible\r\n                            l.classList.remove(notVisible, hasVisible);\r\n                            l.classList.add(visible);                            \r\n                            break;\r\n                    }\r\n                });\r\n\r\n                self.updateLayerVisibility(layer);\r\n            }\r\n        });\r\n        self.updateScale();\r\n    };\r\n\r\n    ctlProto.updateLayerTree = function (layer) {\r\n        var self = this;        \r\n\r\n        if (!layer.isBase && !layer.options.stealth) {\r\n            \r\n            //// 09/04/2019 GLS: ignoramos el atributo que venga en la capa porque en la leyenda queremos que el Ã¡rbol se muestre siempre y \r\n            //// nos ahorramos el tener que pasarlo en el estado del mapa\r\n            if (layer.hideTree || layer.options.hideTree) {\r\n                layer.tree = null;\r\n                layer.hideTree = layer.options.hideTree = false;\r\n\r\n                layer._cache.visibilityStates = {};\r\n            }            \r\n\r\n            TC.control.MapContents.prototype.updateLayerTree.call(self, layer);\r\n\r\n            self.div.querySelector('.' + self.CLASS + '-empty').classList.add(TC.Consts.classes.HIDDEN);            \r\n\r\n            self.getRenderedHtml(self.CLASS + '-node', self.layerTrees[layer.id])\r\n                .then(function (out) {\r\n                    const parser = new DOMParser();\r\n                    const newLi = parser.parseFromString(out, 'text/html').body.firstChild;\r\n                    const uid = newLi.dataset.layerUid;\r\n                    const ul = self.div.querySelector('ul.' + self.CLASS + '-branch');\r\n                    const lis = ul.querySelectorAll('li[data-layer-uid=\"' + uid + '\"]');\r\n                    if (lis.length === 1) {\r\n                        const li = lis[0];\r\n                        li.innerHTML = newLi.innerHTML;\r\n                        li.setAttribute('class', newLi.getAttribute('class')); // Esto actualiza si un nodo deja de ser hoja o pasa a ser hoja\r\n                    }\r\n                    else {\r\n                        newLi.dataset.layerId = layer.id;\r\n                        ul.insertBefore(newLi, ul.firstChild);\r\n                    }\r\n\r\n                    self.update();\r\n                })\r\n                .catch(function (err) {\r\n                    TC.error(err);\r\n                });\r\n        }\r\n    };\r\n\r\n    ctlProto.removeLayer = function (layer) {\r\n        if (!layer.isBase) {\r\n            TC.control.MapContents.prototype.removeLayer.call(this, layer);\r\n        }\r\n    };\r\n\r\n    ctlProto.updateLayerVisibility = function (layer) {\r\n        var self = this;\r\n        self.getLayerUIElements().forEach(function (li) {\r\n            if (li.dataset.layerId === layer.id) {\r\n                li.classList.toggle(self.CLASS + '-node-notvisible', !layer.getVisibility());\r\n            }\r\n        });\r\n    };\r\n\r\n    ctlProto.getLayerUIElements = function () {\r\n        const self = this;\r\n        return self.div.querySelector('ul.' + self.CLASS + '-branch').querySelectorAll('li.' + self.CLASS + '-node');\r\n    };\r\n})();\r\n"]}