{"version":3,"sources":["workers/tc-cb-service-worker.js"],"names":["self","addEventListener","event","cacheName","waitUntil","caches","has","then","hasCache","open","cache","keys","console","log","length","fetch","delete","e","clients","claim","respondWith","match","request","response","catch","reason","url","currentMapStates","postMessage","msg","matchAll","clientList","forEach","client","action","data","name","silent","createCache","list","listLength","counter","add","count","total"],"mappings":"CAAC,WAGGA,KAAKC,iBAAiB,UAAW,SAAUC,GACvC,IAAIC,EAAY,wBAChBD,EAAME,UACFC,OAAOC,IAAIH,GAAWI,KAAK,SAAUC,GAC7BA,GACAH,OAAOI,KAAKN,GAAWI,KAAK,SAAUG,GAClCA,EAAMC,OAAOJ,KAAK,SAAUI,GACxBC,QAAQC,IAAI,sBACRF,EAAKG,QACLC,MAAMJ,EAAK,IAAIJ,KAAK,WAEhBF,OAAOW,OAAOb,GAAWI,KAAK,WAC1BK,QAAQC,IAAI,kBAAoBV,EAAY,gBAEjD,SAAUc,GACTL,QAAQC,IAAII,cAe5CjB,KAAKC,iBAAiB,WAAY,SAAUC,GAExCA,EAAME,UAAUJ,KAAKkB,QAAQC,WAGjCnB,KAAKC,iBAAiB,QAAS,SAAUC,GAErCA,EAAMkB,YACFf,OAAOgB,MAAMnB,EAAMoB,SACdf,KAAK,SAAUgB,GACZ,OAAIA,GAIGR,MAAMb,EAAMoB,SAASE,MAAM,SAAUC,GACxCb,QAAQC,IAAI,2BAA6BX,EAAMoB,QAAQI,IAAM,KAAOD,UAOxF,IAAIE,KAEJ3B,KAAKC,iBAAiB,UAAW,SAAUC,GAGvC,IAAI0B,EAAc,SAAUC,GACxB7B,KAAKkB,QAAQY,WACRvB,KAAK,SAAUwB,GACZA,EAAWC,QAAQ,SAAUC,GACzBA,EAAOL,YAAYC,QAK/BK,EAAShC,EAAMiC,KAAKD,OACxB,OAAQA,GACJ,IAAK,SACD,IAAIE,EAAOlC,EAAMiC,KAAKC,KAClBC,EAASnC,EAAMiC,KAAKE,OACxBV,EAAiBS,GAAQF,EACzB,IAAII,EAAc,WACdjC,OAAOI,KAAK2B,GACX7B,KAAK,SAAUG,GACZ,IAAI6B,EAAOrC,EAAMiC,KAAKI,KAClBC,EAAaD,EAAKzB,OAClB2B,EAAU,EACdF,EAAKP,QAAQ,SAAUN,GACfC,EAAiBS,IACjB1B,EAAMgC,IAAIhB,GACLnB,KACG,WACI,IAAK8B,EAAQ,CACTT,GACIM,OAAQA,EACRE,KAAMA,EACNlC,MAAO,WACPyC,QAASF,EACTG,MAAOJ,IAEPC,IAAYD,GACZZ,GACIM,OAAQA,EACRE,KAAMA,EACNlC,MAAO,aAKvB,WACI0B,GACIM,OAAQA,EACRE,KAAMA,EACNlC,MAAO,QACPwB,IAAKA,WAQrCrB,OAAOW,OAAOoB,GAAM7B,KAAK+B,EAAaA,GACtC,MACJ,IAAK,SACGF,EAAOlC,EAAMiC,KAAKC,KAClBC,EAASnC,EAAMiC,KAAKE,cACjBV,EAAiBS,GACxB/B,OAAOW,OAAOoB,GAAM7B,KAChB,WACS8B,GACDT,GACIM,OAAQA,EACRE,KAAMA,EACNlC,MAAO,aAInB,WACI0B,GACIM,OAAQA,EACRE,KAAMA,EACNlC,MAAO,eAxIlC","sourcesContent":["(function () {\r\n\r\n    // Arreglo del bug de actualizaci칩n de la cache\r\n    self.addEventListener('install', function (event) {\r\n        var cacheName = 'TC.offline.map.common';\r\n        event.waitUntil(\r\n            caches.has(cacheName).then(function (hasCache) {\r\n                if (hasCache) {\r\n                    caches.open(cacheName).then(function (cache) {\r\n                        cache.keys().then(function (keys) {\r\n                            console.log(\"Revisando cache...\");\r\n                            if (keys.length) {\r\n                                fetch(keys[0]).then(function () {\r\n                                    // Estamos online, borramos cache\r\n                                    caches.delete(cacheName).then(function () {\r\n                                        console.log(\"Cache con bug (\" + cacheName + \") borrada\");\r\n                                    });\r\n                                }, function (e) {\r\n                                    console.log(e);\r\n                                });\r\n                            }\r\n                        });\r\n                    });\r\n                }\r\n            })\r\n        );\r\n    });\r\n\r\n    //self.addEventListener('install', function (event) {\r\n    // No hacemos nada en la instalaci\\u00f3n del service worker\r\n    //    event.waitUntil(self.skipWaiting());\r\n    //});\r\n\r\n    self.addEventListener('activate', function (event) {\r\n        // Reclamamos el control inmediatamente, para evitar tener que recargar la p치gina\r\n        event.waitUntil(self.clients.claim());\r\n    });\r\n\r\n    self.addEventListener('fetch', function (event) {\r\n        // Si est치 la petici칩n en la cache se responde de ella, si no, se pide a la red\r\n        event.respondWith(\r\n            caches.match(event.request)\r\n                .then(function (response) {\r\n                    if (response) {\r\n                        return response;\r\n                    }\r\n\r\n                    return fetch(event.request).catch(function (reason) {\r\n                        console.log('[fetch] Could not fetch ' + event.request.url + ': ' + reason);\r\n                    });\r\n                })\r\n        );\r\n    });\r\n\r\n    // Diccionario de estados de cacheo de mapas. Necesario para poder cancelar cacheos.\r\n    var currentMapStates = {};\r\n\r\n    self.addEventListener('message', function (event) {\r\n        // Procesamos las solicitudes de cacheo y borrado\r\n\r\n        var postMessage = function (msg) {\r\n            self.clients.matchAll()\r\n                .then(function (clientList) {\r\n                    clientList.forEach(function (client) {\r\n                        client.postMessage(msg);\r\n                    });\r\n                });\r\n        };\r\n\r\n        var action = event.data.action;\r\n        switch (action) {\r\n            case 'create':\r\n                var name = event.data.name;\r\n                var silent = event.data.silent;\r\n                currentMapStates[name] = action;\r\n                var createCache = function () {\r\n                    caches.open(name)\r\n                    .then(function (cache) {\r\n                        var list = event.data.list;\r\n                        var listLength = list.length;\r\n                        var counter = 0;\r\n                        list.forEach(function (url) {\r\n                            if (currentMapStates[name]) {\r\n                                cache.add(url)\r\n                                    .then(\r\n                                        function () {\r\n                                            if (!silent) {\r\n                                                postMessage({\r\n                                                    action: action,\r\n                                                    name: name,\r\n                                                    event: 'progress',\r\n                                                    count: ++counter,\r\n                                                    total: listLength\r\n                                                });\r\n                                                if (counter === listLength) {\r\n                                                    postMessage({\r\n                                                        action: action,\r\n                                                        name: name,\r\n                                                        event: 'cached'\r\n                                                    });\r\n                                                }\r\n                                            }\r\n                                        },\r\n                                        function () {\r\n                                            postMessage({\r\n                                                action: action,\r\n                                                name: name,\r\n                                                event: 'error',\r\n                                                url: url\r\n                                            });\r\n                                        }\r\n                                    );\r\n                            }\r\n                        });\r\n                    });\r\n                };\r\n                caches.delete(name).then(createCache, createCache);\r\n                break;\r\n            case 'delete':\r\n                var name = event.data.name;\r\n                var silent = event.data.silent;\r\n                delete currentMapStates[name];\r\n                caches.delete(name).then(\r\n                    function () {\r\n                        if (!silent) {\r\n                            postMessage({\r\n                                action: action,\r\n                                name: name,\r\n                                event: 'deleted'\r\n                            });\r\n                        }\r\n                    },\r\n                    function () {\r\n                        postMessage({\r\n                            action: action,\r\n                            name: name,\r\n                            event: 'error'\r\n                        });\r\n                    }\r\n                );\r\n            default:\r\n                break;\r\n        }\r\n    });\r\n\r\n})();"],"file":"../../workers/tc-cb-service-worker.min.js"}