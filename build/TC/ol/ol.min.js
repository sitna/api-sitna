!function(e,t){"function"==typeof define&&define.amd?define(["../../lib/ol/build/ol-sitna"],t):"object"==typeof exports?module.exports=t(require("../../lib/ol/build/ol-sitna")):e.ol=t(e.ol)}(this,function(e){Math.hypot=Math.hypot||function(){for(var e=0,t=arguments.length,r=0;r<t;r++){if(arguments[r]===1/0||arguments[r]===-1/0)return 1/0;e+=arguments[r]*arguments[r]}return Math.sqrt(e)};for(var t=0,r=["ms","moz","webkit","o"],n=0;n<r.length&&!window.requestAnimationFrame;++n){window.requestAnimationFrame=window[r[n]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[r[n]+"CancelAnimationFrame"]||window[r[n]+"CancelRequestAnimationFrame"]}window.requestAnimationFrame||(window.requestAnimationFrame=function(e,r){var n=(new Date).getTime(),a=Math.max(0,16-(n-t)),o=window.setTimeout(function(){e(n+a)},a);t=n+a;return o});window.cancelAnimationFrame||(window.cancelAnimationFrame=function(e){clearTimeout(e)});const a=e.events.EventType.RESIZE,o=e.events.EventType.DRAGENTER,i=e.events.EventType.DRAGOVER,s=e.events.EventType.DROP,l=e.events.EventType.CHANGE,p=e.MapBrowserEventType.SINGLECLICK,c=e.MapBrowserEventType.POINTERMOVE,u=e.MapEventType.MOVEEND,f=e.MapEventType.POSTRENDER,g=e.render.EventType.POSTCOMPOSE,m=e.source.VectorEventType.ADDFEATURE,y=e.source.VectorEventType.REMOVEFEATURE,d=e.source.VectorEventType.CLEAR,C=e.source.TileEventType.TILELOADSTART,h=e.source.TileEventType.TILELOADEND,T=e.source.TileEventType.TILELOADERROR,v=TC.Util.detectMouse()?3:10;var w=TC.url.ol.substr(0,TC.url.ol.lastIndexOf("/"));w=w.substr(0,w.lastIndexOf("/")+1)+"css/ol.css";e.format.KMLCustom||TC.syncLoadJS(TC.apiLocation+"TC/ol/format/KMLCustom");e.format.GPXCustom||TC.syncLoadJS(TC.apiLocation+"TC/ol/format/GPXCustom");if(!window.JSZip){window.JSZip=new Promise(function(e,t){TC.loadJS(!window.JSZip,TC.apiLocation+"lib/jszip/jszip",function(){e()})});window.JSZip.then(null,function(e){TC.error(e);window.JSZip=!1})}e.View.prototype.getValueForResolutionFunction=function(e){const t=e||2,r=this.maxResolution_,n=this.minResolution_,a=Math.log(r/n)/Math.log(t);return function(e){var n=Math.log(r/e)/Math.log(t)/a;return n=Math.max(Math.min(1,n),0)}};TC.Util.detectMobile()||(e.Overlay.prototype.updateRenderedPosition=function(t,r){const n=this.element.style,a=this.getOffset(),o=this.getPositioning();this.setVisible(!0);var i=a[0],s=a[1];if(o==e.OverlayPositioning.BOTTOM_RIGHT||o==e.OverlayPositioning.CENTER_RIGHT||o==e.OverlayPositioning.TOP_RIGHT){""!==this.rendered.left_&&(this.rendered.left_=n.left="");const e=Math.round(r[0]-t[0]-i)/window.devicePixelRatio+"px";this.rendered.right_!=e&&(this.rendered.right_=n.right=e)}else{""!==this.rendered.right_&&(this.rendered.right_=n.right="");o!=e.OverlayPositioning.BOTTOM_CENTER&&o!=e.OverlayPositioning.CENTER_CENTER&&o!=e.OverlayPositioning.TOP_CENTER||(i-=this.element.offsetWidth/2);const r=Math.round(t[0]+i)/window.devicePixelRatio+"px";this.rendered.left_!=r&&(this.rendered.left_=n.left=r)}if(o==e.OverlayPositioning.BOTTOM_LEFT||o==e.OverlayPositioning.BOTTOM_CENTER||o==e.OverlayPositioning.BOTTOM_RIGHT){""!==this.rendered.top_&&(this.rendered.top_=n.top="");const e=Math.round(r[1]-t[1]-s)/window.devicePixelRatio+"px";this.rendered.bottom_!=e&&(this.rendered.bottom_=n.bottom=e)}else{""!==this.rendered.bottom_&&(this.rendered.bottom_=n.bottom="");o!=e.OverlayPositioning.CENTER_LEFT&&o!=e.OverlayPositioning.CENTER_CENTER&&o!=e.OverlayPositioning.CENTER_RIGHT||(s-=this.element.offsetHeight/2);const r=Math.round(t[1]+s)/window.devicePixelRatio+"px";this.rendered.top_!=r&&(this.rendered.top_=n.top=r)}});e.control.OverviewMap.prototype._validateExtent_=e.control.OverviewMap.prototype.validateExtent_;e.control.OverviewMap.prototype.validateExtent_=function(){this._validateExtent_();this._wrap&&this._wrap.parent.options.alwaysCentered&&this.recenter_()};e.control.OverviewMap.prototype._resetExtent_=e.control.OverviewMap.prototype.resetExtent_;e.control.OverviewMap.prototype.resetExtent_=function(){this._resetExtent_.call(this);var t=this._wrap;if(t.is3D){var r=this.ovmap_.getView(),n=r.calculateExtent(),a=t.get3DCameraLayer().getSource().getFeatures()[0];if(a){coordinates=a.getGeometry().getCoordinates();var o=coordinates[0][0],i=coordinates[0][1];if(!e.extent.containsCoordinate(n,o)||!e.extent.containsCoordinate(n,i)){var s=Math.max(n[0]-o[0],n[1]-o[1],o[0]-n[2],o[1]-n[3],n[0]-i[0],n[1]-i[1],i[0]-n[2],i[1]-n[3]);r.fit(e.extent.buffer(n,s))}}}};e.format.GML3CRS84=function(){e.format.GML3.call(this,{srsName:"CRS:84"})};TC.inherit(e.format.GML3CRS84,e.format.GML3);e.format.GML2CRS84=function(){e.format.GML2.call(this,{srsName:"CRS:84"})};TC.inherit(e.format.GML2CRS84,e.format.GML2);const S="http://www.opengis.net/gml",E="http://www.opengis.net/gml/3.2";e.format.GMLBase.prototype.MULTIPOINT_PARSERS_[E]=e.format.GMLBase.prototype.MULTIPOINT_PARSERS_[S];e.format.GMLBase.prototype.MULTILINESTRING_PARSERS_[E]=e.format.GMLBase.prototype.MULTILINESTRING_PARSERS_[S];e.format.GMLBase.prototype.MULTIPOLYGON_PARSERS_[E]=e.format.GMLBase.prototype.MULTIPOLYGON_PARSERS_[S];e.format.GMLBase.prototype.POINTMEMBER_PARSERS_[E]=e.format.GMLBase.prototype.POINTMEMBER_PARSERS_[S];e.format.GMLBase.prototype.LINESTRINGMEMBER_PARSERS_[E]=e.format.GMLBase.prototype.LINESTRINGMEMBER_PARSERS_[S];e.format.GMLBase.prototype.POLYGONMEMBER_PARSERS_[E]=e.format.GMLBase.prototype.POLYGONMEMBER_PARSERS_[S];e.format.GMLBase.prototype.RING_PARSERS[E]=e.format.GMLBase.prototype.RING_PARSERS[S];e.format.GML3.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS[E]=e.format.GML3.prototype.GEOMETRY_FLAT_COORDINATES_PARSERS[S];e.format.GML3.prototype.FLAT_LINEAR_RINGS_PARSERS[E]=e.format.GML3.prototype.FLAT_LINEAR_RINGS_PARSERS[S];e.format.GML3.prototype.GEOMETRY_PARSERS[E]=e.format.GML3.prototype.GEOMETRY_PARSERS[S];e.format.GML3.prototype.MULTICURVE_PARSERS_[E]=e.format.GML3.prototype.MULTICURVE_PARSERS_[S];e.format.GML3.prototype.MULTISURFACE_PARSERS_[E]=e.format.GML3.prototype.MULTISURFACE_PARSERS_[S];e.format.GML3.prototype.CURVEMEMBER_PARSERS_[E]=e.format.GML3.prototype.CURVEMEMBER_PARSERS_[S];e.format.GML3.prototype.SURFACEMEMBER_PARSERS_[E]=e.format.GML3.prototype.SURFACEMEMBER_PARSERS_[S];e.format.GML3.prototype.SURFACE_PARSERS_[E]=e.format.GML3.prototype.SURFACE_PARSERS_[S];e.format.GML3.prototype.CURVE_PARSERS_[E]=e.format.GML3.prototype.CURVE_PARSERS_[S];e.format.GML3.prototype.ENVELOPE_PARSERS_[E]=e.format.GML3.prototype.ENVELOPE_PARSERS_[S];e.format.GML3.prototype.PATCHES_PARSERS_[E]=e.format.GML3.prototype.PATCHES_PARSERS_[S];e.format.GML3.prototype.SEGMENTS_PARSERS_[E]=e.format.GML3.prototype.SEGMENTS_PARSERS_[S];e.format.GMLBase.prototype.readFeaturesInternal=function(t,r){const n=t.localName;let a=null;if("FeatureCollection"==n){var o=this.FEATURE_COLLECTION_PARSERS[e.format.GMLBase.prototype.namespace];o.member||(o.member=e.xml.makeArrayPusher(e.format.GMLBase.prototype.readFeaturesInternal));if("http://www.opengis.net/wfs"===t.namespaceURI)a=e.xml.pushParseAndPop([],this.FEATURE_COLLECTION_PARSERS,t,r,this);else{this.FEATURE_COLLECTION_PARSERS[t.namespaceURI]=this.FEATURE_COLLECTION_PARSERS[t.namespaceURI]||this.FEATURE_COLLECTION_PARSERS[e.format.GMLBase.prototype.namespace];a=e.xml.pushParseAndPop([],this.FEATURE_COLLECTION_PARSERS,t,r,this)}}else if("featureMembers"==n||"featureMember"==n||"member"==n){const o=r[0];let i=o.featureType,s=o.featureNS;const l="p",p="p0";if(t.childNodes){i=[],s={};for(let e=0,r=t.childNodes.length;e<r;++e){const r=t.childNodes[e];if(1===r.nodeType){const e=r.nodeName.split(":").pop();if(-1===i.indexOf(e)){let t="",n=0;const a=r.namespaceURI;for(let e in s){if(s[e]===a){t=e;break}++n}t||(s[t=l+n]=a);i.push(t+":"+e)}}}if("featureMember"!=n){o.featureType=i;o.featureNS=s}}if("string"==typeof s){const e=s;(s={})[p]=e}const c={},u=Array.isArray(i)?i:[i];for(let t in s){const r={};for(let a=0,o=u.length;a<o;++a){(-1===u[a].indexOf(":")?p:u[a].split(":")[0])===t&&(r[u[a].split(":").pop()]="featureMembers"==n?e.xml.makeArrayPusher(this.readFeatureElement,this):e.xml.makeReplacer(this.readFeatureElement,this))}c[s[t]]=r}a="featureMember"==n?e.xml.pushParseAndPop(void 0,c,t,r):e.xml.pushParseAndPop([],c,t,r)}null===a&&(a=[]);return a};e.proj.proj4.register(proj4);e.proj.get("EPSG:4258").metersPerUnit_=e.proj.EPSG4326.METERS_PER_UNIT;e.proj.get("urn:ogc:def:crs:EPSG::4258").metersPerUnit_=e.proj.EPSG4326.METERS_PER_UNIT;e.proj.get("http://www.opengis.net/gml/srs/epsg.xml#4258").metersPerUnit_=e.proj.EPSG4326.METERS_PER_UNIT;e.proj.oldGet=e.proj.get;e.proj.get=function(t){if("string"==typeof t){t=t.trim();TC.loadProjDef({crs:t,sync:!0})}return e.proj.oldGet.call(this,t)};e.format.GMLBase.prototype.readGeometryElement=function(t,r){var n=r[0];n.srsName=t.firstElementChild.getAttribute("srsName");n.srsDimension=t.firstElementChild.getAttribute("srsDimension");if((this instanceof e.format.GML2CRS84||this instanceof e.format.GML3CRS84)&&("EPSG:4326"!==n.srsName||!n.srsName))throw new Error("Conflicto de CRS");n.srsName||(n.srsName=this.srsName);n.dataProjection=e.proj.get(n.srsName);const a=e.xml.pushParseAndPop(null,this.GEOMETRY_PARSERS,t,r,this);return a?e.format.Feature.transformWithOptions(a,!1,n):void 0};const L=/^[\s\xa0]*$/;e.format.GMLBase.prototype.readFeatureElementInternal=function(t,r,n){let a;const o={};for(let i=t.firstElementChild;i;i=i.nextElementSibling){let t;const s=i.localName;if(0===i.childNodes.length||1===i.childNodes.length&&(3===i.firstChild.nodeType||4===i.firstChild.nodeType)){t=e.xml.getAllTextContent(i,!1);L.test(t)&&(t=void 0)}else{n&&(t=this.readGeometryElement(i,r));t?"boundedBy"!==s&&"referencePoint"!==s&&(a=s):t=this.readFeatureElementInternal(i,r,!1)}if(o[s]){o[s]instanceof Array||(o[s]=[o[s]]);o[s].push(t)}else o[s]=t;const l=i.attributes.length;if(l>0){o[s]={_content_:o[s]};for(let e=0;e<l;e++){const t=i.attributes[e].name;o[s][t]=i.attributes[e].value}}}if(n){const r=new e.Feature(o);a&&r.setGeometryName(a);const n=t.getAttribute("fid")||t.getAttributeNS(this.namespace,"id");n&&r.setId(n);return r}return o};const M=function(t,r){var n;if(t){n=(n=e.color.asArray(t)).slice();void 0!==r&&(n[3]=r)}else n=[0,0,0,1];return n};var P=function(e,t){var r=e.map.getView(),n=r.getResolution(),a={projection:r.getProjection(),center:r.getCenter(),resolution:n,enableRotation:!1};e.parent.maxExtent&&(a.extent=e.parent.maxExtent);var o=t;t.type===TC.Consts.layerType.VECTOR&&e.parent.getBaseLayer()&&(o=e.parent.getBaseLayer());var i,s,l=o.getResolutions?o.getResolutions():[];if(l&&l.length){i=o.maxResolution||l[0];s=o.minResolution||l[l.length-1];var p=l.indexOf(s),c=l.indexOf(i);a.resolutions=l.slice(c,p+1)}else{i=o.maxResolution;s=o.minResolution}if(s){a.minResolution=s;n<s&&(a.resolution=s)}if(i){a.maxResolution=i;n>i&&(a.resolution=i)}return a};TC.wrap.Map.prototype.setMap=function(){var t=this,r=[(t.parent.initialExtent[0]+t.parent.initialExtent[2])/2,(t.parent.initialExtent[1]+t.parent.initialExtent[3])/2],n=proj4(t.parent.crs);!function(){var r=t.parent.crs.substr(t.parent.crs.lastIndexOf(":")+1),a={units:n.oProj.units,global:!0},o=[];if("4326"!==r){a.code="EPSG:"+r;o.push(new e.proj.Projection(a));a.code="urn:ogc:def:crs:EPSG::"+r;o.push(new e.proj.Projection(a));e.proj.addEquivalentProjections(o)}e.proj.proj4.register(proj4)}();var o={code:t.parent.crs,units:n.oProj.units};"EPSG:4326"===t.parent.crs&&(o.axisOrientation="neu");var i=new e.proj.Projection(o),s=e.interaction.defaults({constrainResolution:!0}),l={projection:i,center:r,enableRotation:!1};const c=t.parent.maxExtent||t.parent.initialExtent;l.extent=c;var f=t.parent.div.getBoundingClientRect(),g=c[2]-c[0],m=c[3]-c[1];f.width/f.height>g/m?l.resolution=g/f.width:l.resolution=m/f.height;t.map=new e.Map({target:t.parent.div,view:new e.View(l),controls:[],interactions:s,pixelRatio:1});TC.Util.detectMobile()||(t.map.getEventPixel=function(e){var t=this.viewport_.getBoundingClientRect(),r=e.changedTouches?e.changedTouches[0]:e;return[((r=r.clientX?r:r.pointerEvent?r.pointerEvent:r).clientX-t.left)*window.devicePixelRatio,(r.clientY-t.top)*window.devicePixelRatio]});t.map._wrap=t;t._promise=Promise.resolve(t.map);t.manageSize.call(t.map);var y=function(){t.map.updateSize()};t.parent.div.addEventListener(a,y);t.parent.one(TC.Consts.event.MAPLOAD,y);t.map.on(p,function(e){if(t.parent.view!==TC.Consts.view.PRINTING){t.parent.workLayers.forEach(function(e){delete e._noFeatureClicked});var r=t.parent.workLayers.map(function(){return!1});t.map.forEachFeatureAtPixel(e.pixel,function(e,n){if(e._wrap&&e._wrap.parent.showsPopup){for(var a=0;a<t.parent.workLayers.length;a++){if(t.parent.workLayers[a].wrap.layer===n){r[a]=!0;break}}t.parent.trigger(TC.Consts.event.FEATURECLICK,{feature:e._wrap.parent});return e}},{hitTolerance:v});for(var n=0;n<r.length;n++)r[n]||t.parent.trigger(TC.Consts.event.NOFEATURECLICK,{layer:t.parent.workLayers[n]})}});const d=function(){t.map.on(u,function(){t.parent.trigger(TC.Consts.event.ZOOM)})};t.map.getView().on("change:resolution",function(){t.map.hasListener(u)||t.map.once(u,function(){d()});t.parent.trigger(TC.Consts.event.BEFOREZOOM)},t.parent);const C=function(){if(!t.map.hasListener(u)){t.map.un("change:view",C);d()}};t.map.on("change:view",C);var h=function(r){t.map.getView().getResolution(),t.map.getView().getZoom();var n=P(t,r),a=new e.View(n);t.map.setView(a);t.map.render()};t.parent.on(TC.Consts.event.BASELAYERCHANGE,function(e){t.parent.crs!==t.parent.options.crs||t.parent.on3DView||e.layer.type===TC.Consts.layerType.VECTOR||h(e.layer)});t.parent.on(TC.Consts.event.MAPLOAD,function(e){h(t.parent.getBaseLayer())});const T=t.map.getViewport();T.addEventListener(TC.Consts.event.MOUSEMOVE,function(e){var r=!1;if(!t.parent.activeControl||!t.parent.activeControl.isExclusive()){if(t.parent.view===TC.Consts.view.PRINTING)return;var n=t.map.getEventPixel(e);r=t.map.forEachFeatureAtPixel(n,function(e,r){var n=!0;!e._wrap||e._wrap.parent.showsPopup||e._wrap.parent.options.selectable||(n=!1);n&&e._wrap&&t.parent.trigger(TC.Consts.event.FEATUREOVER,{feature:e._wrap.parent});return n},{hitTolerance:v})}T.style.cursor=r?"pointer":""})};var R=function(t,r){var n=t.getUnits();return n&&n!==e.proj.Units.DEGREES?e.proj.METERS_PER_UNIT[n]:TC.Util.getMetersPerDegree(r)};TC.wrap.Map.prototype.getMetersPerUnit=function(){return R(e.proj.get(this.parent.crs),this.getExtent())};var x=function(t){t=t||{};var r=this.parent.options.crs||TC.Cfg.crs,n=e.proj.get(r),a=e.proj.get(t.crs);return R(a,t.extentInDegrees)/R(n,t.extentInDegrees)},_=function(t){var r;(r=t.axisOrientation?new e.proj.Projection({code:t.crs,axisOrientation:t.axisOrientation}):e.proj.get(t.crs)).getUnits()||(r.units_=e.proj.Units.DEGREES);return r};TC.wrap.Map.prototype.setProjection=function(t){const r=this,n=(t=t||{}).baseLayer||r.parent.baseLayer;var a;a=t.extent?t.extent:e.proj.transformExtent(r.getExtent(),r.parent.crs,t.crs);const o=e.proj.transformExtent(a,t.crs,"EPSG:4326"),i=x.call(r,{crs:t.crs,extentInDegrees:o}),s=_(t),l=r.map.getView(),p={projection:s,enableRotation:!1},c=n.getResolutions();if(c&&c.length)p.resolutions=c;else{p.minZoom=l.getMinZoom();p.maxZoom=l.getMaxZoom();const e=n.wrap.layer.getMinResolution(),t=n.wrap.layer.getMaxResolution();var u=1;if(0===e||t===Number.POSITIVE_INFINITY){u=x.call(r,{crs:r.parent.crs,extentInDegrees:o})/i}p.minResolution=0===e?l.getMinResolution()*u:e;t===Number.POSITIVE_INFINITY?p.maxResolution=l.getMaxResolution()*u:p.maxResolution=t}p.center=e.proj.transform(r.getCenter(),r.parent.crs,t.crs);var f=new e.View(p);r.map.setView(f);r.parent.initialExtent=1!==i?e.proj.transformExtent(r.parent.initialExtent,r.parent.crs,t.crs):r.parent.options.initialExtent;r.parent.options.maxExtent&&(r.parent.options.maxExtent=r.parent.maxExtent=1!==i?e.proj.transformExtent(r.parent.maxExtent,r.parent.crs,t.crs):r.parent.options.maxExtent);f.fit(a,{nearest:!0})};TC.wrap.Map.prototype.insertLayer=function(t,r){for(var n=this,a=n.map.getLayers(),o=!1,i=0;i<a.getLength();i++)if(a.item(i)===t){o=!0;break}if(o){a.remove(t);a.insertAt(r,t)}else{r<0?a.push(t):a.insertAt(r,t);var s=n.map.getView();if(n.parent.crs===n.parent.options.crs){if(t instanceof e.layer.Tile){var l=t.getSource().getResolutions();s.maxResolution_=l[0];s.minResolution_=l[l.length-1]}}else if(t instanceof e.layer.Tile){t.setMaxResolution(s.getMaxResolution());t.setMinResolution(s.getMinResolution())}var p=t._wrap,c=0,u=function(e){p.parent.state=TC.Layer.state.LOADING;if(c<=0){c=0;n.parent.trigger(TC.Consts.event.BEFORELAYERUPDATE,{layer:p.parent})}t._loadingTileCount=t._loadingTileCount+1};p.parent.state===TC.Layer.state.LOADING&&p.parent.isRaster()&&u();p.$events.on(TC.Consts.event.BEFORETILELOAD,u);p.$events.on(TC.Consts.event.TILELOAD,function(e){if((c-=1)<=0){c=0;p.parent.state=TC.Layer.state.IDLE;n.parent.trigger(TC.Consts.event.LAYERUPDATE,{layer:p.parent})}})}};TC.wrap.Map.prototype.removeLayer=function(e){this.map.removeLayer(e)};TC.wrap.Map.prototype.getLayerCount=function(){return this.map.getLayerGroup().getLayers().getLength()};TC.wrap.Map.prototype.indexOfFirstVector=function(){var t=-1;this.map.getLayerGroup().getLayers().forEach(function(r,n){r instanceof e.layer.Vector&&-1===t&&(t=n)});return t};TC.wrap.Map.prototype.getLayerIndex=function(e){var t=-1;this.map.getLayerGroup().getLayers().forEach(function(r,n){r===e&&(t=n)});return t};TC.wrap.Map.prototype.setLayerIndex=function(e,t){var r=this.map.getLayers().getArray().indexOf(e);if(r>-1&&r!=t){this.map.removeLayer(e);this.insertLayer(e,t)}};TC.wrap.Map.prototype.setBaseLayer=function(t){var r=this;return new Promise(function(n,a){var o=function(a){if(a=a||r.parent.getBaseLayer()){r.map.removeLayer(a.wrap.layer);t instanceof e.layer.Image&&t._wrap.setProjection({crs:r.parent.crs});if(t._wrap.parent.type===TC.Consts.layerType.WMTS){var o={crs:r.parent.crs,oldCrs:t.getSource().getProjection().getCode()};o.oldCrs!==o.crs&&t._wrap.parent.setProjection(o)}}r.insertLayer(t,0);r.map.getControls().forEach(function(t){t instanceof e.control.ZoomSlider&&t.initSlider_()});n()},i=P(r,t._wrap.parent),s=r.map.getView(),l=s.getResolution();if(i.resolutions){var p=i.resolutions.sort(function(e,t){return e-t}).reduce(function(e,t){return 0===e&&(t>l||Math.abs(1-l/t)<r.parent.options.maxResolutionError)?t:e},0);if(p!==l)if(r.parent.isLoaded)s.animate({resolution:p,duration:TC.Consts.ZOOM_ANIMATION_DURATION},o.bind(r,r.parent.getBaseLayer()));else{s.setResolution(p);o()}else o()}else o()})};TC.wrap.Map.prototype.setExtent=function(t,r){const n=this;r=r||{};const a=function(e,n,a,o){var i=e.getResolutionForExtent(t,n);if(e.constrainResolution){var s=e.constrainResolution(i,0,0);s<i&&s/i<TC.Consts.EXTENT_TOLERANCE&&(s=e.constrainResolution(s,-1,0));i=s}const l=[(t[0]+t[2])/2,(t[1]+t[3])/2];if(void 0===r.animate||r.animate)e.animate({resolution:i,center:l,duration:TC.Consts.ZOOM_ANIMATION_DURATION},a);else{e.setCenter(l);e.setResolution(i);a()}};Promise.resolve(n._setExtentPromise).finally(function(){!function(t){n._setExtentPromise=new Promise(function(r,o){clearTimeout(n._timeout);n._timeout=setTimeout(function(){var o=n.map.getSize(),i=n.map.getView();n.parent.baseLayer?n.parent.baseLayer.wrap.getLayer().then(function(s){const l=i.getResolutionForExtent(t,o),p=n.getResolutions(),c=i.getMaxZoom();c<p.length-1&&(p.length=c+1);if(p.length>0){var u=Math.min.apply(n,p);if(u>l){var f=.5*(u/l-1),g=e.extent.getWidth(t)*f,m=e.extent.getHeight(t)*f;(t=t.slice(0))[0]=t[0]-g;t[1]=t[1]-m;t[2]=t[2]+g;t[3]=t[3]+m}}a(i,o,r)}):a(i,o,r)},50)})}(t)});return n._setExtentPromise};TC.wrap.Map.prototype.getExtent=function(){return this.map.getView().calculateExtent(this.map.getSize())};TC.wrap.Map.prototype.setCenter=function(e,t){const r=this;return new Promise(function(n,a){const o=function(){n()},i=t||{},s=r.map.getView();if(i.animate)s.animate({center:e,duration:TC.Consts.ZOOM_ANIMATION_DURATION},o);else{s.setCenter(e);n()}})};TC.wrap.Map.prototype.getCenter=function(){return this.map.getView().getCenter()};TC.wrap.Map.prototype.getResolution=function(){return this.map.getView().getResolution()};TC.wrap.Map.prototype.setResolution=function(e){this.getMap().then(function(t){t.getView().setResolution(e)})};TC.wrap.Map.prototype.setRotation=function(e){this.getMap().then(function(t){t.getView().setRotation(e)})};TC.wrap.Map.prototype.getRotation=function(){return this.map.getView().getRotation()};TC.wrap.Map.prototype.getResolutions=function(){return this.map.getView().getResolutions()||[]};TC.wrap.Map.prototype.getCoordinateFromPixel=function(e){return this.map.getCoordinateFromPixel(e)};TC.wrap.Map.prototype.getPixelFromCoordinate=function(e){return this.map.getPixelFromCoordinate(e)};TC.wrap.Map.prototype.getViewport=function(e){const t=this;return(e||{}).synchronous?t.map.getViewport():new Promise(function(e,r){t.getMap().then(function(t){e(t.getViewport())})})};TC.wrap.Map.prototype.isNative=function(t){return t instanceof e.Map};TC.wrap.Map.prototype.isGeo=function(){var t=this.map.getView().getProjection().getUnits();return!t||t===e.proj.Units.DEGREES};TC.wrap.Map.prototype.addPopup=function(t){const r=this;return new Promise(function(n,a){var o=void 0===t.options.draggable||t.options.draggable;TC.loadJS(o&&!window.Draggabilly,[TC.apiLocation+TC.Consts.url.DRAGGABILLY],function(){r.getMap().then(function(n){if(!t.popupDiv){const i=TC.Util.getDiv();t.popupDiv=i;window.$&&(t.$popupDiv=$(i));i.classList.add(TC.control.Popup.prototype.CLASS);t.contentDiv=TC.Util.getDiv();t.contentDiv.classList.add(TC.control.Popup.prototype.CLASS+"-content");t.popupDiv.appendChild(t.contentDiv);t.menuDiv=TC.Util.getDiv();t.menuDiv.classList.add(TC.control.Popup.prototype.CLASS+"-menu");t.popupDiv.appendChild(t.menuDiv);r.parent.div.appendChild(i);var a=new e.Overlay({element:i,positioning:e.OverlayPositioning.BOTTOM_LEFT});n.addOverlay(a);t.wrap.popup=a;const s=n.getViewport();if(o){const e=t.popupDiv.parentElement;t.popupDiv.classList.add(TC.Consts.classes.DRAGGABLE);e.addEventListener("touchmove",function(e){var t=e.target;do{if(t.matches(".tc-ctl-finfo-layer-content")){e.stopPropagation();break}t=t.parentElement}while(t)});const r=new Draggabilly(e,{});r.handleEvent=function(e){this.options.not&&e.target.matches(this.options.not)||Draggabilly.prototype.handleEvent.call(this,e)};r.on("pointerDown",function(e,t){var n=e.target.getBoundingClientRect();if(n.left+e.target.clientWidth<t.pageX||n.top+e.target.clientHeight<t.pageY){r._pointerCancel(e,t);return!1}});r.on("dragStart",function(e,r){t.setDragging(!0);t._currentOffset=a.getOffset();if(t._previousContainerPosition){var o=n.getSize();a.setPosition(n.getCoordinateFromPixel([t._previousContainerPosition[0],o[1]-t._previousContainerPosition[1]]));t._currentOffset=[0,0];a.setOffset(t._currentOffset);delete t._previousContainerPosition}else t._currentOffset=a.getOffset()});r.on("dragEnd",function(r){t.setDragging(!1);var o=n.getCoordinateFromPixel([0,0]),i=n.getCoordinateFromPixel(a.getOffset()),s=[i[0]-o[0],i[1]-o[1]],l=a.getPosition();a.setPosition([l[0]+s[0],l[1]+s[1]]);a.setOffset([0,0]);t._currentOffset=[0,0];const p=e.getBoundingClientRect();t._previousContainerPosition=[p.left,p.bottom]})}const l=function(e){const t=n.getViewport();var a=!1;if(!r.parent.activeControl||!r.parent.activeControl.isExclusive()){var o=n.getEventPixel(e);a=n.forEachFeatureAtPixel(o,function(e,t){var r=!0;e._wrap&&!e._wrap.parent.showsPopup&&(r=!1);return r},{hitTolerance:v})}t.style.cursor=a?"pointer":""};s.removeEventListener("mousemove",l);s.addEventListener("mousemove",l)}});n()})})};TC.wrap.Map.prototype.hidePopup=function(e){this.parent.currentFeature=null;e.popupDiv&&e.popupDiv.classList.remove(TC.Consts.classes.VISIBLE)};TC.wrap.Map.prototype.manageSize=function(){const e=this,t=function(e){var t=window.devicePixelRatio||1,r=e.context.canvas.getBoundingClientRect(),n=t*r.width,a=t*r.height;n===r.width&&Number.isInteger(n)||(n=Math.round(n));a===r.height&&Number.isInteger(a)||(a=Math.round(a));if(n!==r.width||a!==r.height){var o=[n,a];e.target.setSize(o)}};TC.Util.detectMobile()||e.on(g,t)};var I=function(t){switch(t){case TC.Consts.layerType.KML:case TC.Consts.mimeType.KML:case TC.Consts.format.KMZ:return new e.format.KMLCustom({showPointNames:!1});case TC.Consts.layerType.GPX:case TC.Consts.mimeType.GPX:return new e.format.GPXCustom;case TC.Consts.layerType.GEOJSON:case TC.Consts.mimeType.GEOJSON:case TC.Consts.mimeType.JSON:case TC.Consts.format.JSON:return new e.format.GeoJSON;case TC.Consts.format.GML2:return new e.format.GML2;case TC.Consts.format.GML3:return new e.format.GML3;case TC.Consts.format.GML32:return new e.format.GML32;case TC.Consts.mimeType.GML:case TC.Consts.format.GML:return new e.format.GML;case TC.Consts.format.TOPOJSON:return new e.format.TopoJSON;case TC.Consts.format.WKT:return new e.format.WKT;default:return null}};TC.wrap.Map.prototype.exportFeatures=function(t,r){r=r||{};var n=N({styles:this.parent.options.styles}),a=t.map(function(e){var t=e.wrap.feature.clone();t.getStyle()||t.setStyle(n);const r=ne(t).getText();r&&t.setProperties({name:r.getText()});return t}),o=I(r.format);if(o instanceof e.format.KML){a=a.map(function(t){const r=t.getGeometry();if(r instanceof e.geom.Point){var n=ne(t);const a=n.getImage();if(a instanceof e.style.RegularShape){const o=2*a.getRadius()+a.getStroke().getWidth()+1,i=o/2,s=document.createElement("canvas");s.width=o;s.height=o;const l=e.render.toContext(s.getContext("2d"),{size:[o,o]}),p=n.getText();(n=n.clone()).setText();l.setStyle(n);l.drawGeometry(new e.geom.Point([i,i]));const c=new e.Feature(r);c.setProperties(t.getProperties());c.setStyle(new e.style.Style({image:new e.style.Icon({src:s.toDataURL("image/png")}),text:p}));return c}}return t});const t=[];a.forEach(function(r){var n=ne(r);const a=r.getGeometry(),o=n.getText();var i;if(o){switch(!0){case a instanceof e.geom.LineString:i=new e.geom.Point(a.getCoordinateAt(.5));break;case a instanceof e.geom.Polygon:i=a.getInteriorPoint();break;case a instanceof e.geom.MultiLineString:const t=a.getLineStrings();var s=-1;i=new e.geom.Point(t[t.map(function(e){return e.getLength()}).reduce(function(e,t,r){if(t>s){s=t;return r}return e},-1)].getCoordinateAt(.5));break;case a instanceof e.geom.MultiPolygon:const r=a.getPolygons();var l=-1;i=r[r.map(function(e){return e.getArea()}).reduce(function(e,t,r){if(t>l){l=t;return r}return e},-1)].getInteriorPoint()}if(i){const r=new e.Feature(i);r.setStyle(new e.style.Style({text:o.clone(),image:new e.style.Icon({crossOrigin:"anonymous",src:TC.apiLocation+"TC/css/img/transparent.gif"})}));t.push(r)}}});t.length&&(a=a.concat(t))}if(o instanceof e.format.GMLBase){o.hasZ=t[0].getGeometryStride()>=3;(a=a.map(function(e){return e.clone()})).forEach(function(e){const t=e.values_,r=[];for(var n in t)n.indexOf(" ")>=0&&r.push(n);r.forEach(function(e){var r=e.replace(/ /g,"_");/^\d/.test(r)&&(r="_"+r);if(e!==r)for(;void 0!==t[r];)r+="_";t[r]=t[e];delete t[e]})});o.featureNS="sitna";o.featureType="feature";var i=o.writeFeaturesNode(a,{featureProjection:this.parent.crs}),s=e.xml.createElementNS("http://www.opengis.net/gml","FeatureCollection");s.setAttributeNS("http://www.w3.org/2001/XMLSchema-instance","xsi:schemaLocation",o.schemaLocation);i.removeAttribute("xmlns:xsi");i.removeAttribute("xsi:schemaLocation");s.appendChild(i)}o instanceof e.format.GPX&&(a=a.map(function(t){const r=t.getGeometry();r instanceof e.geom.LineString&&(t=t.clone()).setGeometry(new e.geom.MultiLineString([r.getCoordinates()]));return t}));var l=o.writeFeatures(a,{dataProjection:"EPSG:4326",featureProjection:this.parent.crs});o instanceof e.format.GPX&&(l=l.replace(/<ele>NaN<\/ele>/g,""));return l};var O=function(e){for(var t=0,r=e.dataTransfer.types.length;t<r;t++)if("Files"===e.dataTransfer.types[t])return!0;return!1},F=function(e){if(O(e)){this.getMap()._wrap.parent.div.classList.add(TC.Consts.classes.DROP);e.preventDefault();e.stopPropagation()}},b=function(e){if(O(e)){var t=this.getMap()._wrap.parent;e.target===this.target&&t.div.classList.remove(TC.Consts.classes.DROP)}};TC.wrap.Map.prototype.enableDragAndDrop=function(t){var r=this,n=t||{},a={formatConstructors:[e.format.KMLCustom,e.format.GPXCustom,e.format.GML3CRS84,e.format.GML2CRS84,e.format.GML3,e.format.GML2,e.format.GeoJSON,function(){return new e.format.WKT({splitCollection:!0})},e.format.TopoJSON]};n.dropTarget?a.target=TC.getDiv(n.dropTarget):a.target=r.parent.div;var l=new e.interaction.DragAndDrop(a);l.on("addfeatures",function(e){var t=e.features?e.features.map(function(e){e.getId()||e.setId(TC.getUID());return TC.wrap.Feature.createFeature(e)}):[];Promise.all(t).then(function(t){var n=r.parent.getLoadingIndicator();n&&n.removeWait(r._featureImportWaitId);t.length&&!t.some(function(e){return!e.geometry})?r.parent.trigger(TC.Consts.event.FEATURESIMPORT,{features:t,fileName:e.file.name,dropTarget:e.target.target}):r.parent.trigger(TC.Consts.event.FEATURESIMPORTERROR,{file:e.file})})});if(n.once)l.map_=r.map;else{r.map.addInteraction(l);var p=l.target?l.target:r.map.getViewport();if(window.JSZip){var c=function(){const e=l.handleResult_;l.handleResult_=function(t,r){var n=this;"application/x-zip-compressed"===t.type||"application/vnd.google-earth.kmz"===t.type?async function(t){try{var r=await JSZip.loadAsync(t)}catch(e){throw e}r.forEach(async function(t,r){r.async("blob").then(function(r){var a=new File([],t),o=new FileReader;o.onload=function(t){e.apply(n,[a,t])};o.readAsText(r)})})}(t):e.apply(n,[t,r])}};window.JSZip instanceof Promise?window.JSZip.then(c):c()}var u=function(e){if(O(e)){var t=r.parent;if(l.target===e.target){var n=t.getLoadingIndicator();n&&(r._featureImportWaitId=n.addWait());e.stopPropagation()}else e.preventDefault();t.div.classList.remove(TC.Consts.classes.DROP)}};l.dropListenKeys_.push(e.events.listen(p,o,F,l));l.dropListenKeys_.push(e.events.listen(document.body,o,F,l));l.dropListenKeys_.push(e.events.listen(p,i,F,l));l.dropListenKeys_.push(e.events.listen(document.body,i,F,l));l.dropListenKeys_.push(e.events.listen(p,s,u,l));l.dropListenKeys_.push(e.events.listen(document.body,s,u,l));l.dropListenKeys_.push(e.events.listen(document.body,"dragleave",b,l));l.dropListenKeys_.push(e.events.listen(document.body,"dragend",b,l));l.dropListenKeys_.push(e.events.listen(document.body,"dragexit",b,l));document.addEventListener("mouseenter",function(e){e.buttons||r.parent.div.classList.remove(TC.Consts.classes.DROP)},!1);r.ddEnabled=!0}return l};TC.wrap.Map.prototype.loadFiles=function(t,r){var n,a=this;a.ddEnabled?a.map.getInteractions().forEach(function(t){t instanceof e.interaction.DragAndDrop&&(n=t)}):n=a.enableDragAndDrop({once:!0});if(n&&r){var o=n.target;n.target=r.control;const e=function(t){n.target=o;a.parent.off(TC.Consts.event.FEATURESIMPORT,e)};a.parent.on(TC.Consts.event.FEATURESIMPORT,e)}var i=a.parent.getLoadingIndicator();i&&(a._featureImportWaitId=i.addWait());for(let r=0,a=t.length;r<a;++r){const a=t.item(r),o=new FileReader;o.addEventListener(e.events.EventType.LOAD,n.handleResult_.bind(n,a));o.readAsText(a)}};TC.wrap.Layer.prototype.getVisibility=function(){const e=this;var t=!1;e.layer&&(t=e.layer.getVisible());return t};TC.wrap.Layer.prototype.setVisibility=function(e){this.getLayer().then(function(t){t.setVisible(e)})};TC.wrap.Layer.prototype.isNative=function(t){return t instanceof e.layer.Layer};TC.wrap.Layer.prototype.setProjection=function(t){const r=this;t=t||{};const n=r.parent;if(n.map){const i=x.call(r,{crs:t.crs,extentInDegrees:e.proj.transformExtent(n.map.getExtent(),n.map.crs,"EPSG:4326")});var a=n.getResolutions();if(a&&a.length){a=a.map(function(e){return e/i});n.wrap.layer.setMaxResolution(a[0]);n.wrap.layer.setMinResolution(a[a.length-1])}else if(!t.oldCrs||e.proj.get(t.oldCrs).getUnits()!==e.proj.Units.METERS||e.proj.get(t.crs).getUnits()&&e.proj.get(t.crs).getUnits()!==e.proj.Units.DEGREES){if(t.oldCrs&&e.proj.get(t.oldCrs).getUnits()===e.proj.Units.DEGREES&&e.proj.get(t.crs).getUnits()===e.proj.Units.METERS){var o=TC.Util.getMetersPerDegree(e.proj.transformExtent(n.map.getExtent(),n.map.crs,"EPSG:4326"));if(n.minResolution){n.minResolution=n.minResolution*o;r.layer.setMinResolution(n.minResolution)}if(n.maxResolution){n.maxResolution=n.maxResolution*o;r.layer.setMaxResolution(n.maxResolution)}}}else{if(n.minResolution){n.minResolution=n.minResolution/i;r.layer.setMinResolution(n.minResolution)}if(n.maxResolution){n.maxResolution=n.maxResolution/i;r.layer.setMaxResolution(n.maxResolution)}}}};TC.wrap.layer.Raster.prototype.WmsParser=e.format.WMSCapabilities;TC.wrap.layer.Raster.prototype.WmtsParser=e.format.WMTSCapabilities;TC.wrap.Layer.prototype.addCommonEvents=function(e){var t=this;e.on("change:visible",function(){t.parent.map&&t.parent.map.trigger(TC.Consts.event.LAYERVISIBILITY,{layer:t.parent})},t.parent.map)};TC.wrap.layer.Raster.prototype.getGetMapUrl=function(){var e=null;switch(this.getServiceType()){case TC.Consts.layerType.WMS:for(var t=this.parent.capabilities.Capability.Request.GetMap.DCPType,r=0;r<t.length;r++)if(t[r].HTTP&&t[r].HTTP.Get){e=t[r].HTTP.Get.OnlineResource;break}break;case TC.Consts.layerType.WMTS:e=this.parent.capabilities.OperationsMetadata.GetTile.DCP.HTTP.Get[0].href}const n=document.createDocumentFragment(),a=document.createElement("textarea");n.appendChild(a);a.innerHTML=e;return e=a.textContent};TC.wrap.layer.Raster.prototype.getInfoFormats=function(){var e=null,t=this.parent.capabilities;t.Capability&&t.Capability.Request.GetFeatureInfo&&(e=t.Capability.Request.GetFeatureInfo.Format);return e};TC.wrap.layer.Raster.infoFormatPreference=["application/json","application/vnd.ogc.gml/3.1.1","application/vnd.ogc.gml","application/vnd.esri.wms_featureinfo_xml","text/html","text/plain","text/xml"];TC.wrap.layer.Raster.prototype.getWMTSLayer=function(){var e=null,t=this.parent.capabilities;if(t&&t.Contents)for(var r=0;r<t.Contents.Layer.length;r++)for(var n=t.Contents.Layer[r],a=0;a<n.TileMatrixSetLink.length;a++)if(this.parent.options.matrixSet===n.TileMatrixSetLink[a].TileMatrixSet){e=n;break}return e};TC.wrap.layer.Raster.prototype.getTileMatrix=function(e){var t=null,r=this.parent.capabilities;if(r&&r.Contents&&r.Contents.TileMatrixSet)for(var n=0;n<r.Contents.TileMatrixSet.length;n++){var a=r.Contents.TileMatrixSet[n];if(a.Identifier===e){t=a.TileMatrix;break}}return t};TC.wrap.layer.Raster.prototype.getScaleDenominators=function(e){var t=[];e.ScaleDenominator?t=[e.ScaleDenominator,e.ScaleDenominator]:(e.MinScaleDenominator||e.MaxScaleDenominator)&&(t=[e.MaxScaleDenominator,e.MinScaleDenominator]);if(!t.length&&!this.getName(e)){for(var r=this.getLayerNodes(e),n=-1/0,a=1/0,o=0,i=r.length;o<i;o++){var s=this.getScaleDenominators(r[o]);s[0]>n&&(n=s[0]);s[1]<a&&(a=s[1])}n>-1/0&&a<1/0&&(t=[n,a])}return t};TC.wrap.layer.Raster.prototype.getAttribution=function(){const e={},t=TC.capabilities[this.parent.url];if(t)if(t.ServiceProvider){e.name=t.ServiceProvider.ProviderName.trim();e.site=t.ServiceProvider.ProviderSite;e.site.href&&e.site.href.trim().length>0&&(e.site=e.site.href)}else t.ServiceIdentification?e.name=t.ServiceIdentification.Title.trim():e.name=t.Service.Title.trim();return e};TC.wrap.layer.Raster.prototype.getInfo=function(e){var t=this,r={},n=t.parent.capabilities;if(n&&n.Capability)for(var a=t.getAllLayerNodes(),o=0;o<a.length;o++){var i=a[o];if(t.parent.compareNames(t.getName(i),e)){i.Title&&(r.title=i.Title);i.Abstract&&(r.abstract=i.Abstract);r.legend=[];var s=function(e,r){if(e.Layer&&e.Layer.length>0)for(var n in e.Layer)s(e.Layer[n],r);else r.apply(t,[e])};s(i,function(e){var t=this.getLegend(e);t.src&&r.legend.push({src:t.src,title:e.Title})});if(i.MetadataURL&&i.MetadataURL.length){r.metadata=[];for(var l=0;l<i.MetadataURL.length;l++){var p=i.MetadataURL[l];r.metadata.push({format:p.Format,type:p.type,url:p.OnlineResource})}}r.queryable=i.queryable;break}}return r};TC.wrap.layer.Raster.prototype.getServiceType=function(){var e=null,t=this.parent.capabilities;t.Capability&&t.Capability.Request&&t.Capability.Request.GetMap?e=TC.Consts.layerType.WMS:t.OperationsMetadata&&t.OperationsMetadata.GetTile&&(e=TC.Consts.layerType.WMTS);return e};TC.wrap.layer.Raster.prototype.getServiceTitle=function(){var e=null,t=this.parent.capabilities;t.Capability&&t.Service?e=t.Service.Title:t.ServiceIdentification&&(e=t.ServiceIdentification.Title);return e};TC.wrap.layer.Raster.prototype.getRootLayerNode=function(){var e;this.getServiceType()===TC.Consts.layerType.WMS&&(e=this.parent.capabilities.Capability.Layer);return e};TC.wrap.layer.Raster.prototype.getName=function(e,t){var r=e.Name;if(r&&t){var n=r.indexOf(":");n>=0&&(r=r.substr(n+1))}return r};TC.wrap.layer.Raster.prototype.getIdentifier=function(e){return e.Identifier};TC.wrap.layer.Raster.prototype.getLayerNodes=function(e){var t=e.Layer;Array.isArray(t)||(t=t?[t]:[]);return t};TC.wrap.layer.Raster.prototype.getAllLayerNodes=function(){var e=this;if(!e._layerList)switch(e.getServiceType()){case TC.Consts.layerType.WMS:var t=e.getRootLayerNode();e._layerList=t?function t(r){for(var n=[r],a=e.getLayerNodes(r),o=0;o<a.length;o++)n=n.concat(t(a[o]));return n}(t):[];break;case TC.Consts.layerType.WMTS:e._layerList=e.parent.capabilities.Contents.Layer.slice();break;default:e._layerList=[]}return e._layerList};TC.wrap.layer.Raster.prototype.normalizeLayerNode=function(e){return e};TC.wrap.layer.Raster.prototype.normalizeCapabilities=function(e){return e};TC.wrap.layer.Raster.prototype.getLegend=function(e){var t={},r=e.Style;if(r&&r.length&&r.length&&r[0].LegendURL&&r[0].LegendURL.length){var n=r[0].LegendURL[0];const e=document.createDocumentFragment(),a=document.createElement("textarea");e.appendChild(a);a.innerHTML=n.OnlineResource;t.src=a.textContent}return t};TC.wrap.layer.Raster.prototype.isCompatible=function(e){var t=this,r=!0,n=t.parent;switch(t.getServiceType()){case TC.Consts.layerType.WMS:if(n.capabilities&&n.capabilities.Capability&&n.capabilities.Capability.Layer&&n.names.length>0)for(var a=n.names.slice(0),o=function r(a,o,i){var s=!1;if(a)for(var l=0;l<a.length;l++){var p=a[l];const u=p.CRS||p.SRS,f=Array.isArray(u)?u:[u];var c=i||f.indexOf(e)>=0;if(n.compareNames(t.getName(p),o)){c&&(s=!0);break}if(r(p.Layer,o,c)){s=!0;break}}return s};a.length>0;)if(!o([n.capabilities.Capability.Layer],a.pop())){r=!1;break}break;case TC.Consts.layerType.WMTS:r=!1;if(n.capabilities&&n.capabilities.Contents&&n.capabilities.Contents.TileMatrixSet)for(var i=n.capabilities.Contents.TileMatrixSet,s=0;s<i.length;s++)if(i[s].Identifier===n.options.matrixSet){r=TC.Util.CRSCodesEqual(e,i[s].SupportedCRS);break}}return r};TC.wrap.layer.Raster.prototype.getCompatibleCRS=function(){var e=[],t=this.parent;switch(this.getServiceType()){case TC.Consts.layerType.WMS:if(t.capabilities&&t.capabilities.Capability&&t.capabilities.Capability.Layer&&t.names.length>0){const r=t.names.map(function(e){return t.getNodePath(e).map(function(e){const t=e.CRS||e.SRS||[],r=Array.isArray(t)?t:[t];return Array.isArray(r)?r:[r]}).reduce(function(e,t){if(0===e.length)return t;t.forEach(function(t){e.indexOf(t)<0&&(e[e.length-1]=t)});return e},[])});if(1===r.length)e=r[0];else{const t=r.slice(1);e=r[0].filter(function(e){return t.every(function(t){return t.indexOf(e)>=0})})}}break;case TC.Consts.layerType.WMTS:t.capabilities&&t.capabilities.Contents&&t.capabilities.Contents.Layer.filter(function(e){return e.Identifier===t.layerNames}).forEach(function(r){const n=r.TileMatrixSetLink.map(function(e){return e.TileMatrixSet});e=t.capabilities.Contents.TileMatrixSet.filter(function(e){return n.indexOf(e.Identifier)>=0}).map(function(e){return e.SupportedCRS})})}return e};TC.wrap.layer.Raster.prototype.getCompatibleLayers=function(e){var t=[],r=this.parent;switch(this.getServiceType()){case TC.Consts.layerType.WMS:if(r.capabilities&&r.capabilities.Capability&&r.capabilities.Capability.Layer){var n=function(e,r,a){var o=e.CRS||e.SRS,i=Array.isArray(o)?o:[o],s=a||i.indexOf(r)>=0;s&&e.Name&&(t[t.length]=e.Name);if(e.Layer)for(var l=0;l<e.Layer.length;l++)n(e.Layer[l],r,s)};n(r.capabilities.Capability.Layer,e)}break;case TC.Consts.layerType.WMTS:if(r.capabilities&&r.capabilities.Contents&&r.capabilities.Contents.TileMatrixSet)for(var a=r.capabilities.Contents.TileMatrixSet,o=0,i=a.length;o<i;o++){var s=a[o];if(TC.Util.CRSCodesEqual(e,s.SupportedCRS))for(var l=s.Identifier,p=r.capabilities.Contents.Layer,c=0,u=p.length;c<u;c++)for(var f=p[c].TileMatrixSetLink,g=0,m=f.length;g<m;g++)if(f[g].TileMatrixSet===l){t[t.length]=p[c].Identifier;break}}}return t};TC.wrap.layer.Raster.prototype.getCompatibleMatrixSets=function(e){var t=[];_({crs:e});var r=this.parent;if(this.getServiceType()===TC.Consts.layerType.WMTS)for(var n=r.capabilities.Contents.Layer,a=r.capabilities.Contents.TileMatrixSet,o=0,i=n.length;o<i;o++)if(r.layerNames===n[o].Identifier)for(var s=n[o].TileMatrixSetLink,l=0,p=s.length;l<p;l++)for(var c=s[l],u=0,f=a.length;u<f;u++){var g=a[u];if(g.Identifier===c.TileMatrixSet){TC.Util.CRSCodesEqual(e,g.SupportedCRS)&&(t[t.length]=g.Identifier);break}}return t};TC.wrap.layer.Raster.prototype.setWMTSUrl=function(){var e=this;e.getLayer().then(function(t){e.parent.options=e.parent.options||{};var r=t.getSource().getUrls();e.parent.options.urlPattern=r[r.length-1]})};TC.wrap.layer.Raster.prototype.createWMSLayer=function(t,r,n){const a=this;var o=null,i=new e.source.ImageWMS({url:t,crossOrigin:n.map?n.map.options.crossOrigin:void 0,params:r,extent:TC.Cfg.initialExtent,ratio:TC.Cfg.imageRatio,imageLoadFunction:a.parent.getImageLoad.bind(a.parent)});i.on("imageloadstart",function(e){a.trigger(TC.Consts.event.BEFORETILELOAD,{tile:e.image.getImage()})});i.on("imageloadend",function(e){a.trigger(TC.Consts.event.TILELOAD,{tile:e.image.getImage()})});i.on("imageloaderror",function(e){a.trigger(TC.Consts.event.TILELOAD,{tile:e.image.getImage()})});var s={visible:!!r.LAYERS.length||n&&n.method&&"POST"===n.method,source:i};n.minResolution&&(s.minResolution=n.minResolution);n.maxResolution&&(s.maxResolution=n.maxResolution);(o=new e.layer.Image(s))._wrap=a;a.addCommonEvents(o);return o};var A=function(t){var r=this,n=null,a=e.source.WMTS.optionsFromCapabilities(r.parent.capabilities,{layer:t.layerNames,matrixSet:t.matrixSet,crossOrigin:t.map?t.map.options.crossOrigin:void 0,requestEncoding:t.encoding,format:t.format});if(a){"https:"===location.protocol&&(a.urls=a.urls.map(function(e){return e.replace("http:","https:")}));a.crossOrigin=t.map?t.map.options.crossOrigin:void 0;(n=new e.source.WMTS(a)).setTileLoadFunction(r.parent.getImageLoad.bind(r.parent));n.on(C,function(e){r.trigger(TC.Consts.event.BEFORETILELOAD,{tile:e.tile.getImage()})});n.on(h,function(e){r.trigger(TC.Consts.event.TILELOAD,{tile:e.tile.getImage()})});n.on(T,function(e){r.trigger(TC.Consts.event.TILELOAD,{tile:e.tile.getImage()})});var o=n.getResolutions.bind(n);n.getResolutions=function(){var e=o(),t=r.parent.getLimitedMatrixSet();if(t&&t.length){var n=t[0].matrixIndex;e=e.slice(n,t.length+n)}return e}}return n};TC.wrap.layer.Raster.prototype.createWMTSLayer=function(t){const r=this;var n=null,a=A.call(r,t);if(a){var o={source:a};t.minResolution&&(o.minResolution=t.minResolution);t.maxResolution&&(o.maxResolution=t.maxResolution);(n=new e.layer.Tile(o))._wrap=r;r.addCommonEvents(n);var i=a.getResolutions();n.setMaxResolution(i[0]+1);n.setMinResolution(i[i.length-1])}return n};TC.wrap.layer.Raster.prototype.getParams=function(){return this.layer.getSource().getParams()};TC.wrap.layer.Raster.prototype.setParams=function(e){this.layer.getSource().updateParams(e)};TC.wrap.layer.Raster.prototype.setMatrixSet=function(e){const t=this;t.layer.getSource().getResolutions();if(t.parent.type===TC.Consts.layerType.WMTS){const r=A.call(t,TC.Util.extend({},t.parent.options,{matrixSet:e})),n=r.getResolutions(),a=n[0],o=n[n.length-1];t.layer.setMaxResolution(a);t.layer.setMinResolution(o);t.parent.minResolution&&(t.parent.minResolution=o);t.parent.maxResolution&&(t.parent.maxResolution=a);t.layer.setSource(r)}};TC.wrap.layer.Raster.prototype.getResolutions=function(){if(this.layer.getSource){var e=this.layer.getSource();return e.getResolutions?e.getResolutions():[]}return[]};TC.wrap.layer.Raster.prototype.setResolutions=function(e){if(this.layer.getSource){var t=this.layer.getSource();t.resolutions_?t.resolutions_=e:t.tileGrid&&(t.tileGrid.resolutions_=e)}};TC.wrap.layer.Raster.prototype.reloadSource=function(){const e=this;return new Promise(function(t,r){if(e.layer.getSource){e.layer.getSource().refresh();t()}else r()})};TC.wrap.Geometry={getNearest:function(t,r){return new e.geom.LineString(r).getClosestPoint(t)}};var G=function(e,t,r){if(e){var n=function(n){var a=(r&&r._wrap?r._wrap.parent.options.width:null)||t;if(a<n){var o=a/n;e.setScale(o)}},a=e.getSize();if(a)n(a[0]);else{var o=e.getImage();if(o.naturalWidth)n(o.naturalWidth);else{const t=document.createDocumentFragment(),r=document.createElement("img");r.src=e.getSrc();r.addEventListener("load",function(){n(this.naturalWidth)});t.appendChild(r)}}}},k=function(e,t){var r=e,n=t&&t.wrap&&t.wrap.feature;if("string"==typeof e){var a=e.match(/^\$\{(.+)\}$/);if(a&&n){for(var o=a[1].split("."),i=n.getProperties(),s=0;s<o.length&&void 0!==i;s++)i=i[o[s]];if(void 0===i){i=t.data;for(s=0;s<o.length&&void 0!==i;s++)i=i[o[s]]}r=i}}else TC.Util.isFunction(e)&&(r=e(t));return r},N=function(t,r){var n,a,o,i,s,l={};if(r){switch(r.getGeometry().getType()){case"Point":case"MultiPoint":a=!0;break;case"LineString":case"MultiLineString":o=!0;break;case"Polygon":case"MultiPolygon":i=!0}n=r._wrap?r._wrap.parent:{id:TC.wrap.Feature.prototype.getId.call({feature:r}),features:r.get("features"),getData:function(){return TC.wrap.Feature.prototype.getData.call({feature:r})}}}var p={};if((s=n&&Array.isArray(n.features)&&n.features.length>1&&t.cluster?TC.Util.extend(!0,{},TC.Cfg.styles.cluster,t.cluster.styles):t.styles||TC.Cfg.styles).line&&(o||!r)){p=s.line;l.stroke=new e.style.Stroke({color:k(s.line.strokeColor,n),width:k(s.line.strokeWidth,n),lineDash:s.line.lineDash})}if(s.polygon&&(i||!r)){p=s.polygon;l.fill=new e.style.Fill({color:M(k(s.polygon.fillColor,n),k(s.polygon.fillOpacity,n))});l.stroke=new e.style.Stroke({color:k(s.polygon.strokeColor,n),width:k(s.polygon.strokeWidth,n),lineDash:s.polygon.lineDash})}if(s.point&&(a||!r)){p=s.point;var c={radius:k(p.radius,n)||(k(p.height,n)+k(p.width,n))/4};p.fillColor&&(c.fill=new e.style.Fill({color:M(k(p.fillColor,n),k(p.fillOpacity,n))}));p.strokeColor&&(c.stroke=new e.style.Stroke({color:k(p.strokeColor,n),width:k(p.strokeWidth,n),lineDash:p.lineDash}));isNaN(c.radius)||(l.image=new e.style.Circle(c))}p.label&&(l.text=D(p,n));if(s.marker&&(a||!r)){if((p=s.marker).url){l.image=new e.style.Icon({crossOrigin:"anonymous",anchor:p.anchor,anchorXUnits:p.anchorXUnits||"fraction",anchorYUnits:p.anchorYUnits||"fraction",src:p.url});l.text=D(p,n)}}return[new e.style.Style(l)]};const D=function(t,r){if(!t||!t.label)return;const n={text:""+k(t.label,r)};t.fontSize&&(n.font=k(t.fontSize,r)+"pt sans-serif");t.angle&&(n.rotation=-Math.PI*k(t.angle,r)/180);t.fontColor&&(n.fill=new e.style.Fill({color:M(k(t.fontColor,r),1)}));t.labelOutlineColor&&(n.stroke=new e.style.Stroke({color:M(k(t.labelOutlineColor,r),1),width:k(t.labelOutlineWidth,r)}));if(t.labelOffset){n.offsetX=t.labelOffset[0];n.offsetY=t.labelOffset[1]}return new e.style.Text(n)};var U=function(e){var t=e.toString(16);1===t.length&&(t="0"+t);return t},V=function(e){return"#"+U(e[0])+U(e[1])+U(e[2])},W=function(t,r){var n={};TC.Util.isFunction(t)&&r&&(t=t(r));Array.isArray(t)&&(t=t[0]);if(!TC.Util.isFunction(t)){var a,o,i;if(r){const n=r.getGeometry().getType();n!==e.geom.GeometryType.POINT&&n!==e.geom.GeometryType.MULTI_POINT&&t.setImage(null)}var s=t.getImage();if(s)if(s instanceof e.style.RegularShape){if(a=(o=s.getStroke()).getColor()){a=e.color.asArray(a);n.strokeColor=V(a)}n.strokeWidth=o.getWidth();if(i=s.getFill()){if(a=i.getColor()){a=e.color.asArray(a);n.fillColor=V(a)}n.fillOpacity=a[3]}}else{n.url=s.getSrc();var l=s.getSize();if(l){n.width=l[0];n.height=l[1];n.anchor=s.getAnchor();if(n.anchor){n.anchor[0]=n.anchor[0]/n.width;n.anchor[1]=n.anchor[1]/n.height}}}else{if(o=t.getStroke()){if(a=o.getColor()){a=e.color.asArray(a);n.strokeColor=V(a)}n.strokeWidth=o.getWidth();n.lineDash=o.getLineDash()}if(i=t.getFill()){if(a=i.getColor()){a=e.color.asArray(a);n.fillColor=V(a)}n.fillOpacity=a[3]}}}return n};TC.wrap.layer.Vector.prototype.getStyle=function(){return W(this.layer.getStyle())};TC.wrap.layer.Vector.prototype.reloadSource=function(){const t=this;return new Promise(function(r,n){const a=t.createVectorSource(t.parent,t.createStyles(t.parent));if(t.parent.type===TC.Consts.layerType.WFS)var o=a.source.on("change",function(t){if("ready"==a.source.getState()){e.Observable.unByKey(o);r()}});var i=t.layer.getSource().getFeatures();t.layer.setSource(a.source);a.style&&t.layer.setStyle(a.style);if(t.parent.type!=TC.Consts.layerType.WFS){a.source.addFeatures(i);r()}})};TC.wrap.layer.Vector.prototype.import=function(e){var t=TC.Util.extend({},e);t.type=e.format;var r=this.layer.getSource().getFeatures(),n=this.createVectorSource(t,this.createStyles(this.parent));this.layer.setSource(n.source);n.style&&this.layer.setStyle(n.style);n.source.addFeatures(r)};TC.wrap.layer.Vector.prototype.createVectorSource=function(t,r){const n=this;var a,o,i,s,p,c=!1;if(Array.isArray(t.url)||t.urls){var u=t.urls||t.url;o={url:u=u.map(function(e,t){return TC.proxify(e)}),format:new e.format.KMLCustom({showPointNames:!1}),projection:t.crs}}else if(t.url&&t.type!==TC.Consts.layerType.WFS){(o={url:TC.proxify(t.url),projection:t.crs}).format=I(t.format)||I(function(e){var t=e.indexOf("?");t>=0?e=e.substr(0,t):(t=e.indexOf("#"))>=0&&(e=e.substr(0,t));switch(e.substr(e.lastIndexOf(".")+1).toLowerCase()){case"kml":return TC.Consts.mimeType.KML;case"json":case"geojson":return TC.Consts.mimeType.GEOJSON;case"gml":return TC.Consts.mimeType.GML;case"gpx":return TC.Consts.mimeType.GPX;default:return null}}(t.url))||I(t.type);o.loader=(i=o.url,s=o.format,p=e.featureloader.xhr(i,s),function(e,t,r){n.parent.state=TC.Layer.state.LOADING;n.parent.map&&n.parent.map.trigger(TC.Consts.event.BEFORELAYERUPDATE,{layer:n.parent});p.call(this,e,t,r)});c=!0}else if(t.data)(o={projection:t.crs,loader:function(e,r,a){n.parent.state=TC.Layer.state.LOADING;n.parent.map&&n.parent.map.trigger(TC.Consts.event.BEFORELAYERUPDATE,{layer:n.parent});var o=this.getFormat();try{var i=o.readFeatures(t.data,{featureProjection:a});this.addFeatures(i);n.parent.state=TC.Layer.state.IDLE;n.parent.map&&n.parent.map.trigger(TC.Consts.event.LAYERUPDATE,{layer:n.parent,newData:data})}catch(e){n.parent.state=TC.Layer.state.IDLE;n.parent.map&&n.parent.map.trigger(TC.Consts.event.LAYERERROR,{layer:n.parent,reason:e.message})}}}).format=I(t.format)||I(t.type);else if(t.type==TC.Consts.layerType.WFS){var f,g;switch(t.outputFormat){case TC.Consts.format.JSON:f=new e.format.GeoJSON({geometryName:t.geometryName});g="json";break;case TC.Consts.format.GML3:f=new e.format.WFS({gmlFormat:new e.format.GML3});g=TC.Consts.mimeType.GML;break;case TC.Consts.format.GML32:f=new e.format.WFS({gmlFormat:new e.format.GML32});g=TC.Consts.mimeType.GML;break;default:f=new e.format.WFS({gmlFormat:new e.format.GML2});g=TC.Consts.mimeType.GML}o={format:f,loader:function(e,r,a){var o=this,i=t.url;if(i){n.parent.state=TC.Layer.state.LOADING;n.parent.map.trigger(TC.Consts.event.BEFORELAYERUPDATE,{layer:n.parent});const e=e=>{const t=e.data;let r;try{r=f.readFeatures(t)}catch(e){n.parent.map.trigger(TC.Consts.event.LAYERERROR,{layer:n.parent,reason:e.message})}const a=function(){n.parent.map.trigger(TC.Consts.event.LAYERUPDATE,{layer:n.parent,newData:t})},i=function(e){if(e.layer===n.parent){n.parent.map.off(TC.Consts.event.FEATURESADD,i);a()}};if(r&&r.length){o.addFeatures(r);n.parent.map.on(TC.Consts.event.FEATURESADD,i)}else a();n.parent.state=TC.Layer.state.IDLE},r=(e,r)=>{var n={},o=a.getCode(),s=t.version||r.version||"1.1.0";r.version=s;var l=i,p=Array.isArray(t.featureType)?t.featureType:[t.featureType];if(t.properties&&t.properties.getText(r.version).length>TC.Consts.URL_MAX_LENGTH){n.method="POST";n.url=l;n.data=TC.Util.WFSQueryBuilder(p,t.properties,r,e?null:t.outputFormat,e,o,t.maxFeatures)}else{n.method="GET";n.url=l;n.data={service:"WFS",request:"GetFeature",version:s,typename:(t.featurePrefix?t.featurePrefix+":":"")+t.featureType,outputFormat:t.outputFormat,srsname:o};e&&(n.data=Object.assign(n.data,{resultType:"hits"}));t.properties&&(t.properties instanceof TC.filter.Bbox?n.data=Object.assign(n.data,{BBOX:"{0},{1},{2},{3},{4}".format(t.properties.extent.concat([o]))}):n.data=Object.assign(n.data,{filter:t.properties.getText()}));t.maxFeatures&&(n.data=Object.assign(n.data,{maxFeatures:t.maxFeatures}))}switch(e?"":g){case"json":n.responseType=TC.Consts.mimeType.JSON;break;default:n.responseType=TC.Consts.mimeType.XML}n.contentType=TC.Consts.mimeType.XML;return TC.ajax(n)};n.parent.getCapabilitiesPromise().then(a=>{const o=a;let i=null;try{i=o.Operations.GetFeature.CountDefault.DefaultValue}catch(e){}if(i){t.maxFeatures||(t.maxFeatures=i);r(!0,o).then(t=>{var a=t.data.children[0];if(a.tagName.toLowerCase().indexOf("exception")>=0)n.parent.map.trigger(TC.Consts.event.LAYERERROR,{layer:n.parent,reason:a.querySelector("ExceptionText").innerHTML});else if(a.tagName.toLowerCase().indexOf("featurecollection")>=0){let t=parseInt((a.attributes.numberMatched||a.attributes.numberOfFeatures).value,10);if(isNaN(t)||t>=parseInt(i,10)){n.parent.map.trigger(TC.Consts.event.LAYERERROR,{layer:n.parent,reason:TC.Consts.WFSErrors.MAX_NUM_FEATURES,data:{limit:parseInt(i,10),founded:t}});return}if(!isNaN(t)&&0===t){e({data:f.writeFeatures([])});return}r(!1,o).then(e)}})}else r(!1,o).then(e)});n._requestUrl=i}},projection:t.crs}}a=new e.source.Vector(o);c&&a.on(l,function(e){n.parent.map&&n.parent.map.trigger(TC.Consts.event.LAYERUPDATE,{layer:n.parent})});a._tcLayer=n.parent;var C=t.style&&t.style.marker?t.style.marker:TC.Cfg.styles.marker;t.style&&t.style.marker||(C=TC.Util.extend({},C,{anchor:TC.Cfg.styles.point.anchor}));if(t.cluster){a=new e.source.Cluster({projection:t.crs,distance:t.cluster.distance,source:a});if(t.cluster.animate){var h=function(t,r){var n=Date.now(),a=t.getGeometry().getCoordinates(),o=r.getGeometry().getCoordinates();r.setGeometry(new e.geom.Point(a));requestAnimationFrame(function i(){var s=function(e,t,r,n){var a=Math.min((Date.now()-n)/r,1),o=(t[0]-e[0])*a,i=(t[1]-e[1])*a;return[e[0]+o,e[1]+i]}(a,o,TC.Consts.CLUSTER_ANIMATION_DURATION,n);r.setGeometry(new e.geom.Point(s));s[0]!==o[0]&&s[1]!==o[1]?requestAnimationFrame(i):T.splice(T.indexOf(t),1)})},T=[];a.addEventListener(y,function(e){var t=e.feature.get("features");t&&t.length>1&&T.push(e.feature)});a.addEventListener(m,function(e){var t=e.feature.get("features");if(t){var r=t[0].getGeometry().getCoordinates();if(t.length>1){var n=T.filter(function(e){var t=e.getGeometry().getCoordinates();return t[0]===r[0]&&t[1]===r[1]});n.length&&T.splice(T.indexOf(n[0]),1)}var a=T.filter(function(e){var t=e.get("features");if(t&&t.length>0){return t.filter(function(e){var t=e.getGeometry().getCoordinates();return t[0]===r[0]&&t[1]===r[1]}).length>0}});a.length&&h(a[a.length-1],e.feature)}})}}var v=a;do{v.addEventListener(m,function(e){var t=e.feature,r=ne(t,!0);r&&G(r.getImage(),C.width,t)});v=TC.Util.isFunction(v.getSource)?v.getSource():null}while(v);a.addEventListener(m,function(e){const t=e.feature,r=function(e){var r;switch(!0){case TC.feature.Point&&e instanceof TC.feature.Point:r=n.parent.addPoint;break;case TC.feature.Polyline&&e instanceof TC.feature.Polyline:r=n.parent.addPolyline;break;case TC.feature.Polygon&&e instanceof TC.feature.Polygon:r=n.parent.addPolygon;break;case TC.feature.MultiPolygon&&e instanceof TC.feature.MultiPolygon:r=n.parent.addMultiPolygon;break;case TC.feature.MultiPolyline&&e instanceof TC.feature.MultiPolyline:r=n.parent.addMultiPolyline;break;default:r=n.parent.addFeature}if(r){var a;r.call(n.parent,t).then(function(r){var o=t.get("features");Array.isArray(o)&&(r.features=o.map(function(t){return new e.constructor(t)}));clearTimeout(a);a=setTimeout(function(){n.parent.map.trigger(TC.Consts.event.FEATURESADD,{layer:n.parent,features:[r]})},50)})}};t._wrap&&t._wrap.parent.layer||TC.wrap.Feature.createFeature(t).then(r)});a.addEventListener(y,function(e){var t=e.feature;if(t._wrap){var r=n.parent.features.indexOf(t._wrap.parent);if(r>-1){n.parent.features.splice(r,1);n.parent.map.trigger(TC.Consts.event.FEATUREREMOVE,{layer:n.parent,feature:t._wrap.parent})}}});a.addEventListener(m,function(e){n.parent.map&&n.parent.map.trigger(TC.Consts.event.VECTORUPDATE,{layer:n.parent})});a.addEventListener(y,function(){n.parent.map&&n.parent.map.trigger(TC.Consts.event.VECTORUPDATE,{layer:n.parent})});a.addEventListener(d,function(){n.parent.map&&n.parent.map.trigger(TC.Consts.event.FEATURESCLEAR,{layer:n.parent})});var w={source:a};t.minResolution&&(w.minResolution=t.minResolution);t.maxResolution&&(w.maxResolution=t.maxResolution);o&&o.format instanceof e.format.KML&&!t.cluster||(w.style=r||t.styles);return w};TC.wrap.layer.Vector.prototype.createStyles=function(e){var t=this,r=!1;if(TC.Util.isFunction(e)){r=!0;t.styleFunction=function(t){return N(e(t))}}else{(e=TC.Util.extend({},e)).crs=e.crs||TC.Cfg.crs;e.styles=e.styles||TC.Cfg.styles;r=!(!e.cluster||!e.cluster.styles)||function e(t){for(var r in t){var n=t[r];switch(typeof n){case"string":if(/^\$\{(.+)\}$/.test(n))return!0;break;case"object":if(e(n))return!0;break;case"function":return!0}}return!1}(e.styles);t.styleFunction=function(e){return N({styles:t.parent.styles},e)}}return r?t.styleFunction:t.styleFunction()};TC.wrap.layer.Vector.prototype.setStyles=function(e){const t=this;t.getLayer().then(function(r){r.setStyle(t.createStyles({styles:e}))})};TC.wrap.layer.Vector.prototype.createVectorLayer=function(){var t=null,r=this.parent.options,n=this.createVectorSource(r,this.createStyles(r));n.declutter=this.parent.options.declutter||!1;(t=new e.layer.Vector(n))._wrap=this;this.addCommonEvents(t);return t};TC.wrap.layer.Vector.prototype.addFeatures=function(e){const t=this,r=function(t){for(var r=t;TC.Util.isFunction(r.getSource);)r=r.getSource();r.addFeatures(e)};t.layer?r(t.layer):t.getLayer().then(r)};TC.wrap.layer.Vector.prototype.getFeatures=function(){var t=this.getLayer();return t instanceof e.layer.Layer?t.getSource().getFeatures():[]};TC.wrap.layer.Vector.prototype.getFeatureById=function(t){var r=this.layer;return r instanceof e.layer.Layer?r.getSource().getFeatureById(t):null};TC.wrap.layer.Vector.prototype.removeFeature=function(e){const t=this,r=function(t){if(e.wrap.feature){t.getSource().removeFeature(e.wrap.feature)}};t.layer?r(t.layer):t.getLayer().then(r)};TC.wrap.layer.Vector.prototype.clearFeatures=function(){const e=this,t=function(e){var t=e.getSource();t.clearFeatures?t.clearFeatures():t.clear()};e.layer?t(e.layer):e.getLayer().then(t)};TC.wrap.layer.Vector.prototype.setFeatureVisibility=function(t,r){var n=this,a={color:"rgba(0, 0, 0, 0)"},o={color:"rgba(0, 0, 0, 0)"},i=new e.style.Style({image:new e.style.Circle({radius:0,fill:new e.style.Fill(a),stroke:new e.style.Stroke(o)}),fill:new e.style.Fill(a),stroke:new e.style.Stroke(o)});if(n.parent.features.indexOf(t)>=0){var s=t.wrap.feature;n.getLayer().then(function(e){if(r&&s._originalStyle)s.setStyle(s._originalStyle);else{s._originalStyle=s.getStyle()||e.getStyle();s.setStyle(i)}n.parent.map.trigger(TC.Consts.event.VECTORUPDATE,{layer:n.parent})})}};TC.wrap.layer.Vector.prototype.getRGBA=function(e,t){return M(e,t)};TC.wrap.layer.Vector.prototype.findFeature=function(e){};TC.wrap.layer.Vector.prototype.getGetFeatureUrl=function(){return this._requestUrl};TC.wrap.layer.Vector.prototype.sendTransaction=function(t,r,n){const a=this,o=function(e){return e.wrap.feature};return new Promise(function(i,s){const l=t.map(o),p=r.map(o),c=n.map(o);t.length||r.length||n.length?a.getLayer().then(function(t){var r=new e.format.WFS,n=a.parent.options,o=r.writeTransaction(l,p,c,{featurePrefix:n.featurePrefix,featureNS:n.featureNS,featureType:n.featureType[0]}),u={url:a.parent.url,method:"POST",contentType:TC.Consts.mimeType.XML,responseType:TC.Consts.mimeType.XML,data:o.outerHTML};TC.ajax(u).then(function(e){const t=e.data,n="http://www.opengis.net/ows";var a=t.getElementsByTagNameNS(n,"ExceptionReport")[0],o={reason:""};if(a){var l=a.getElementsByTagNameNS(n,"Exception")[0];if(l){o.code=l.getAttribute("exceptionCode");for(var p=l.getElementsByTagNameNS(n,"ExceptionText"),c=0,u=p.length;c<u;c++)o.reason+="\n"+p[c].innerHTML}s(o)}else{var f=r.readTransactionResponse(t);i(f)}}).catch(function(){s({code:"",reason:"unknown"})})}):i(a.parent)})};TC.wrap.layer.Vector.prototype.setDraggable=function(t,r,n){var a=this;Promise.all([a.parent.map.wrap.getMap(),a.getLayer()]).then(function(o){const i=o[0],s=o[1];if(t){var l={layers:[s],features:new e.Collection(s.getSource().getFeatures())};a.interaction=new e.interaction.Translate(l);TC.Util.isFunction(r)&&a.interaction.on("translateend",function(e){e.features.getLength()&&r(e.features.item(0)._wrap.parent)});TC.Util.isFunction(n)&&a.interaction.on("translatestart",function(e){e.features.getLength()&&n(e.features.item(0)._wrap.parent)});i.addInteraction(a.interaction)}else if(a.interaction){i.removeInteraction(a.interaction);if(TC.Util.detectIE()&&a._handlerDraggablePointerMove&&TC.Util.isFunction(a._handlerDraggablePointerMove)){i.un("pointermove",a._handlerDraggablePointerMove);delete a._handlerDraggablePointerMove}}})};TC.wrap.layer.Vector.prototype.getFeaturesInExtent=function(t,r){var n=this.layer.getSource().getFeatures(),a=[];if(r){var o=this.parent.map.getPixelFromCoordinate([t[0],t[1]]),i=this.parent.map.getPixelFromCoordinate([t[2],t[3]]);o[0]-=r[0]/2;o[1]+=r[1];i[0]+=r[0]/2;t=this.parent.map.getCoordinateFromPixel(o).concat(this.parent.map.getCoordinateFromPixel(i))}for(var s=0;s<n.length;s++){var l=n[s],p=l.getGeometry().getCoordinates();e.extent.containsCoordinate(t,p)&&a.push(l._wrap.parent)}return a};TC.wrap.layer.Vector.prototype.getAttribution=function(){return null};TC.wrap.layer.Vector.prototype.getGetMapUrl=function(){var e=null;switch(this.getServiceType()){case TC.Consts.layerType.WFS:try{e=this.parent.capabilities.Operations.GetFeature.DCP.HTTP.Get.href}catch(e){}}const t=document.createDocumentFragment(),r=document.createElement("textarea");t.appendChild(r);r.innerHTML=e;return e=r.textContent};TC.wrap.layer.Vector.prototype.getServiceType=function(){var e=null;this.parent.capabilities&&(e=TC.Consts.layerType.WFS);return e};TC.wrap.control.Click.prototype.register=function(e){var t=this;t._trigger=function(r){if(e.view!==TC.Consts.view.PRINTING){var n=0;e.wrap.map.forEachFeatureAtPixel(r.pixel,function(e,t){e._wrap&&e._wrap.parent.showsPopup&&n++},{hitTolerance:v});if(!n){t.parent.map.trigger(TC.Consts.event.CLICK,{coordinate:r.coordinate,pixel:r.pixel});t.parent.callback(r.coordinate,r.pixel)}return 0===n}}};TC.wrap.control.Click.prototype.activate=function(){var e=this;e.parent.map.wrap.getMap().then(function(t){t.on(p,e._trigger)})};TC.wrap.control.Click.prototype.deactivate=function(){var e=this;e.parent.map.wrap.getMap().then(function(t){t.un(p,e._trigger)})};TC.wrap.control.ScaleBar.prototype.render=function(){this.ctl?this.ctl.updateElement_():this.ctl=new e.control.ScaleLine({target:this.parent.div})};TC.wrap.control.ScaleBar.prototype.getText=function(){if(this.ctl)return this.ctl.renderedHTML_};TC.wrap.control.NavBar.prototype.register=function(t){var r=this;t.wrap.getMap().then(function(n){const a=r.parent.div;r.zCtl=new e.control.Zoom({target:a});r.zsCtl=new e.control.ZoomSlider({render:function(t){if(!t.frameState||!t.frameState.viewState||n.getView().getMinResolution()<=t.frameState.viewState.resolution){var a=function(){if(this.element.offsetWidth>this.element.offsetHeight){r.requestSliderSize||(r.requestSliderSize=window.requestAnimationFrame(a.bind(this)));window.requestAnimationFrame(a.bind(this))}else if(this.element.offsetWidth<this.element.offsetHeight){if(r.requestSliderSize){window.cancelAnimationFrame(r.requestSliderSize);delete r.requestSliderSize}e.control.ZoomSlider.render.call(this,t)}};a.call(this)}}});r.zsCtl.setTarget(a);n.addControl(r.zsCtl);n.addControl(r.zCtl);a.querySelectorAll("button").forEach(function(e){e.classList.add("tc-ctl-btn",r.parent.CLASS+"-btn");e.style.display="block";e.innerHTML="";if(e.matches(".ol-zoom-in")){e.classList.add(r.parent.CLASS+"-btn-zoomin");e.setAttribute("title",r.parent.getLocaleString("zoomIn"))}if(e.matches(".ol-zoom-out")){e.classList.add(r.parent.CLASS+"-btn-zoomout");e.setAttribute("title",r.parent.getLocaleString("zoomOut"))}});const o=a.querySelector(".ol-zoomslider");o.classList.add(r.parent.CLASS+"-bar");o.querySelector(".ol-zoomslider-thumb").classList.add(r.parent.CLASS+"-slider");t.on(TC.Consts.event.BASELAYERCHANGE,r.refresh.bind(r))})};TC.wrap.control.NavBar.prototype.refresh=function(){var e=this,t=e.parent.map.wrap.map;e.parent.renderPromise().then(function(){if(e.zsCtl.sliderInitialized_){var r=t.getView().getResolution();e.zsCtl.setThumbPosition_(r)}else t.once(f,function(t){e.zsCtl.render(t)})})};TC.wrap.control.NavBarHome.prototype.register=function(t){var r=this;t.wrap.getMap().then(function(n){const a=r.parent.div;r.z2eCtl=new e.control.ZoomToExtent({target:a,extent:t.initialExtent,tipLabel:""});n.addControl(r.z2eCtl);a.querySelectorAll("button").forEach(function(e){e.style.display="block";e.innerHTML=""});const o=a.querySelector(".ol-zoom-extent button");o.classList.add("tc-ctl-btn",r.parent.CLASS+"-btn");o.setAttribute("title",r.parent.getLocaleString("zoomToInitialExtent"))})};TC.wrap.control.NavBarHome.prototype.setInitialExtent=function(e){this.z2eCtl.extent=e};TC.wrap.control.Coordinates.prototype.register=function(t){const r=this;r.map=t;return new Promise(function(n,a){r._coordsTrigger=function(e){r.parent.coordsToClick(e)};t.wrap.getMap().then(function(t){r.olMap=t;if(r.parent.map.on3DView){r.parent.crs=r.parent.map.view3D.crs;r.parent.units=TC.Consts.units.DEGREES}else{var a=t.getView().getProjection();r.parent.crs=a.getCode();r.parent.units=a.getUnits()}r.parent.isGeo=r.parent.units===e.proj.Units.DEGREES;n()})})};TC.wrap.control.Coordinates.prototype.onMouseMove=function(e){if(this.map.wrap.map){var t=this.map.wrap.map.getEventCoordinate(e);if(t){this.parent.isGeo?this.parent.latLon=t.reverse():this.parent.xy=t;this.parent.update.apply(this.parent,arguments)}}};TC.wrap.control.Geolocation.prototype.register=function(e){var t=this;t.map=e;t._snapTrigger=function(e){e.dragging||t.initSnap(t.olMap.getEventCoordinate(e),e.pixel)};t._postcomposeTrigger=function(e){t.duringTrackSnap(e)};e.wrap.getMap().then(function(e){t.olMap=e})};var B=function(){return this.parent.layerTracking.features.filter(function(e){return e instanceof TC.feature.Polyline})[0]};TC.wrap.control.Geolocation.prototype.hasCoordinates=function(){return this.parent.layerTracking.features.length>0&&this.parent.layerTracking.features[0].geometry.length>=1};TC.wrap.control.Geolocation.prototype.showElevationMarker=function(e){TC.wrap.control.ResultsPanel.prototype.showElevationMarker.call(this,{data:e,layer:this.parent.layerTrack,coords:this.parent.elevationChartData.coords})};TC.wrap.control.Geolocation.prototype.hideElevationMarker=function(){TC.wrap.control.ResultsPanel.prototype.hideElevationMarker.call(this)};TC.wrap.control.Geolocation.prototype.addWaypoint=function(t,r){var n=new e.Feature({geometry:new e.geom.Point([t[0],t[1],r.ele,r.time],"XYZM")});n.setProperties(r);this.parent.layerTracking.wrap.layer.getSource().addFeature(n)};TC.wrap.control.Geolocation.prototype.addPosition=function(e,t,r,n,a,o,i){var s=Math.round(e[0]),l=Math.round(e[1]),p=B.call(this);if(this.parent.layerTracking.features&&p){var c=p.geometry.length>0&&p.geometry[p.geometry.length-1];if(c&&0==c.length){this.parent.layerTracking.features[0].geometry.push([s,l,i,r]);p.wrap.feature.getGeometry().appendCoordinate([s,l,i,r])}else{var u=Math.round(c[0]),f=Math.round(c[1]);if(s!=u||l!=f){this.parent.layerTracking.features[0].geometry.push([s,l,i,r]);p.wrap.feature.getGeometry().appendCoordinate([s,l,i,r])}}TC.Util.storage.setSessionLocalValue(this.parent.Const.LocalStorageKey.TRACKINGTEMP,this.formattedToStorage(this.parent.layerTracking).features)}this.parent.trigger(this.parent.Const.Event.STATEUPDATED,{moving:null!=t&&null!=n&&n>0&&t>0})};TC.wrap.control.Geolocation.prototype.positionChangehandler=function(e){const t=this;var r,n,a,o,i;B.call(this)||t.parent.setTracking(!1);return new Promise(function(s,l){if(e&&e.coords){t.parent.layerGPS.clearFeatures();r=e.coords.accuracy/t.parent.map.getMetersPerUnit()||0;n=e.coords.heading||e[2]||0;a=e.coords.speed?3.6*e.coords.speed:0;o=e.coords.altitude||0;i=e.coords.altitudeAccuracy||0;if(t.parent.layerTracking){var p=[e.coords&&e.coords.longitude||e[0],e.coords&&e.coords.latitude||e[1]],c=TC.Util.reproject(p,"EPSG:4326",t.parent.map.crs);t.addPosition(c,n,(new Date).getTime(),a,r,i,o);var u=B.call(t).geometry,f=u.length;f>=2&&(t.parent.deltaMean=(u[f-1][3]-u[0][3])/(f-1));t.parent.trigger(t.parent.Const.Event.POSITIONCHANGE,{pd:{position:c,altitude:o,accuracy:r,heading:TC.Util.radToDeg(n),speed:a}});Promise.all([t.parent.layerGPS.addPoint(c,{radius:4,fillColor:"#00CED1",fillOpacity:1,strokeColor:"#ffffff",strokeWidth:2,showsPopup:!1}),t.parent.layerGPS.addCircle([c,r],{strokeColor:"#00CED1",strokeWidth:.4,fillColor:"#ffffff",fillOpacity:.2,showsPopup:!1})]).then(function(e){const r=e[0],n=e[1];t.parent.geopositionTracking=!0;if(0==t.parent.firstPosition){t.parent.firstPosition=!0;if(!t.parent.trackCenterButton){t.parent.trackCenterButton=t.parent.div.querySelector("."+t.parent.CLASS+"-track-center");t.parent.trackCenterButton.querySelector("button").addEventListener("click",function(){t.parent.layerGPS.map.zoomToFeatures(t.parent.layerGPS.features);t.parent.track.infoPanel.isVisible()||t.parent.track.infoPanel.doVisible();t.parent.track.infoPanel.isMinimized()&&t.parent.track.infoPanel.maximize()});var a=t.parent.map.getControlsByClass("TC.control.ControlContainer")[0];a?t.parent.trackCenterButton=a.addElement({position:a.POSITION.LEFT,htmlElement:t.parent.trackCenterButton}):t.parent.map.div.appendChild(t.parent.trackCenterButton)}t.parent.trackCenterButton.classList.remove(TC.Consts.classes.HIDDEN);t.parent.layerGPS.map.zoomToFeatures(t.parent.layerGPS.features)}s({marker:r,accuracy:n})})}else s(null)}else s(null)})};TC.wrap.control.Geolocation.prototype.setTracking=function(t){var r=this;if(t){r.parent.firstPosition=!1;var n,a=[];if(r.parent.sessionTracking){var o=(new TC.wrap.parser.JSON).parser.readFeatures(r.parent.sessionTracking);o&&r.parent.storageCRS!==r.parent.map.crs&&(o=o.map(function(e){var t=e.clone();t.getGeometry().transform(r.parent.storageCRS,r.parent.map.crs);return t}));var i=o.filter(function(e){var t=e.getGeometry().getType().toLowerCase();"point"===t&&a.push(e);return"linestring"===t||"multilinestring"===t})[0].getGeometry().getCoordinates();n=new e.Feature({geometry:new e.geom.LineString(i,"XYZM"),tracking:!0})}else n=new e.Feature({geometry:new e.geom.LineString([],"XYZM"),tracking:!0});n&&TC.wrap.Feature.createFeature(n).then(function(e){r.parent.layerTracking.addFeature(e);e.geometry.length>1&&r.parent.map.zoomToFeatures(r.parent.layerTracking.features);a.length>0&&Promise.all(a.map(function(e){return TC.wrap.Feature.createFeature(e)})).then(function(e){e&&e.forEach(function(e){r.parent.layerTracking.addFeature(e)})});r.parent.currentPositionWaiting=r.parent.getLoadingIndicator().addWait();r.currentPositionTrk||(r.currentPositionTrk=[]);var t,n=0,o=0,i=!1,s={enableHighAccuracy:!0,timeout:6e5};t=setInterval(function e(a){var l=n++;navigator.geolocation.getCurrentPosition(function(e){clearInterval(t);r.parent.getLoadingIndicator().removeWait(r.parent.currentPositionWaiting);r.positionChangehandler(e).then(function(e){1==r.parent.geopositionTracking&&e&&e.marker&&e.accuracy&&r.currentPositionTrk.push(navigator.geolocation.watchPosition(r.positionChangehandler.bind(r),r.parent.onGeolocateError.bind(r.parent),s))})},a||function(n){switch(n.code){case n.TIMEOUT:if(o>10){clearInterval(t);r.parent.onGeolocateError.call(r.parent,n)}else{o++;e(function(){clearInterval(t);if(!i){i=!0;r.parent.onGeolocateError.call(r.parent,n)}})}break;default:clearInterval(t);r.parent.onGeolocateError.call(r.parent,n)}},{timeout:5e3+l,maximumAge:10,enableHighAccuracy:!0})},1e3);setTimeout(function(){if(r.parent.layerTracking&&r.parent.layerTracking.features&&r.parent.layerTracking.features.length>0&&0==r.parent.layerTracking.features[0].geometry.length){clearInterval(t);r.parent.getLoadingIndicator().removeWait(r.parent.currentPositionWaiting);r.map.toast(r.parent.getLocaleString("geo.error.permission_denied"),{type:TC.Consts.msgType.WARNING});r.parent.track.activateButton.classList.remove(TC.Consts.classes.HIDDEN);r.parent.track.deactivateButton.classList.add(TC.Consts.classes.HIDDEN)}},s.timeout+1e3)})}else{r.parent.firstPosition=!1;if(r.currentPositionTrk){r.currentPositionTrk=r.currentPositionTrk instanceof Array?r.currentPositionTrk:[r.currentPositionTrk];r.currentPositionTrk.forEach(function(e){navigator.geolocation.clearWatch(e)});r.currentPositionTrk=[]}r.parent.trackCenterButton&&r.parent.trackCenterButton.classList.add(TC.Consts.classes.HIDDEN)}};TC.wrap.control.Geolocation.prototype.activateSnapping=function(){if(!TC.Util.detectMobile()){this.olMap.on([c,p],this._snapTrigger);this.olMap.on(g,this._postcomposeTrigger)}};TC.wrap.control.Geolocation.prototype.deactivateSnapping=function(){var e=this;e.parent.map.wrap.getMap().then(function(t){if(!TC.Util.detectMobile()){t.un([c,p],e._snapTrigger);t.un(g,e._postcomposeTrigger)}e.snapInfo&&t.removeOverlay(e.snapInfo);e.snapInfoElement&&(e.snapInfoElement.style.display="none");if(e.snapLine){delete e.snapLine;t.render()}})};TC.wrap.control.Geolocation.prototype.clear=function(e){e&&e.clearFeatures();attachedDTD=!1;this.deactivateSnapping.call(this)};TC.wrap.control.Geolocation.prototype.duringTrackSnap=function(t){var r=t.vectorContext;if(r&&this.snapLine){"function"==typeof r.setFillStrokeStyle&&r.setFillStrokeStyle(null,new e.style.Stroke({color:"rgba(197, 39, 55, 1)",width:1}));"function"==typeof r.drawGeometry&&r.drawGeometry(this.snapLine.wrap.feature.getGeometry())}};TC.wrap.control.Geolocation.prototype.endSnap=function(){var e=this;e.parent.map.wrap.getMap().then(function(t){e.snapInfo&&t.removeOverlay(e.snapInfo);e.snapInfoElement&&(e.snapInfoElement.style.display="none");e.snapLine&&delete e.snapLine})};TC.wrap.control.Geolocation.prototype.initSnap=function(t,r){var n=this;if(n.parent.layerTrack){var a=n.parent.layerTrack.wrap.layer.getSource().getClosestFeatureToCoordinate(t);if(null!==a){var o=a.getGeometry().getClosestPoint(t);const u=n.parent.map.getPixelFromCoordinate(o);if(Math.sqrt(Math.pow(r[0]-u[0],2)+Math.pow(r[1]-u[1],2))>n.parent.snappingTolerance)n.endSnap();else{var i=[t,[o[0],o[1]]];n.snapLine?n.snapLine.wrap.feature.getGeometry().setCoordinates(i):n.snapLine=new TC.feature.Polyline(i,{});n.snapInfoElement||(n.snapInfoElement=document.getElementsByClassName("tc-ctl-geolocation-track-snap-info")[0]);n.snapInfoElement.style.display="block";if(!n.snapInfo){n.snapInfo=new e.Overlay({element:n.snapInfoElement,offset:[5,18]});n.olMap.addOverlay(n.snapInfo)}null==n.snapInfo.getMap()&&n.snapInfo.setMap(n.olMap);n.snapInfo.setPosition(t);var s={};"LineString"!=a.getGeometry().getType()&&a.getKeys().indexOf("name")>-1&&(s.n=a.get("name"));var l=n.parent.map.options.locale&&n.parent.map.options.locale.replace("_","-")||void 0;s.x=n.map.wrap.isGeo()?o[0].toLocaleString(l,{minimumFractionDigits:5}):Math.round(o[0]).toLocaleString(l);s.y=n.map.wrap.isGeo()?o[1].toLocaleString(l,{minimumFractionDigits:5}):Math.round(o[1]).toLocaleString(l);n.map.wrap.isGeo()&&(s.isGeo=!0);var p=function(e){return o[e]?(Math.round(100*o[e])/100).toLocaleString(l):void 0},c=function(e){return o[e]>0?new Date(o[e]).toLocaleString(l):void 0};if(a.getGeometry().getLayout()===e.geom.GeometryLayout.XYZM){s.z=p(2);s.m=c(3)}else a.getGeometry().getLayout()===e.geom.GeometryLayout.XYZ?s.z=p(2):a.getGeometry().getLayout()===e.geom.GeometryLayout.XYM&&(s.m=c(2));s&&n.parent.getRenderedHtml(n.parent.CLASS+"-track-snapping-node",s,function(e){n.snapInfoElement.innerHTML=e})}}}n.olMap.render()};TC.wrap.control.Geolocation.prototype.drawTrackingData=function(e){const t=this;return new Promise(function(r,n){const a=[],o=(new TC.wrap.parser.JSON).parser.readFeatures(e.data);o.filter(function(e){return"linestring"===e.getGeometry().getType().toLowerCase()||"multilinestring"===e.getGeometry().getType().toLowerCase()}).forEach(function(t){t.getGeometry().setCoordinates(t.getGeometry().getCoordinates(),e.layout)});t.activateSnapping.call(t);for(var i=0,s=o.length;i<s;i++)a.push(TC.wrap.Feature.createFeature(o[i]));Promise.all(a).then(function(e){e.forEach(function(e){e&&t.parent.layerTrack.addFeature(e)});t.parent.map.zoomToFeatures(t.parent.layerTrack.features);r()})})};TC.wrap.control.Geolocation.prototype.formattedFromStorage=function(t){const r=this;if(r.parent.storageCRS!==r.parent.map.crs){var n=(new e.format.GeoJSON).readFeatures(t);if(n){n=n.map(function(e){var t=e.clone();t.getGeometry().transform(r.parent.storageCRS,r.parent.map.crs);return t});return(new e.format.GeoJSON).writeFeatures(n)}}return t};TC.wrap.control.Geolocation.prototype.formattedToStorage=function(t,r,n){var a=this,o=new TC.wrap.parser.JSON;o=o.parser;var i,s=t.wrap.layer.getSource().getFeatures();s=s.map(function(t){t.getGeometry()instanceof e.geom.LineString&&(i=t.getGeometry().getLayout());r&&t.getProperties().tracking&&t.unset("tracking");if(!n&&a.parent.map.crs!==a.parent.storageCRS){var o=t.clone();o.getGeometry().transform(a.parent.map.crs,a.parent.storageCRS);return o}return t}).sort(function(t,r){return t.getGeometry()instanceof e.geom.Point&&!(r.getGeometry()instanceof e.geom.Point)?-1:r.getGeometry()instanceof e.geom.Point&&!(t.getGeometry()instanceof e.geom.Point)?2:t.getProperties().name<r.getProperties().name?-1:t.getProperties().name>r.getProperties().name?1:0});return{features:o.writeFeatures(s),layout:i}};TC.wrap.control.Geolocation.prototype.export=function(t){const r=this;return new Promise(function(n,a){r.parent.getTrackingData(t).then(function(o){if(o){var i=(new e.format.GeoJSON).readFeatures(o.data);if(0===i.length){var s=r.parent.getTrackingData(t);i=(new e.format.GeoJSON).readFeatures(s)}Promise.all(i.map(function(e){return TC.wrap.Feature.createFeature(e)})).then(e=>{n(e)})}else a()})})};var j,H,q=function(e){var t=[],r=[];if(e.length>1){4==e[0].length&&(e=e.sort(function(e,t){return e[0][3]==t[0][3]?0:e[0][3]<t[0][3]?-1:1}));for(var n=0;n<e.length;n++){for(var a=e[n],o=-1,i=1/0,s=a.getLastCoordinate(),l=n+1;l<e.length;l++){var p=e[l].getFirstCoordinate(),c=Math.hypot(s[0]-p[0],s[1]-p[1]);if(c<i){o=l;i=c}}if(t.length<e.length){if(-1==t.indexOf(n)){t.push(n);r=r.concat(a.getCoordinates())}if(-1==t.indexOf(o)){t.push(o);r=r.concat(e[o].getCoordinates())}}}return r}return e[0].getCoordinates()};TC.wrap.control.Geolocation.prototype.processImportedFeatures=function(t){for(var r=this,n=r.parent.layerTrack.wrap.layer.getSource(),a=r.parent.importedFileName,o=[],i=[],s=[],l=[],p=n.getFeatures(),c=[],u=[],f=function(e){e.getProperties().hasOwnProperty("name")&&e.getProperties().name.trim().length>0?o.push(e.getProperties().name):o.push(a)},g=0;g<p.length;g++){var m=p[g];m instanceof TC.Feature&&(m=p[g].wrap.feature);if(m.getGeometry()instanceof e.geom.Point){u.push(m.getGeometry().getCoordinates());l.push(m)}else if(m.getGeometry()instanceof e.geom.LineString){f(m);i.push(new e.Feature({geometry:new e.geom.LineString(m.getGeometry().getCoordinates(),m.getGeometry().getLayout())}));s.push(m)}else if(m.getGeometry()instanceof e.geom.MultiLineString){var y=m.clone();f(y);var d=y.getGeometry().getLineStrings(),C=q(d);i.push(new e.Feature({geometry:new e.geom.LineString(C,m.getGeometry().getLayout())}));s.push(m)}}if(c.length>0){C=q(c);i.push(new e.Feature({geometry:new e.geom.LineString(C)}))}u.length>0&&l.length==p.length&&i.push(new e.Feature({geometry:new e.geom.LineString(u)}));if(s.length>0)for(var h=0;h<s.length;h++)n.removeFeature(s[h]);if(i.length>0){var T,v=0;(function(){const e=i.map(function(e,s){return new Promise(function(e,l){T&&n.removeFeature(T);if(o.length>s){var p=o[s];(function(e,t){for(var r=[],n=e.indexOf(t);-1!=n;){r.push(n);n=e.indexOf(t,n+1);if(r.length>1)return!0}return r.length>1})(o,p)&&(p="["+(s+1)+"] "+p)}r.parent.importedFileName=p||a;T=i[s];n.addFeature(T);r.parent.saveTrack({message:r.parent.getLocaleString("geo.trk.upload.ok",{trackName:p||a}),importedFileName:p||a,notReproject:t.notReproject}).then(function(t){0==s&&(v=t);e()})})});return Promise.all(e)})().then(function(){r.parent.layerTrack.setVisibility(!1);r.parent.layerTrack.clearFeatures();r.parent.trigger(r.parent.Const.Event.IMPORTEDTRACK,{index:v});delete r.parent.importedFileName;r.parent.getLoadingIndicator().removeWait(t.wait)})}else{if(r.parent.layerTrack){r.parent.map.removeLayer(r.parent.layerTrack);r.parent.layerTrack=void 0}delete r.parent.importedFileName;r.parent.getLoadingIndicator().removeWait(t.wait);TC.alert(r.parent.getLocaleString("geo.trk.upload.error4"))}};TC.wrap.control.Geolocation.prototype.import=function(t,r,n){var a,o,i=this;if(r&&r.text){var s=i.parent.layerTrack.wrap.createVectorSource({data:r.text,type:n});a=s.source;o=a.on("change",function(r){if("ready"==a.getState()){e.Observable.unByKey(o);i.processImportedFeatures(t)}});i.parent.layerTrack.wrap.layer.setSource(a)}else{if(i.parent.layerTrack){i.parent.map.removeLayer(i.parent.layerTrack);i.parent.layerTrack=void 0}delete i.parent.importedFileName;i.parent.getLoadingIndicator().removeWait(t);TC.alert(i.parent.getLocaleString("geo.trk.upload.error4"))}};TC.wrap.control.Geolocation.prototype.simulateTrackEnd=function(){this.parent.chartProgressClear();if(this.simulateMarker){window.cancelAnimationFrame(j);this.simulateMarker.layer.wrap.layer.getSource().getFeatures().length>0&&this.simulateMarker.layer.removeFeature(this.simulateMarker);delete this.simulateMarker}};TC.wrap.control.Geolocation.prototype.simulateTrack=function(){for(var t,r=this,n=r.parent.layerTrack.wrap.layer.getSource().getFeatures(),a=0;a<n.length;a++)if(n[a].getGeometry()instanceof e.geom.LineString){t=n[a].getGeometry().getCoordinates();break}if(t&&t.length>0){var o=t[0];new Promise(function(e,t){if(r.simulateMarker){r.simulateMarker.setCoords(o.slice(0,2));e(r.simulateMarker)}else r.parent.layerTrack.addPoint(o.slice(0,2),{radius:7,fillColor:"#ff0000",fillOpacity:.5,strokeColor:"#ffffff",strokeWidth:2}).then(function(t){e(t)})}).then(function(n){r.simulateMarker=n;var a=function(){t.length;var n,a=!1;const o=function(e){return r.parent.map.crs!==r.parent.map.options.utmCrs?TC.Util.reproject(e,r.parent.map.crs,r.parent.map.options.utmCrs):e};var i=t;if(4==i[0].length&&i[0][3]>0){n=i[0][3];i[i.length-1][3];a=!0}else{i[0][3]=Date.now();for(var s=1;s<i.length;s++){i[s][3]=0;u=s+1<i.length?new e.geom.LineString(o(i.slice(s-1,s+1))).getLength():new e.geom.LineString(o(i.slice(s-1))).getLength();i[s][3]=i[s-1][3]+36e5*u/r.parent.walkingSpeed}n=i[0][3];i[i.length-1][3]}var l=new e.geom.LineString(i),p=n,c=0;c=r.parent.map.crs!==r.parent.map.options.utmCrs?new e.geom.LineString(o(JSON.parse(JSON.stringify(i)))).getLength():l.getLength();var u=0,f=function(){if(!r.parent.simulate_paused){var t=l.getCoordinateAtM(p),n=function(t){for(var r=0;r<i.length;r++)if(i[r][3]>t)return{d:new e.geom.LineString(o(i.slice(0,r))).getLength(),p:i[r-1].slice(0,2)}}(p);if(!t||!n){var s=r.parent.getSelectedTrack();s&&r.parent.uiSimulate(!1,s);r.parent.hasElevation&&r.parent.chartProgressClear();r.simulateTrackEnd();return}r.parent.hasElevation&&r.parent.chartSetProgress(n,t,c,!!a&&r.parent._getTime(i[0][3],t[3]));if(r.simulateMarker){var u=r.simulateMarker.getCoords(),g=t;Math.atan2(g[1]-u[1],g[0]-u[0]),Math.PI;r.simulateMarker.setCoords(t)}1!==r.parent.simulate_speed?p+=r.parent.delta*r.parent.simulate_speed:p+=r.parent.delta}j=requestAnimationFrame(f)};j=requestAnimationFrame(f)};new Promise(function(e,t){window.d3?e():TC.loadJS(!window.d3,[TC.Consts.url.D3C3],function(){e()})}).then(function(){j=requestAnimationFrame(a)})})}};TC.wrap.control.Geolocation.prototype.headingChangehandler=function(e){var t=this;if(!t.parent.track.infoOnMap){t.parent.track.infoOnMap=document.createElement("div");const e=t.parent.track.infoOnMap.style;e.overFlowY="scroll";e.height="200px";e.width="200px";e.top="0";e.left="100px";e.backgroundColor="fuchsia";e.position="absolute";t.parent.map.div.appendChild(t.parent.track.infoOnMap)}t.parent.track.infoOnMap.style.display="";t.heading=e.target.getHeading();t.parent.track.infoOnMap.innerHTML=t.parent.track.infoOnMap.innerHTML+"<br> <p> salta headingChangehandler </p> <br> <p> evt.target.getHeading(): "+t.heading+" </p>";t.map.wrap.getMap().then(function(e){e.getView().setRotation(-t.heading)});t.parent.trigger(t.parent.Const.Event.STATEUPDATED,{moving:null!=heading&&heading>0})};TC.wrap.control.Geolocation.prototype.orientationChangehandler=function(e){var t=this.map.wrap.map.getView(),r=t.getCenter(),n=t.getResolution(),a=e.target.getBeta()||0,o=e.target.getGamma()||0;r[0]-=n*o*25;r[1]+=n*a*25;t.setCenter(t.constrainCenter(r));this.parent.trigger(this.parent.Const.Event.STATEUPDATED,{moving:null!=heading&&heading>0})};TC.wrap.control.Geolocation.prototype.pulsate=function(t){this.pulsated=!0;var r,n=t.wrap.feature.getGeometry().getRadius(),a=(new Date).getTime();r=this.olMap.on(g,function(o){var i=o.vectorContext,s=o.frameState,l=s.time-a,p=t.wrap.feature.getGeometry().clone(),c=function(e){switch(!0){case e<=50:return n;case e>50&&e<=100:return 1.02*n;case e>100&&e<=150:return 1.05*n;case e>150&&e<=200:return 1.02*n;case e>200&&e<=300:return n;case e>300&&e<=350:return 1.02*n;case e>350&&e<=400:return 1.05*n;case e>400&&e<=450:return 1.02*n;case e>450&&e<=500:return 1*n;default:return n}}(l);p.setRadius(c);i.setFillStrokeStyle(new e.style.Fill({color:"rgba(0, 0, 0, 0.1)"}),new e.style.Stroke({color:"rgba(255, 0, 0, .8)",width:1}));i.drawCircleGeometry(p);l>500?e.Observable.unByKey(r):s.animate=!0})};TC.wrap.control.ResultsPanel.prototype.register=function(e){const t=this;t.map=e;e.wrap.getMap().then(function(e){t.olMap=e})};TC.wrap.control.ResultsPanel.prototype.showElevationMarker=function(t){const r=this,n=(t=t||{}).data,a=t.layer,o=t.coords;if(!r.elevationMarker){const t=document.createElement("div");t.style.display="none";t.classList.add("tc-ctl-geolocation-trackMarker","elevation");r.elevationMarker=new e.Overlay({element:t,offset:[0,-11],positioning:e.OverlayPositioning.CENTER_CENTER,stopEvent:!1})}if(a.getVisibility()&&a.getOpacity()>0){r.elevationMarker.getElement().style.display="";r.olMap.addOverlay(r.elevationMarker);r.elevationMarker.setPosition(o[n[0].index])}};TC.wrap.control.ResultsPanel.prototype.hideElevationMarker=function(){this.elevationMarker&&(this.elevationMarker.getElement().style.display="none")};TC.wrap.control.Coordinates.prototype.coordsActivate=function(){this.olMap.on(p,this._coordsTrigger)};TC.wrap.control.Coordinates.prototype.coordsDeactivate=function(){this.olMap.un(p,this._coordsTrigger)};TC.wrap.Parser=function(){};TC.wrap.Parser.prototype.read=function(e){var t=[];if(this.parser){TC.Feature||TC.syncLoadJS(TC.apiLocation+"TC/Feature");t=this.parser.readFeatures(e).map(function(e){return new TC.Feature(null,{id:e.getId(),data:e.getProperties()})})}return t};TC.wrap.parser={WFS:function(t){this.parser=new e.format.WFS(t)},JSON:function(t){this.parser=new e.format.GeoJSON(t)}};TC.inherit(TC.wrap.parser.WFS,TC.wrap.Parser);TC.inherit(TC.wrap.parser.JSON,TC.wrap.Parser);TC.wrap.control.OverviewMap.prototype.register=function(t){var r=this;r.parent.layer.wrap.getLayer().then(function(n){r.ovMap=new e.control.OverviewMap({target:r.parent.div,collapsed:!1,collapsible:!1,className:r.parent.CLASS+" ol-overviewmap",layers:[n]});r.ovMap._wrap=r;r.ovMap.getOverviewMap().pixelRatio_=1;r.ovMap.ovmap_.removeOverlay(r.ovMap.boxOverlay_);var a=document.createElement("DIV");a.className="ol-overviewmap-box";a.style.boxSizing="border-box";r.ovMap.boxOverlay_=new e.Overlay({position:[0,0],positioning:e.OverlayPositioning.BOTTOM_LEFT,element:a});r.ovMap.ovmap_.addOverlay(r.ovMap.boxOverlay_);r.manageSize.call(r.ovMap.ovmap_);r._boxElm=r.ovMap.boxOverlay_.getElement();TC.loadJS(!window.Draggabilly,[TC.apiLocation+TC.Consts.url.DRAGGABILLY],function(){var e=r.ovMap.ovmap_;const n=new Draggabilly(r._boxElm);n.positionDrag=function(){const e=this.element.style,t="translate3d( "+this.dragPoint.x+"px, "+this.dragPoint.y+"px, 0)";if(e.transform.length){const r=e.transform.indexOf("translate3d");if(r>=0){const n=e.transform.indexOf(")",r);e.transform=e.transform.replace(e.transform.substring(r,n+1),t)}else e.transform=t+" "+e.transform}else e.transform=t};n.on("pointerDown",function(a){n.dragged=r._boxElm.cloneNode();n.dragged.classList.add(TC.Consts.classes.ACTIVE);n.dragged.style.position="absolute";r._boxElm.insertAdjacentElement("beforebegin",n.dragged);if(t.maxExtent){var o=e.getPixelFromCoordinate([t.maxExtent[0],t.maxExtent[1]]),i=e.getPixelFromCoordinate([t.maxExtent[2],t.maxExtent[3]]),s=e.getSize();const r=document.createElement("div");r.style.position="absolute";r.style.bottom=Math.round(s[1]-o[1])+"px";r.style.left=Math.round(o[0])+"px";r.style.top=Math.round(i[1])+"px";r.style.right=Math.round(s[0]-i[0])+"px";const a=e.getViewport();a.insertBefore(r,a.firstElementChild);n.options.containment=r}});n.on("pointerUp",function(r){n.dragged.parentElement.removeChild(n.dragged);if(t.maxExtent){e.getViewport().removeChild(n.options.containment);n.options.containment=null}});n.on("dragMove",function(e,t,r){n._delta=r});n.on("dragEnd",function(a,o){var i=r.ovMap.getMap().getView(),s=e.getPixelFromCoordinate(i.getCenter()),l=e.getCoordinateFromPixel([s[0]+n._delta.x,s[1]+n._delta.y]),p=t.getExtent(),c=(p[2]-p[0])/2,u=(p[3]-p[1])/2;l[0]+c>t.maxExtent[2]?l[0]=t.maxExtent[2]-c:l[0]-c<t.maxExtent[0]&&(l[0]=t.maxExtent[0]+c);l[1]+u>t.maxExtent[3]?l[1]=t.maxExtent[3]-u:l[1]-u<t.maxExtent[1]&&(l[1]=t.maxExtent[1]+u);n.setPosition(0,0);delete n._delta;t.setCenter(l,{animate:!0})})});t.wrap.getMap().then(function(e){r.reset();const t=r.parent.div.querySelector("."+r.parent.CLASS+"-load");n._wrap.$events.on(TC.Consts.event.BEFORETILELOAD,function(){t.classList.remove(TC.Consts.classes.HIDDEN);t.classList.add(TC.Consts.classes.VISIBLE)});n._wrap.$events.on(TC.Consts.event.TILELOAD,function(){t.classList.remove(TC.Consts.classes.VISIBLE);t.classList.add(TC.Consts.classes.HIDDEN)});e.addControl(r.ovMap);r.parent.isLoaded=!0;r.parent.trigger(TC.Consts.event.MAPLOAD)})})};TC.wrap.control.OverviewMap.prototype.reset=function(t){const r=this;return new Promise(function(n,a){const o=function(t,a){if(t.type===TC.Consts.layerType.WMTS){var o={crs:a||r.parent.map.crs,oldCrs:t.wrap.layer.getSource().getProjection().getCode()};o.oldCrs!==o.crs&&t.setProjection(o)}t.wrap.getLayer().then(function(a){var o=new e.View(P(r.parent.map.wrap,a._wrap.parent));if(o.getResolutions()){o.setResolution(o.getResolutions().filter(function(e){return e>o.getResolutionForExtent(r.parent.map.getExtent(),s.getSize())}).reverse()[0]);s.setView(o)}else o.getProjection().getCode()!==s.getView().getProjection().getCode()&&s.setView(o);a._wrap.$events.one(TC.Consts.event.TILELOAD,function(){s.getLayers().getArray()[0].getSource().refresh()});if(t!==r.parent.layer||-1===s.getLayers().getArray().indexOf(t)){r.parent.map.trigger(TC.Consts.event.OVERVIEWBASELAYERCHANGE,{oldLayer:t!==r.parent.layer?r.parent.layer:null,newLayer:t});s.getLayers().forEach(function(t){(t instanceof e.layer.Image||t instanceof e.layer.Tile)&&s.removeLayer(t)});const n=r.parent.div.querySelector("."+r.parent.CLASS+"-load");a._wrap.$events.on(TC.Consts.event.BEFORETILELOAD,function(){n.classList.remove(TC.Consts.classes.HIDDEN);n.classList.add(TC.Consts.classes.VISIBLE)});a._wrap.$events.on(TC.Consts.event.TILELOAD,function(){n.classList.remove(TC.Consts.classes.VISIBLE);n.classList.add(TC.Consts.classes.HIDDEN)});s.getLayers().insertAt(0,a)}n(t)})};var i=(t=t||{}).layer||r.parent.layer;if(r.parent.map&&i&&r.ovMap){var s=r.ovMap.ovmap_;i.getCapabilitiesPromise().then(function(){var e=i;i.isCompatible(r.parent.map.crs)||0!==i.wrap.getCompatibleMatrixSets(r.parent.map.crs).length?o(i):(i=i.getFallbackLayer()||r.parent.defaultLayer).getCapabilitiesPromise().then(function(){r.parent.map.on3DView&&!i.isCompatible(r.parent.map.crs)?r.parent.map.loadProjections({crsList:e.getCompatibleCRS(),orderBy:"name"}).then(function(t){o(e,t[0].code)}):i.isCompatible(r.parent.map.crs)&&o(i)})})}})};TC.wrap.control.OverviewMap.prototype.get3DCameraLayer=function(){var t=null;if(this.ovMap){(r=this.ovMap.getOverviewMap()).getLayers().forEach(function(e){"3DCamera"===e.get("id")&&(t=e)});if(!t){var r=this.ovMap.getOverviewMap(),n=N({});n[0].getFill().setColor([0,0,0,0]);t=new e.layer.Vector({id:"3DCamera",source:new e.source.Vector,style:n});r.addLayer(t)}}return t};TC.wrap.control.OverviewMap.prototype.draw3DCamera=function(t){if(this.parent.map.isLoaded){this.is3D=!!t;var r=this.get3DCameraLayer();if(r){var n,a=(t=t||{}).fov,o=r.getSource();if(a&&a.length){var i=o.getFeatures();if(i.length)n=i[0];else{n=new e.Feature;o.addFeature(n)}n.setGeometry(new e.geom.Polygon([a]))}else o.clear();var s="number"==typeof t.heading?t.heading:0;this._boxElm.style.transform="rotate("+s+"rad)"}}};TC.wrap.control.OverviewMap.prototype.enable=function(){if(this.parent.layer&&this.parent.layer.setVisibility){this.parent.layer.setVisibility(!0);this.parent.wrap.ovMap.ovmap_.updateSize();const e=document.createEvent("HTMLEvents");e.initEvent("resize",!1,!1);this.parent.map.div.dispatchEvent(e)}};TC.wrap.control.OverviewMap.prototype.disable=function(){this.parent.layer&&this.parent.layer.setVisibility&&this.parent.layer.setVisibility(!1)};TC.wrap.control.OverviewMap.prototype.manageSize=function(){TC.wrap.Map.prototype.manageSize.call(this)};TC.wrap.control.FeatureInfo.prototype.register=function(e){var t=this;e.wrap.getMap().then(function(r){TC.wrap.control.Click.prototype.register.call(t,e);var n=t._trigger;t._trigger=function(r){var a=n.call(t,r);a?t.parent.beforeRequest({xy:r.pixel}):e.trigger(TC.Consts.event.NOFEATUREINFO,{control:t.parent});return a}})};var Y=function(e){var t=e.innerHTML||e.textContent;(H=H||document.createElement("textarea")).innerHTML=t;return H.value},z={readFeatures:function(t){var r=[],n=(new DOMParser).parseFromString(t,"text/xml");if("FeatureInfoResponse"===n.documentElement.tagName)for(var a=n.documentElement.getElementsByTagName("FeatureInfoCollection"),o=0,i=a.length;o<i;o++)for(var s=a[o],l=s.getAttribute("layername"),p=s.getElementsByTagName("FeatureInfo"),c=0,u=p.length;c<u;c++){for(var f=p[c].getElementsByTagName("Field"),g={},m=0,y=f.length;m<y;m++){var d=f[m];g[Y(d.getElementsByTagName("FieldName")[0])]=Y(d.getElementsByTagName("FieldValue")[0])}var C=new e.Feature(g);C.setId(l+"."+TC.getUID());r[r.length]=C}return r}},J=function(e,t,r){var n=t.getPath(r);e.layers.push({name:r,title:n[n.length-1],path:n.slice(1),features:[]})};TC.wrap.control.FeatureInfo.prototype.getFeatureInfo=function(t,r,n){var a=this,o=n||{},i=a.parent.map;i.wrap.getMap().then(function(n){var s={},l={};const p=[],c=[];var u=[],f=[];v=(v=n.getLayers().getArray()).filter(function(t){return t instanceof e.layer.Image&&t.getVisible()});for(var g=0;g<v.length;g++){var m=v[g],y=m._wrap.parent;if((S=m.getSource()).getGetFeatureInfoUrl&&i.workLayers.indexOf(y)>=0&&y.names.length>0&&(!o.serviceUrl||o.serviceUrl===y.url)){if(s[y.url]){w=s[y.url];l[y.url].source.updateParams(TC.Util.extend(l[y.url].source.getParams(),S.getParams()))}else{w={url:y.url,layers:[],mapLayers:[],title:y.title,request:null};s[y.url]=w;l[y.url]={source:TC.Util.extend(!0,{},S),layers:[]}}w.mapLayers.push(y);var d=y.getDisgregatedLayerNames();if(o.layerName){if(d.indexOf(o.layerName)>=0&&m._wrap.getInfo(o.layerName).queryable){J(w,y,o.layerName);l[y.url].layers.push(o.layerName)}}else{for(var C=0;C<d.length;C++){var h=d[C];if(m._wrap.getInfo(h).queryable)J(w,y,h);else{TC.Util.consoleRegister('Capa "'+d[C]+'" no queryable, la eliminamos de la petici\xf3n GFI');d.splice(C,1);C-=1}}d.length>0&&(l[y.url].layers=l[y.url].layers.concat(d))}}}for(var T in s){f.push(s[T]);var v,w=s[T],S=l[T].source;if(!(v=l[T].layers)||v&&0===v.length)continue;var E=S.getParams();S.params_.LAYERS=v.join(",");var L=S.getGetFeatureInfoUrl(t,r,i.crs,{QUERY_LAYERS:v.join(","),INFO_FORMAT:E.INFO_FORMAT,FEATURE_COUNT:1e3,radius:i.options.pixelTolerance,buffer:i.options.pixelTolerance}),M=L=L.replace(/sld_body=[a-zA-Z%0-9._]*/);const e={serviceUrl:T,requestedFormat:E.INFO_FORMAT,expandUrl:M};c.push(e);p.push(new Promise(function(t,r){const n=w.mapLayers[0];n.toolProxification.fetch(L).then(function(r){n.toolProxification.cacheHost.getAction(e.expandUrl).then(function(a){e.originalUrl=a.action.call(n.toolProxification,e.expandUrl);t(TC.Util.extend({},r,e))})}).catch(function(e){r(Error(e))})}));TC.Util.consoleRegister("Lanzamos GFI")}if(p.length>0)Promise.all(p).then(function(n){for(var l=!1,p=0,f=[],g=0;g<n.length;g++){var m,y=n[g],d=s[c[g].serviceUrl];l=!0;d.text=y.responseText;var C=y.contentType;C&&C.indexOf(";")>-1&&(C=C.substr(0,C.indexOf(";")).trim());C||(C=y.requestedFormat);if(C===y.requestedFormat){switch(C){case"application/json":m=new e.format.GeoJSON;break;case"application/vnd.ogc.gml":m=y.responseText.indexOf("FeatureCollection")>-1?new e.format.WFS({gmlFormat:new e.format.GML2({srsName:i.crs})}):new e.format.WMSGetFeatureInfo;break;case"application/vnd.ogc.gml/3.1.1":m=new e.format.GML3({srsName:i.crs});break;case"application/vnd.esri.wms_featureinfo_xml":m=z;break;default:m=null}if(m){var h;try{h=m.readFeatures(y.responseText,{featureProjection:e.proj.get(i.crs)})}catch(e){TC.error(a.parent.getLocaleString("featureInfo.error.badResponse",{url:y.serviceUrl})+": "+e.message);h=[];continue}p+=h.length;for(var T=function(e,t,r){var n=!1;if(t===r)n=!0;else{var a=e.getNodePath(t),o=e.getNodePath(r);if(a.length>0&&o.length>=a.length){n=!0;for(var i=0;i<a.length;i++)if(e.wrap.getName(a[i])!==e.wrap.getName(o[i])){n=!1;break}}}return n},v={},w=0;w<h.length;w++){var S=h[w];if(S instanceof e.Feature){for(var E=S.getId()||TC.getUID(),L=!1,M=E.substr(0,E.lastIndexOf(".")),P=0;P<d.layers.length;P++){var R=d.layers[P],x=R.name.substr(R.name.indexOf(":")+1);if(d.mapLayers.some(function(e){return T(e,x,M)})){L=!0;if(!o.featureId||S.getId()===o.featureId){u.push(TC.wrap.Feature.createFeature(S,{showsPopup:!1}));f.push(R.features)}break}}if(!L){var _;if(v[M])_=v[M];else{_={name:M,title:M,path:[M],features:[]};v[M]=_;d.layers.push(_)}if(!o.featureId||S.getId()===o.featureId){u.push(TC.wrap.Feature.createFeature(S,{showsPopup:!1}));f.push(_.features)}}}}}else{var I={name:"layer"+TC.getUID(),title:"Datos en el punto",features:[]};d.layers[d.layers.length]=I;I.features[0]={rawUrl:y.originalUrl,expandUrl:y.expandUrl,rawContent:y.responseText,rawFormat:C};p+=1}}else{TC.Util.consoleRegister("Respuesta GFI: lo m\xe1s probable es que el servidor est\xe9 devolviendo una excepci\xf3n");TC.Util.consoleRegister("Lanzamos los eventos que corresponde y mostramos tostada");a.parent.responseError({message:y.responseText,status:y.status});i.toast(a.parent.getLocaleString("featureInfo.error"),{type:TC.Consts.msgType.ERROR})}}if(l){var O=u;u.length&&(O=O.concat(new Promise(function(e,t){TC.loadJS(!TC.Geometry,TC.apiLocation+"TC/Geometry",function(){e()})})));Promise.all(O).then(function(e){var n;e.forEach(function(e,r){if(e){e.attributes=[];for(var o in e.data){var i=e.data[o];"object"!=typeof i?e.attributes.push({name:o,value:"number"==typeof i?i.toLocaleString(TC.Util.getMapLocale(a.parent.map)):i}):e.attributes.push({name:o,value:i})}!n&&TC.Geometry.isInside(t,e.geometry)&&(n=e);f[r].push(e)}});var o=[];for(var i in s)s.hasOwnProperty(i)&&o.push(s[i]);a.parent.responseCallback({coords:t,resolution:r,services:o,featureCount:p,defaultFeature:n})})}},function(e,n,o){if(f&&0==f.length)for(var l in s)f.push(s[l]);a.parent.responseCallback({coords:t,resolution:r,services:f,featureCount:0});i.toast(a.parent.getLocaleString("featureInfo.error"),{type:TC.Consts.msgType.ERROR})});else{i.workLayers.filter(function(e){return e instanceof TC.layer.Raster}).length>0&&i.toast(a.parent.getLocaleString("featureInfo.notQueryableLayers"),{type:TC.Consts.msgType.INFO});if(f&&0==f.length)for(var T in s)f.push(s[T]);i.on(TC.Consts.event.BEFOREFEATUREINFO,function(){a.parent.responseCallback({coords:t,resolution:r,services:f,featureCount:0})});a.parent.responseCallback({coords:t,resolution:r,services:f,featureCount:0})}})};TC.wrap.control.GeometryFeatureInfo.prototype.register=function(e){var t=this;e.wrap.getMap().then(function(r){TC.wrap.control.Click.prototype.register.call(t,e);var n=t._trigger;t._trigger=function(e){t.hasSuitableLayers().then(function(r){r&&(t.parent._isSearching||e.type!=p||t.parent._isDrawing||t.parent._isSearching||n.call(t,e))})}})};TC.wrap.control.GeometryFeatureInfo.prototype.hasSuitableLayers=function(){const e=this;return new Promise(function(t,r){const n=e.parent.map;var a=!1;n.wrap.getMap().then(function(e){e.getLayers().forEach(function(e){var t=e._wrap.parent;if(e.getSource().getGetFeatureInfoUrl&&n.workLayers.indexOf(t)>=0){a=!0;return!1}});t(a)})})};TC.wrap.control.GeometryFeatureInfo.prototype.beginDraw=function(t){var r=this,n=(t=t||{}).xy,a=t.layer,o=t.callback,i=t.geometryType,s=!1;if(r.drawCtrl){r.drawCtrl.setActive(!0);r.drawCtrl.startDrawing_({coordinate:n})}else a.wrap.getLayer().then(function(t){var a;switch(i){case TC.Consts.geom.POLYLINE:a=e.geom.GeometryType.LINE_STRING;break;default:a=e.geom.GeometryType.POLYGON}r.drawCtrl=new e.interaction.Draw({source:t.getSource(),type:a,style:t.getStyle()});var l=function(e){e.parent.showsPopup=!1};t.getSource().on(m,function(e){e.feature._wrap?l(e.feature._wrap):e.feature._wrapPromise.then(l)});r.drawCtrl.handleEvent=function(t){if(t.type==p){var r=a===e.geom.GeometryType.POLYGON?this.sketchCoords_[0]:this.sketchCoords_;s&&2==r.length&&null!==this.sketchFeature_?this.addToDrawing_(t):s=!0}return e.interaction.Draw.prototype.handleEvent.call(this,t)};const c=r.parent.map.wrap.map;c.addInteraction(r.drawCtrl);r.drawCtrl.on("drawstart",function(t){r.parent._isDrawing=!0;c.getInteractions().forEach(function(t,r){t instanceof e.interaction.DoubleClickZoom&&t.setActive(!1)})});r.drawCtrl.startDrawing_({coordinate:n});r.drawCtrl.on("drawend",function(n){r.parent._isDrawing=!1;c.getInteractions().forEach(function(t,r){t instanceof e.interaction.DoubleClickZoom&&t.setActive(!1)});c.removeInteraction(r.drawCtrl);this.setActive(!1);r.drawCtrl=null;t.getSource().clear();r.parent._drawToken=!0;setTimeout(function(){r.parent._drawToken=!1},500);o&&TC.wrap.Feature.createFeature(n.feature,{showsPopup:!1}).then(function(e){o(e)})})})};TC.wrap.control.GeometryFeatureInfo.prototype.cancelDraw=function(e,t,r){if(this.drawCtrl&&this.parent._isDrawing){this.parent._isDrawing=!1;this.drawCtrl.setActive(!1);this.drawCtrl.source_.clear()}};const X=function(e,t,r){return new Promise(async function(n,a){try{var o=await e.describeFeatureType(t)}catch(e){a(e);return}var i={};if(1===t.length){var s={};s[t[0]]=o;o=s}for(var l in o){let e;var p=[];for(var c in o[l])!TC.Util.isGeometry(o[l][c].type)||o[l][c].nillable||o[l][c].minOccurs||p.push(c);if(p.length<=1){var u=(e,t)=>{if(e instanceof TC.filter.LogicalNary)e.conditions.forEach(e=>{u(e,t)});else if(e instanceof TC.filter.Spatial){e.geometryName=t;return e}};e=Object.assign(new r.constructor,u(r,0===p.length?null:p[0]))}else if(p.length>1){u=((e,t)=>{if(e instanceof TC.filter.LogicalNary)e.conditions.forEach(e=>{u(e,t)});else if(e instanceof TC.filter.Spatial)return TC.filter.or.apply(null,t.reduce((t,r)=>{t.push(new(TC.filter[e.getTagName()])(r,e.geometry,e.srsName));return t},[]))});e=Object.assign(new r.constructor,u(r,p))}i[l]=e}n(i)})};var K=function(e,t,r,n){const a=[];var o={};const i=function(e){const t=e.mapLayers[0];return e.title||e.mapLayers.reduce(function(e,t){return e||t.title},"")||t.tree&&t.tree.title||t.capabilities.Service.Title},s=e.wrap.map,l=function(){return!n||r!==TC.Consts.mimeType.JSON&&r!==TC.Consts.mimeType.KML?e.getCRS():TC.Consts.SRSDOWNLOAD_GEOJSON_KML},p=function(e,t){return new Promise(function(r){n?r({url:e.url,data:t}):function(e,t){return new Promise(function(r){e.mapLayer.toolProxification.fetch(e.url,{data:t,contentType:"application/xml",type:"POST"}).then(function(e){if(e instanceof XMLDocument){const t=e.querySelector("ExceptionReport Exception");if(t){r({errors:[{key:TC.Consts.WFSErrors.INDETERMINATE,params:{err:t.getAttribute("exceptionCode"),errorThrown:t.querySelector("ExceptionText").textContent}}]});return}}r({response:e})}).catch(function(e){r({errors:[{key:TC.Consts.WFSErrors.INDETERMINATE,params:{err:e.name,errorThrown:e.message}}]})})})}(e,t).then(function(e){if(e.errors&&e.errors.length>0){e.errors[0].params.serviceTitle=service.mapLayers.reduce(function(e,t){return e||t.title},"")||i(service);r(e)}else r(e)})})};s.getLayers().forEach(function(s){var c=s._wrap.parent;if(!s.getVisible()||e.workLayers.indexOf(c)<0||c.type!==TC.Consts.layerType.WMS)return;var u=c.getDisgregatedLayerNames()||c.availableNames;const f=c.url.toLowerCase();var g=o[f];g||(g=o[f]={url:f,layers:[],mapLayers:[c],layerNames:[]});for(var m=0;m<u.length;m++){var y=u[m];if(c.wrap.getInfo(y).queryable){g.layerNames.push(y);var d=c.getPath(y);g.layers.push({name:y,title:d[d.length-1],path:d.slice(1),features:[]})}}if(0!=g.layerNames.length&&void 0===g.request){g.request=g.request||c.getWFSCapabilities();a.push(new Promise(function(e,a){g.request.then(function(a){var s=null,c=[];for(var u in o)o[u].request&&o[u].request==g.request&&(s=o[u]);var f=null,m=s.layerNames;if(m instanceof Array&&m.length)if(void 0!==a.Operations.GetFeature){for(var y=[],d=0;d<m.length;d++){for(var C=m[d];"_"===C[C.length-1];)C=C.substring(0,C.lastIndexOf("_"));if(a.FeatureTypes.hasOwnProperty(C.substring(m[d].indexOf(":")+1)))y.indexOf(C)<0&&y.push(C);else{var h=s.mapLayers[0].getPath(C.substring(m[d].indexOf(":")+1));c.push({key:TC.Consts.WFSErrors.LAYERS_NOT_AVAILABLE,params:{serviceTitle:i(s),layerName:h[h.length-1]}})}}if(0!=y.length){a.Operations.GetFeature.CountDefault&&(f=a.Operations.GetFeature.CountDefault.DefaultValue);if("1.0.0"===a.version&&!a.Operations.GetFeature.Operations.hasOwnProperty("Query")||("2.0.0"===a.version||"1.1.0"===a.version)&&a.Operations.QueryExpressions.indexOf("wfs:Query")<0){c.push({key:TC.Consts.WFSErrors.QUERY_NOT_AVAILABLE,params:{serviceTitle:i(s)}});e({errors:c})}else{u=a.Operations.GetFeature.DCPType?a.Operations.GetFeature.DCPType[1].HTTP.Post.onlineResource:a.Operations.GetFeature.DCP.HTTP.Post.href;Promise.all([X(s.mapLayers[0],y,t)]).then(function(t){var o,g,m,y=t[0];f?(o=f,g={url:u,mapLayer:s.mapLayers[0]},m=TC.Util.WFSQueryBuilder(y,null,a,r,!0,l()),new Promise(function(e){g.mapLayer.toolProxification.fetchXML(g.url,{data:m,contentType:"application/xml",type:"POST"}).then(function(t){if(t instanceof XMLDocument){const r=t.querySelector("ExceptionReport Exception");if(r){e({errors:[{key:TC.Consts.WFSErrors.INDETERMINATE,params:{err:r.getAttribute("exceptionCode"),errorThrown:r.querySelector("ExceptionText").textContent}}]});return}}var r=parseInt(t.querySelector("FeatureCollection").getAttribute("numberMatched")||t.querySelector("FeatureCollection").getAttribute("numberOfFeatures"),10);isNaN(r)||r>parseInt(o,10)?e({errors:[{key:TC.Consts.WFSErrors.MAX_NUM_FEATURES}]}):e(0!==r?r:{errors:[{key:TC.Consts.WFSErrors.NO_FEATURES}]})}).catch(function(t){e({errors:[{key:TC.Consts.WFSErrors.INDETERMINATE,params:{err:t.name,errorThrown:t.message}}]})})})).then(function(t){if(t.errors&&t.errors.length>0){switch(t.errors[0].key){case TC.Consts.WFSErrors.INDETERMINATE:t.errors[0].params.serviceTitle=s.mapLayers.reduce(function(e,t){return e||t.title},"")||i(s);break;case TC.Consts.WFSErrors.MAX_NUM_FEATURES:t.errors[0].params={limit:f,serviceTitle:i(s)};break;case TC.Consts.WFSErrors.NO_FEATURES:t.errors[0].params={serviceTitle:i(s)}}e(t)}else p({url:u,mapLayer:s.mapLayers[0]},TC.Util.WFSQueryBuilder(y,null,a,n?r:TC.Consts.mimeType.JSON,!1,l())).then(function(t){e(Object.assign({service:s,errors:c},t))})}):p({url:u,mapLayer:s.mapLayers[0]},TC.Util.WFSQueryBuilder(y,null,a,n?r:TC.Consts.mimeType.JSON,!1,l())).then(function(t){e(Object.assign({service:s,errors:c},t))})}).catch(function(t){e({errors:[{key:TC.Consts.WFSErrors.INDETERMINATE,params:{err:t.name,errorThrown:t.message,serviceTitle:i(s)}}]})})}}else{c.push({key:TC.Consts.WFSErrors.NO_VALID_LAYERS,params:{serviceTitle:i(s)}});e({errors:c})}}else{c.push({key:TC.Consts.WFSErrors.GETFEATURE_NOT_AVAILABLE,params:{serviceTitle:i(s)}});e({errors:c})}},function(t){var r=null;for(var n in o)o[n].request&&o[n].request===g.request&&(r=o[n]);e({errors:[{key:TC.Consts.WFSErrors.GETCAPABILITIES,params:{err:t.name,serviceTitle:i(r)}}]})})}))}});return a};TC.WFSGetFeatureBuilder=K;var Z=function(t,r,n){var a,o=n;o&&o.indexOf(";")>-1&&(o=o.substr(0,o.indexOf(";")).trim());o||(o=r.requestedFormat);switch(o){case"application/json":a=new e.format.GeoJSON;break;case"application/vnd.ogc.gml":a=r.responseText.indexOf("FeatureCollection")>-1?new e.format.WFS({gmlFormat:new e.format.GML2({srsName:t.crs})}):new e.format.WMSGetFeatureInfo;break;case"application/vnd.ogc.gml/3.1.1":a=new e.format.GML3({srsName:t.crs});break;case"text/xml":case"application/xml":const n=r.querySelector("ServiceException");n&&TC.error(n);a=null;break;default:a=null}return a?a.readFeatures(r,{featureProjection:e.proj.get(t.crs)}):null},Q=function(t,r){for(var n=[],a=[],o=function(e,t,r){var n=!1;if(t===r||0===t.indexOf(r))n=!0;else{var a=e.getPath(t),o=e.getPath(r);if(a.length>0&&o.length>=a.length){n=!0;for(var i=0;i<a.length;i++)if(a[i]!==o[i]){n=!1;break}}}return n},i={},s=0;s<t.length;s++){var l=t[s];if(l instanceof e.Feature){for(var p=l.getId()||TC.getUID(),c=!1,u=p.substr(0,p.lastIndexOf(".")),f=0;f<r.layers.length;f++){var g=r.layers[f],m=g.name.substr(g.name.indexOf(":")+1);if(r.mapLayers.some(function(e){return o(e,m,u)})){c=!0;n.push(TC.wrap.Feature.createFeature(l));a[l.id_]=g.features;break}}if(!c){var y;if(i[u])y=i[u];else{y={name:u,title:u,features:[]};i[u]=y;r.layers.push(y)}n.push(TC.wrap.Feature.createFeature(l));a.push(l.id_)}}}return new Promise(function(e,t){Promise.all(n).then(function(t){t.forEach(function(e){e.attributes=[];for(var t in e.data){var r=e.data[t];e.attributes.push({name:t,value:r})}a[e.id].push(e)});e({service:r})})})};TC.wrap.control.GeometryFeatureInfo.prototype.getFeaturesByGeometry=function(t,r){var n=this,a=n.parent.map;n.parent.filterFeature=t;t.layer=n.parent.filterLayer;a.wrap.getMap().then(function(o){var i=t.wrap.feature.getGeometry(),s=i.stride,l=i.getFlatCoordinates();if(!r){for(var p=null,c=1,u=l.length;c<u;c+=s)(!p||p[1]<l[c])&&(p=[l[c-1],l[c]]);r=o.getPixelFromCoordinate(new e.geom.Point(p).getCoordinates())}n.parent.beforeRequest({xy:r});var f=K(a,new TC.filter.intersects(t,a.crs),TC.Consts.format.JSON);const g=[];Promise.all(f).then(function(e){for(var t=[],o=0,i=0;i<e.length;i++){const r=e[i];if(r){g[g.length]=new Promise(function(e,t){if(r.errors&&r.errors.length){for(var o=0;o<r.errors.length;o++){var i,s=TC.Consts.msgType.WARNING;!0;var l=r.errors[o];switch(l.key){case TC.Consts.WFSErrors.MAX_NUM_FEATURES:i=n.parent.getLocaleString("wfs.tooManyFeatures",l.params);break;case TC.Consts.WFSErrors.GETCAPABILITIES:i=n.parent.getLocaleString("wfsGFI.inValidService",l.params);break;case TC.Consts.WFSErrors.NO_FEATURES:!1;continue;case TC.Consts.WFSErrors.INDETERMINATE:i=n.parent.getLocaleString("wfs.IndeterminateError");TC.error("Error:{error} \r\n Descripcion:{descripcion} \r\n Servicio:{serviceName}".format({error:l.params.err,descripcion:l.params.errorThrown,serviceName:l.params.serviceTitle}),TC.Consts.msgErrorMode.CONSOLE);s=TC.Consts.msgType.ERROR;break;default:i=n.parent.getLocaleString("wfsGFI."+l.key,l.params)}a.toast(i,{type:s})}r.response||e()}});var s=r.response?Z(a,r.response.responseText,r.response.contentType):[];g[g.length-1]=Q(s,r.service);r.service&&t.push(r.service);o+=s.length}}Promise.all(g).then(function(){n.parent.responseCallback({xy:r||null,services:t,featureCount:o})})},function(e){n.parent.responseCallback({})})})};TC.wrap.control.Popup.prototype=function(){this.popup=null};TC.Consts.event.PANANIMATIONSTART="pananimationstart.tc";TC.Consts.event.PANANIMATIONEND="pananimationend.tc";TC.wrap.control.Popup.prototype.fitToView=function(){var t=this,r=t.parent.map,n=t.parent.map.wrap.map,a=t.parent.popupDiv.getBoundingClientRect(),o=r.div.getBoundingClientRect(),i=n.getCoordinateFromPixel([a.left-o.left,a.top-o.top]),s=n.getCoordinateFromPixel([a.right-o.left,a.bottom-o.top]),l=i[0],p=i[1],c=s[0],u=[l,s[1],c,p],f=r.getExtent();if(!e.extent.containsExtent(f,u)){var g={left:Math.max(f[0]-u[0],0),bottom:Math.max(f[1]-u[1],0),right:Math.max(u[2]-f[2],0),top:Math.max(u[3]-f[3],0)};if(t.parent.dragged){var m=t.popup.getPosition();g.right?m[0]=m[0]-g.right:g.left&&(m[0]=m[0]+g.left);g.top?m[1]=m[1]-g.top:g.bottom&&(m[1]=m[1]+g.bottom);var y=n.getPixelFromCoordinate(m);y[1]=n.getSize()[1]-y[1];t.parent._previousContainerPosition=y;(t.popup._oldUpdatePixelPosition||t.popup.updatePixelPosition).call(t.popup,m)}else if(t.parent.isVisible()){var d=n.getView(),C=d.getCenter().slice();g.top?C[1]+=g.top:g.bottom&&(C[1]-=g.bottom);g.right?C[0]+=g.right:g.left&&(C[0]-=g.left);d.animate({center:C,easing:function(e){0===e&&t.parent.map.trigger(TC.Consts.event.PANANIMATIONSTART);1===e&&t.parent.map.trigger(TC.Consts.event.PANANIMATIONEND);return e}})}}};TC.wrap.control.Popup.prototype.setDragged=function(t){var r=this.popup;if(t){if(!r._oldUpdatePixelPosition){r._oldUpdatePixelPosition=r.updatePixelPosition;r.updatePixelPosition=function(){}}if(!r._newHandleOffsetChanged){r._newHandleOffsetChanged=function(){this._oldUpdatePixelPosition()};e.events.unlisten(r,e.Object.getChangeEventType("offset"),r.handleOffsetChanged,r);e.events.listen(r,e.Object.getChangeEventType("offset"),r._newHandleOffsetChanged,r)}}else{const t=r.getElement().parentElement.style;t.setProperty("top",r.rendered.top_);t.setProperty("bottom",r.rendered.bottom_);t.setProperty("left",r.rendered.left_);t.setProperty("right",r.rendered.right_);delete this.parent._previousContainerPosition;if(r._oldUpdatePixelPosition){r.updatePixelPosition=r._oldUpdatePixelPosition;delete r._oldUpdatePixelPosition}if(r._newHandleOffsetChanged){e.events.unlisten(r,e.Object.getChangeEventType("offset"),r._newHandleOffsetChanged,r);e.events.listen(r,e.Object.getChangeEventType("offset"),r.handleOffsetChanged,r);delete r._newHandleOffsetChanged}}};TC.wrap.Feature.prototype.getLegend=function(){var t={},r=ne(this.feature,!0);if(r){var n=r.getImage();if(n){if(n instanceof e.style.Icon){t.src=n.getSrc();var a=n.getScale();if(a){t.scale=a;var o=n.getImage();if(o.width){t.width=o.width*a;t.height=o.height*a}}}else n instanceof e.style.Circle&&(t.src=n.canvas_.toDataURL());if(this.parent.options.radius)t.height=t.width=2*this.parent.options.radius;else{t.width=t.width||this.parent.options.width;t.height=t.height||this.parent.options.height}}else{var i=r.getStroke(),s=r.getFill();if(i){var l=i.getColor();l&&(t.strokeColor=e.color.asString(l));var p=i.getWidth();p&&(t.strokeWidth=p)}if(s){var c=s.getColor();c&&(t.fillColor=e.color.asString(c))}}}return t};var ee=function(t){const r=new e.Feature;t&&r.setGeometryName(t);return r};TC.wrap.Feature.prototype.createPoint=function(e,t){const r=this;r.feature=ee(t.geometryName);r.feature._wrap=r;r.parent.setCoords(e);TC.Util.hasStyleOptions(t)&&r.feature.setStyle(N({styles:{point:t}},r.feature));r.setData(r.parent.data)};TC.wrap.Feature.prototype.createMarker=function(e,t){const r=this;var n=TC.Util.getPointIconUrl(t);if(n){t.url=n;r.feature=ee(t.geometryName);r.feature._wrap=r;r.parent.setCoords(e);TC.Util.hasStyleOptions(t)&&r.feature.setStyle(N({styles:{marker:t}},r.feature));r.setData(r.parent.data)}else r.createPoint(e,t)};TC.wrap.Feature.prototype.createPolyline=function(e,t){const r=this;r.feature=ee(t.geometryName);r.feature._wrap=r;r.parent.setCoords(e);TC.Util.hasStyleOptions(t)&&r.feature.setStyle(N({styles:{line:t}},r.feature));r.setData(r.parent.data)};TC.wrap.Feature.prototype.createPolygon=function(e,t){const r=this;t=t||{};r.feature=ee(t.geometryName);r.feature._wrap=r;r.parent.setCoords(e);TC.Util.hasStyleOptions(t)&&r.feature.setStyle(N({styles:{polygon:t}},r.feature));r.setData(r.parent.data)};TC.wrap.Feature.prototype.createMultiPolyline=function(e,t){const r=this;r.feature=ee(t.geometryName);r.feature._wrap=r;r.parent.setCoords(e);TC.Util.hasStyleOptions(t)&&r.feature.setStyle(N({styles:{line:t}},r.feature));r.setData(r.parent.data)};TC.wrap.Feature.prototype.createMultiPolygon=function(e,t){const r=this;t=t||{};r.feature=ee(t.geometryName);r.feature._wrap=r;r.parent.setCoords(e);TC.Util.hasStyleOptions(t)&&r.feature.setStyle(N({styles:{polygon:t}},r.feature));r.setData(r.parent.data)};TC.wrap.Feature.prototype.createCircle=function(t,r){const n=this;n.feature=ee(r.geometryName);n.feature._wrap=n;n.parent.setCoords(t);r&&n.feature.setStyle(new e.style.Style({stroke:new e.style.Stroke({color:r.strokeColor,width:r.strokeWidth,lineDash:r.lineDash}),fill:new e.style.Fill({color:M(r.fillColor,r.fillOpacity)})}));n.setData(n.parent.data)};TC.wrap.Feature.createFeature=function(t,r){t._featurePromise||(t._featurePromise=new Promise(function(n,a){var o=t.getGeometry();(r=r||{}).id=t.getId();let i,s=t.getStyle();s&&TC.Util.extend(r,W(s,t));switch(!0){case o instanceof e.geom.Point:TC.Util.isFunction(s)&&(s=s(t));for(var l=s?Array.isArray(s)?s:[s]:[],p=0,c=l.length;p<c;p++)if((s=l[p]).getImage()instanceof e.style.Icon){i="Marker";break}i=i||"Point";break;case o instanceof e.geom.LineString:i="Polyline";break;case o instanceof e.geom.Polygon:i="Polygon";break;case o instanceof e.geom.MultiLineString:i="MultiPolyline";break;case o instanceof e.geom.MultiPolygon:i="MultiPolygon"}i?TC.loadJS(!TC.feature||!TC.feature[i],[TC.apiLocation+"TC/feature/"+i],function(){const e=new TC.feature[i](t,r);e.data=e.wrap.getData();n(e)}):TC.loadJS(!TC.Feature,[TC.apiLocation+"TC/Feature"],function(){var e=new TC.Feature(t,r);e.data=e.wrap.getData();n(e)})}));return t._featurePromise};TC.wrap.Feature.prototype.cloneFeature=function(){return this.feature.clone()};TC.wrap.Feature.prototype.getStyle=function(){var t={},r=this.feature.getStyle();TC.Util.isFunction(r)&&(r=r(this.feature));var n=r?Array.isArray(r)?r:[r]:[];const a=function(e,t){if(e){const r=e.getFill();if(r){t.fillColor=r.getColor();Array.isArray(t.fillColor)&&(t.fillOpacity=t.fillColor[3])}}},o=function(e,t){if(e){const r=e.getStroke();if(r){t.strokeColor=r.getColor();t.strokeWidth=r.getWidth()}}};for(var i=0,s=n.length;i<s;i++){a(r=n[i],t);o(r,t);const s=r.getImage();if(s instanceof e.style.Icon){t.url=s.getSrc();const e=s.getSize(),r=s.getScale()||1;if(e){t.width=e[0]*r;t.height=e[1]*r}var l=s.getAnchor();if(l){t.anchor=[l[0]*r,l[1]*r];if(e){t.anchor[0]=t.anchor[0]/t.width;t.anchor[1]=t.anchor[1]/t.height}}}else{a(s,t);o(s,t)}var p=r.getText();if(p){t.label=p.getText();var c=p.getFont();c&&(t.fontSize=parseInt(c.match(/\d+pt/))||.75*parseInt(c.match(/\d+px/)));var u=p.getRotation();u&&(t.angle=-180*u/Math.PI);t.labelOffset=[p.getOffsetX(),p.getOffsetY()];fill=p.getFill();fill&&(t.fontColor=fill.getColor());stroke=p.getStroke();if(stroke){t.labelOutlineColor=stroke.getColor();t.labelOutlineWidth=stroke.getWidth()}}}TC.Util.extend(this.parent.options,t);return t};TC.wrap.Feature.prototype.getGeometry=function(){var t;if(this.feature&&this.feature.getGeometry){var r=this.feature.getGeometry();r&&(r.getCoordinates?t=r.getCoordinates():r instanceof e.geom.Circle&&(t=[r.getCenter(),r.getRadius()]))}return t};TC.wrap.Feature.prototype.setGeometry=function(t){const r=this;if(r.feature&&r.feature.getGeometry){var n,a,o,i,s,l,p,c,u=r.feature.getGeometry();switch(!0){case TC.feature.MultiPolygon&&r.parent instanceof TC.feature.MultiPolygon:l=!0;n=e.geom.MultiPolygon;s=t;Array.isArray(s)&&(i=t[0]);case TC.feature.Polygon&&r.parent instanceof TC.feature.Polygon||TC.feature.MultiPolyline&&r.parent instanceof TC.feature.MultiPolyline:p=!0;n=n||(TC.feature.Polygon&&r.parent instanceof TC.feature.Polygon?e.geom.Polygon:e.geom.MultiLineString);i=l?i:t;Array.isArray(i)&&(o=i[0]);case TC.feature.Polyline&&r.parent instanceof TC.feature.Polyline:c=!0;n=n||e.geom.LineString;o=p?o:t;Array.isArray(o)&&(a=o[0]);case TC.feature.Point&&r.parent instanceof TC.feature.Point:n=n||e.geom.Point;a=c?a:t;if(Array.isArray(a)&&"number"==typeof a[0]&&"number"==typeof a[1]){switch(a.length){case 3:f=e.geom.GeometryLayout.XYZ;break;case 4:f=e.geom.GeometryLayout.XYZM;break;default:f=e.geom.GeometryLayout.XY}if(u)u.setCoordinates(t,f);else{u=new n(t,f);r.feature.setGeometry(u)}}break;case TC.feature.Circle&&r.parent instanceof TC.feature.Circle:if(Array.isArray(t)&&Array.isArray(t[0])&&"number"==typeof t[0][0]&&"number"==typeof t[0][1]&&"number"==typeof t[1]){var f;switch(t[0].length){case 3:f=e.geom.GeometryLayout.XYZ;break;case 4:f=e.geom.GeometryLayout.XYZM;break;default:f=e.geom.GeometryLayout.XY}if(u)u.setCenterAndRadius(t[0],t[1],f);else{u=new e.geom.Circle(t[0],t[1],f);r.feature.setGeometry(u)}}}}};TC.wrap.Feature.prototype.getId=function(){var e;this.feature&&(e=this.feature.getId());return e};TC.wrap.Feature.prototype.setId=function(e){this.feature&&this.feature.setId(e)};const te=function(t,r){const n=this;var a=0;t.getLinearRings().forEach(function(t){coordinates=t.getCoordinates();r.crs&&(coordinates=TC.Util.reproject(coordinates,n.parent.layer.map.crs,r.crs));const o=new e.geom.Polygon([coordinates]).getLinearRing(0);a+=e.geom.flat.linearRingLength(o.flatCoordinates,0,o.flatCoordinates.length,o.stride)});return a},re=function(t,r){const n=this;coordinates=t.getCoordinates();r.crs&&(coordinates=TC.Util.reproject(coordinates,n.parent.layer.map.crs,r.crs));return new e.geom.LineString(coordinates).getLength()};TC.wrap.Feature.prototype.getLength=function(t){const r=this;t=t||{};var n=0;const a=r.feature.getGeometry();switch(!0){case a instanceof e.geom.Polygon:n=te.call(r,a,t);break;case a instanceof e.geom.LineString:n=re.call(r,a,t);break;case a instanceof e.geom.MultiPolygon:a.getPolygons().forEach(function(e){n+=te.call(r,e,t)});break;case a instanceof e.geom.MultiPolygon:a.getLineStrings().forEach(function(e){n+=re.call(r,e,t)})}return n};TC.wrap.Feature.prototype.getArea=function(t){const r=this;t=t||{};const n=r.feature.getGeometry();var a;if(n instanceof e.geom.Polygon){a=n.getLinearRing(0).getCoordinates();t.crs&&(a=TC.Util.reproject(a,r.parent.layer.map.crs,t.crs));return new e.geom.Polygon([a]).getArea()}};const ne=function(t,r){var n=t.getStyle();TC.Util.isFunction(n)&&(n=n(t));Array.isArray(n)&&(n=n.reduce(function(e,t){e.fill_=t.fill_||e.fill_;e.image_=t.image_||e.image_;e.stroke_=t.stroke_||e.stroke_;e.text_=t.text_||e.text_;return e},new e.style.Style));if(!n&&!r){n=new e.style.Style;t.setStyle(n)}return n};TC.wrap.Feature.prototype.setStyle=function(t){const r=this.feature;if(null===t){r.setStyle(null);return}const n=this.parent,a=r.getGeometry();let o,i=r.getStyle();n.layer&&(o=function(t){var r=this.getStyle();TC.Util.isFunction(r)&&(r=r(t));Array.isArray(r)&&(r=r[r.length-1]);r||(r=new e.style.Style);return r}.call(n.layer.wrap.layer,n.wrap.feature));i||(i=o?o.clone():new e.style.Style);TC.Util.isFunction(i)&&(i=i(r));Array.isArray(i)||(i=[i]);let s=i[i.length-1];if(a instanceof e.geom.Point||a instanceof e.geom.MultiPoint){var l;if(t.anchor||t.url||t.cssClass){l=s.getImage();const r={};if(l instanceof e.style.Icon){r.src=t.url||TC.Util.getBackgroundUrlFromCss(t.cssClass)||l.getSrc();t.width&&t.height?r.size=[k(t.width,n),k(t.height,n)]:r.size=l.getSize();r.anchor=k(t.anchor,n);if(!r.anchor){const e=l.getAnchor();Array.isArray(e)&&(r.anchor=e.map(function(e,t){return e/r.size[t]}))}}else{r.src=TC.Util.getPointIconUrl(t);r.anchor=k(t.anchor,n);r.size=[k(t.width,n),k(t.height,n)]}t.angle&&(r.angle=t.angle);l=new e.style.Icon(r)}else if(!s.getImage()&&s.getText())void 0!==t.label&&t.label.length?s.setText(D(t,n)):s.setText();else{(l=s.getImage())||(l=new e.style.Circle);const r={radius:k(t.radius,n)||(k(t.height,n)+k(t.width,n))/4};isNaN(r.radius)&&(r.radius=l.getRadius());t.fillColor?r.fill=new e.style.Fill({color:M(k(t.fillColor,n),k(t.fillOpacity,n))}):r.fill=l.getFill();r.stroke=l.getStroke();const a=o&&o.getStroke();if(t.strokeColor||t.strokeWidth){r.stroke||(r.stroke=new e.style.Stroke);if(t.strokeColor)r.stroke.setColor(k(t.strokeColor,n));else{const e=r.stroke.getColor()||a&&a.getColor()||TC.Cfg.styles.point.strokeColor;r.stroke.setColor(k(e,n))}if(t.strokeWidth)r.stroke.setWidth(k(t.strokeWidth,n));else{const e=r.stroke.getWidth()||a&&a.getWidth()||TC.Cfg.styles.point.strokeWidth;r.stroke.setWidth(k(e,n))}}l=new e.style.Circle(r)}s.setImage(l)}else{var p=s.getStroke(),c=!1;p||(p=new e.style.Stroke);if(t.strokeColor){p.setColor(k(t.strokeColor,n));c=!0}if(t.strokeWidth){p.setWidth(k(t.strokeWidth,n));c=!0}if(t.lineDash){p.setLineDash(t.lineDash);c=!0}c&&s.setStroke(p);if((a instanceof e.geom.Polygon||a instanceof e.geom.MultiPolygon)&&(t.fillColor||t.fillOpacity)){var u=s.getFill()||new e.style.Fill;u.setColor(M(k(t.fillColor,n),k(t.fillOpacity,n)));s.setFill(u)}}void 0!==t.label&&(t.label.length?s.setText(D(t,n)):s.setText());r.setStyle(i);r.changed()};TC.wrap.Feature.prototype.toggleSelectedStyle=function(e){const t=this.feature;(void 0===e?!t._originalStyle:e)?se(t):le(t)};TC.wrap.Feature.prototype.getInnerPoint=function(t){var r,n=t||{},a=this.feature.getGeometry();const o=function(e){const t=n.clipBox;e[0]=Math.min(Math.max(e[0],t[0]),t[2]);e[1]=Math.min(Math.max(e[1],t[1]),t[3])};r=a.getFirstCoordinate();switch(a.getType()){case e.geom.GeometryType.MULTI_POLYGON:var i=0;a=a.getPolygons().reduce(function(e,t){const r=t.getArea(),n=r>i?t:e;i=r;return n});case e.geom.GeometryType.POLYGON:var s=function(e,t){for(var r=!1,n=0,a=t.length-1;n<t.length;a=n++){var o=t[n][0],i=t[n][1],s=t[a][0],l=t[a][1];i>e[1]!=l>e[1]&&e[0]<(s-o)*(e[1]-i)/(l-i)+o&&(r=!r)}return r},l=a.getCoordinates();g=l,n.clipBox&&g[0].forEach(o);r=(a=new e.geom.Polygon(l)).getInteriorPoint().getCoordinates();for(var p=a.getLinearRings(),c=1;c<p.length;c++)if(s(r,p[c].getCoordinates())){r=a.getClosestPoint(r);break}break;case e.geom.GeometryType.MULTI_LINE_STRING:var u=0;a=a.getLineStrings().reduce(function(e,t){const r=t.getLength(),n=r>u?t:e;u=r;return n});case e.geom.GeometryType.LINE_STRING:var f=[0,0];!function(e){const t=n.clipBox;if(t)for(var r=e.length-1;r>=0;r--){const n=e[r],a=n[0],o=n[1];(a<t[0]||a>t[2]||o<t[1]||o>t[3])&&e.splice(r,1)}}(l=a.getCoordinates());a=new e.geom.LineString(l);for(c=0;c<l.length;c++){f[0]+=l[c][0];f[1]+=l[c][1]}f[0]/=l.length;f[1]/=l.length;r=a.getClosestPoint(f)}var g;return r};TC.wrap.Feature.prototype.showPopup=function(t){var r=t.map;if(r){var n=this.feature;if(n){r.currentFeature=this.parent;var a=r.getExtent();this._innerCentroid=this.getInnerPoint({clipBox:a});t.contentDiv.innerHTML=this.parent.getInfo({locale:r.options.locale});t.menuDiv.innerHTML="";if(t.options.closeButton||void 0===t.options.closeButton){const e=document.createElement("div");e.classList.add(t.CLASS+"-close");e.setAttribute("title",t.getLocaleString("close"));t.menuDiv.appendChild(e);e.addEventListener(TC.Consts.event.CLICK,function(){t.hide()});t.contentDiv.classList.add(t.CLASS+"-has-btn");const r=t.contentDiv.querySelector(".tc-ctl-finfo");if(r){r.width="auto";r.height="auto"}}var o,i=this.parent.options;if(TC.Util.isEmptyObject(i)&&this.parent.layer&&this.parent.layer.options&&this.parent.layer.options.styles)switch(this.parent.CLASSNAME){case"TC.feature.Point":(i=this.parent.layer.options.styles.point)&&!TC.Util.isEmptyObject(i)||(i=this.parent.layer.options.styles.marker);break;case"TC.feature.Marker":i=this.parent.layer.options.styles.marker;break;case"TC.feature.Circle":i=this.parent.layer.options.styles.circle;break;case"TC.feature.MultiPolygon":case"TC.feature.Polygon":i=this.parent.layer.options.styles.polygon;break;case"TC.feature.MultiPolyline":case"TC.feature.Polyline":i=this.parent.layer.options.styles.line}if(i.anchor)o=k(i.anchor,this.parent);else{for(var s,l=n._wrap.parent,p=0;p<r.workLayers.length;p++){var c=r.workLayers[p];if(!c.isRaster()&&c.features.indexOf(l)>=0){s=c.wrap.styleFunction(n);break}}if(Array.isArray(s)){const t=s[0].getImage();o=!t||t instanceof e.style.Icon?[.5,0]:[.5,.5]}}const f=[0,0];if(o)if(i.height)f[1]=-(k(i.height,this.parent)||0)*o[1];else{var u=ne(n,!0);if(u){const t=u.getImage();if(t instanceof e.style.Icon){const e=t.getImageSize();e&&(f[1]=e[1]*-t.getScale())}}}t.wrap.setDragged(!1);t.wrap.popup.setOffset(f);t.wrap.popup.setPosition(this._innerCentroid);t.popupDiv.classList.add(TC.Consts.classes.VISIBLE)}else r.wrap.hidePopup(t)}};TC.wrap.Feature.prototype.isNative=function(t){return t instanceof e.Feature};TC.wrap.Feature.prototype.getPath=function(){var e=[];this.feature&&this.feature._folders&&(e=this.feature._folders);return e};TC.wrap.Feature.prototype.getBounds=function(){var e=null;if(this.feature){const t=this.feature.getGeometry();if(!t)return null;e=t.getExtent()}return e};TC.wrap.Feature.prototype.getTemplate=function(){var e=null,t=this.feature.getStyle();TC.Util.isFunction(t)&&(t=t(this.feature));if(Array.isArray(t))for(var r=0;r<t.length;r++)if(t[r]._balloon){if(t[r]._balloon.getText()){t=t[r]._balloon;break}}t&&!Array.isArray(t)&&t.getText&&(e=t.getText());return e};TC.wrap.Feature.prototype.getData=function(){var e=this.feature.getProperties();Array.isArray(e.features)&&(e=1===e.features.length?e.features[0].getProperties():e.features.length+" elementos");var t=this.feature.getGeometryName();e[t]&&delete e[t];return e};TC.wrap.Feature.prototype.setData=function(e){this.feature.setProperties(e)};TC.wrap.Feature.prototype.unsetData=function(e){this.feature.unset(e)};TC.wrap.Feature.prototype.clearData=function(){const e=this.feature,t=e.getGeometryName();e.getKeys().forEach(function(r){r!==t&&e.unset(r)})};TC.wrap.control.Draw.prototype.mouseMoveHandler=function(e){const t=this;t.sketch&&t.parent.trigger(TC.Consts.event.MEASUREPARTIAL,t.getMeasureData())};TC.wrap.control.Draw.prototype.mouseOverHandler=function(e){const t=this;if(t.sketch&&t.hoverCoordinate){t.pushCoordinate(t.hoverCoordinate);t.hoverCoordinate=null}};TC.wrap.control.Draw.prototype.clickHandler=function(e){const t=this;if(t.parent.map.view!==TC.Consts.view.PRINTING){if(t._mdPx){const r=t._mdPx[0]-e.clientX,n=t._mdPx[1]-e.clientY;if(r*r+n*n>t.interaction.squaredClickTolerance_)return}if(t.sketch){var r=t.sketch.getGeometry().getCoordinates();t.parent.trigger(TC.Consts.event.POINT,{point:r[r.length-1]})}}};TC.wrap.control.Draw.prototype.mousedownHandler=function(e){this._mdPx=[e.clientX,e.clientY]};TC.wrap.control.Draw.prototype.getMeasureData=function(){var t=this,r={units:e.proj.Units.METERS};if(this.sketch){var n=this.sketch.getGeometry();n instanceof e.geom.Polygon?function(r,n){r=new e.geom.Polygon([TC.Util.reproject(r.getLinearRing(0).getCoordinates(),t.parent.map.crs,t.parent.map.options.utmCrs)]);n.area=r.getArea();var a=r.getLinearRing(0);n.perimeter=e.geom.flat.linearRingLength(a.flatCoordinates,0,a.flatCoordinates.length,a.stride)}(n,r):n instanceof e.geom.LineString&&function(r,n){r=new e.geom.LineString(TC.Util.reproject(r.getCoordinates(),t.parent.map.crs,t.parent.map.options.utmCrs));n.length=r.getLength()}(n,r)}return r};TC.wrap.control.Draw.prototype.activate=function(t){var r,n=this;switch(t){case TC.Consts.geom.POLYGON:r=e.geom.GeometryType.POLYGON;break;case TC.Consts.geom.MULTIPOLYGON:r=e.geom.GeometryType.MULTI_POLYGON;break;case TC.Consts.geom.POINT:r=e.geom.GeometryType.POINT;break;case TC.Consts.geom.MULTIPOINT:r=e.geom.GeometryType.MULTI_POINT;break;case TC.Consts.geom.MULTIPOLYLINE:r=e.geom.GeometryType.MULTI_LINE_STRING;break;default:r=e.geom.GeometryType.LINE_STRING}n.parent.map&&Promise.all([n.parent.map.wrap.getMap(),n.parent.getLayer()]).then(function(a){const o=a[0],i=a[1];i&&i.wrap.getLayer().then(function(a){n.viewport||(n.viewport=o.getViewport());if(n.interaction){o.removeInteraction(n.interaction);if(n._mousedownHandler){n.viewport.removeEventListener("mousedown",n._mousedownHandler);n._mousedownHandler=null}if(n._clickHandler){n.viewport.removeEventListener(TC.Consts.event.CLICK,n._clickHandler);n._clickHandler=null}if(n._mouseMoveHandler&&n._mouseOverHandler){n.viewport.removeEventListener("mousemove",n._mouseMoveHandler);n.viewport.removeEventListener("mouseover",n._mouseOverHandler)}}n.snapInteraction&&o.removeInteraction(n.snapInteraction);if(t){n._mousedownHandler=n.mousedownHandler.bind(n);n._clickHandler=n.clickHandler.bind(n);n.viewport.addEventListener("mousedown",n._mousedownHandler);n.viewport.addEventListener(TC.Consts.event.CLICK,n._clickHandler);if(n.parent.measure){n._mouseMoveHandler=n.mouseMoveHandler.bind(n);n._mouseOverHandler=n.mouseOverHandler.bind(n);n.viewport.addEventListener("mousemove",n._mouseMoveHandler);n.viewport.addEventListener("mouseover",n._mouseOverHandler)}var i={type:r,snapTolerance:0,condition:function(){e.events.condition.shiftKeyOnly(arguments[0])&&(hole=o.forEachFeatureAtPixel(o.getPixelFromCoordinate(arguments[0].coordinate),function(t){return e.geom.GeometryType.POLYGON==t.getGeometry().getType()||e.geom.GeometryType.MULTI_POLYGON==t.getGeometry().getType()?t:null},{hitTolerance:v}));return n.parent.map.view!==TC.Consts.view.PRINTING||null}};a&&(i.source=a.getSource());const l=n.parent.styles||{};switch(t){case TC.Consts.geom.RECTANGLE:i.style=N({styles:{line:n.parent.styles.line}});i.type=e.geom.GeometryType.LINE_STRING;i.maxPoints=2;i.geometryFunction=function(t,r){const n=t[0],a=t[1],o=[[n,[n[0],a[1]],a,[a[0],n[1]],n]];r?r.setCoordinates(o):r=new e.geom.Polygon(o);return r};break;case TC.Consts.geom.POLYGON:case TC.Consts.geom.MULTIPOLYGON:l.polygon&&(i.style=N({styles:{polygon:l.polygon}}));break;case TC.Consts.geom.POINT:case TC.Consts.geom.MULTIPOINT:l.point&&(i.style=N({styles:{point:l.point}}));break;case TC.Consts.geom.MULTIPOLYLINE:default:l.line&&(i.style=N({styles:{line:l.line}}))}n.interaction=new e.interaction.Draw(i);n.interaction.on("drawstart",function(e){n.sketch=e.feature;n.parent.trigger(TC.Consts.event.DRAWSTART)},this);n.interaction.on("drawend",function(e){const t=e.target.overlay_.getStyle();e.feature.setStyle(Array.isArray(t)?t.map(function(e){return e.clone()}):t);n.parent.measure&&n.parent.trigger(TC.Consts.event.MEASURE,n.getMeasureData());TC.wrap.Feature.createFeature(n.sketch).then(function(e){n.parent.trigger(TC.Consts.event.DRAWEND,{feature:e});n.sketch=null})},this);n._projectionChangeHandler=function(t){!function(t,r){if(t.sketch){const a=r.oldValue.getProjection(),o=r.target.get(r.key).getProjection();if(a.getCode()!==o.getCode()){const r=t.sketch.getGeometry();r.transform(a,o);t.interaction.sketchPoint_.getGeometry().transform(a,o);const i=[];var n;n="Polygon"===t.interaction.getMode()?t.interaction.sketchCoords_[0]:t.interaction.sketchCoords_;e.geom.flat.deflateCoordinates(i,0,n,r.stride);e.proj.getTransform(a,o)(i,i,r.stride);n=e.geom.flat.inflateCoordinates(i,0,i.length,r.stride);"Polygon"===t.interaction.getMode()?t.interaction.sketchCoords_=[n]:t.interaction.sketchCoords_=n}}}(n,t)};o.on("change:view",n._projectionChangeHandler);o.addInteraction(n.interaction);if(n.parent.snapping){var s={};a?s.source=a.getSource():n.parent.snapping instanceof TC.Layer&&(s.source=n.parent.snapping.wrap.layer.getSource());n.snapInteraction=new e.interaction.Snap(s);o.addInteraction(n.snapInteraction)}}n.redoStack=[]})})};TC.wrap.control.Draw.prototype.deactivate=function(){var e=this;e.parent.map&&Promise.all([e.parent.map.wrap.getMap(),e.parent.getLayer()]).then(function(t){const r=t[0],n=t[1];if(e.viewport){if(e._mousedownHandler){e.viewport.removeEventListener("mousedown",e._mousedownHandler);e._mousedownHandler=null}if(e._clickHandler){e.viewport.removeEventListener(TC.Consts.event.CLICK,e._clickHandler);e._clickHandler=null}}n&&!e.parent.persistent&&n.clearFeatures();if(e.interaction){r.removeInteraction(e.interaction);e.interaction=null}r.un("change:view",e._projectionChangeHandler)})};TC.wrap.control.Draw.prototype.popCoordinate=function(){var t=null;if(this.interaction){var r=this.interaction.sketchFeature_;if(r){var n,a=r.getGeometry();a instanceof e.geom.Polygon?n=a.getCoordinates()[0]:a instanceof e.geom.LineString&&(n=a.getCoordinates());if(n.length>1){var o;a instanceof e.geom.Polygon?o=this.interaction.sketchCoords_[0]:a instanceof e.geom.LineString&&(o=this.interaction.sketchCoords_);var i,s=!1;if(this.interaction.sketchPoint_)for(var l=this.interaction.sketchPoint_.getGeometry().getCoordinates(),p=0;p<n.length;p++)if(n[p][0]==l[0]&&n[p][1]==l[1]){s=!0;break}t=o[i=s?o.length-2:o.length-1];o.splice(i,1);if(a instanceof e.geom.Polygon){a.setCoordinates([o]);this.interaction.sketchLine_.getGeometry().setCoordinates(o)}else a.setCoordinates(o);r.setGeometry(a)}}}return t};TC.wrap.control.Draw.prototype.pushCoordinate=function(t){var r=!1;if(this.interaction){var n=this.interaction.sketchFeature_;if(n){var a,o=n.getGeometry();o instanceof e.geom.Polygon?a=o.getCoordinates()[0]:o instanceof e.geom.LineString&&(a=o.getCoordinates());var i;o instanceof e.geom.Polygon?i=this.interaction.sketchCoords_[0]:o instanceof e.geom.LineString&&(i=this.interaction.sketchCoords_);var s=!1;if(this.interaction.sketchPoint_)for(var l=this.interaction.sketchPoint_.getGeometry().getCoordinates(),p=0;p<a.length;p++)if(a[p][0]==l[0]&&a[p][1]==l[1]){s=!0;break}index=s?i.length-1:i.length;i.splice(index,0,t);if(o instanceof e.geom.LineString)o.setCoordinates(i,e.geom.GeometryLayout.XY);else{o.setCoordinates([i],e.geom.GeometryLayout.XY);this.interaction.sketchLine_.getGeometry().setCoordinates(i)}r=!0}}return r};TC.wrap.control.Draw.prototype.undo=function(){var e=!1,t=this.popCoordinate();if(t){this.redoStack.push(t);e=!0}this.parent.trigger(TC.Consts.event.MEASUREPARTIAL,this.getMeasureData());return e};TC.wrap.control.Draw.prototype.redo=function(){var e=!1;if(this.redoStack.length>0){this.pushCoordinate(this.redoStack.pop());e=!0}this.parent.trigger(TC.Consts.event.MEASUREPARTIAL,this.getMeasureData());return e};TC.wrap.control.Draw.prototype.end=function(){this.interaction&&this.interaction.sketchFeature_&&this.interaction.finishDrawing()};TC.wrap.control.Draw.prototype.setStyle=function(e){const t=this;t.interaction&&t.interaction.overlay_.setStyle(N({styles:e}))};TC.wrap.control.CacheBuilder.prototype.getRequestSchemas=function(e){for(var t=e.extent,r=e.layers,n=new Array(r.length),a=0,o=n.length;a<o;a++){var i=r[a],s={layerId:i.id},l=i.wrap.layer.getSource();l.getUrls&&(s.url=l.getUrls()[0]);if(l.getTileGrid){for(var p=l.getTileGrid(),c=p.getResolutions(),u=p.getMatrixIds(),f=i.getLayerNodeByName(i.layerNames),g=null,m=0,y=f.TileMatrixSetLink.length;m<y;m++){var d=f.TileMatrixSetLink[m];if(d.TileMatrixSet===i.matrixSet){g=d.TileMatrixSetLimits;break}}s.tileMatrixLimits=[];m=0;for(var C=c.length;m<C;m++){var h=p.getOrigin(m),T=p.getTileSize(m),v=c[m],w=T*v,S={mId:u[m],res:v,origin:h,tSize:T,cl:Math.floor((t[0]-h[0])/w),cr:Math.floor((t[2]-h[0])/w),rt:Math.floor((h[1]-t[3])/w),rb:Math.floor((h[1]-t[1])/w)};if(g){var E=g[m];if(E){S.cl=Math.max(S.cl,E.MinTileCol);S.cr=Math.min(S.cr,E.MaxTileCol);S.rt=Math.max(S.rt,E.MinTileRow);S.rb=Math.min(S.rb,E.MaxTileRow)}}S.cl<=S.cr&&S.rt<=S.rb&&s.tileMatrixLimits.push(S)}}n[a]=s}return n};TC.wrap.control.CacheBuilder.prototype.getGetTilePattern=function(e){var t="",r=e.wrap.layer.getSource();r.getUrls&&(t=r.getUrls()[0]);if(e.options.encoding!==TC.Consts.WMTSEncoding.RESTFUL){t.indexOf("?")<0&&(t+="?");t.indexOf("?")===t.length-1&&(t=t+"layer="+e.layerNames+"&style=default&tilematrixset="+encodeURIComponent(e.matrixSet)+"&Service=WMTS&Request=GetTile&Version=1.0.0&Format="+encodeURIComponent(e.format)+"&TileMatrix={TileMatrix}&TileCol={TileCol}&TileRow={TileRow}")}return t};const ae=function(t){return new e.style.Stroke({color:"#ffffff",width:t+4})},oe=function(t){return new e.style.Stroke({color:"#000000",width:t+6})},ie=function(t){t||(t=[]);t instanceof e.style.Style&&(t=[t]);const r=(t=t.slice())[0];if(r){const a=r.getImage();var n;if(a instanceof e.style.RegularShape){n=a.getStroke().getWidth();const o=a.getRadius(),i=r.clone();i.setImage(new e.style.Circle({radius:o,stroke:ae(n)}));t.unshift(i);const s=r.clone();s.setImage(new e.style.Circle({radius:o,stroke:oe(n)}));t.unshift(s)}const o=r.getStroke();if(o){n=o.getWidth();t.unshift(new e.style.Style({stroke:ae(n)}));t.unshift(new e.style.Style({stroke:oe(n)}))}return t}return null},se=function(e){pe.call(e);e.changed()},le=function(e){e.hasOwnProperty("_originalStyle")&&e.setStyle(e._originalStyle);delete e._originalStyle},pe=function(){this.style_=function(e){let t=e._originalStyle=e._originalStyle||e.getStyle();!e._originalStyle&&e._wrap.parent.layer&&(t=e._wrap.parent.layer.wrap.layer.getStyle());t||(t=N({},e));return TC.Util.isFunction(t)?function(e,r){return ie(t(e,r))}:ie(t)}(this);this.styleFunction_=this.style_?e.Feature.createStyleFunction(this.style_):void 0};TC.wrap.control.Modify.prototype.activate=function(){const t=this;t.parent.map&&Promise.all([t.parent.map.wrap.getMap(),t.parent.layer.wrap.getLayer()]).then(function(r){const n=r[0],a=r[1];t.selectInteraction&&n.removeInteraction(t.selectInteraction);var o=new e.interaction.Select({layers:[a],hitTolerance:v});t.selectInteraction=o;n.addInteraction(o);var i=function(e){return e._wrap.parent};o.on("select",function(e){e.selected.length>0&&t.parent.trigger(TC.Consts.event.FEATURESSELECT,{ctrl:t,features:e.selected.map(i)});e.deselected.length>0&&0==e.selected.length&&t.parent.trigger(TC.Consts.event.FEATURESUNSELECT,{ctrl:t.parent,features:e.deselected.map(i)})});t.modifyInteraction&&n.removeInteraction(t.modifyInteraction);var s=new e.interaction.Modify({features:o.getFeatures()});s.on("modifyend",function(e){e.features.forEach(function(e){e._wrap.parent.geometry=e._wrap.getGeometry();t.parent.trigger(TC.Consts.event.FEATUREMODIFY,{feature:e._wrap.parent,layer:t.parent.layer})})});t.modifyInteraction=s;n.addInteraction(s);t.snapInteraction&&n.removeInteraction(t.snapInteraction);if(t.parent.snapping){t.snapInteraction=new e.interaction.Snap({source:a.getSource()});n.addInteraction(t.snapInteraction)}t._onMouseMove||(t._onMouseMove=function(e){const r=n.getViewport();var a,o=n.getEventPixel(e);a=n.forEachFeatureAtPixel(o,function(e,r){return!(!t.parent.layer||r!==t.parent.layer.wrap.layer)},{hitTolerance:v});r.style.cursor=a?"pointer":""});n.getViewport().addEventListener("mousemove",t._onMouseMove)})};TC.wrap.control.Modify.prototype.deactivate=function(){const e=this;if(e.modifyInteraction){e.modifyInteraction.setActive(!1);e.selectInteraction.setActive(!1);e.parent.map.wrap.getMap().then(function(t){t.getViewport().removeEventListener("mousemove",e._onMouseMove);t.removeInteraction(e.modifyInteraction);t.removeInteraction(e.selectInteraction);e.modifyInteraction=null;e.selectInteraction=null})}};TC.wrap.control.Modify.prototype.getSelectedFeatures=function(){var e=[];this.selectInteraction&&this.selectInteraction.getFeatures().forEach(function(t){e[e.length]=t._wrap.parent});return e};TC.wrap.control.Modify.prototype.setSelectedFeatures=function(e){if(this.selectInteraction){var t=this.selectInteraction.featureOverlay_.getSource();t.clear();t.addFeatures(e.map(function(e){return e.wrap.feature}))}};TC.wrap.control.Modify.prototype.unselectFeatures=function(e){e=e||[];const t=this,r=t.selectInteraction?t.selectInteraction.getFeatures():null;if(r){const n=[];r.getArray().slice().forEach(function(t){if(!e.length||e.indexOf(t)>=0){r.remove(t);n[n.length]=t._wrap.parent}});n.length&&t.parent.trigger(TC.Consts.event.FEATURESUNSELECT,{features:n})}};TC.wrap.control.Edit.prototype.cancel=function(e,t){this.points=[];this.histPoints=[];this.control&&this.control.layer||this.modifyInteraction&&this.modifyInteraction.layer;if(this.selectInteraction){var r=this.selectInteraction.getFeatures();this.parent.trigger(TC.Consts.event.FEATURESUNSELECT,{ctrl:this.parent,feature:r.get(0)});r.clear();this.selectInteraction.setActive(!1)}};TC.wrap.control.Edit.prototype.deleteFeatures=function(e){var t=this;if(Array.isArray(e)){var r=e.map(function(e){return e.wrap.feature});t.parent.layer.wrap.getLayer().then(function(e){for(var n=t.selectInteraction?t.selectInteraction.getFeatures():null,a=0,o=r.length;a<o;a++){var i=r[a];if(n){n.remove(i);t.parent.trigger(TC.Consts.event.FEATURESUNSELECT,{feature:i._wrap.parent})}e.getSource().removeFeature(i);t.parent.trigger(TC.Consts.event.FEATUREREMOVE,{feature:i._wrap.parent})}})}};TC.wrap.Feature.prototype.toGML=function(t,r){var n=new e.format.GML({srsName:r}).writeGeometryNode(this.feature.getGeometry()),a=n.querySelector("MultiSurface,MultiPolygon,Polygon");a&&a.querySelectorAll("Polygon,LinearRing").forEach(e=>{e.removeAttribute("srsName")});n.firstChild.setAttribute("gml:id",n.firstChild.tagName+"."+TC.getUID());return(new XMLSerializer).serializeToString(n.firstChild).replace(/\<\/?\w/gm,function(e){var t=e.indexOf("/")>0?e.indexOf("/")+1:1;return e.substring(0,t)+"gml:"+e.substring(t)})};TC.wrap.Feature.prototype.toGeoJSON=function(){return(new e.format.GeoJSON).writeGeometry(this.feature.getGeometry())};TC.wrap.Geometry.write=function(t){var r;(t=t||{}).format;t.parser=new e.format.GeoJSON;switch(t.type){case TC.Consts.geom.POLYLINE:r=new e.geom.LineString(t.coordinates);break;case TC.Consts.geom.POLYGON:r=new e.geom.Polygon(t.coordinates);break;case TC.Consts.geom.MULTIPOINT:r=new e.geom.MultiPoint(t.coordinates);break;case TC.Consts.geom.MULTIPOLYLINE:r=new e.geom.MultiLineString(t.coordinates);break;case TC.Consts.geom.MULTIPOLYGON:r=new e.geom.MultiPolygon(t.coordinates);break;case TC.Consts.geom.POINT:default:r=new e.geom.Point(t.coordinates)}return t.parser.writeGeometry(r)};TC.wrap.Geometry.toGeoJSON=function(e){return TC.wrap.Geometry.write(e)};return e});
//# sourceMappingURL=../maps/ol/ol.min.js.map