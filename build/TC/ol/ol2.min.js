window.OpenLayers||TC.syncLoadJS(TC.url.ol),function(){OpenLayers._getScriptLocation=function(){var e=OpenLayers._getScriptLocation();return e||(e=TC.url.ol.substr(0,TC.url.ol.lastIndexOf("/")+1)),function(){return e}}(),OpenLayers.CustomTheme=TC.apiLocation+"OpenLayers/theme/tcsa/style.css",OpenLayers.Util.extend(OpenLayers.Feature.Vector.style["default"],{fillColor:TC.Cfg.styles.polygon.fillColor,fillOpacity:TC.Cfg.styles.polygon.fillOpacity,strokeColor:TC.Cfg.styles.line.strokeColor,strokeWidth:TC.Cfg.styles.line.strokeWidth}),OpenLayers.Format.XML.prototype._write=OpenLayers.Format.XML.prototype.write,OpenLayers.Format.XML.prototype.write=function(){var e=OpenLayers.Format.XML.prototype._write.apply(this,arguments);return e=e.replace(new RegExp('xmlns:NS\\d+="" NS\\d+:',"g"),"")},OpenLayers.Control.PanZoom.prototype.onButtonClick=function(e){var t=e.buttonElement;switch(t.action){case"panup":this.map.pan(0,-this.getSlideFactor("h"));break;case"pandown":this.map.pan(0,this.getSlideFactor("h"));break;case"panleft":this.map.pan(-this.getSlideFactor("w"),0);break;case"panright":this.map.pan(this.getSlideFactor("w"),0);break;case"zoomin":this.map.zoomIn();break;case"zoomout":this.map.zoomOut();break;case"zoomworld":this.map.zoomToExtent(this.map.options.extent)}},OpenLayers.Control.OverviewMap.prototype._updateOverview=OpenLayers.Control.OverviewMap.prototype.updateOverview,OpenLayers.Control.OverviewMap.prototype.updateOverview=function(){var e=this;(e.active||null===e.active)&&e._updateOverview()},OpenLayers.Format.WMSGetFeatureInfo=OpenLayers.Class(OpenLayers.Format.XML,{layerIdentifier:"_layer",featureIdentifier:"_feature",regExes:{trimSpace:/^\s*|\s*$/g,removeSpace:/\s*/g,splitSpace:/\s+/,trimComma:/\s*,\s*/g},gmlFormat:null,read:function(e){var t;"string"==typeof e&&(e=OpenLayers.Format.XML.prototype.read.apply(this,[e]));var r=e.documentElement;if(r){var a=this["read_"+r.nodeName];t=a?a.call(this,r):new OpenLayers.Format.GML(this.options?this.options:{}).read(e)}else t=e;return t},read_msGMLOutput:function(e){var t=[],r=this.getSiblingNodesByTagCriteria(e,this.layerIdentifier);if(r)for(var a=0,n=r.length;n>a;++a){var o=r[a],i=o.nodeName;o.prefix&&(i=i.split(":")[1]);var i=i.replace(this.layerIdentifier,""),s=this.getSiblingNodesByTagCriteria(o,this.featureIdentifier);if(s)for(var p=0;p<s.length;p++){var l=s[p],u=this.parseGeometry(l),y=this.parseAttributes(l),c=new OpenLayers.Feature.Vector(u.geometry,y,null);c.bounds=u.bounds,c.type=i,t.push(c)}}return t},read_FeatureInfoResponse:function(e){for(var t=[],r=this.getElementsByTagNameNS(e,"*","FIELDS"),a=0,n=r.length;n>a;a++){var o,i=r[a],s=null,p={},l=i.attributes.length;if(l>0)for(o=0;l>o;o++){var u=i.attributes[o];p[u.nodeName]=u.nodeValue}else{var y=i.childNodes;for(o=0,l=y.length;l>o;++o){var c=y[o];3!=c.nodeType&&(p[c.getAttribute("name")]=c.getAttribute("value"))}}t.push(new OpenLayers.Feature.Vector(s,p,null))}return t},getSiblingNodesByTagCriteria:function(e,t){var r,a,n,o,i,s=[];if(e&&e.hasChildNodes()){r=e.childNodes,n=r.length;for(var p=0;n>p;p++){for(i=r[p];i&&1!=i.nodeType;)i=i.nextSibling,p++;a=i?i.nodeName:"",a.length>0&&a.indexOf(t)>-1?s.push(i):(o=this.getSiblingNodesByTagCriteria(i,t),o.length>0&&(0==s.length?s=o:s.push(o)))}}return s},parseAttributes:function(e){var t={};if(1==e.nodeType)for(var r=e.childNodes,a=r.length,n=0;a>n;++n){var o=r[n];if(1==o.nodeType){var i=o.childNodes,s=o.prefix?o.nodeName.split(":")[1]:o.nodeName;if(0==i.length)t[s]=null;else if(1==i.length){var p=i[0];if(3==p.nodeType||4==p.nodeType){var l=p.nodeValue.replace(this.regExes.trimSpace,"");t[s]=l}}}}return t},parseGeometry:function(e){this.gmlFormat||(this.gmlFormat=new OpenLayers.Format.GML);var t,r=this.gmlFormat.parseFeature(e),a=null;return r&&(t=r.geometry&&r.geometry.clone(),a=r.bounds&&r.bounds.clone(),r.destroy()),{geometry:t,bounds:a}},CLASS_NAME:"OpenLayers.Format.WMSGetFeatureInfo"}),OpenLayers.Format.GML.prototype._oldParseFeature=OpenLayers.Format.GML.prototype.parseFeature,OpenLayers.Format.GML.prototype.parseFeature=function(e){this.externalProjection=null;for(var t,r,a=["MultiPolygon","Polygon","MultiLineString","LineString","MultiPoint","Point","Envelope"],n=0;n<a.length;++n)if(t=a[n],r=this.getElementsByTagNameNS(e,this.gmlns,t),r.length>0){var o=r[0].getAttribute("srsName");o&&(TC.loadProjDef(o,!0),this.externalProjection=new OpenLayers.Projection("EPSG:"+o.substr(o.lastIndexOf("#")+1)));break}return this._oldParseFeature(e)},OpenLayers.Control.WMSGetFeatureInfo=OpenLayers.Class(OpenLayers.Control,{hover:!1,drillDown:!1,maxFeatures:10,clickCallback:"click",output:"features",layers:null,queryVisible:!1,url:null,layerUrls:null,infoFormat:"text/html",vendorParams:{},format:null,formatOptions:null,handler:null,hoverRequest:null,initialize:function(e){if(e=e||{},e.handlerOptions=e.handlerOptions||{},OpenLayers.Control.prototype.initialize.apply(this,[e]),this.format||(this.format=new OpenLayers.Format.WMSGetFeatureInfo(e.formatOptions)),this.drillDown===!0&&(this.hover=!1),this.hover)this.handler=new OpenLayers.Handler.Hover(this,{move:this.cancelHover,pause:this.getInfoForHover},OpenLayers.Util.extend(this.handlerOptions.hover||{},{delay:250}));else{var t={};t[this.clickCallback]=this.getInfoForClick,this.handler=new OpenLayers.Handler.Click(this,t,this.handlerOptions.click||{})}},getInfoForClick:function(e){this.events.triggerEvent("beforegetfeatureinfo",{xy:e.xy}),OpenLayers.Element.addClass(this.map.viewPortDiv,"olCursorWait"),this.request(e.xy,{})},getInfoForHover:function(e){this.events.triggerEvent("beforegetfeatureinfo",{xy:e.xy}),this.request(e.xy,{hover:!0})},cancelHover:function(){this.hoverRequest&&(this.hoverRequest.abort(),this.hoverRequest=null)},findLayers:function(){for(var e,t,r=this.layers||this.map.layers,a=[],n=r.length-1;n>=0;--n)e=r[n],e instanceof OpenLayers.Layer.WMS&&(!this.queryVisible||e.getVisibility())&&(t=OpenLayers.Util.isArray(e.url)?e.url[0]:e.url,this.drillDown!==!1||this.url||(this.url=t),(this.drillDown===!0||this.urlMatches(t))&&a.push(e));return a},urlMatches:function(e){var t=OpenLayers.Util.isEquivalentUrl(this.url,e);if(!t&&this.layerUrls)for(var r=0,a=this.layerUrls.length;a>r;++r)if(OpenLayers.Util.isEquivalentUrl(this.layerUrls[r],e)){t=!0;break}return t},buildWMSOptions:function(e,t,r,a){for(var n=[],o=[],i=0,s=t.length;s>i;i++)null!=t[i].params.LAYERS&&(n=n.concat(t[i].params.LAYERS),o=o.concat(this.getStyleNames(t[i])));var p=t[0],l=this.map.getProjection(),u=p.projection;u&&u.equals(this.map.getProjectionObject())&&(l=u.getCode());var y=OpenLayers.Util.extend({service:"WMS",version:p.params.VERSION,request:"GetFeatureInfo",exceptions:p.params.EXCEPTIONS,bbox:this.map.getExtent().toBBOX(null,p.reverseAxisOrder()),feature_count:this.maxFeatures,height:this.map.getSize().h,width:this.map.getSize().w,format:a,info_format:p.params.INFO_FORMAT||this.infoFormat},parseFloat(p.params.VERSION)>=1.3?{crs:l,i:parseInt(r.x),j:parseInt(r.y)}:{srs:l,x:parseInt(r.x),y:parseInt(r.y)});return 0!=n.length&&(y=OpenLayers.Util.extend({layers:n,query_layers:n,styles:o},y)),OpenLayers.Util.applyDefaults(y,this.vendorParams),{url:e,params:OpenLayers.Util.upperCaseObject(y),callback:function(t){this.handleResponse(r,t,e)},scope:this}},getStyleNames:function(e){var t;return t=e.params.STYLES?e.params.STYLES:OpenLayers.Util.isArray(e.params.LAYERS)?new Array(e.params.LAYERS.length):e.params.LAYERS.replace(/[^,]/g,"")},request:function(e,t){var r=this.findLayers();if(0==r.length)return this.events.triggerEvent("nogetfeatureinfo"),void OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait");if(t=t||{},this.drillDown===!1){var a=this.buildWMSOptions(this.url,r,e,r[0].params.FORMAT),n=OpenLayers.Request.GET(a);t.hover===!0&&(this.hoverRequest=n)}else{this._requestCount=0,this._numRequests=0,this.features=[];for(var o,i={},s=0,p=r.length;p>s;s++){var l=r[s];o=OpenLayers.Util.isArray(l.url)?l.url[0]:l.url,o in i?i[o].push(l):(this._numRequests++,i[o]=[l])}var r;for(var o in i){r=i[o];var a=this.buildWMSOptions(o,r,e,r[0].params.FORMAT);OpenLayers.Request.GET(a)}}},triggerGetFeatureInfo:function(e,t,r){this.events.triggerEvent("getfeatureinfo",{text:e.responseText,features:r,request:e,xy:t}),OpenLayers.Element.removeClass(this.map.viewPortDiv,"olCursorWait")},handleResponse:function(e,t,r){var a=t.responseXML;a&&a.documentElement||(a=t.responseText);var n=this.format.read(a);this.drillDown===!1?this.triggerGetFeatureInfo(t,e,n):(this._requestCount++,this._features=(this._features||[]).concat("object"===this.output?{url:r,features:n}:n),this._requestCount===this._numRequests&&(this.triggerGetFeatureInfo(t,e,this._features.concat()),delete this._features,delete this._requestCount,delete this._numRequests))},CLASS_NAME:"OpenLayers.Control.WMSGetFeatureInfo"}),OpenLayers.Format.WMSGetFeatureInfo.prototype._defaultRead_FeatureInfoResponse=OpenLayers.Format.WMSGetFeatureInfo.prototype.read_FeatureInfoResponse,OpenLayers.Format.WMSGetFeatureInfo.prototype["read_esri_wms:FeatureInfoResponse"]=function(e){for(var t=[],r=this.getElementsByTagNameNS(e,"http://www.esri.com/wms","FeatureInfoCollection"),a=0;a<r.length;a++)for(var n=r[a],o=this.getElementsByTagNameNS(n,"http://www.esri.com/wms","FeatureInfo"),i=0;i<o.length;i++){for(var s=o[i],p=null,l=this.getElementsByTagNameNS(s,"http://www.esri.com/wms","FieldName"),u=this.getElementsByTagNameNS(s,"http://www.esri.com/wms","FieldValue"),y={},c=0;c<l.length;c++){var f=l[c],h=u[c],g=void 0===f.textContent?"text":"textContent";y[f[g]]=h[g]}var d=new OpenLayers.Feature.Vector(p,y,null);d.type=n.getAttribute("layername"),t.push(d)}return t},OpenLayers.Format.WMSGetFeatureInfo.prototype.read_FeatureInfoResponse=function(e){return"http://www.esri.com/wms"===e.namespaceURI?OpenLayers.Format.WMSGetFeatureInfo.prototype["read_esri_wms:FeatureInfoResponse"].call(this,e):OpenLayers.Format.WMSGetFeatureInfo.prototype._defaultRead_FeatureInfoResponse.call(this,e)},function(){function e(e){OpenLayers.Request.XMLHttpRequest.onreadystatechange&&OpenLayers.Request.XMLHttpRequest.onreadystatechange.apply(e),e.dispatchEvent({type:"readystatechange",bubbles:!1,cancelable:!1,timeStamp:new Date+0})}function t(e){try{e.responseText=e._object.responseText}catch(t){}try{e.responseXML=fGetDocument(e._object)}catch(t){}try{e.status=e._object.status}catch(t){}try{e.statusText=e._object.statusText}catch(t){}}function r(e){e._object.onreadystatechange=new window.Function}{var a=!!window.controllers,n=window.document.all&&!window.opera;n&&window.navigator.userAgent.match(/MSIE 7.0/)}OpenLayers.Request.XMLHttpRequest.prototype.open=function(o,i,s,p,l){function u(e){var t=0!==e.indexOf("http")&&0!==e.indexOf("//"),r=!t&&e.match(this.URL_SPLIT_REGEX);if(r){var a=window.location;t=r[1]==a.protocol&&r[3]==a.hostname;var n=r[4],o=a.port;(80!=n&&""!=n||"80"!=o&&""!=o)&&(t=t&&n==o)}return t}u(i)||"withCredentials"in this._object||!window.XDomainRequest||(this._object=new window.XDomainRequest),delete this._headers,arguments.length<3&&(s=!0),this._async=s;var y,c=this,f=this.readyState;n&&s&&(y=function(){f!=OpenLayers.Request.XMLHttpRequest.DONE&&(r(c),c.abort())},window.attachEvent("onunload",y)),OpenLayers.Request.XMLHttpRequest.onopen&&OpenLayers.Request.XMLHttpRequest.onopen.apply(this,arguments),arguments.length>4?this._object.open(o,i,s,p,l):arguments.length>3?this._object.open(o,i,s,p):this._object.open(o,i,s),this.readyState=OpenLayers.Request.XMLHttpRequest.OPENED,e(this),"withCredentials"in this._object||"onreadystatechange"in this._object?this._object.onreadystatechange=function(){if(!a||s){if(c.readyState=c._object.readyState,t(c),c._aborted)return void(c.readyState=OpenLayers.Request.XMLHttpRequest.UNSENT);c.readyState==OpenLayers.Request.XMLHttpRequest.DONE&&(delete c._data,r(c),n&&s&&window.detachEvent("onunload",y)),f!=c.readyState&&e(c),f=c.readyState}}:this._object.onload=function(){(!a||s)&&(c.readyState=OpenLayers.Request.XMLHttpRequest.DONE,c._object.status=200,c._object.statusText="OK",t(c),delete c._data,n&&s&&window.detachEvent("onunload",y),c.onreadystatechange())}},OpenLayers.Request.XMLHttpRequest.prototype.setRequestHeader=function(e,t){return this._headers||(this._headers={}),this._headers[e]=t,"setRequestHeader"in this._object?this._object.setRequestHeader(e,t):("contentType"in this._object&&"Content-Type"==e,void 0)}}(),OpenLayers.Format.KML.prototype._getNodeText=function(e){var t="";return void 0!==e.textContent?t=e.textContent:void 0!==e.innerHTML?t=e.innerHTML:void 0!==e.text&&(t=e.text),t},OpenLayers.Format.KML.prototype._getFolderHierarchy=function(e){var t=[],r=e;if(r.parentNode)do if(r=r.parentNode,"folder"==r.nodeName.toLowerCase()){var a;r.childNodes&&r.childNodes.length&&r.childNodes.length>0&&("name"==r.childNodes[0].nodeName?a=this._getNodeText(r.childNodes[0]):r.childNodes.length>1&&(a=this._getNodeText(r.childNodes[1]))),a&&t.push(a)}while(null!==r.parentNode&&"document"!==r.parentNode.nodeName.toLowerCase());return t.reverse(),this._folderTree||(this._folderTree={children:[]}),TC.Util.addArrayToTree(t,this._folderTree),t},OpenLayers.Format.KML.prototype.parserTimeout=0,OpenLayers.Format.KML.prototype.parseFeatures=function(e,t){for(var r,a,n=[],o=new Date,i=0,s=e.length;s>i;i++){if(this.parserTimeout>0&&i%10===0&&i>0&&(r=new Date,a=parseInt(r.getTime()-o.getTime()),a>this.parserTimeout))throw"El archivo KML es demasiado complejo para este navegador."+a+"ms, "+i+" features";var p=e[i],l=this.parseFeature.apply(this,[p]);if(!l)throw"Bad Placemark: "+i;if(this.extractStyles&&l.attributes&&l.attributes.styleUrl&&(l.style=this.getStyle(l.attributes.styleUrl,t)),this.extractStyles){var u=this.getElementsByTagNameNS(p,"*","Style")[0];if(u){var y=this.parseStyle(u);y&&(l.style=OpenLayers.Util.extend(l.style,y))}}if(this.parseFolders&&(l._folders=this._getFolderHierarchy(p)),this.extractTracks){var c=this.getElementsByTagNameNS(p,this.namespaces.gx,"Track");if(c&&c.length>0){var f=c[0],h={features:[],feature:l};this.readNode(f,h),h.features.length>0&&n.push.apply(n,h.features)}}else n.push(l)}this.features=this.features.concat(n)},OpenLayers.Format.KML.prototype._read=OpenLayers.Format.KML.prototype.read,OpenLayers.Format.KML.prototype.read=function(e){var t=this.getChildEl(e.documentElement,"Document");if(t){var r=this.getChildEl(t,"name");r&&(this._documentName=this._getNodeText(r))}return this._read.call(this,e)},OpenLayers.Popup.Anchored.prototype.calculateRelativePosition=function(){return"tr"},OpenLayers.Control.PanZoomBar.prototype._draw=OpenLayers.Control.PanZoomBar.prototype.draw,OpenLayers.Control.PanZoomBar.prototype.draw=function(e){var t=this,r=OpenLayers.Control.PanZoomBar.prototype._draw.call(t,e);$(t.div).removeAttr("style").addClass("tc-ctl-nav");var a=$(t.buttons[0]),n=a.height();a.removeAttr("style").addClass("tc-ctl-nav-btn tc-ctl-nav-btn-zoomin");var o=(a.height()-n,$(t.zoombarDiv)),n=o.css("height");o.removeAttr("style").addClass("tc-ctl-nav-bar").css("height",n);var i=$(t.slider);return n=i.css("height"),i.removeAttr("style").addClass("tc-ctl-nav-slider").css("height",n),$(t.buttons[1]).removeAttr("style").addClass("tc-ctl-nav-btn tc-ctl-nav-btn-zoomout"),$(t.buttons[2]).removeAttr("style").addClass("tc-ctl-nav-btn tc-ctl-nav-btn-home"),r},TC.wrap.Map.prototype.setMap=function(){var e=this,t=e.parent.options;t.proxy&&(OpenLayers.ProxyHost=t.proxy),e.map=new OpenLayers.Map(e.parent.div,{projection:t.crs,extent:t.initialExtent,maxExtent:t.maxExtent,restrictedExtent:t.maxExtent,controls:[new OpenLayers.Control.Navigation({dragPanOptions:{enableKinetic:!0},pinchZoomOptions:{autoActivate:!0},zoomWheelEnabled:t.mouseWheelZoom})],theme:OpenLayers.CustomTheme}),e.map.events.register("zoomstart",e.parent,function(){e.parent.$events.trigger($.Event(TC.Consts.event.BEFOREZOOM))}),e.map.events.register("zoomend",e.parent,function(){e.parent.$events.trigger($.Event(TC.Consts.event.ZOOM))}),e.map.events.register("featureclick",e.parent,function(t){t.feature&&t.feature._wrap&&e.parent.$events.trigger($.Event(TC.Consts.event.FEATURECLICK,{feature:t.feature._wrap.parent}))}),e.map.events.register("nofeatureclick",e.parent,function(t){for(var r=0;r<e.parent.workLayers.length;r++){var a=e.parent.workLayers[r];a.wrap.layer===t.layer&&e.parent.$events.trigger($.Event(TC.Consts.event.NOFEATURECLICK,{layer:a}))}});var r;$(e.parent.div).on("resize",function(){clearTimeout(r),r=setTimeout(function(){e.map.updateSize()},200)}),e.mapDeferred.resolve(e.map)},TC.wrap.Map.prototype.insertLayer=function(e,t){for(var r=this,a=!1,n=0;n<r.map.layers.length;n++)if(r.map.layers[n]===e){a=!0;break}a||r.map.addLayer(e),r.map.setLayerIndex(e,t)},TC.wrap.Map.prototype.removeLayer=function(e){this.map.removeLayer(e)},TC.wrap.Map.prototype.getLayerCount=function(){return this.map.getNumLayers()},TC.wrap.Map.prototype.indexOfFirstVector=function(){for(var e=this,t=-1,r=0,a=e.map.layers.length;a>r;r++)if(e.map.layers[r]instanceof OpenLayers.Layer.Vector){t=r;break}return t},TC.wrap.Map.prototype.getLayerIndex=function(e){return this.map.getLayerIndex(e)},TC.wrap.Map.prototype.setLayerIndex=function(e,t){this.map.setLayerIndex(e,t)},TC.wrap.Map.prototype.setBaseLayer=function(e){var t=this,r=new $.Deferred;return t.map.addLayer(e),t.map.setBaseLayer(e),t.parent.baseLayer&&t.map.removeLayer(t.parent.baseLayer.wrap.getLayer()),r.resolve(),r},TC.wrap.Map.prototype.setExtent=function(e){this.map.updateSize(),this.map.zoomToExtent(e)},TC.wrap.Map.prototype.getExtent=function(){var e=null,t=this.map.getExtent();return t&&(e=[t.left,t.bottom,t.right,t.top]),e},TC.wrap.Map.prototype.setCenter=function(e){this.map.panTo(e)},TC.wrap.Map.prototype.getResolution=function(){return this.map.getResolution()},TC.wrap.Map.prototype.setResolution=function(e){$.when(this.getMap()).then(function(t){t.zoomTo(t.getZoomForResolution(e))})},TC.wrap.Map.prototype.getResolutions=function(){var e=[],t=this;if(t.map.resolutions)e=t.map.resolutions;else if(t.map.baseLayer&&(e=t.map.baseLayer.resolutions),!e)for(var r=0;r<t.map.layers.length&&!e;r++)e=t.map.layers[r].resolutions;return e},TC.wrap.Map.prototype.getCoordinateFromPixel=function(e){var t=this.map.getLonLatFromPixel({x:e[0],y:e[1]});return[t.lon,t.lat]},TC.wrap.Map.prototype.getPixelFromCoordinate=function(e){var t=this.map.getPixelFromLonLat({lon:e[0],lat:e[1]});return[t.x,t.y]},TC.wrap.Map.prototype.getViewport=function(){var e=new $.Deferred;return $.when(this.getMap()).then(function(t){e.resolve(t.getViewport())}),e},TC.wrap.Map.prototype.isNative=function(e){return e instanceof OpenLayers.Map},TC.wrap.Map.prototype.isGeo=function(){var e=this,t=e.map.getProjectionObject();null===t&&(t=new OpenLayers.Projection(e.map.projection));var r=t.getUnits();return"degrees"===r||!r},TC.wrap.Map.prototype.addPopup=function(e){e.$popupDiv=$("<div>")},TC.wrap.Map.prototype.hidePopup=function(e){var t=this,r=t.parent;e&&$.when(r.wrap.getMap()).then(function(t){e.wrap.popup&&r.popup===e&&(t.removePopup(e.wrap.popup),e.wrap.popup.destroy(),delete e.wrap.popup,r.popup=null)})},TC.wrap.Map.prototype.exportFeatures=function(e,t){TC.error("TC.wrap.Map.prototype.exportFeatures no implementado en OpenLayers 2")},TC.wrap.Map.prototype.enableDragAndDrop=function(e){TC.error("TC.wrap.Map.prototype.enableDragAndDrop no implementado en OpenLayers 2")},TC.wrap.Map.prototype.loadFiles=function(e){TC.error("TC.wrap.Map.prototype.loadFiles no implementado en OpenLayers 2")},TC.wrap.Layer.prototype.getVisibility=function(){var e=this,t=!1;return e.layer&&(t=e.layer.getVisibility()),t},TC.wrap.Layer.prototype.setVisibility=function(e){var t=this;$.when(t.getLayer()).then(function(t){t.setVisibility(e)})},TC.wrap.Layer.prototype.isNative=function(e){return e instanceof OpenLayers.Layer},TC.wrap.Layer.prototype.WmsParser=OpenLayers.Format.WMSCapabilities,TC.wrap.Layer.prototype.WmtsParser=OpenLayers.Format.WMTSCapabilities,TC.wrap.Layer.prototype.addCommonEvents=function(e){var t=this;e.events.register("loadstart",t.parent.map,function(){t.parent.state=TC.Layer.state.LOADING,t.parent.map&&t.parent.map.$events.trigger($.Event(TC.Consts.event.BEFORELAYERUPDATE,{layer:t.parent}))}),e.events.register("loadend",t.parent.map,function(){t.parent.state=TC.Layer.state.IDLE,t.parent.map&&t.parent.map.$events.trigger($.Event(TC.Consts.event.LAYERUPDATE,{layer:t.parent}))}),e.events.register("visibilitychanged",t.parent.map,function(){t.parent.map&&t.parent.map.$events.trigger($.Event(TC.Consts.event.LAYERVISIBILITY,{layer:t.parent}))})},TC.wrap.layer.Raster.prototype.getGetMapUrl=function(){var e=null,t=this;switch(t.getServiceType()){case TC.Consts.layerType.WMS:e=t.parent.capabilities.capability.request.getmap.href;break;case TC.Consts.layerType.WMTS:e=t.parent.capabilities.operationsMetadata.GetTile.dcp.http.get[0].url}return e},TC.wrap.layer.Raster.prototype.getInfoFormats=function(){var e=null,t=this.parent.capabilities;return t.capability&&t.capability.request.getfeatureinfo&&(e=t.capability.request.getfeatureinfo.formats),e},TC.wrap.layer.Raster.infoFormatPreference=["application/vnd.ogc.gml","application/json","application/vnd.esri.wms_featureinfo_xml","application/vnd.esri.wms_raw_xml","application/vnd.ogc.wms_xml","text/xml","text/html","text/plain"],TC.wrap.layer.Raster.prototype.getWMTSLayer=function(){var e=null,t=this,r=t.parent.capabilities;if(r&&r.contents)for(var a=0;a<r.contents.layers.length;a++)for(var n=r.contents.layers[a],o=0;o<n.tileMatrixSetLinks.length;o++)if(t.parent.options.matrixSet===n.tileMatrixSetLinks[o].tileMatrixSet){e=n;break}return e},TC.wrap.layer.Raster.prototype.getTileMatrix=function(e){var t=null,r=this,a=r.parent.capabilities;return a&&a.contents&&a.contents.tileMatrixSets[e]&&(t=_layer.capabilities.contents.tileMatrixSets[_layer.options.matrixSet].matrixIds),t},TC.wrap.layer.Raster.prototype.getScaleDenominators=function(e){var t=[],r=this;if(e.scaleDenominator?t=[e.scaleDenominator,e.scaleDenominator]:(e.minScale||e.maxScale)&&(t=[e.minScale,e.maxScale]),!t.length&&!r.getName(e)){for(var a=r.getLayerNodes(e),n=-(1/0),o=1/0,i=0,s=a.length;s>i;i++){var p=r.getScaleDenominators(a[i]);p[0]>n&&(n=p[0]),p[1]<o&&(o=p[1])}n>-(1/0)&&1/0>o&&(t=[n,o])}return t},TC.wrap.layer.Raster.prototype.getAttribution=function(e){var t=null;return e&&(t=e.serviceIdentification?e.serviceIdentification.title:e.service.title),t},TC.wrap.layer.Raster.prototype.getInfo=function(e){var t={},r=this.parent.capabilities;if(r&&r.capability)for(var a=function(e,t){var r=e.prefix.length&&0!==t.indexOf(e.prefix)?e.prefix+":"+t:t;return e.name===r},n=0;n<r.capability.layers.length;n++){var o=r.capability.layers[n];if(a(o,e)){if(o.title&&(t.title=o.title),o["abstract"]&&(t["abstract"]=o["abstract"]),o.styles.length&&(t.legend=o.styles[0].legend.href),o.metadataURLs.length){t.metadata=[];for(var i=0;i<o.metadataURLs.length;i++){var s=o.metadataURLs[i];t.metadata.push({format:s.format,type:s.type,url:s.href})}}t.queryable=o.queryable;break}}return t},TC.wrap.layer.Raster.prototype.getServiceType=function(){var e=null,t=this.parent.capabilities;return t.capability&&t.capability.request&&t.capability.request.getmap?e=TC.Consts.layerType.WMS:t.operationsMetadata&&t.operationsMetadata.GetTile&&(e=TC.Consts.layerType.WMTS),e},TC.wrap.layer.Raster.prototype.getServiceTitle=function(){var e=null,t=this.parent.capabilities;return t.capability&&t.service?e=t.service.title:t.serviceIdentification&&(e=t.serviceIdentification.title),e},TC.wrap.layer.Raster.prototype.getRootLayerNode=function(){var e,t=this;return t.getServiceType()===TC.Consts.layerType.WMS&&(e=t.parent.capabilities.capability.nestedLayers[0]),e},TC.wrap.layer.Raster.prototype.getName=function(e,t){var r=e.name;if(r&&t){var a=r.indexOf(":");a>=0&&(r=r.substr(a+1))}return r},TC.wrap.layer.Raster.prototype.getIdentifier=function(e){return e.identifier},TC.wrap.layer.Raster.prototype.getLayerNodes=function(e){var t=e.nestedLayers;return $.isArray(t)||(t=[]),t},TC.wrap.layer.Raster.prototype.normalizeLayerNode=function(e){if(e.Layer=e.nestedLayers,e.Layer)for(var t=0;t<e.Layer.length;t++)TC.wrap.layer.Raster.prototype.normalizeLayerNode(e.Layer[t]);return e.Title=e.title,e.Abstract=e["abstract"],e},TC.wrap.layer.Raster.prototype.normalizeCapabilities=function(e){return{Capability:{Exception:cap.capability.exception,Layer:cap.capability.nestedLayers[0]},Service:cap.service,version:cap.version}},TC.wrap.layer.Raster.prototype.getAllLayerNodes=function(){var e=this.parent.capabilities;switch(self.getServiceType()){case TC.Consts.layerType.WMS:return e.capability.layers;case TC.Consts.layerType.WMTS:return e.contents.layers;default:return[]}},TC.wrap.layer.Raster.prototype.getLegend=function(e){var t={},r=e.styles;if(r&&r.length){var a=r[0].legend||{};t.src=a.href}return t},TC.wrap.layer.Raster.prototype.isCompatible=function(e){var t=this,r=!1,a=t.parent;switch(t.getServiceType()){case TC.Consts.layerType.WMS:if(a.capabilities&&a.capabilities.capability&&a.capabilities.capability.layers)if(0===a.names.length)r=!0;else for(var n=a.names.slice(0),o=0;o<a.capabilities.capability.layers.length;o++){var i=a.capabilities.capability.layers[o],s=$.inArray(t.getName(i),n);if(s>=0&&(n.splice(s,1),r=i.srs[e],!r||!n.length))break}break;case TC.Consts.layerType.WMTS:var p=a.capabilities&&a.capabilities.contents&&a.capabilities.contents.tileMatrixSets[a.options.matrixSet]&&a.capabilities.contents.tileMatrixSets[a.options.matrixSet].supportedCRS,l=new RegExp("^urn:ogc:def:crs:"+e.replace(":",":.*:")+"$","g");r=p&&(l.test(p)||p===e)}return r},TC.wrap.layer.Raster.prototype.getCompatibleLayers=function(e){var t=this,r=[],a=t.parent;switch(t.getServiceType()){case TC.Consts.layerType.WMS:if(a.capabilities&&a.capabilities.capability&&a.capabilities.capability.layers)for(var n=0;n<a.capabilities.capability.layers.length;n++){var o=a.capabilities.capability.layers[n],i=t.getName(o);o.srs[e]&&i&&(r[r.length]=i)}break;case TC.Consts.layerType.WMTS:var s=a.capabilities&&a.capabilities.contents&&a.capabilities.contents.tileMatrixSets;if(s){var p=new RegExp("^urn:ogc:def:crs:"+e.replace(":",":.*:")+"$","g");for(var l in s){var u=s[l].supportedCRS;u&&(p.test(u)||u===e)&&(r[r.length]=l)}}}return r},TC.wrap.layer.Raster.prototype.createWmsLayer=function(e,t,r){var a=this,n=new OpenLayers.Layer.WMS(r&&r.id?r.id:t.LAYERS,e,t,{isBaseLayer:1==(r&&r.isBase),singleTile:!0,transitionEffect:"resize",projection:a.parent.crs,units:"m",ratio:TC.Cfg.imageRatio});return n._wrap=a,t.LAYERS.length||n.setVisibility(!1),a.addCommonEvents(n),n._originalGetURL=n.getURL,n._noGetURL=function(){return TC.Consts.BLANK_IMAGE},n.getURL=n.params.LAYERS.length>0?n._originalGetURL:n._noGetURL,n},TC.wrap.layer.Raster.prototype.createWmtsLayer=function(e,t,r){var a=(new OpenLayers.Format.WMTSCapabilities).createLayer(this.parent.capabilities,{isBaseLayer:1==(r&&r.isBase),name:r&&r.id?r.id:TC.Consts.layerType.WMTS,matrixSet:e,layer:t,requestEncoding:r.encoding===TC.Consts.WMTSEncoding.RESTFUL?"REST":"KVP"});return a._wrap=self,this.addCommonEvents(a),a},TC.wrap.layer.Raster.prototype.getParams=function(){return this.layer.params},TC.wrap.layer.Raster.prototype.setParams=function(e){var t=this;t.layer.getURL=e.LAYERS.length>0?t.layer._originalGetURL:t.layer._noGetURL,t.layer.mergeNewParams(e)},TC.wrap.layer.Raster.prototype.getResolutions=function(){return[]},TC.wrap.layer.Raster.prototype.setWMTSUrl=function(){},TC.wrap.Geometry={getNearest:function(e,t){var r=new OpenLayers.Geometry.LineString($.map(t,function(e){return new OpenLayers.Geometry.Point(e[0],e[1])})),a=r.distanceTo(new OpenLayers.Geometry.Point(e[0],e[1]),{details:!0});return[a.x0,a.y0]}},TC.wrap.layer.Vector.prototype.createVectorLayer=function(){var e=this,t=null,r=$.extend({},TC.Cfg,e.parent.options),a=OpenLayers.Feature.Vector.style["default"],n=function(e,t){var n=OpenLayers.Style.prototype.getSymbolizerPrefix(t.geometry).toLowerCase();return r.styles[n]&&r.styles[n][e]||a[e]},o={strokeColor:"${getStrokeColor}",strokeWidth:"${getStrokeWidth}",strokeOpacity:"${getStrokeOpacity}",fillColor:"${getFillColor}",fillOpacity:"${getFillOpacity}",strokeLinecap:"${getStrokeLinecap}",strokeDashstyle:"${getStrokeDashstyle}"},i={getStrokeColor:function(e){return n("strokeColor",e)},getStrokeWidth:function(e){return n("strokeWidth",e)},getStrokeOpacity:function(e){return n("strokeOpacity",e)},getStrokeLinecap:function(e){return n("strokeLinecap",e)},getStrokeDashstyle:function(e){return n("strokeDashstyle",e)},getFillColor:function(e){return n("fillColor",e)},getFillOpacity:function(e){return n("fillOpacity",e)}},s=function(e){var t=e;if($.isFunction(e)){var r="f"+TC.getUID();i[r]=e,t="${"+r+"}"}return t};r.styles.point&&(o.pointRadius=s(r.styles.point.radius),o.graphic=r.styles.point.graphic,o.label=s(r.styles.point.label),o.fontColor=s(r.styles.point.fontColor),o.fontSize=s(r.styles.point.fontSize),o.fontWeight=s(r.styles.point.fontWeight),o.angle=s(r.styles.point.angle));var p=new OpenLayers.StyleMap({"default":new OpenLayers.Style($.extend({},a,o),{context:i})}),l={styleMap:p,projection:TC.Cfg.crs};r.isLabeling&&(l.renderers=[OpenLayers.Class(OpenLayers.Renderer.SVG,{drawText:function(e,t,r){var a=!!t.labelOutlineWidth;if(a){var n=OpenLayers.Util.extend({},t);n.fontColor=s(n.labelOutlineColor),n.fontStrokeColor=s(n.labelOutlineColor),n.fontStrokeWidth=s(t.labelOutlineWidth),t.labelOutlineOpacity&&(n.fontOpacity=s(t.labelOutlineOpacity)),delete n.labelOutlineWidth,this.drawText(e,n,r)}var o=this.getResolution(),i=(r.x-this.featureDx)/o+this.left,p=r.y/o-this.top,l=a?this.LABEL_OUTLINE_SUFFIX:this.LABEL_ID_SUFFIX,u=this.nodeFactory(e+l,"text");if(u.setAttributeNS(null,"x",i),u.setAttributeNS(null,"y",-p),t.angle||0==t.angle){var y="rotate(-"+t.angle+","+i+","+-p+")";u.setAttributeNS(null,"transform",y)}t.fontColor&&u.setAttributeNS(null,"fill",t.fontColor),t.fontStrokeColor&&u.setAttributeNS(null,"stroke",t.fontStrokeColor),t.fontStrokeWidth&&u.setAttributeNS(null,"stroke-width",t.fontStrokeWidth),t.fontOpacity&&u.setAttributeNS(null,"opacity",t.fontOpacity),t.fontFamily&&u.setAttributeNS(null,"font-family",t.fontFamily),t.fontSize&&u.setAttributeNS(null,"font-size",t.fontSize),t.fontWeight&&u.setAttributeNS(null,"font-weight",t.fontWeight),t.fontStyle&&u.setAttributeNS(null,"font-style",t.fontStyle),t.labelSelect===!0?(u.setAttributeNS(null,"pointer-events","visible"),u._featureId=e):u.setAttributeNS(null,"pointer-events","none");var c=t.labelAlign||OpenLayers.Renderer.defaultSymbolizer.labelAlign;u.setAttributeNS(null,"text-anchor",OpenLayers.Renderer.SVG.LABEL_ALIGN[c[0]]||"middle"),OpenLayers.IS_GECKO===!0&&u.setAttributeNS(null,"dominant-baseline",OpenLayers.Renderer.SVG.LABEL_ALIGN[c[1]]||"central");for(var f=t.label.split("\n"),h=f.length;u.childNodes.length>h;)u.removeChild(u.lastChild);for(var g=0;h>g;g++){var d=this.nodeFactory(e+l+"_tspan_"+g,"tspan");if(t.labelSelect===!0&&(d._featureId=e,d._geometry=r,d._geometryClass=r.CLASS_NAME),OpenLayers.IS_GECKO===!1&&d.setAttributeNS(null,"baseline-shift",OpenLayers.Renderer.SVG.LABEL_VSHIFT[c[1]]||"-35%"),d.setAttribute("x",i),0==g){var m=OpenLayers.Renderer.SVG.LABEL_VFACTOR[c[1]];null==m&&(m=-.5),d.setAttribute("dy",m*(h-1)+"em")}else d.setAttribute("dy","1em");d.textContent=""===f[g]?" ":f[g],d.parentNode||u.appendChild(d)}u.parentNode||this.textRoot.appendChild(u)},CLASS_NAME:"OpenLayers.Control.CustomSVG"})]);var u=new OpenLayers.Strategy.Fixed;if(e.parent.type===TC.Consts.layerType.KML)l.strategies=[u],l.protocol=new OpenLayers.Protocol.HTTP({url:TC.proxify(r.url),format:new OpenLayers.Format.KML({extractStyles:!0,extractAttributes:!0,parseFolders:!0,internalProjection:new OpenLayers.Projection(TC.Cfg.crs),externalProjection:new OpenLayers.Projection("EPSG:4326")})});else if(r.type===TC.Consts.layerType.WFS){var y=function(e){var t,r=[];for(var a in e){var n,o,i,s=e[a];if(s.type){n=s.type,o=s.value;var p=new OpenLayers.Filter.Comparison({type:n,property:a,value:o});s.ignoreHyphens?(p=[p,new OpenLayers.Filter.Comparison({
type:n,property:a,value:o.replace(/-/g,"")})],i=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.OR,filters:p})):i=p}else n=OpenLayers.Filter.Comparison.EQUAL_TO,o=s,i=new OpenLayers.Filter.Comparison({type:n,property:a,value:o});r.push(i)}switch(r.length){case 0:t=null;break;case 1:t=r[0];break;default:t=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:r})}return t},c={};if(r.properties)for(var f=0;f<r.properties.length;f++){var h=r.properties[f];h.name&&h.type?c[h.name]={value:h.value||"",type:h.type,ignoreHyphens:h.ignoreHyphens}:c[h]=""}l.strategies=[u],l.protocol=new OpenLayers.Protocol.WFS({url:r.url,version:r.version,featureType:r.featureType,geometryName:r.geometryName,featurePrefix:r.namespace,outputFormat:r.outputFormat,srsName:TC.Cfg.crs}),l.filter=y(c)}r.cluster&&($.isArray(l.strategies)||(l.strategies=[]),l.strategies.push(new OpenLayers.Strategy.Cluster({distance:r.cluster.distance}))),t=new OpenLayers.Layer.Vector("Vectors",l),t._wrap=e,this.addCommonEvents(t),t.events.register("beforefeaturesadded",null,function(){e.parent.map.$events.trigger($.Event(TC.Consts.event.BEFOREFEATURESADD,{layer:e.parent}))}),t.events.register("featuresadded",null,function(t){for(var r=[],a=[],n=[],o=0;o<t.features.length;o++){var i=t.features[o];i._wrap||(i.geometry instanceof OpenLayers.Geometry.Point?r[r.length]=i:i.geometry instanceof OpenLayers.Geometry.LineString||i.geometry instanceof OpenLayers.Geometry.MultiLineString?a[a.length]=i:(i.geometry instanceof OpenLayers.Geometry.Polygon||i.geometry instanceof OpenLayers.Geometry.MultiPolygon)&&(n[n.length]=i))}var s=[];r.length>0&&s.push(e.parent.addMarkers(r)),a.length>0&&s.push(e.parent.addPolylines(a)),n.length>0&&s.push(e.parent.addPolygons(n)),$.when.apply(e,s).then(function(){var t=[];if(arguments.length)for(var r=0;r<arguments[0].length;r++){var a=t[r]=arguments[0][r];$.isArray(a.wrap.feature.cluster)&&(a.features=$.map(a.wrap.feature.cluster,function(e){return new a.constructor(e)}))}e.parent.map.$events.trigger($.Event(TC.Consts.event.FEATURESADD,{layer:e.parent,features:t}))})}),t.events.register("featureremoved",null,function(t){var r=t.feature;if(r._wrap){var a=$.inArray(r._wrap.parent,e.parent.features);a>-1&&(e.parent.features.splice(a,1),e.parent.map.$events.trigger($.Event(TC.Consts.event.FEATUREREMOVE,{layer:e.parent,feature:r._wrap.parent})))}});$(e.parent.map);if(t.events.register("featuresadded",null,function(){e.parent.map.$events.trigger($.Event(TC.Consts.event.VECTORUPDATE,{layer:e.parent}))}),t.events.register("featuresremoved",null,function(){e.parent.map.$events.trigger($.Event(TC.Consts.event.VECTORUPDATE,{layer:e.parent}))}),e.parent.type===TC.Consts.layerType.KML&&(t.events.register("added",null,function(){u.activate()}),!e.parent.options.title)){var g=function d(){t.protocol.format._documentName&&(e.parent.title=t.protocol.format._documentName),t.events.unregister("loadend",null,d)};t.events.register("loadend",null,g)}return t},TC.wrap.layer.Vector.prototype.getGetFeatureUrl=function(){return null},TC.wrap.layer.Vector.prototype["import"]=function(e){TC.error("TC.wrap.layer.Vector.prototype.import no está soportada con OpenLayers 2")},TC.wrap.layer.Vector.prototype.addFeatures=function(e){$.when(this.getLayer()).then(function(t){t.addFeatures(e)})},TC.wrap.layer.Vector.prototype.getFeatures=function(){var e=this.getLayer();if(e instanceof OpenLayers.Layer){if(e.strategies)for(var t=0;t<e.strategies.length;t++){var r=e.strategies[t];r instanceof OpenLayers.Strategy.Filter&&r.setFilter(r.filter)}return e.features}return[]},TC.wrap.layer.Vector.prototype.getFeatureById=function(e){var t=this.getLayer();if(t instanceof OpenLayers.Layer){if(t.strategies)for(var r=0;r<t.strategies.length;r++){var a=t.strategies[r];a instanceof OpenLayers.Strategy.Filter&&a.setFilter(a.filter)}return t.getFeatureById(e)}return null},TC.wrap.layer.Vector.prototype.removeFeature=function(e){$.when(this.getLayer()).then(function(t){t.removeFeatures([e.wrap.feature])})},TC.wrap.layer.Vector.prototype.clearFeatures=function(){$.when(this.getLayer()).then(function(e){e.removeAllFeatures()})},TC.wrap.layer.Vector.prototype.setFeatureVisibility=function(e,t){var r=this,a=$.inArray(e,r.parent.features);a>=0&&(t?delete e.wrap.feature.style.display:e.wrap.feature.style.display="none",r._redrawTimeout&&clearTimeout(r._redrawTimeout),r._redrawTimeout=setTimeout(function(){$.when(r.getLayer()).then(function(e){e.redraw(),r.parent.map.$events.trigger($.Event(TC.Consts.event.VECTORUPDATE,{layer:r.parent}))}),delete r._redrawTimeout},100))},TC.wrap.layer.Vector.prototype.getRGBA=function(e,t){var r=[0,0,0,1];if("string"==typeof e){var a=4===e.length?1:2;r[0]=parseInt(e.substr(1,a),16),r[1]=parseInt(e.substr(1+a,a),16),r[2]=parseInt(e.substr(1+2*a,a),16),1===a&&(r[0]=17*r[0],r[1]=17*r[1],r[2]=17*r[2]),void 0!==t&&(r[3]=t)}return r},TC.wrap.layer.Vector.prototype.findFeature=function(e){var t=this;$.when(t.getLayer()).then(function(t){var r=t.filter;if(r){if(r.filters&&r.filters.length<=e.length)for(var a=0;a<r.filters.length;a++){var n=r.filters[a];n.type===OpenLayers.Filter.Logical.OR?(n.filters[0].value=e[a],n.filters[1].value=e[a].replace("-","")):n.value=e[a]}else r.value=e[0];t.removeAllFeatures(),t.setVisibility(!0),t.strategies[0].active||t.strategies[0].activate(),t.refresh()}})},TC.wrap.layer.Vector.prototype.sendTransaction=function(e,t,r){var a=$.Deferred();return TC.error('"sendTransaction" no está soportado por la versión OpenLayers 2 de la API SITNA'),a.reject(),a},TC.wrap.layer.Vector.prototype.setDraggable=function(e,t,r){var a=this;$.when(a.parent.map.wrap.getMap(),a.getLayer()).then(function(n,o){if(e){if(!a._ctl){var i={};$.isFunction(t)&&(i.onComplete=function(e,r){t.call(this,e._wrap.parent,[r.x,r.y])}),$.isFunction(r)&&(i.onStart=function(e,t){r.call(this,e._wrap.parent,[t.x,t.y])}),a._ctl=new OpenLayers.Control.DragFeature(o,i),n.addControl(a._ctl)}a._ctl.activate()}else a._ctl&&a._ctl.deactivate()})},TC.wrap.control.Click.prototype.register=function(e){var t=this;t._ctl=new OpenLayers.Control,$.when(e.wrap.getMap()).then(function(r){var a=function(e){var a=r.getLonLatFromPixel(e.xy);t.parent.callback([a.lon,a.lat],[e.xy.x,e.xy.y])};t._ctl.handler=new OpenLayers.Handler.Click(this,{click:a},{single:!0,"double":!1,pixelTolerance:e.options.pixelTolerance,stopSingle:!1,stopDouble:!1}),r.addControl(t._ctl)})},TC.wrap.control.Click.prototype.activate=function(){var e=this;e._ctl.activate()},TC.wrap.control.Click.prototype.deactivate=function(){var e=this;e._ctl.deactivate()},TC.wrap.control.ScaleBar.prototype.render=function(){var e=this;e.ctl?e.ctl.draw():e.ctl=new OpenLayers.Control.ScaleLine({div:e.parent.div,bottomInUnits:"",bottomOutUnits:""})},TC.wrap.control.NavBar.prototype.register=function(e){var t=this;$.when(e.wrap.getMap()).then(function(e){t.zsCtl=new OpenLayers.Control.PanZoomBar({panIcons:!1,zoomWorldIcon:!0}),e.addControl(t.zsCtl),e.events.register("changebaselayer",null,function(){t.zsCtl.moveZoomBar()})})},TC.wrap.control.NavBar.prototype.refresh=function(){},TC.wrap.control.Coordinates.prototype.register=function(e){var t=this,r=new $.Deferred;return $.when(e.wrap.getMap()).then(function(a){var n=a.getProjectionObject();null===n&&(n=new OpenLayers.Projection(a.projection)),t.parent.crs=n.getCode(),t.parent.units=n.getUnits(),t.parent.isGeo=e.wrap.isGeo();var o=function(e){var r=a.getLonLatFromPixel(a.events.getMousePosition(e));r&&(t.parent.isGeo?t.parent.latLon=[r.lat,r.lon]:t.parent.xy=[r.lon,r.lat],t.parent.update.apply(t.parent,arguments))};a.events.register("mousemove",t.parent,o),a.events.register("mouseover",t.parent,o),a.events.register("mouseout",t.parent,function(){t.parent.clear.apply(t.parent,arguments)}),r.resolve()}),r},TC.wrap.Parser=function(){},TC.wrap.Parser.prototype.read=function(e){var t=[],r=this;return r.parser&&(TC.Feature||TC.syncLoadJS(TC.apiLocation+"TC/Feature.js"),t=$.map(r.parser.read(e),function(e){return new TC.Feature(null,{id:e.fid,data:e.data})})),t},TC.wrap.parser={WFS:function(e){this.parser=new OpenLayers.Format.GML(e)},JSON:function(e){this.parser=new OpenLayers.Format.GeoJSON(e)}},TC.inherit(TC.wrap.parser.WFS,TC.wrap.Parser),TC.inherit(TC.wrap.parser.JSON,TC.wrap.Parser),TC.wrap.control.Search.prototype.addEvents=function(){var e=this;$.when(e.parent.layer.wrap.getLayer()).then(function(t){var r=e.parent.layer.map,a=r.wrap.isGeo()?r.options.pointBoundsRadius/TC.Util.getMetersPerDegree(r.getExtent()):r.options.pointBoundsRadius;t.events.register("featuresadded",t,function(t){for(var r=t.features[0].geometry.getBounds(),n=1;n<t.features.length;n++)r.extend(t.features[n].geometry.getBounds());r.left===r.right&&(r.left-=a,r.right+=a),r.top===r.bottom&&(r.bottom-=a,r.top+=a),e.parent.layer.map.setExtent(r)})})},TC.wrap.control.OverviewMap.prototype.register=function(e){var t=this,r=function(){var e=new OpenLayers.Size(t.parent._$div.width(),t.parent._$div.height());return 0===e.w&&(e.w=100),0===e.h&&(e.h=100),e},a=r();$.when(t.parent.layer.wrap.getLayer()).then(function(n){t.ovMap=new OpenLayers.Control.OverviewMap({div:t.parent.div,size:a,layers:[n],minRatio:24,maxRatio:48,autoPan:!0,theme:OpenLayers.CustomTheme,mapOptions:{projection:e.crs,displayProjection:e.crs,baseLayer:n,maxExtent:e.options.maxExtent,minRatio:24,maxRatio:48,minRectSize:30,theme:OpenLayers.CustomTheme},maximized:!0});var o=$(t.parent.div).find("."+t.parent.CLASS+"-load");n.events.register("loadstart",t.parent.layer,function(){o.removeClass(TC.Consts.classes.HIDDEN).addClass(TC.Consts.classes.VISIBLE)}),n.events.register("loadend",t.parent.layer,function(){o.removeClass(TC.Consts.classes.VISIBLE).addClass(TC.Consts.classes.HIDDEN)}),$.when(e.wrap.getMap()).then(function(e){e.addControl(t.ovMap),t.parent.isLoaded=!0,t.parent.$events.trigger($.Event(TC.Consts.event.MAPLOAD)),e.events.register("updatesize",t.parent,function(){r();t.ovMap.ovmap&&($ovmap=$(t.ovMap.ovmap.div),$ovmap.css("width",t.parent._$div.css("width")).css("height",t.parent._$div.css("height")),t.ovMap.ovmap.updateSize(),t.ovMap.updateRectToMap())})})})},TC.wrap.control.OverviewMap.prototype.enable=function(){var e=this;e.ovMap.activate(),e.ovMap.update()},TC.wrap.control.OverviewMap.prototype.disable=function(){this.ovMap.deactivate()},TC.wrap.control.FeatureInfo.prototype.register=function(e){var t=this;t._map=e,$.when(e.wrap.getMap()).then(function(r){TC.wrap.control.Click.prototype.register.call(t,e);for(var a=[],n=function(e){var t=!1;return e instanceof TC.layer.Raster&&!e.isBase&&e.wrap.getInfoFormats()&&(t=!0),t},o=0;o<e.workLayers.length;o++){var i=e.workLayers[o];n(i)&&a.push(i.wrap.layer)}t._gfi=new OpenLayers.Control.WMSGetFeatureInfo({layers:a,autoActivate:!1,drillDown:!0,maxFeatures:1e3,queryVisible:!0,output:"object",formatOptions:{internalProjection:r.projection}}),e.options.pixelTolerance&&(t._gfi.vendorParams={radius:e.options.pixelTolerance,buffer:e.options.pixelTolerance}),r.addControl(t._gfi),e.on(TC.Consts.event.LAYERADD,function(e){n(e.layer)&&t._gfi.layers.push(e.layer.wrap.layer)}).on(TC.Consts.event.LAYERREMOVE,function(e){var r=$.inArray(e.layer.wrap.layer,t._gfi.layers);r>=0&&t._gfi.layers.splice(r,1)});var s={};t._gfi.events.register("beforegetfeatureinfo",t.parent,function(r){for(var a=0;a<r.object.layers.length;a++)for(var n=0;n<e.workLayers.length;n++)e.workLayers[n].wrap.layer===r.object.layers[a]&&(s[r.object.layers[a].url]=e.workLayers[n]);e.$events.trigger($.Event(TC.Consts.event.BEFOREFEATUREINFO,{xy:[r.xy.x,r.xy.y],control:t.parent}))}),t._gfi.events.register("getfeatureinfo",t.parent,function(r){for(var a,n=0,o=[],i=[],p=[],l=0;l<r.features.length;l++){var u=r.features[l];a={layers:[],text:r.text};var y=s[u.url];y&&(a.mapLayer=y,delete s[u.url]);for(var c=0;c<u.features.length;c++){for(var f=u.features[c],h=f.fid?f.fid.substr(0,f.fid.lastIndexOf(".")):f.type||"",g=a.mapLayer?a.mapLayer.wrap.getInfo(h).title||h:"[Sin título]",d=null,m=0;m<a.layers.length;m++)if(a.layers[m].name===h){d=a.layers[m];break}d||(d={name:h,title:g,features:[]},a.layers.push(d)),o.push(TC.wrap.Feature.createFeature(f)),i.push(d.features),n+=1}u.features.length||(contentType=r.request.getResponseHeader("Content-Type"),0===contentType.indexOf("text/")&&(d={name:h,title:g,features:[]},a.layers.push(d),d.features.push({rawUrl:r.request._object.responseURL,rawContent:r.text}),n+=1)),p.push(a)}$.when.apply(this,o).then(function(){if(arguments.length)for(var a=0;a<arguments.length;a++){var o=arguments[a];o.attributes=[];for(var s in o.data)o.attributes.push({name:s,value:o.data[s]});i[a].push(o)}e.$events.trigger($.Event(TC.Consts.event.FEATUREINFO,{xy:[r.xy.x,r.xy.y],services:p,featureCount:n,control:t.parent}))})}),t._gfi.events.register("exception",t.parent,function(r){e.$events.trigger($.Event(TC.Consts.event.FEATUREINFOERROR,{xy:[r.xy.x,r.xy.y],control:t.parent,layer:r.layer._wrap.parent}))})})},TC.wrap.control.FeatureInfo.prototype.getFeatureInfo=function(e){var t=this;t._map&&t._gfi.layers.length>0&&t._gfi.getInfoForClick({xy:{x:e[0],y:e[1]}})},TC.wrap.control.Popup.prototype=function(){this.popup=null},TC.wrap.control.Popup.prototype.fitToView=function(){var e=this;setTimeout(function(){e.popup.updateSize()},100)},TC.wrap.control.Popup.prototype.setDragged=function(e){},TC.wrap.Feature.prototype.getLegend=function(){var e=this,t={},r=e.feature.style;return r.externalGraphic?(t.src=r.externalGraphic,t.width=r.graphicWidth,t.height=r.graphicHeight):(r.strokeColor&&(t.strokeColor=r.strokeColor),r.strokeWidth&&(t.strokeWidth=r.strokeWidth),r.fillColor&&(t.fillColor=r.fillColor),r.pointRadius&&(t.height=t.width=2*r.pointRadius)),t},TC.wrap.Feature.prototype.createPoint=function(e,t){var r=this;if($.isArray(e)){var a={pointRadius:t.radius||(t.height+t.width)/4};t.fillColor?(a.fillColor=t.fillColor,a.fillOpacity=t.fillOpacity):a.fill=!1,t.strokeColor?(a.strokeColor=t.strokeColor,a.strokeWidth=t.strokeWidth):a.stroke=!1,r.feature=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(e[0],e[1]),null,a)}else r.isNative(e)&&(r.feature=e,r.parent.geometry=[e.geometry.x,e.geometry.y],e.style&&(r.parent.options.radius=e.style.pointRadius,r.parent.options.fillColor=e.style.fillColor,r.parent.options.fillOpacity=e.style.fillOpacity,r.parent.options.strokeColor=e.style.strokeColor));t&&t.id&&(r.feature.id=t.id),r.feature._wrap=r},TC.wrap.Feature.prototype.createMarker=function(e,t){var r=this,a=TC.Util.getPointIconUrl(t);if(a){if($.isArray(e)){var n={externalGraphic:TC.Util.getPointIconUrl(t),graphicWidth:t.width,graphicHeight:t.height,graphicXOffset:-Math.round(t.anchor[0]*t.width),graphicYOffset:-Math.round(t.anchor[1]*t.height)};r.feature=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Point(e[0],e[1]),null,n)}else r.isNative(e)&&(r.feature=e,r.parent.geometry=[e.geometry.x,e.geometry.y],e.style&&(r.parent.options.url=e.style.externalGraphic,r.parent.options.width=e.style.graphicWidth,r.parent.options.height=e.style.graphicHeight,r.parent.options.anchor=[-e.style.graphicXOffset/e.style.graphicWidth,-e.style.graphicYOffset/e.style.graphicHeight]));t&&t.id&&(r.feature.id=t.id),r.feature._wrap=r}else r.createPoint(e,t)},TC.wrap.Feature.prototype.createPolyline=function(e,t){var r=this;if($.isArray(e)){var a=$.map(e,function(e){return new OpenLayers.Geometry.Point(e[0],e[1])});r.feature=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.LineString(a),null,{stroke:!0,strokeColor:t.strokeColor,strokeWidth:t.strokeWidth})}else if(r.isNative(e)){r.feature=e;for(var n=r.parent.geometry=e.geometry.getVertices(),o=0;o<n.length;o++)n[o]=[n[o].x,n[o].y];e.style&&(r.parent.options.strokeColor=e.style.strokeColor,r.parent.options.strokeWidth=e.style.strokeWidth)}r.feature._wrap=r},TC.wrap.Feature.prototype.createPolygon=function(e,t){var r=this;if($.isArray(e)){var a,n=function(e){return new OpenLayers.Geometry.LinearRing($.map(e,function(e){return new OpenLayers.Geometry.Point(e[0],e[1])}))};if(e.length>0&&$.isArray(e[0])&&e[0].length>0&&$.isArray(e[0][0])){a=new Array(e.length);for(var o=0,i=e.length;i>o;o++)a[o]=n(e[o])}else a=[n(e)];r.feature=new OpenLayers.Feature.Vector(new OpenLayers.Geometry.Polygon(a),null,{stroke:!0,strokeColor:t.strokeColor,strokeWidth:t.strokeWidth,fillColor:t.fillColor,fillOpacity:t.fillOpacity})}else if(r.isNative(e)){if(r.feature=e,e.geometry)for(var s=r.parent.geometry=e.geometry.getVertices(),o=0;o<s.length;o++)s[o]=[s[o].x,s[o].y];e.style&&(r.parent.options.strokeColor=e.style.strokeColor,r.parent.options.strokeWidth=e.style.strokeWidth,r.parent.options.fillColor=e.style.fillColor,r.parent.options.fillOpacity=e.style.fillOpacity)}r.feature._wrap=r},TC.wrap.Feature.prototype.createCircle=function(e,t){},TC.wrap.Feature.createFeature=function(e){var t=new $.Deferred,r={id:e.fid,data:e.attributes};return e.geometry instanceof OpenLayers.Geometry.Point?TC.loadJS(!TC.feature||TC.feature&&!TC.feature.Point,[TC.apiLocation+"TC/feature/Point.js"],function(){t.resolve(new TC.feature.Point(e,r))}):e.geometry instanceof OpenLayers.Geometry.LineString?TC.loadJS(!TC.feature||TC.feature&&!TC.feature.Polyline,[TC.apiLocation+"TC/feature/Polyline.js"],function(){t.resolve(new TC.feature.Polyline(e,r))}):e.geometry instanceof OpenLayers.Geometry.MultiLineString?TC.loadJS(!TC.feature||TC.feature&&!TC.feature.MultiPolyline,[TC.apiLocation+"TC/feature/MultiPolyline.js"],function(){t.resolve(new TC.feature.MultiPolyline(e,r))}):e.geometry instanceof OpenLayers.Geometry.Polygon?TC.loadJS(!TC.feature||TC.feature&&!TC.feature.Polygon,[TC.apiLocation+"TC/feature/Polygon.js"],function(){t.resolve(new TC.feature.Polygon(e,r))}):e.geometry instanceof OpenLayers.Geometry.MultiPolygon?TC.loadJS(!TC.feature||TC.feature&&!TC.feature.MultiPolygon,[TC.apiLocation+"TC/feature/MultiPolygon.js"],function(){t.resolve(new TC.feature.MultiPolygon(e,r))}):TC.loadJS(!TC.Feature,[TC.apiLocation+"TC/Feature.js"],function(){t.resolve(new TC.Feature(e,r))}),t},TC.wrap.Feature.prototype.getGeometry=function(){var e,t=this;if(t.feature&&t.feature.geometry){var r=function(e){return[e.x,e.y]},a=function(e){for(var t=e.getVertices(),a=0,n=t.length;n>a;a++)t[a]=r(t[a]);return t},n=function(e){for(var t=new Array(e.components.length),r=0,n=e.components.length;n>r;r++)t[r]=a(e.components[r]);return t},o=t.feature.geometry;o instanceof OpenLayers.Geometry.Point?e=r(o):o instanceof OpenLayers.Geometry.LineString?e=a(o):o instanceof OpenLayers.Geometry.MultiLineString?e=a(o.components[0]):o instanceof OpenLayers.Geometry.Polygon?e=n(o):o instanceof OpenLayers.Geometry.MultiPolygon&&(e=n(o.components[0]))}return e},TC.wrap.Feature.prototype.setGeometry=function(e){var t=!1,r=this;if(r.feature&&r.feature.geometry){var a=r.feature.geometry;a instanceof OpenLayers.Geometry.Point&&$.isArray(e)&&"number"==typeof e[0]&&"number"==typeof e[1]&&(a.move(e[0]-a.x,e[1]-a.y),t=!0)}return t},TC.wrap.Feature.prototype.getId=function(){var e,t=this;return t.feature&&(e=t.feature.fid),e},TC.wrap.Feature.prototype.setId=function(e){var t=this;t.feature&&(t.feature.fid=e)},TC.wrap.Feature.prototype.setStyle=function(e){var t=this,r=t.feature.style||new OpenLayers.Style;e instanceof OpenLayers.Style||(e=new OpenLayers.Style(e));var e=e.createLiterals(OpenLayers.Util.extend({},e.defaultStyle),t.feature);t.feature.geometry instanceof OpenLayers.Geometry.Point?(r.externalGraphic=e.url,r.graphicWidth=e.width,r.graphicHeight=e.height,e.anchor&&e.width&&(r.graphicXOffset=-Math.round(e.anchor[0]*e.width)),e.anchor&&e.height&&(r.graphicYOffset=-Math.round(e.anchor[1]*e.height)),r.graphic=e.graphic,e.label&&(r.label=e.label.toCamelCase()),e.angle&&(r.angle=e.angle),r.fontColor=e.fontColor,r.labelOutlineColor=e.labelOutlineColor,r.labelOutlineWidth=e.labelOutlineWidth):t.feature.geometry.components&&t.feature.geometry.components instanceof Array&&t.feature.geometry.components[0].CLASS_NAME==(new OpenLayers.Geometry.LineString).CLASS_NAME||!t.feature.geometry.components&&t.feature.geometry instanceof new OpenLayers.Geometry.LineString?(r.stroke=!0,r.strokeColor=e.strokeColor,r.strokeWidth=e.strokeWidth):(t.feature.geometry.components&&t.feature.geometry.components instanceof Array&&t.feature.geometry.components[0].CLASS_NAME==(new OpenLayers.Geometry.Polygon).CLASS_NAME||!t.feature.geometry.components&&t.feature.geometry instanceof new OpenLayers.Geometry.Polygon)&&(r.stroke=!0,r.strokeColor=e.strokeColor,r.strokeWidth=e.strokeWidth,r.fillColor=e.fillColor,r.fillOpacity=e.fillOpacity),t.feature.layer&&t.feature.layer.drawFeature(t.feature,r)},TC.wrap.Feature.prototype.getInnerPoint=function(e){var t=this.feature,r=t.geometry.getCentroid(!0);if(!result.intersects(t.geometry)){var a=t.geometry.distanceTo(result,{details:!0});r=new OpenLayers.Geometry.Point(a.x0,a.y0)}return[r.x,r.y]},TC.wrap.Feature.prototype.showPopup=function(e){{var t=this;t.feature}Modernizr.canvas&&-1===OpenLayers.Popup.Anchored.prototype.displayClass.indexOf(TC.control.Popup.prototype.CLASS)&&(OpenLayers.Popup.Anchored.prototype.displayClass=OpenLayers.Popup.Anchored.prototype.displayClass+" "+TC.control.Popup.prototype.CLASS+" "+TC.Consts.classes.VISIBLE);var r=Modernizr.canvas?OpenLayers.Popup.Anchored:OpenLayers.Popup.FramedCloud;t._innerCentroid||(t._innerCentroid=t.getInnerPoint()),e.currentFeature=t.parent;var a=e.map;a&&$.when(a.wrap.getMap()).then(function(n){a.popup&&(n.removePopup(a.popup.wrap.popup),a.popup.wrap.popup.destroy(),delete a.popup.wrap.popup,a.popup=null);var o=t.parent.getInfo();if(o){var i=t.parent.options,s=null;Modernizr.canvas&&i.anchor&&i.height&&(s={size:new OpenLayers.Size(0,i.height),offset:new OpenLayers.Pixel(0,-i.height*i.anchor[1])});var p=new r(null,new OpenLayers.LonLat(t._innerCentroid[0],t._innerCentroid[1]),null,o,s,e.options.closeButton,function(t){this.hide(),OpenLayers.Event.stop(t),a.$events.trigger($.Event(TC.Consts.event.POPUPHIDE,{control:e}))});if(p.autoSize=!0,p.panMapIfOutOfView=!0,p.keepInMap=!0,p.maxSize=new OpenLayers.Size(n.size.w/2,n.size.h/2),e.$popupDiv=$(p.div),e.wrap.popup=p,a.popup=e,n.addPopup(p),Modernizr.canvas){e.$popupDiv.css("overflow","").css("border","").css("width","").css("height","");var l=$(p.contentDiv).css("position","");p.updateSize(),l.css("width","");var u=$(p.groupDiv).find(".olPopupCloseBox").attr("style","").addClass(e.CLASS+"-close").attr("title",e.getLocaleString("close"));u.length&&l.css("margin-right",u.width())}}})},TC.wrap.Feature.prototype.isNative=function(e){return e instanceof OpenLayers.Feature},TC.wrap.Feature.prototype.getPath=function(){var e=[],t=this;return t.feature&&t.feature._folders&&(e=t.feature._folders),e},TC.wrap.Feature.prototype.getBounds=function(){var e=null,t=this;if(t.feature&&t.feature.geometry){var r=t.feature.geometry.getBounds();e=[r.left,r.bottom,r.right,r.top]}return e},TC.wrap.Feature.prototype.getTemplate=function(){var e=null,t=this;return t.feature.style&&(e=t.feature.style.balloonStyle,e&&(e=e.replace(/\$\{(\w+)\}/g,"$$[$1]"))),e},TC.wrap.Feature.prototype.getData=function(){var e=$.extend({},this.feature.attributes);for(var t in e)e[t].value&&(e[t]=e[t].value);return e},TC.wrap.control.Draw.prototype.activate=function(e){var t=this,r=e===TC.Consts.geom.POLYGON?OpenLayers.Handler.Polygon:OpenLayers.Handler.Path;t.parent.map&&$.when(t.parent.map.wrap.getMap()).then(function(a){if(t.control&&(t.control.deactivate(),a.removeControl(t.control)),e){var n=function(e){var r="measurepartial"===e.type?TC.Consts.event.MEASUREPARTIAL:TC.Consts.event.MEASURE,a={units:e.units};1===e.order?a.length=e.measure:2===e.order&&(a.area=e.measure,a.perimeter=t.control.getLength(e.geometry,e.units)),t.parent.$events.trigger(t.parent.measure?$.Event(r,a):$.Event(TC.Consts.event.DRAWEND,{geometry:new TC.feature.Polygon(e.geometry.components)}))};t.control=new OpenLayers.Control.Measure(r,{geodesic:!0,persist:!0,immediate:!0}),t.control.handler.callbacks.point=function(e){t.parent.$events.trigger($.Event(TC.Consts.event.POINT,{point:[e.x,e.y]}))},t.control.events.on(t.parent.measure?{measure:n,measurepartial:n}:{measure:n}),a.addControl(t.control),t.control.activate()}})},TC.wrap.control.Draw.prototype.deactivate=function(){var e=this;e.control&&e.control.deactivate()},TC.wrap.control.Draw.prototype.undo=function(){var e=this,t=!1;return e.control&&e.control.handler&&(t=e.control.handler.undo()),t},TC.wrap.control.Draw.prototype.redo=function(){var e=this,t=!1;return e.control&&e.control.handler&&(t=e.control.handler.redo()),t},TC.wrap.control.Draw.prototype.end=function(){var e=this;e.control&&e.control.handler&&(e.control.handler.finishGeometry(),e.control.handler.layer&&e.control.handler.layer.redraw())},TC.wrap.control.CacheBuilder.prototype.getRequestSchema=function(e){return{}},TC.wrap.control.CacheBuilder.prototype.getGetTilePattern=function(e){return""}}();