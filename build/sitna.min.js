var SITNA=window.SITNA||{},TC=window.TC||{};SITNA.syncLoadJS=function(e){var t=new XMLHttpRequest;t.open("GET",e,!1),t.send(null);var a=document.getElementsByTagName("head")[0],r=document.createElement("script");r.type="text/javascript",r.text=t.responseText,a.appendChild(r)},function(){if(!window.TC||!window.TC.Cfg){var e,t;if(document.currentScript)t=document.currentScript;else{var a=document.getElementsByTagName("script");t=a[a.length-1]}var e=t.getAttribute("src");TC.apiLocation=e.substr(0,e.lastIndexOf("/")+1),SITNA.syncLoadJS(TC.apiLocation+"tcmap.js")}}(),SITNA.Map=function(e,t){var a,r,o=this,n=new TC.Map(e,t);o.addLayer=function(e,t){n.addLayer(e,t)},o.setBaseLayer=function(e,t){n.setBaseLayer(e,t)},o.addMarker=function(e,t){n.addMarker(e,t)},o.zoomToMarkers=function(e){n.zoomToMarkers(e)},o.loaded=function(e){n.loaded(e)},n.loaded(function(){if(a=new TC.control.Search,a.register(n),a.getLayer().then(function(e){r=e}),!n.activeControl){var e=n.getControlsByClass("TC.control.FeatureInfo")[0];e&&e.activate()}}),o.getQueryableData=function(e,t){var r=a.availableSearchTypes[e];if(r.queryableData)t&&t(r.queryableData);else{var o={request:"GetFeature",service:"WFS",typename:r.featurePrefix+":"+r.featureType,version:r.version,propertyname:(r.dataIdProperty instanceof Array?r.dataIdProperty:[r.dataIdProperty]).concat(r.outputProperties instanceof Array?r.outputProperties:[r.outputProperties]).join(","),outputformat:TC.Consts.format.JSON},n=r.url+"?"+$.param(o);$.ajax({url:n}).done(function(e){if(r.queryableData=[],e.features)for(var o=e.features,n=0;n<o.length;n++){var s=o[n],e={};e.id=[],r.dataIdProperty instanceof Array||(r.dataIdProperty=[r.dataIdProperty]);for(var l=0;l<r.dataIdProperty.length;l++)s.properties.hasOwnProperty(r.dataIdProperty[l])&&e.id.push(s.properties[r.dataIdProperty[l]]);e.id=e.id.join(r.idPropertiesIdentifier?r.idPropertiesIdentifier:""),e.label=[],r.outputProperties instanceof Array||(r.outputProperties=[r.outputProperties]);for(var i=0;i<r.outputProperties.length;i++)s.properties.hasOwnProperty(r.outputProperties[i])&&e.label.push(s.properties[r.outputProperties[i]]);var u=e.label instanceof Array&&e.label.join("").trim().length>0||!(e.label instanceof Array)&&e.label.trim().length>0;e.label=r.outputFormatLabel?r.outputFormatLabel.tcFormat(e.label):e.label.join("-"),u&&r.queryableData.push(e)}r.queryableData=r.queryableData.sort(function(e,t){return(r.idPropertiesIdentifier?-1!=e.id.indexOf(r.idPropertiesIdentifier):1)?a.removePunctuation(e.label.split(" ")[0])<a.removePunctuation(t.label.split(" ")[0])?-1:a.removePunctuation(e.label.split(" ")[0])>a.removePunctuation(t.label.split(" ")[0])?1:0:a.removePunctuation(e.label)<a.removePunctuation(t.label)?-1:a.removePunctuation(e.label)>a.removePunctuation(t.label)?1:0}),r.queryableData=r.queryableData.filter(function(e,t,a){return 1>t?!0:e.id!==a[t-1].id&&e.label!==a[t-1].label}),t&&t(r.queryableData)})}},o.getMunicipalities=function(e){o.getQueryableData(SITNA.Consts.mapSearchType.MUNICIPALITY,e)},o.getUrbanAreas=function(e){o.getQueryableData(SITNA.Consts.mapSearchType.URBAN,e)},o.getCommonwealths=function(e){o.getQueryableData(SITNA.Consts.mapSearchType.COMMONWEALTH,e)},o.getCouncils=function(e){o.getQueryableData(SITNA.Consts.mapSearchType.COUNCIL,e)},o.searchCommonwealth=function(e,t){o.searchTyped(SITNA.Consts.mapSearchType.COMMONWEALTH,e,t)},o.searchCouncil=function(e,t){o.searchTyped(SITNA.Consts.mapSearchType.COUNCIL,e,t)},o.searchUrbanArea=function(e,t){o.searchTyped(SITNA.Consts.mapSearchType.URBAN,e,t)},o.searchMunicipality=function(e,t){o.searchTyped(SITNA.Consts.mapSearchType.MUNICIPALITY,e,t)},o.searchTyped=function(e,t,s){var l=TC.getUID(),i=a.availableSearchTypes[e];t instanceof Array&&i.goToIdFormat&&(t=i.goToIdFormat.tcFormat(t)),a._search.data=a._search.data||[],a._search.data.push({dataLayer:i.featureType,dataRole:e,id:t,label:"",text:""}),o.removeSearch(),a.availableSearchTypes[e]&&!a.allowedSearchTypes[e]&&(a.allowedSearchTypes={},a.allowedSearchTypes[e]={},a.availableSearchTypes[e].hasOwnProperty("goTo")||(a.allowedSearchTypes[e]={goTo:function(){var r,s=function(e,t,a){return e[t][a]},u=function(e){var t=[];i.idPropertiesIdentifier&&(e=e.split(i.idPropertiesIdentifier)),e instanceof Array||(e=[e]);for(var a=0;a<i.dataIdProperty.length;a++)t.push({name:i.dataIdProperty[a],value:e[a],type:TC.Consts.comparison.EQUAL_TO});return t},p={id:l,type:SITNA.Consts.layerType.WFS,url:i.url,version:i.version,stealth:!0,geometryName:"the_geom",featurePrefix:i.featurePrefix,featureType:i.featureType,properties:u(t),outputFormat:TC.Consts.format.JSON,styles:{polygon:{fillColor:s.bind(self,i.styles[i.featureType],"polygon","fillColor"),fillOpacity:s.bind(self,i.styles[i.featureType],"polygon","fillOpacity")},line:{strokeColor:s.bind(self,i.styles[i.featureType],"line","strokeColor"),strokeOpacity:s.bind(self,i.styles[i.featureType],"line","strokeOpacity"),strokeWidth:s.bind(self,i.styles[i.featureType],"line","strokeWidth")}}};n.addLayer(p).then(function(t){r=t,o.search={layer:t,type:e},delete a.allowedSearchTypes[e]}),n.one(TC.Consts.event.FEATURESADD,function(e){if(e.layer==r&&e.layer.features&&e.layer.features.length>0){for(var t=0;t<e.layer.features.length;t++)e.layer.features[t].showsPopup!=a.queryableFeatures&&(e.layer.features[t].showsPopup=a.queryableFeatures);n.zoomToFeatures(e.layer.features)}})}})),n.one(TC.Consts.event.SEARCHQUERYEMPTY,function(e){n.toast(a.EMPTY_RESULTS_LABEL,{type:TC.Consts.msgType.INFO,duration:5e3}),s&&s(null)}),n.one(TC.Consts.event.FEATURESADD,function(t){t.layer==r&&t.layer.features&&t.layer.features.length>0&&n.zoomToFeatures(t.layer.features),o.search={layer:t.layer,type:e},s&&s(t.layer.id!==l?t.layer.id:l)}),a.goToResult(t)},o.searchFeature=function(e,t,r,s){var l=TC.getUID(),i=a.featurePrefix;if(o.removeSearch(),e=(e||"").trim(),t=(t||"").trim(),r=(r||"").trim(),0==e.length||0==t.length||0==r.length)n.toast(a.EMPTY_RESULTS_LABEL,{type:TC.Consts.msgType.INFO,duration:5e3}),s&&s(null);else{e.indexOf(":")>-1&&(i=e.split(":")[0],e=e.split(":")[1]);var u,p={id:l,type:SITNA.Consts.layerType.WFS,url:a.url,version:a.version,stealth:!0,geometryName:"the_geom",featurePrefix:i,featureType:e,maxFeatures:1,properties:[{name:t,value:r,type:TC.Consts.comparison.EQUAL_TO}],outputFormat:TC.Consts.format.JSON};n.addLayer(p).then(function(e){u=e,o.search={layer:e,type:SITNA.Consts.mapSearchType.GENERIC}}),n.on(TC.Consts.event.FEATURESADD,function(e){if(e.layer==u&&e.layer.features&&e.layer.features.length>0){for(var t=0;t<e.layer.features.length;t++)e.layer.features[t].showsPopup!=a.queryableFeatures&&(e.layer.features[t].showsPopup=a.queryableFeatures);n.zoomToFeatures(e.layer.features)}}),n.on(TC.Consts.event.LAYERUPDATE,function(e){e.layer==u&&e.layer.features&&0==e.layer.features.length&&n.toast(a.EMPTY_RESULTS_LABEL,{type:TC.Consts.msgType.INFO,duration:5e3}),s&&s(e.layer==u&&e.layer.features&&0==e.layer.features.length?null:l)})}},o.removeSearch=function(e){if(o.search)if(a.availableSearchTypes[o.search.type]&&a.availableSearchTypes[o.search.type].hasOwnProperty("goTo")){for(var t=0;t<o.search.layer.features.length;t++)o.search.layer.removeFeature(o.search.layer.features[t]);o.search=null}else n.removeLayer(o.search.layer).then(function(){o.search=null});e&&e()},o.exportImage=function(){return n.exportImage()},o.search=null},SITNA.Consts=TC.Consts,SITNA.Cfg=TC.Cfg,SITNA.Cfg.layout=TC.apiLocation+"TC/layout/responsive";